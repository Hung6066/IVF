services:
  # PostgreSQL Database (Primary — WAL archiving + replication enabled)
  db:
    image: postgres:16-alpine
    container_name: ivf-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=ivf_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_archive:/var/lib/postgresql/archive
      - ./docker/postgres/init-wal-replication.sh:/docker-entrypoint-initdb.d/20-init-wal-replication.sh:ro
    networks:
      - default
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =============================================
  # PostgreSQL Standby — Streaming Replication
  # Read-only replica of the primary database.
  # Activate with: docker compose --profile replication up -d
  # After primary is initialized, this will clone via pg_basebackup.
  # =============================================
  db-standby:
    image: postgres:16-alpine
    container_name: ivf-db-standby
    profiles:
      - replication
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - PRIMARY_HOST=db
      - PRIMARY_PORT=5432
      - REPLICATOR_USER=replicator
      - REPLICATOR_PASSWORD=replicator_pass
    ports:
      - "5434:5432"
    volumes:
      - postgres_standby:/var/lib/postgresql/data
      - ./docker/postgres/standby-entrypoint.sh:/standby-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/standby-entrypoint.sh"]
    depends_on:
      db:
        condition: service_healthy
    networks:
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  # IVF API
  api:
    build:
      context: .
      dockerfile: src/IVF.API/Dockerfile
    container_name: ivf-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=8080
      - ConnectionStrings__DefaultConnection=Host=db;Database=ivf_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=redis:6379,abortConnect=false
      - JwtSettings__Secret=SuperSecretKeyForDevelopmentOnly123!@#
      - JwtSettings__Issuer=IVF_System
      - JwtSettings__Audience=IVF_Users
      - DigitalSigning__SignServerUrl=https://signserver:8443/signserver
      - DigitalSigning__WorkerName=PDFSigner
      - DigitalSigning__Enabled=true
      - DigitalSigning__SkipTlsValidation=true
      - DigitalSigning__ClientCertificatePath=/app/certs/api-client.p12
      - DigitalSigning__ClientCertificatePasswordFile=/run/secrets/api_cert_password
      - DigitalSigning__TrustedCaCertPath=/app/certs/ca-chain.pem
      - MinIO__Endpoint=minio:9000
      - MinIO__AccessKey=minioadmin
      - MinIO__SecretKey=minioadmin123
      - MinIO__UseSSL=false
      - MinIO__DocumentsBucket=ivf-documents
      - MinIO__SignedPdfsBucket=ivf-signed-pdfs
      - MinIO__MedicalImagesBucket=ivf-medical-images
    ports:
      - "5000:8080"
    volumes:
      - ./certs/ejbca-admin.p12:/app/certs/ejbca-admin.p12:ro
      - ./certs/api/api-client.p12:/app/certs/api-client.p12:ro
      - ./certs/ca-chain.pem:/app/certs/ca-chain.pem:ro
      - ./secrets/api_cert_password.txt:/run/secrets/api_cert_password:ro
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      minio:
        condition: service_healthy
    networks:
      - ivf-public
      - ivf-signing
      - ivf-data
    restart: on-failure
    security_opt:
      - no-new-privileges:true

  # Redis Cache
  redis:
    image: redis:alpine
    container_name: ivf-redis
    ports:
      - "6379:6379"
    networks:
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

  # =============================================
  # EJBCA - Certificate Authority
  # Quản lý chứng thư số (CA, phát hành, thu hồi)
  # Admin UI: https://localhost:8443/ejbca/adminweb/
  # Public UI: https://localhost:8443/ejbca/
  # =============================================
  ejbca:
    image: keyfactor/ejbca-ce:latest
    container_name: ivf-ejbca
    hostname: ejbca.ivf.local
    environment:
      - DATABASE_JDBC_URL=jdbc:postgresql://ejbca-db:5432/ejbca
      - DATABASE_USER=ejbca
      - DATABASE_PASSWORD=ejbca_secret
      - TLS_SETUP_ENABLED=simple
      # Initial admin setup
      - INITIAL_ADMIN=;PublicAccessAuthenticationToken:TRANSPORT_ANY;
    ports:
      - "8443:8443" # HTTPS Admin/Public web (EJBCA admin)
      - "8442:8080" # HTTP (public enrollment)
    volumes:
      - ejbca_persistent:/opt/keyfactor/persistent
      - ./certs/ca/ca.pem:/tmp/ivf-root-ca.pem:ro
      - ./scripts/init-ejbca-rest.sh:/scripts/init-ejbca-rest.sh:ro
    depends_on:
      ejbca-db:
        condition: service_healthy
    networks:
      - ivf-signing
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-fk",
          "https://localhost:8443/ejbca/publicweb/healthcheck/ejbcahealth",
        ]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 120s

  # EJBCA Database (separate from IVF DB)
  ejbca-db:
    image: postgres:16-alpine
    container_name: ivf-ejbca-db
    environment:
      - POSTGRES_USER=ejbca
      - POSTGRES_PASSWORD=ejbca_secret
      - POSTGRES_DB=ejbca
    volumes:
      - ejbca_db_data:/var/lib/postgresql/data
    networks:
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ejbca"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =============================================
  # SignServer - Document Signing Service
  # Ký số PDF sử dụng chứng thư từ EJBCA
  # Admin UI: https://localhost:9443/signserver/adminweb/
  # REST API: accessed internally via Docker network (not exposed to host)
  # =============================================
  signserver:
    image: keyfactor/signserver-ce:latest
    container_name: ivf-signserver
    hostname: signserver.ivf.local
    environment:
      - DATABASE_JDBC_URL=jdbc:postgresql://signserver-db:5432/signserver
      - DATABASE_USER=signserver
      - DATABASE_PASSWORD=signserver_secret
      - TLS_SETUP_ENABLED=simple
      - INITIAL_ADMIN=;PublicAccessAuthenticationToken:TRANSPORT_ANY;
      - SIGNSERVER_NODEID=node1
    ports:
      - "9443:8443" # HTTPS Admin web (mTLS)
      # Port 9080 REMOVED (Phase 3) — all signing via HTTPS 8443 with mTLS
    volumes:
      - signserver_persistent:/opt/keyfactor/persistent
      - ./certs/ca/ca.pem:/opt/keyfactor/persistent/keys/ivf-ca.pem:ro
      - ./scripts/init-mtls.sh:/opt/keyfactor/persistent/init-mtls.sh:ro
      - ./scripts/init-tsa.sh:/opt/keyfactor/persistent/init-tsa.sh:ro
    depends_on:
      signserver-db:
        condition: service_healthy
      ejbca:
        condition: service_healthy
    networks:
      - ivf-signing
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/tmp:size=200M
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/data:size=100M
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/log:size=50M
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/configuration:size=50M
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-fk",
          "https://localhost:8443/signserver/healthcheck/signserverhealth",
        ]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 120s

  # SignServer Database
  signserver-db:
    image: postgres:16-alpine
    container_name: ivf-signserver-db
    environment:
      - POSTGRES_USER=signserver
      - POSTGRES_PASSWORD=signserver_secret
      - POSTGRES_DB=signserver
    volumes:
      - signserver_db_data:/var/lib/postgresql/data
    networks:
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U signserver"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =============================================
  # MinIO - S3-Compatible Object Storage
  # Lưu trữ file ký số, hồ sơ bệnh án điện tử
  # Console: http://localhost:9001
  # API: http://localhost:9000
  # =============================================
  minio:
    image: minio/minio:latest
    container_name: ivf-minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # MinIO Console
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================
  # OpenMaxIO Object Browser - S3 Console UI
  # Custom MinIO Console for browsing objects
  # Console UI: http://localhost:9090
  # =============================================
  # object-browser:
  #   build:
  #     context: ./openmaxio-object-browser
  #     dockerfile: Dockerfile
  #   container_name: ivf-object-browser
  #   environment:
  #     - CONSOLE_MINIO_SERVER=http://minio:9000
  #   ports:
  #     - "9090:9090"
  #   depends_on:
  #     minio:
  #       condition: service_healthy
  #   networks:
  #     - ivf-data
  #   restart: unless-stopped
  #   security_opt:
  #     - no-new-privileges:true
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9090"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # MinIO Client - Auto-create buckets on startup
  minio-init:
    image: minio/mc:latest
    container_name: ivf-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set ivf http://minio:9000 minioadmin minioadmin123;
      mc mb ivf/ivf-documents --ignore-existing;
      mc mb ivf/ivf-signed-pdfs --ignore-existing;
      mc mb ivf/ivf-medical-images --ignore-existing;
      mc anonymous set download ivf/ivf-documents;
      echo 'MinIO buckets initialized successfully';
      exit 0;
      "
    networks:
      - ivf-data

  # =============================================
  # SignServer + SoftHSM2 (Phase 4: PKCS#11 / FIPS 140-2 Level 1)
  # Custom image extending SignServer CE with SoftHSM2 library.
  # Activate with: docker compose --profile softhsm up -d
  # Then run: docker exec ivf-signserver bash /opt/keyfactor/persistent/init-softhsm.sh
  # =============================================
  signserver-softhsm:
    build:
      context: ./docker/signserver-softhsm
      dockerfile: Dockerfile
    container_name: ivf-signserver
    hostname: signserver.ivf.local
    profiles:
      - softhsm
    environment:
      - DATABASE_JDBC_URL=jdbc:postgresql://signserver-db:5432/signserver
      - DATABASE_USER=signserver
      - DATABASE_PASSWORD=signserver_secret
      - TLS_SETUP_ENABLED=simple
      - INITIAL_ADMIN=;PublicAccessAuthenticationToken:TRANSPORT_ANY;
      - SIGNSERVER_NODEID=node1
      - SOFTHSM_TOKEN_LABEL=SignServerToken
      - SOFTHSM_USER_PIN=changeit
    ports:
      - "9443:8443"
    volumes:
      - signserver_persistent:/opt/keyfactor/persistent
      - ./certs/ca/ca.pem:/opt/keyfactor/persistent/keys/ivf-ca.pem:ro
      - ./scripts/init-mtls.sh:/opt/keyfactor/persistent/init-mtls.sh:ro
      - ./scripts/init-tsa.sh:/opt/keyfactor/persistent/init-tsa.sh:ro
      - ./scripts/init-softhsm.sh:/opt/keyfactor/persistent/init-softhsm.sh:ro
      - ./scripts/migrate-p12-to-pkcs11.sh:/opt/keyfactor/persistent/migrate-p12-to-pkcs11.sh:ro
    depends_on:
      signserver-db:
        condition: service_healthy
      ejbca:
        condition: service_healthy
    networks:
      - ivf-signing
      - ivf-data
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/tmp:size=200M
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/data:size=100M
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/log:size=50M
      - /opt/keyfactor/wildfly-35.0.1.Final/standalone/configuration:size=50M
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-fk",
          "https://localhost:8443/signserver/healthcheck/signserverhealth",
        ]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 120s

  # =============================================
  # Trivy — Container Security Scanner (Phase 4)
  # Scans all IVF containers for vulnerabilities.
  # Usage: docker compose --profile security-scan run --rm trivy-scan
  # =============================================
  trivy-scan:
    image: aquasec/trivy:latest
    container_name: ivf-trivy-scan
    profiles:
      - security-scan
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - trivy_cache:/root/.cache/trivy
    entrypoint: >
      /bin/sh -c "
      echo '═══════════════════════════════════════════════════════════';
      echo '  IVF Container Security Scan — $(date)';
      echo '═══════════════════════════════════════════════════════════';
      echo '';
      echo '─── Scanning SignServer ───';
      trivy image --severity HIGH,CRITICAL keyfactor/signserver-ce:latest;
      echo '';
      echo '─── Scanning EJBCA ───';
      trivy image --severity HIGH,CRITICAL keyfactor/ejbca-ce:latest;
      echo '';
      echo '─── Scanning PostgreSQL ───';
      trivy image --severity HIGH,CRITICAL postgres:16-alpine;
      echo '';
      echo '─── Scanning MinIO ───';
      trivy image --severity HIGH,CRITICAL minio/minio:latest;
      echo '';
      echo '─── Scanning Redis ───';
      trivy image --severity HIGH,CRITICAL redis:alpine;
      echo '';
      echo '═══════════════════════════════════════════════════════════';
      echo '  Scan Complete';
      echo '═══════════════════════════════════════════════════════════';
      "
    networks: []

volumes:
  postgres_data:
  postgres_archive:
  postgres_standby:
  ejbca_persistent:
  ejbca_db_data:
  signserver_persistent:
  signserver_db_data:
  minio_data:
  trivy_cache:
  softhsm_tokens:

networks:
  # Public network: API + frontend (external access)
  ivf-public:
    driver: bridge

  # Signing network: API ↔ SignServer ↔ EJBCA (internal, no internet)
  ivf-signing:
    driver: bridge
    internal: true

  # Data network: databases + storage (internal, no internet)
  ivf-data:
    driver: bridge
    internal: true
