<div class="dashboard-layout">
    <header class="page-header">
        <div class="header-title">
            <h1>üè• Ti·∫øp ƒë√≥n & Thu ng√¢n</h1>
        </div>
        <div class="quick-actions">
            <button class="btn btn-primary" routerLink="/patients/new">‚ûï BN M·ªõi</button>
            <button class="btn btn-secondary" routerLink="/couples/new">üíë T·∫°o c·∫∑p ƒë√¥i</button>
            <button class="btn btn-warning" (click)="scanFingerprint()">üñêÔ∏è Qu√©t v√¢n tay</button>
        </div>
    </header>

    <div class="search-section card">
        <input type="text" class="search-input" [(ngModel)]="searchTerm"
            placeholder="T√¨m b·ªánh nh√¢n (M√£ BN, T√™n, SƒêT, CCCD)..." (keyup.enter)="searchPatient()" />
        <button class="btn btn-primary" (click)="searchPatient()">üîç T√¨m</button>
    </div>

    @if (searchResults().length > 0) {
    <section class="search-results card">
        <h2>K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
        <div class="result-list">
            @for (patient of searchResults(); track patient.id) {
            <div class="result-card" (click)="selectPatient(patient)">
                <div class="patient-avatar">üë§</div>
                <div class="patient-info">
                    <strong>{{ patient.fullName }}</strong>
                    <span class="code">{{ patient.patientCode }}</span>
                </div>
                <div class="patient-meta">
                    <span>üì± {{ patient.phone || 'N/A' }}</span>
                    <span>üéÇ {{ formatDate(patient.dateOfBirth) }}</span>
                </div>
                <button class="btn btn-sm btn-success" (click)="$event.stopPropagation(); checkinPatient(patient)">
                    ƒêƒÉng k√Ω kh√°m
                </button>
            </div>
            }
        </div>
    </section>
    }

    <div class="dashboard-grid">
        <section class="queue-section card">
            <h2>üé´ S·ªë ƒëang ch·ªù h√¥m nay</h2>
            <div class="queue-numbers">
                <a routerLink="/queue/TV" class="queue-item consultation">
                    <span class="dept">T∆∞ v·∫•n</span>
                    <span class="count">{{ queueTuVan() }}</span>
                </a>
                <a routerLink="/queue/US" class="queue-item ultrasound">
                    <span class="dept">Si√™u √¢m</span>
                    <span class="count">{{ queueSieuAm() }}</span>
                </a>
                <a routerLink="/queue/TM" class="queue-item injection">
                    <span class="dept">Ti√™m</span>
                    <span class="count">{{ queueTiem() }}</span>
                </a>
                <a routerLink="/queue/XN" class="queue-item lab">
                    <span class="dept">X√©t nghi·ªám</span>
                    <span class="count">{{ queueXN() }}</span>
                </a>
            </div>
        </section>

        <section class="payment-section card">
            <h2>üí∞ Thu ng√¢n h√¥m nay</h2>
            <div class="payment-stats">
                <div class="payment-item">
                    <span class="label">T·ªïng thu</span>
                    <span class="value">{{ formatCurrency(totalPayment()) }}</span>
                </div>
                <div class="payment-item">
                    <span class="label">S·ªë phi·∫øu</span>
                    <span class="value">{{ paymentCount() }}</span>
                </div>
                <div class="payment-item">
                    <span class="label">Ch·ªù thanh to√°n</span>
                    <span class="value pending">{{ pendingPayment() }}</span>
                </div>
            </div>
        </section>

        <section class="recent-checkins card">
            <h2>üìã ƒêƒÉng k√Ω g·∫ßn ƒë√¢y</h2>
            <div class="checkin-list">
                @for (checkin of recentCheckins(); track checkin.id) {
                <div class="checkin-item">
                    <span class="time">{{ formatTime(checkin.time) }}</span>
                    <span class="name">{{ checkin.patientName }}</span>
                    <span class="dept-tag">{{ checkin.department }}</span>
                </div>
                } @empty {
                <div class="empty-state">Ch∆∞a c√≥ ƒëƒÉng k√Ω</div>
                }
            </div>
        </section>
    </div>

    @if (showCheckinModal) {
    <div class="modal-overlay" (click)="showCheckinModal = false">
        <div class="modal-content large-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>üìù ƒêƒÉng k√Ω kh√°m: {{ selectedPatient?.fullName }}</h3>
                <button class="close-btn" (click)="showCheckinModal = false">&times;</button>
            </div>

            <form (ngSubmit)="submitCheckin()">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Ch·ªçn Ph√≤ng kh√°m (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                        <div class="dept-checkboxes">
                            @for (d of departments; track d.code) {
                            <div class="dept-check-item" [class.checked]="isDeptSelected(d.code)"
                                (click)="toggleDept(d.code)">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" [checked]="isDeptSelected(d.code)"
                                        (change)="toggleDept(d.code)" (click)="$event.stopPropagation()">
                                </div>
                                <span class="dept-name">{{ d.name }}</span>
                            </div>
                            }
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">B√°c sƒ© ch·ªâ ƒë·ªãnh (t√πy ch·ªçn)</label>
                            <input class="form-control" type="text" [(ngModel)]="checkinData.doctor" name="doctor"
                                placeholder="VD: BS. Giang" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">M·ª©c ƒë·ªô ∆∞u ti√™n</label>
                            <select class="form-control" [(ngModel)]="checkinData.priority" name="priority">
                                <option value="Normal">B√¨nh th∆∞·ªùng</option>
                                <option value="VIP">VIP</option>
                                <option value="Emergency">C·∫•p c·ª©u</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ghi ch√∫</label>
                        <textarea class="form-control" [(ngModel)]="checkinData.notes" name="notes" rows="3"
                            placeholder="L√Ω do kh√°m..."></textarea>
                    </div>

                    <div class="form-group services-section">
                        <label class="form-label">üìã Ch·ªâ ƒë·ªãnh d·ªãch v·ª•</label>
                        <div class="services-grid">
                            @for (svc of services(); track svc.id) {
                            <div class="service-item" [class.selected]="isServiceSelected(svc.id)"
                                (click)="toggleService(svc.id)">
                                <div class="service-check">
                                    <input type="checkbox" [checked]="isServiceSelected(svc.id)"
                                        (change)="toggleService(svc.id)" (click)="$event.stopPropagation()" />
                                </div>
                                <div class="service-info">
                                    <span class="service-code">{{ svc.code }}</span>
                                    <span class="service-name">{{ svc.name }}</span>
                                </div>
                                <span class="service-price">{{ formatCurrency(svc.unitPrice) }}</span>
                            </div>
                            }
                        </div>
                        @if (checkinData.selectedServices.length > 0) {
                        <div class="services-total">
                            <span>T·ªïng {{ checkinData.selectedServices.length }} d·ªãch v·ª•:</span>
                            <strong>{{ formatCurrency(getSelectedServicesTotal()) }}</strong>
                        </div>
                        }
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="showCheckinModal = false">Hu·ª∑</button>
                    <button type="submit" class="btn btn-primary">C·∫•p s·ªë & In phi·∫øu</button>
                </div>
            </form>
        </div>
    </div>
    }
</div>