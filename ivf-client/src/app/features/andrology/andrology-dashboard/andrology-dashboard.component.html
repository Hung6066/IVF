<div class="dashboard-layout">
    <header class="page-header">
        <div class="header-title">
            <h1>üî¨ Nam Khoa - Andrology</h1>
        </div>
        <div class="header-actions">
            <!-- Add actions if needed -->
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon info">üìä</div>
            <div class="stat-content">
                <span class="value">{{ todayAnalysis() }}</span>
                <span class="label">XN h√¥m nay</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">üß™</div>
            <div class="stat-content">
                <span class="value">{{ todayWashing() }}</span>
                <span class="label">L·ªçc r·ª≠a h√¥m nay</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">‚è≥</div>
            <div class="stat-content">
                <span class="value">{{ pendingCount() }}</span>
                <span class="label">Ch·ªù k·∫øt qu·∫£</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon neutral">üìà</div>
            <div class="stat-content">
                <span class="value">{{ avgConcentration() }}M</span>
                <span class="label">M·∫≠t ƒë·ªô TB</span>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab-btn" [class.active]="activeTab === 'queue'" (click)="activeTab = 'queue'">üé´ H√†ng
            ƒë·ª£i</button>
        <button class="tab-btn" [class.active]="activeTab === 'analysis'" (click)="activeTab = 'analysis'">üìä Tinh d·ªãch
            ƒë·ªì</button>
        <button class="tab-btn" [class.active]="activeTab === 'washing'" (click)="activeTab = 'washing'">üß™ L·ªçc
            r·ª≠a</button>
        <button class="tab-btn" [class.active]="activeTab === 'statistics'" (click)="activeTab = 'statistics'">üìà Th·ªëng
            k√™</button>
    </div>

    @if (activeTab === 'queue') {
    <section class="content-section card">
        <div class="section-header">
            <h2>Danh s√°ch ch·ªù <span class="count-badge">{{ queueCount() }}</span></h2>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="80">STT</th>
                        <th>H·ªç t√™n</th>
                        <th>M√£ BN</th>
                        <th>Gi·ªù l·∫•y s·ªë</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th width="200" class="text-right">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @for (q of queue(); track q.id) {
                    <tr [class.active-row]="q.status === 'Called'">
                        <td class="stt-cell">{{ q.number }}</td>
                        <td class="name-cell">{{ q.patientName }}</td>
                        <td class="code-cell">{{ q.patientCode }}</td>
                        <td>{{ formatTime(q.issueTime) }}</td>
                        <td>
                            <span class="status-badge" [ngClass]="{
                    'pending': q.status === 'Waiting',
                    'called': q.status === 'Called',
                    'processing': q.status === 'InService'
                  }">
                                {{ q.status === 'Waiting' ? 'ƒêang ch·ªù' :
                                q.status === 'Called' ? 'ƒêang g·ªçi' :
                                q.status === 'InService' ? 'ƒêang l√†m' : q.status }}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-sm btn-info" (click)="callPatient(q)"
                                [disabled]="q.status !== 'Waiting'">üì¢ G·ªçi</button>
                            <button class="btn btn-sm btn-primary" (click)="startExam(q)"
                                [disabled]="q.status === 'InService'">üß™ Nh·∫≠n m·∫´u</button>
                            <button class="btn btn-sm btn-warning" (click)="skipPatient(q)"
                                [disabled]="q.status === 'InService'">‚è≠Ô∏è B·ªè qua</button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="6" class="empty-state">Kh√¥ng c√≥ b·ªánh nh√¢n ch·ªù</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'analysis') {
    <section class="content-section card">
        <div class="section-header">
            <h2>Danh s√°ch x√©t nghi·ªám tinh d·ªãch ƒë·ªì</h2>
            <button class="btn btn-primary" (click)="showNewAnalysis = true">‚ûï X√©t nghi·ªám m·ªõi</button>
        </div>

        <div class="filter-bar">
            <input type="date" [(ngModel)]="filterDate" class="form-control" />
            <select [(ngModel)]="filterStatus" class="form-control">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="Pending">Ch·ªù XN</option>
                <option value="Processing">ƒêang XN</option>
                <option value="Completed">Ho√†n th√†nh</option>
            </select>
            <input type="text" [(ngModel)]="searchTerm" placeholder="T√¨m theo m√£ BN..." class="form-control" />
        </div>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£ BN</th>
                        <th>H·ªç t√™n</th>
                        <th>Ng√†y XN</th>
                        <th>Th·ªÉ t√≠ch</th>
                        <th>M·∫≠t ƒë·ªô</th>
                        <th>Di ƒë·ªông PR</th>
                        <th>Di ƒë·ªông NP</th>
                        <th>B·∫•t ƒë·ªông</th>
                        <th>H√¨nh th√°i</th>
                        <th>S·ªëng</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @for (item of filteredAnalyses(); track item.id) {
                    <tr>
                        <td class="code-cell">{{ item.patientCode }}</td>
                        <td class="name-cell">{{ item.patientName }}</td>
                        <td>{{ formatDate(item.analysisDate) }}</td>
                        <td>{{ item.volume ?? '‚Äî' }} ml</td>
                        <td [class.text-danger]="(item.concentration ?? 0) < 15">{{ item.concentration ?? '‚Äî' }} M/ml
                        </td>
                        <td [class.text-danger]="(item.progressiveMotility ?? 0) < 32">{{ item.progressiveMotility ??
                            '‚Äî' }}%</td>
                        <td>{{ item.nonProgressiveMotility ?? '‚Äî' }}%</td>
                        <td>{{ item.immotile ?? '‚Äî' }}%</td>
                        <td [class.text-danger]="(item.normalMorphology ?? 0) < 4">{{ item.normalMorphology ?? '‚Äî' }}%
                        </td>
                        <td>{{ item.vitality ?? '‚Äî' }}%</td>
                        <td>
                            <span class="status-badge" [ngClass]="item.status.toLowerCase()">{{
                                getStatusName(item.status) }}</span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn-icon" title="S·ª≠a" (click)="editAnalysis(item)">‚úèÔ∏è</button>
                            <button class="btn-icon" title="In" (click)="printResult(item)">üñ®Ô∏è</button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="12" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'washing') {
    <section class="content-section card">
        <div class="section-header">
            <h2>Danh s√°ch l·ªçc r·ª≠a tinh tr√πng</h2>
            <button class="btn btn-primary" (click)="showNewWashing = true">‚ûï L·ªçc r·ª≠a m·ªõi</button>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£ chu k·ª≥</th>
                        <th>H·ªç t√™n</th>
                        <th>Ph∆∞∆°ng ph√°p</th>
                        <th>M·∫≠t ƒë·ªô tr∆∞·ªõc</th>
                        <th>M·∫≠t ƒë·ªô sau</th>
                        <th>Di ƒë·ªông sau</th>
                        <th>Ng√†y l·ªçc</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @for (item of washings(); track item.id) {
                    <tr>
                        <td class="code-cell">{{ item.cycleCode }}</td>
                        <td class="name-cell">{{ item.patientName }}</td>
                        <td>{{ item.method }}</td>
                        <td>{{ item.preWashConcentration ?? '‚Äî' }} M/ml</td>
                        <td>{{ item.postWashConcentration ?? '‚Äî' }} M/ml</td>
                        <td>{{ item.postWashMotility ?? '‚Äî' }}%</td>
                        <td>{{ formatDate(item.washDate) }}</td>
                        <td><span class="status-badge" [ngClass]="item.status.toLowerCase()">{{
                                getStatusName(item.status) }}</span></td>
                        <td class="actions-cell">
                            <button class="btn-icon" title="S·ª≠a" (click)="editWashing(item)">‚úèÔ∏è</button>
                            <button class="btn-icon" title="In" (click)="printWashing(item)">üñ®Ô∏è</button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="9" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'statistics') {
    <section class="content-section card">
        <h2>Th·ªëng k√™ Nam khoa</h2>
        <div class="stats-visuals-grid">
            <div class="stat-box">
                <h4>Ph√¢n lo·∫°i m·∫≠t ƒë·ªô tinh tr√πng</h4>
                <div class="bar-chart">
                    <div class="bar-item"><span class="bar-label">Normozoospermia</span>
                        <div class="bar" [style.width.%]="getDistPercentage('Normozoospermia')"></div><span>{{
                            getDistPercentage('Normozoospermia') }}%</span>
                    </div>
                    <div class="bar-item"><span class="bar-label">Oligozoospermia</span>
                        <div class="bar warning" [style.width.%]="getDistPercentage('Oligozoospermia')"></div><span>{{
                            getDistPercentage('Oligozoospermia') }}%</span>
                    </div>
                    <div class="bar-item"><span class="bar-label">Severe Oligo</span>
                        <div class="bar danger" [style.width.%]="getDistPercentage('Severe Oligo')"></div><span>{{
                            getDistPercentage('Severe Oligo') }}%</span>
                    </div>
                    <div class="bar-item"><span class="bar-label">Azoospermia</span>
                        <div class="bar danger" [style.width.%]="getDistPercentage('Azoospermia')"></div><span>{{
                            getDistPercentage('Azoospermia') }}%</span>
                    </div>
                </div>
            </div>
            <!-- Simplified stats for brevity -->
        </div>
    </section>
    }

    @if (showNewAnalysis) {
    <div class="modal-overlay" (click)="showNewAnalysis = false">
        <div class="modal-content large" (click)="$event.stopPropagation()">
            <header class="modal-header">
                <h3>{{ editingAnalysisId ? '‚úèÔ∏è C·∫≠p nh·∫≠t k·∫øt qu·∫£' : '‚ûï X√©t nghi·ªám tinh d·ªãch ƒë·ªì m·ªõi' }}</h3>
                <button class="close-btn" (click)="showNewAnalysis = false">√ó</button>
            </header>
            <form (ngSubmit)="submitAnalysis()">
                <div class="modal-body">
                    <div class="form-group" [class.disabled]="editingAnalysisId">
                        <label>T√¨m b·ªánh nh√¢n</label>
                        @if(editingAnalysisId) {
                        <input type="text" [value]="newAnalysis.patientName" class="form-control" disabled />
                        } @else {
                        <app-patient-search [placeholder]="'Nh·∫≠p m√£ ho·∫∑c t√™n b·ªánh nh√¢n...'"
                            [(ngModel)]="selectedAnalysisPatientId" name="analysisPatientName" [genderFilter]="'Male'"
                            (patientSelected)="onPatientChange($event)"></app-patient-search>
                        }
                    </div>

                    <div class="form-section-title">ƒê·∫°i th·ªÉ (Macroscopic)</div>
                    <div class="grid-4">
                        <div class="form-group"><label>Th·ªÉ t√≠ch (ml)</label><input type="number"
                                [(ngModel)]="newAnalysis.volume" name="volume" step="0.1" class="form-control" /></div>
                        <div class="form-group"><label>M√†u s·∫Øc</label><input type="text"
                                [(ngModel)]="newAnalysis.appearance" name="appearance" class="form-control" /></div>
                        <div class="form-group"><label>Ly gi·∫£i</label><input type="text"
                                [(ngModel)]="newAnalysis.liquefaction" name="liquefaction" class="form-control" /></div>
                        <div class="form-group"><label>pH</label><input type="number" [(ngModel)]="newAnalysis.ph"
                                name="ph" step="0.1" class="form-control" /></div>
                    </div>

                    <div class="form-section-title">Vi th·ªÉ (Microscopic)</div>
                    <div class="grid-2">
                        <div class="form-group"><label>M·∫≠t ƒë·ªô (M/ml)</label><input type="number"
                                [(ngModel)]="newAnalysis.concentration" name="concentration" step="0.1"
                                class="form-control" /></div>
                        <div class="form-group"><label>T·ªïng s·ªë (M)</label><input type="number"
                                [(ngModel)]="newAnalysis.totalCount" name="totalCount" step="0.1"
                                class="form-control" />
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group"><label>Di ƒë·ªông PR (%)</label><input type="number"
                                [(ngModel)]="newAnalysis.progressiveMotility" name="pr" max="100"
                                class="form-control" />
                        </div>
                        <div class="form-group"><label>Di ƒë·ªông NP (%)</label><input type="number"
                                [(ngModel)]="newAnalysis.nonProgressiveMotility" name="np" max="100"
                                class="form-control" />
                        </div>
                        <div class="form-group"><label>B·∫•t ƒë·ªông (%)</label><input type="number"
                                [(ngModel)]="newAnalysis.immotile" name="im" max="100" class="form-control" /></div>
                        <div class="form-group"><label>H√¨nh th√°i (% b√¨nh th∆∞·ªùng)</label><input type="number"
                                [(ngModel)]="newAnalysis.normalMorphology" name="morph" max="100"
                                class="form-control" />
                        </div>
                        <div class="form-group"><label>T·ª∑ l·ªá s·ªëng (%)</label><input type="number"
                                [(ngModel)]="newAnalysis.vitality" name="vital" max="100" class="form-control" /></div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="showNewAnalysis = false">Hu·ª∑</button>
                    <button type="submit" class="btn btn-primary">L∆∞u k·∫øt qu·∫£</button>
                </div>
            </form>
        </div>
    </div>
    }

    @if (showNewWashing) {
    <div class="modal-overlay" (click)="showNewWashing = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <header class="modal-header">
                <h3>{{ editingWashingId ? '‚úèÔ∏è C·∫≠p nh·∫≠t l·ªçc r·ª≠a' : '‚ûï L·ªçc r·ª≠a m·ªõi' }}</h3>
                <button class="close-btn" (click)="showNewWashing = false">√ó</button>
            </header>
            <form (ngSubmit)="submitWashing()">
                <div class="modal-body">
                    <div class="form-group" [class.disabled]="editingWashingId">
                        <label>M√£ chu k·ª≥ <span class="required">*</span></label>
                        @if(editingWashingId) {
                        <input type="text" [value]="newWashing.cycleCode" class="form-control" disabled />
                        } @else {
                        <app-cycle-search [placeholder]="'Nh·∫≠p m√£ chu k·ª≥...'" [patientId]="selectedWashingPatientId"
                            (cycleSelected)="onCycleChange($event)"></app-cycle-search>
                        }
                    </div>
                    <div class="form-group" [class.disabled]="editingWashingId">
                        <label>T√¨m b·ªánh nh√¢n <span class="required">*</span></label>
                        @if(editingWashingId) {
                        <input type="text" [value]="newWashing.patientName" class="form-control" disabled />
                        } @else {
                        <app-patient-search [placeholder]="'Nh·∫≠p t√™n ho·∫∑c m√£ b·ªánh nh√¢n...'"
                            [(ngModel)]="selectedWashingPatientId" [suggestedPatients]="suggestedPatients"
                            name="patientName" (patientSelected)="onWashingPatientChange($event)"></app-patient-search>
                        }
                    </div>
                    <div class="form-group"><label>Ph∆∞∆°ng ph√°p</label><select [(ngModel)]="newWashing.method"
                            name="method" class="form-control">
                            <option value="Gradient">Gradient</option>
                            <option value="Swim-up">Swim-up</option>
                        </select></div>
                    <div class="grid-2">
                        <div class="form-group"><label>M·∫≠t ƒë·ªô tr∆∞·ªõc (M/ml)</label><input type="number"
                                [(ngModel)]="newWashing.preWashConcentration" name="pre" step="0.1"
                                class="form-control" /></div>
                        <div class="form-group"><label>M·∫≠t ƒë·ªô sau (M/ml)</label><input type="number"
                                [(ngModel)]="newWashing.postWashConcentration" name="post" step="0.1"
                                class="form-control" />
                        </div>
                    </div>
                    <div class="form-group"><label>Di ƒë·ªông sau (%)</label><input type="number"
                            [(ngModel)]="newWashing.postWashMotility" name="motility" max="100" class="form-control" />
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="showNewWashing = false">Hu·ª∑</button>
                    <button type="submit" class="btn btn-primary">L∆∞u k·∫øt qu·∫£</button>
                </div>
            </form>
        </div>
    </div>
    }
</div>

<!-- Print Templates (Visible only when printing) -->
<div class="print-container">
    @if (printAnalysisData) {
    <div class="print-content">
        <h1 class="text-center">PHI·∫æU X√âT NGHI·ªÜM TINH D·ªäCH ƒê·ªí</h1>
        <h3 class="text-center">SEMEN ANALYSIS REPORT</h3>
        <hr>
        <div class="patient-info">
            <p><strong>H·ªç t√™n:</strong> {{ printAnalysisData.patientName }}</p>
            <p><strong>M√£ BN:</strong> {{ printAnalysisData.patientCode }}</p>
            <p><strong>Ng√†y XN:</strong> {{ formatDate(printAnalysisData.analysisDate) }}</p>
        </div>

        <h4 class="section-title">1. ƒê·∫†I TH·ªÇ (MACROSCOPIC)</h4>
        <table class="print-table">
            <tr>
                <td>Th·ªÉ t√≠ch (Volume)</td>
                <td>{{ printAnalysisData.volume ?? '‚Äî' }} ml</td>
            </tr>
            <tr>
                <td>M√†u s·∫Øc (Appearance)</td>
                <td>B√¨nh th∆∞·ªùng</td>
            </tr>
            <tr>
                <td>Ly gi·∫£i (Liquefaction)</td>
                <td>{{ printAnalysisData.volume ? '< 30 ph√∫t' : '‚Äî' }}</td>
            </tr>
            <tr>
                <td>pH</td>
                <td>{{ printAnalysisData.volume ? '7.2' : '‚Äî' }}</td>
            </tr>
        </table>

        <h4 class="section-title">2. VI TH·ªÇ (MICROSCOPIC)</h4>
        <table class="print-table">
            <tr>
                <td>M·∫≠t ƒë·ªô (Concentration)</td>
                <td>{{ printAnalysisData.concentration ?? '‚Äî' }} M/ml</td>
            </tr>
            <tr>
                <td>T·ªïng s·ªë (Total Count)</td>
                <td>{{ printAnalysisData.totalCount ?? '‚Äî' }} M</td>
            </tr>
            <tr>
                <td>Di ƒë·ªông ti·∫øn t·ªõi (PR)</td>
                <td>{{ printAnalysisData.progressiveMotility ?? '‚Äî' }}%</td>
            </tr>
            <tr>
                <td>Di ƒë·ªông kh√¥ng ti·∫øn t·ªõi (NP)</td>
                <td>{{ printAnalysisData.nonProgressiveMotility ?? '‚Äî' }}%</td>
            </tr>
            <tr>
                <td>B·∫•t ƒë·ªông (Immotile)</td>
                <td>{{ printAnalysisData.immotile ?? '‚Äî' }}%</td>
            </tr>
            <tr>
                <td>H√¨nh th√°i b√¨nh th∆∞·ªùng</td>
                <td>{{ printAnalysisData.normalMorphology ?? '‚Äî' }}%</td>
            </tr>
            <tr>
                <td>T·ª∑ l·ªá s·ªëng</td>
                <td>{{ printAnalysisData.vitality ?? '‚Äî' }}%</td>
            </tr>
        </table>

        <div class="footer-sign">
            <p><strong>Chuy√™n vi√™n th·ª±c hi·ªán</strong></p>
            <br><br><br>
            <p>BS. Andrology</p>
        </div>
    </div>
    }

    @if (printWashingData) {
    <div class="print-content">
        <h1 class="text-center">PHI·∫æU L·ªåC R·ª¨A TINH TR√ôNG</h1>
        <h3 class="text-center">SPERM PREPARATION REPORT</h3>
        <hr>
        <div class="patient-info">
            <p><strong>H·ªç t√™n:</strong> {{ printWashingData.patientName }}</p>
            <p><strong>M√£ chu k·ª≥:</strong> {{ printWashingData.cycleCode }}</p>
            <p><strong>Ng√†y l·ªçc:</strong> {{ formatDate(printWashingData.washDate) }}</p>
            <p><strong>Ph∆∞∆°ng ph√°p:</strong> {{ printWashingData.method }}</p>
        </div>

        <table class="print-table">
            <thead>
                <tr>
                    <th>Th√¥ng s·ªë</th>
                    <th>Tr∆∞·ªõc l·ªçc (Pre-wash)</th>
                    <th>Sau l·ªçc (Post-wash)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>M·∫≠t ƒë·ªô (Concentration)</td>
                    <td>{{ printWashingData.preWashConcentration ?? '‚Äî' }} M/ml</td>
                    <td>{{ printWashingData.postWashConcentration ?? '‚Äî' }} M/ml</td>
                </tr>
                <tr>
                    <td>Di ƒë·ªông (Motility)</td>
                    <td>‚Äî</td>
                    <td>{{ printWashingData.postWashMotility ?? '‚Äî' }}%</td>
                </tr>
            </tbody>
        </table>

        <div class="footer-sign">
            <p><strong>Chuy√™n vi√™n th·ª±c hi·ªán</strong></p>
            <br><br><br>
            <p>BS. Andrology</p>
        </div>
    </div>
    }
</div>