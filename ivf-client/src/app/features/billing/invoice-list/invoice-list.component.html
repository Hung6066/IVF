<div class="dashboard-layout">
    <header class="page-header">
        <div class="header-title">
            <h1>üí∞ Ho√° ƒë∆°n & Thanh to√°n</h1>
        </div>
        <div class="tabs-container">
            <button class="tab-btn" [class.active]="activeTab === 'invoices'" (click)="activeTab = 'invoices'">üìã Ho√°
                ƒë∆°n</button>
            <button class="tab-btn" [class.active]="activeTab === 'payments'" (click)="activeTab = 'payments'">üí≥ Thanh
                to√°n</button>
            <button class="tab-btn" [class.active]="activeTab === 'revenue'" (click)="activeTab = 'revenue'">üìä Doanh
                thu</button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon info">üìÑ</div>
            <div class="stat-content">
                <span class="value">{{ todayInvoices() }}</span>
                <span class="label">Ho√° ƒë∆°n h√¥m nay</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">üí∞</div>
            <div class="stat-content">
                <span class="value">{{ formatCurrency(todayRevenue()) }}</span>
                <span class="label">Thu h√¥m nay</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">‚è≥</div>
            <div class="stat-content">
                <span class="value">{{ pendingPayments() }}</span>
                <span class="label">Ch·ªù thanh to√°n</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon primary">üè¶</div>
            <div class="stat-content">
                <span class="value">{{ formatCurrency(monthRevenue()) }}</span>
                <span class="label">Thu th√°ng n√†y</span>
            </div>
        </div>
    </div>

    @if (activeTab === 'invoices') {
    <section class="card">
        <div class="section-header">
            <h2>Danh s√°ch ho√° ƒë∆°n</h2>
            <button class="btn btn-primary" (click)="showCreateInvoice = true">‚ûï T·∫°o ho√° ƒë∆°n</button>
        </div>
        <div class="filter-row">
            <input class="form-control" type="date" [(ngModel)]="filterDate" />
            <select class="form-control" [(ngModel)]="filterStatus">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="Paid">ƒê√£ thanh to√°n</option>
                <option value="Pending">Ch·ªù thanh to√°n</option>
                <option value="Partial">Thanh to√°n 1 ph·∫ßn</option>
            </select>
            <input class="form-control search-input" type="text" placeholder="T√¨m m√£ ho√° ƒë∆°n..."
                [(ngModel)]="searchTerm" />
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£ HD</th>
                        <th>B·ªánh nh√¢n</th>
                        <th>Ng√†y</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>ƒê√£ thu</th>
                        <th>C√≤n l·∫°i</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th class="text-right">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @for (inv of filteredInvoices(); track inv.id) {
                    <tr>
                        <td class="code-cell">{{ inv.code }}</td>
                        <td>{{ inv.patient }}</td>
                        <td>{{ inv.date }}</td>
                        <td class="amount-cell">{{ formatCurrency(inv.total) }}</td>
                        <td class="amount-cell">{{ formatCurrency(inv.paid) }}</td>
                        <td class="amount-cell" [class.text-danger]="inv.remaining > 0">{{ formatCurrency(inv.remaining)
                            }}</td>
                        <td><span class="status-badge" [class]="inv.status.toLowerCase()">{{ getStatusName(inv.status)
                                }}</span></td>
                        <td class="actions-cell">
                            <button class="btn-icon" title="Chi ti·∫øt" (click)="viewInvoice(inv)">üìã</button>
                            <button class="btn-icon" title="Thu ti·ªÅn" (click)="payInvoice(inv)">üí≥</button>
                            <button class="btn-icon" title="In" (click)="printInvoice(inv)">üñ®Ô∏è</button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="8" class="empty-state">Kh√¥ng c√≥ ho√° ƒë∆°n</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'payments') {
    <section class="card">
        <div class="section-header">
            <h2>L·ªãch s·ª≠ thanh to√°n</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£</th>
                        <th>Ho√° ƒë∆°n</th>
                        <th>B·ªánh nh√¢n</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Ph∆∞∆°ng th·ª©c</th>
                        <th>Th·ªùi gian</th>
                        <th>Thu ng√¢n</th>
                    </tr>
                </thead>
                <tbody>
                    @for (p of payments(); track p.id) {
                    <tr>
                        <td class="code-cell">{{ p.code }}</td>
                        <td class="code-cell">{{ p.invoice }}</td>
                        <td>{{ p.patient }}</td>
                        <td class="amount-cell">{{ formatCurrency(p.amount) }}</td>
                        <td>{{ p.method }}</td>
                        <td>{{ p.datetime }}</td>
                        <td>{{ p.cashier }}</td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="7" class="empty-state">Kh√¥ng c√≥ l·ªãch s·ª≠</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'revenue') {
    <section class="card">
        <div class="section-header">
            <h2>B√°o c√°o doanh thu</h2>
        </div>
        <div class="revenue-grid">
            <div class="rev-card">
                <h4>Tu·∫ßn n√†y</h4>
                <span class="rev-value">{{ formatCurrency(weekRevenue()) }}</span>
                <span class="rev-trend up">‚Üë 12%</span>
            </div>
            <div class="rev-card">
                <h4>Th√°ng n√†y</h4>
                <span class="rev-value">{{ formatCurrency(monthRevenue()) }}</span>
                <span class="rev-trend up">‚Üë 8%</span>
            </div>
            <div class="rev-card">
                <h4>Qu√Ω n√†y</h4>
                <span class="rev-value">{{ formatCurrency(quarterRevenue()) }}</span>
                <span class="rev-trend down">‚Üì 3%</span>
            </div>
        </div>
        <div class="chart-placeholder">
            <h4>Bi·ªÉu ƒë·ªì doanh thu theo ng√†y</h4>
            <div class="bars">
                @for (d of chartData(); track d.day) {
                <div class="bar-col">
                    <div class="bar" [style.height.%]="d.pct"></div>
                    <span>{{ d.day }}</span>
                </div>
                }
            </div>
        </div>
    </section>
    }

    @if (showCreateInvoice) {
    <div class="modal-overlay" (click)="showCreateInvoice = false">
        <div class="modal-content large-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>‚ûï T·∫°o ho√° ƒë∆°n m·ªõi</h3>
                <button class="close-btn" (click)="showCreateInvoice = false">√ó</button>
            </div>

            <form (ngSubmit)="submitInvoice()">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">T√¨m b·ªánh nh√¢n *</label>
                        <app-patient-search [(ngModel)]="newInvoice.patientSearch" name="search" [required]="true"
                            (patientSelected)="onPatientSelect($event)"></app-patient-search>
                    </div>

                    <div class="invoice-items-section">
                        <h4>D·ªãch v·ª•</h4>
                        @for (item of newInvoice.items; track $index) {
                        <div class="item-row">
                            <input class="form-control" type="text" [(ngModel)]="item.name" [name]="'name'+$index"
                                placeholder="T√™n d·ªãch v·ª•" />
                            <input class="form-control qty-input" type="number" [(ngModel)]="item.qty"
                                [name]="'qty'+$index" placeholder="SL" />
                            <input class="form-control" type="number" [(ngModel)]="item.price" [name]="'price'+$index"
                                placeholder="ƒê∆°n gi√°" />
                            <button type="button" class="btn-icon danger" (click)="removeItem($index)">‚úñ</button>
                        </div>
                        }
                        <button type="button" class="btn btn-secondary full-width" (click)="addItem()">‚ûï Th√™m d·ªãch
                            v·ª•</button>
                    </div>

                    <div class="total-row">
                        <span>T·ªïng c·ªông:</span>
                        <span class="total-value">{{ formatCurrency(calcTotal()) }}</span>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="showCreateInvoice = false">Hu·ª∑</button>
                    <button type="submit" class="btn btn-primary">T·∫°o ho√° ƒë∆°n</button>
                </div>
            </form>
        </div>
    </div>
    }
</div>