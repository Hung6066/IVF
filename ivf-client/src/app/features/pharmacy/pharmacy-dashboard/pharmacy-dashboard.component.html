<div class="dashboard-layout">
    <header class="page-header">
        <div class="header-title">
            <h1>üíä Nh√† thu·ªëc</h1>
        </div>
        <div class="tabs-container">
            <button class="tab-btn" [class.active]="activeTab === 'prescriptions'"
                (click)="activeTab = 'prescriptions'">üìã ƒê∆°n thu·ªëc</button>
            <button class="tab-btn" [class.active]="activeTab === 'inventory'" (click)="activeTab = 'inventory'">üì¶ T·ªìn
                kho</button>
            <button class="tab-btn" [class.active]="activeTab === 'import'" (click)="activeTab = 'import'">üì• Nh·∫≠p
                kho</button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon info">üìã</div>
            <div class="stat-content">
                <span class="value">{{ pendingRx() }}</span>
                <span class="label">Ch·ªù ph√°t</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">‚úÖ</div>
            <div class="stat-content">
                <span class="value">{{ completedRx() }}</span>
                <span class="label">ƒê√£ ph√°t</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">‚ö†Ô∏è</div>
            <div class="stat-content">
                <span class="value">{{ lowStockCount() }}</span>
                <span class="label">S·∫Øp h·∫øt</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon primary">üì¶</div>
            <div class="stat-content">
                <span class="value">{{ totalItems() }}</span>
                <span class="label">T·ªïng m·∫∑t h√†ng</span>
            </div>
        </div>
    </div>

    @if (activeTab === 'prescriptions') {
    <section class="card">
        <div class="section-header">
            <h2>H√†ng ƒë·ª£i ƒë∆°n thu·ªëc</h2>
        </div>
        <div class="rx-queue-grid">
            @for (rx of prescriptions(); track rx.id) {
            <div class="rx-card" [class]="rx.status.toLowerCase()">
                <div class="rx-header">
                    <span class="rx-patient">{{ rx.patient }}</span>
                    <span class="rx-time">{{ rx.time }}</span>
                </div>
                <div class="rx-info">
                    üë®‚Äç‚öïÔ∏è {{ rx.doctor }} ‚Ä¢ üíä {{ rx.items }} thu·ªëc
                </div>
                <div class="rx-actions">
                    @if (rx.status === 'Pending') {
                    <button class="btn btn-sm btn-warning" (click)="processRx(rx)">B·∫Øt ƒë·∫ßu</button>
                    } @else if (rx.status === 'Processing') {
                    <button class="btn btn-sm btn-primary" (click)="completeRx(rx)">Ho√†n th√†nh</button>
                    } @else {
                    <span class="status-badge success">‚úì ƒê√£ ph√°t</span>
                    }
                </div>
            </div>
            } @empty {
            <div class="empty-state">Kh√¥ng c√≥ ƒë∆°n thu·ªëc</div>
            }
        </div>
    </section>
    }

    @if (activeTab === 'inventory') {
    <section class="card">
        <div class="section-header">
            <h2>T·ªìn kho thu·ªëc</h2>
            <input type="text" class="search-input" placeholder="T√¨m thu·ªëc..." [(ngModel)]="drugSearch" />
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£</th>
                        <th>T√™n thu·ªëc</th>
                        <th>ƒêVT</th>
                        <th>T·ªìn</th>
                        <th>T·ªëi thi·ªÉu</th>
                        <th>H·∫°n s·ª≠ d·ª•ng</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody>
                    @for (d of filteredDrugs(); track d.id) {
                    <tr [class.low-stock-row]="d.stock < d.minStock">
                        <td class="code-cell">{{ d.code }}</td>
                        <td>{{ d.name }}</td>
                        <td>{{ d.unit }}</td>
                        <td class="font-bold">{{ d.stock }}</td>
                        <td>{{ d.minStock }}</td>
                        <td>{{ d.expiry }}</td>
                        <td>
                            <span class="status-badge" [class.warning]="d.stock < d.minStock"
                                [class.success]="d.stock >= d.minStock">
                                {{ d.stock < d.minStock ? 'S·∫Øp h·∫øt' : 'ƒê·ªß' }} </span>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="7" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'import') {
    <section class="card">
        <div class="section-header">
            <h2>L·ªãch s·ª≠ nh·∫≠p kho</h2>
            <button class="btn btn-primary" (click)="showNewImport = true">‚ûï Nh·∫≠p kho m·ªõi</button>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£ phi·∫øu</th>
                        <th>Ng√†y</th>
                        <th>NCC</th>
                        <th>S·ªë m·∫∑t h√†ng</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th class="text-right">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @for (i of imports(); track i.id) {
                    <tr>
                        <td class="code-cell">{{ i.code }}</td>
                        <td>{{ i.date }}</td>
                        <td>{{ i.supplier }}</td>
                        <td>{{ i.items }}</td>
                        <td>{{ formatCurrency(i.total) }}</td>
                        <td><span class="status-badge success">{{ i.status }}</span></td>
                        <td class="actions-cell">
                            <button class="btn-icon" (click)="viewImport(i)">üëÅÔ∏è</button>
                            <button class="btn-icon" (click)="editImport(i)">‚úèÔ∏è</button>
                            <button class="btn-icon" (click)="deleteImport(i)">üóëÔ∏è</button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="7" class="empty-state">Kh√¥ng c√≥ l·ªãch s·ª≠</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (showNewImport) {
    <div class="modal-overlay" (click)="showNewImport = false">
        <div class="modal-content large-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>‚ûï Nh·∫≠p kho m·ªõi</h2>
                <button class="close-btn" (click)="showNewImport = false">√ó</button>
            </div>
            <form (ngSubmit)="submitImport()">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nh√† cung c·∫•p *</label>
                            <input class="form-control" type="text" [(ngModel)]="newImport.supplier" name="supplier"
                                required />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ng√†y nh·∫≠p</label>
                            <input class="form-control" type="date" [(ngModel)]="newImport.date" name="date" />
                        </div>
                    </div>

                    <div class="inventory-list">
                        <h4>Danh s√°ch thu·ªëc</h4>
                        @for (item of newImport.items; track $index) {
                        <div class="item-row">
                            <input class="form-control" type="text" [(ngModel)]="item.name" [name]="'name'+$index"
                                placeholder="T√™n thu·ªëc" />
                            <input class="form-control qty-input" type="number" [(ngModel)]="item.qty"
                                [name]="'qty'+$index" placeholder="SL" />
                            <input class="form-control" type="number" [(ngModel)]="item.price" [name]="'price'+$index"
                                placeholder="ƒê∆°n gi√°" />
                            <button type="button" class="btn-icon danger" (click)="removeImportItem($index)">‚úñ</button>
                        </div>
                        }
                        <button type="button" class="btn btn-secondary full-width" (click)="addImportItem()">‚ûï Th√™m
                            thu·ªëc</button>
                    </div>

                    <div class="total-row">
                        <span>T·ªïng ti·ªÅn:</span>
                        <span class="total-value">{{ formatCurrency(calcImportTotal()) }}</span>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="showNewImport = false">Hu·ª∑</button>
                    <button type="submit" class="btn btn-primary">L∆∞u phi·∫øu nh·∫≠p</button>
                </div>
            </form>
        </div>
    </div>
    }
</div>