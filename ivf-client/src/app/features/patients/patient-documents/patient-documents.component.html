<div class="patient-documents">
  <!-- Header -->
  <header class="page-header">
    <a [routerLink]="['/patients', patientId]" class="back-link">
      <span>‚Üê</span> H·ªì s∆° b·ªánh nh√¢n
    </a>
    <div class="header-row">
      <div class="header-info">
        <h1>üìÅ H·ªì s∆° b·ªánh √°n ƒëi·ªán t·ª≠</h1>
        @if (patient()) {
          <p class="subtitle">{{ patient().patientCode }} ‚Äî {{ patient().fullName }}</p>
        }
      </div>
      <button class="btn btn-primary" (click)="openUploadDialog()">
        <span class="icon">+</span> T·∫£i l√™n t√†i li·ªáu
      </button>
    </div>
  </header>

  <!-- Messages -->
  @if (successMessage()) {
    <div class="alert alert-success">‚úì {{ successMessage() }}</div>
  }
  @if (error()) {
    <div class="alert alert-error">‚ö† {{ error() }}</div>
  }

  <!-- Summary Cards -->
  @if (summary()) {
    <div class="summary-grid">
      <div class="summary-card">
        <span class="summary-icon">üìÑ</span>
        <div class="summary-info">
          <span class="summary-value">{{ summary()!.totalDocuments }}</span>
          <span class="summary-label">T√†i li·ªáu</span>
        </div>
      </div>
      <div class="summary-card">
        <span class="summary-icon">üíæ</span>
        <div class="summary-info">
          <span class="summary-value">{{ storageUsed() }}</span>
          <span class="summary-label">Dung l∆∞·ª£ng</span>
        </div>
      </div>
      @for (entry of summary()!.documentCountsByType | keyvalue; track entry.key) {
        <div class="summary-card mini">
          <span class="summary-icon material-icon">{{ getDocTypeIcon(entry.key) }}</span>
          <div class="summary-info">
            <span class="summary-value">{{ entry.value }}</span>
            <span class="summary-label">{{ getDocTypeLabel(entry.key) }}</span>
          </div>
        </div>
      }
    </div>
  }

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <input
        type="text"
        placeholder="T√¨m ki·∫øm t√†i li·ªáu..."
        [ngModel]="searchTerm()"
        (ngModelChange)="onSearch($event)"
      />
    </div>
    <select [ngModel]="selectedType()" (ngModelChange)="onTypeChange($event)">
      <option value="">T·∫•t c·∫£ lo·∫°i</option>
      @for (type of documentTypes(); track type.value) {
        <option [value]="type.value">{{ type.label }}</option>
      }
    </select>
  </div>

  <!-- Document List -->
  <div class="document-list">
    @if (loading()) {
      <div class="loading">ƒêang t·∫£i...</div>
    } @else if (documents().length === 0) {
      <div class="empty-state">
        <span class="empty-icon">üìÇ</span>
        <p>Ch∆∞a c√≥ t√†i li·ªáu n√†o</p>
        <button class="btn btn-outline" (click)="openUploadDialog()">
          T·∫£i l√™n t√†i li·ªáu ƒë·∫ßu ti√™n
        </button>
      </div>
    } @else {
      <table class="doc-table">
        <thead>
          <tr>
            <th>T√†i li·ªáu</th>
            <th>Lo·∫°i</th>
            <th>K√≠ch th∆∞·ªõc</th>
            <th>Tr·∫°ng th√°i</th>
            <th>K√Ω s·ªë</th>
            <th>Ng√†y t·∫°o</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          @for (doc of documents(); track doc.id) {
            <tr (click)="viewDocument(doc)" class="doc-row" [class.signed]="doc.isSigned">
              <td class="doc-name">
                <span class="doc-icon">{{ getDocTypeIcon(doc.documentType) }}</span>
                <div>
                  <span class="doc-title">{{ doc.title }}</span>
                  <span class="doc-filename">{{ doc.originalFileName }}</span>
                </div>
              </td>
              <td>
                <span class="badge type">{{ getDocTypeLabel(doc.documentType) }}</span>
              </td>
              <td>{{ formatSize(doc.fileSizeBytes) }}</td>
              <td>
                <span class="badge status" [class]="getStatusClass(doc.status)">{{
                  getStatusLabel(doc.status)
                }}</span>
              </td>
              <td>
                @if (doc.isSigned) {
                  <span class="signed-badge" title="ƒê√£ k√Ω b·ªüi {{ doc.signedByName }}">‚úì ƒê√£ k√Ω</span>
                } @else {
                  <span class="unsigned-badge">‚Äî</span>
                }
              </td>
              <td>{{ formatDate(doc.createdAt) }}</td>
              <td class="actions" (click)="$event.stopPropagation()">
                <button class="btn-icon" title="T·∫£i xu·ªëng" (click)="downloadDocument(doc)">
                  ‚¨á
                </button>
                @if (doc.isSigned) {
                  <button
                    class="btn-icon signed"
                    title="T·∫£i b·∫£n k√Ω s·ªë"
                    (click)="downloadDocument(doc, true)"
                  >
                    üîè
                  </button>
                }
                @if (!doc.isSigned && doc.contentType === 'application/pdf') {
                  <button class="btn-icon" title="K√Ω s·ªë" (click)="signDocument(doc)">‚úç</button>
                }
                <button class="btn-icon danger" title="X√≥a" (click)="deleteDocument(doc)">
                  üóë
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Pagination -->
      @if (totalPages > 1) {
        <div class="pagination">
          <button
            class="btn btn-sm"
            [disabled]="currentPage() === 1"
            (click)="onPageChange(currentPage() - 1)"
          >
            ‚Üê Tr∆∞·ªõc
          </button>
          <span class="page-info">Trang {{ currentPage() }} / {{ totalPages }}</span>
          <button
            class="btn btn-sm"
            [disabled]="currentPage() >= totalPages"
            (click)="onPageChange(currentPage() + 1)"
          >
            Sau ‚Üí
          </button>
        </div>
      }
    }
  </div>

  <!-- Detail Panel (Slide-in) -->
  @if (showDetailPanel() && selectedDocument()) {
    <div class="overlay" (click)="closeDetailPanel()"></div>
    <aside class="detail-panel">
      <div class="panel-header">
        <h2>Chi ti·∫øt t√†i li·ªáu</h2>
        <button class="btn-close" (click)="closeDetailPanel()">√ó</button>
      </div>
      <div class="panel-body">
        <div class="detail-section">
          <h3>{{ selectedDocument()!.title }}</h3>
          @if (selectedDocument()!.description) {
            <p class="description">{{ selectedDocument()!.description }}</p>
          }
        </div>

        <div class="detail-grid">
          <div class="detail-item">
            <label>Lo·∫°i</label>
            <span>{{ getDocTypeLabel(selectedDocument()!.documentType) }}</span>
          </div>
          <div class="detail-item">
            <label>Tr·∫°ng th√°i</label>
            <span class="badge status" [class]="getStatusClass(selectedDocument()!.status)">{{
              getStatusLabel(selectedDocument()!.status)
            }}</span>
          </div>
          <div class="detail-item">
            <label>File g·ªëc</label>
            <span>{{ selectedDocument()!.originalFileName }}</span>
          </div>
          <div class="detail-item">
            <label>K√≠ch th∆∞·ªõc</label>
            <span>{{ formatSize(selectedDocument()!.fileSizeBytes) }}</span>
          </div>
          <div class="detail-item">
            <label>M·ª©c b·∫£o m·∫≠t</label>
            <span>{{ getConfidentialityLabel(selectedDocument()!.confidentiality) }}</span>
          </div>
          <div class="detail-item">
            <label>Phi√™n b·∫£n</label>
            <span>v{{ selectedDocument()!.version }}</span>
          </div>
          <div class="detail-item">
            <label>Ng√†y t·∫°o</label>
            <span>{{ formatDate(selectedDocument()!.createdAt) }}</span>
          </div>
          @if (selectedDocument()!.checksum) {
            <div class="detail-item full-width">
              <label>SHA-256</label>
              <span class="checksum">{{ selectedDocument()!.checksum }}</span>
            </div>
          }
        </div>

        <!-- Signing Info -->
        @if (selectedDocument()!.isSigned) {
          <div class="detail-section signed-info">
            <h4>üîè Th√¥ng tin k√Ω s·ªë</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Ng∆∞·ªùi k√Ω</label>
                <span>{{ selectedDocument()!.signedByName }}</span>
              </div>
              <div class="detail-item">
                <label>Ng√†y k√Ω</label>
                <span>{{ formatDate(selectedDocument()!.signedAt) }}</span>
              </div>
            </div>
          </div>
        }

        <!-- Version History -->
        @if (versionHistory().length > 1) {
          <div class="detail-section">
            <h4>üìã L·ªãch s·ª≠ phi√™n b·∫£n</h4>
            <div class="version-list">
              @for (ver of versionHistory(); track ver.id) {
                <div class="version-item" [class.current]="ver.id === selectedDocument()!.id">
                  <span class="version-badge">v{{ ver.version }}</span>
                  <span class="version-name">{{ ver.originalFileName }}</span>
                  <span class="version-date">{{ formatDate(ver.createdAt) }}</span>
                  <span class="version-status badge status" [class]="getStatusClass(ver.status)">{{
                    getStatusLabel(ver.status)
                  }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Actions -->
        <div class="panel-actions">
          <button class="btn btn-primary" (click)="downloadDocument(selectedDocument()!)">
            ‚¨á T·∫£i xu·ªëng
          </button>
          @if (selectedDocument()!.isSigned) {
            <button class="btn btn-success" (click)="downloadDocument(selectedDocument()!, true)">
              üîè T·∫£i b·∫£n k√Ω s·ªë
            </button>
          }
          @if (
            !selectedDocument()!.isSigned && selectedDocument()!.contentType === 'application/pdf'
          ) {
            <button class="btn btn-warning" (click)="signDocument(selectedDocument()!)">
              ‚úç K√Ω s·ªë
            </button>
          }
          <button class="btn btn-danger" (click)="deleteDocument(selectedDocument()!)">
            üóë X√≥a
          </button>
        </div>
      </div>
    </aside>
  }

  <!-- Upload Dialog -->
  @if (showUploadDialog()) {
    <div class="overlay" (click)="closeUploadDialog()"></div>
    <div class="dialog upload-dialog">
      <div class="dialog-header">
        <h2>T·∫£i l√™n t√†i li·ªáu m·ªõi</h2>
        <button class="btn-close" (click)="closeUploadDialog()">√ó</button>
      </div>
      <div class="dialog-body">
        <!-- Drop zone -->
        <div class="drop-zone" (click)="fileInput.click()">
          @if (selectedFile()) {
            <span class="file-preview"
              >üìÑ {{ selectedFile()!.name }} ({{ formatSize(selectedFile()!.size) }})</span
            >
          } @else {
            <span class="drop-icon">‚òÅÔ∏è</span>
            <span>K√©o th·∫£ file ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn</span>
            <span class="drop-hint">H·ªó tr·ª£: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG (t·ªëi ƒëa 50MB)</span>
          }
          <input
            #fileInput
            type="file"
            hidden
            (change)="onFileSelected($event)"
            accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.csv,.txt,.dicom,.dcm"
          />
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Ti√™u ƒë·ªÅ *</label>
            <input
              type="text"
              [ngModel]="uploadTitle()"
              (ngModelChange)="uploadTitle.set($event)"
              placeholder="Nh·∫≠p ti√™u ƒë·ªÅ t√†i li·ªáu"
            />
          </div>

          <div class="form-group">
            <label>Lo·∫°i t√†i li·ªáu</label>
            <select [ngModel]="uploadDocType()" (ngModelChange)="uploadDocType.set($event)">
              @for (type of documentTypes(); track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>M√¥ t·∫£</label>
            <textarea
              [ngModel]="uploadDescription()"
              (ngModelChange)="uploadDescription.set($event)"
              rows="3"
              placeholder="M√¥ t·∫£ n·ªôi dung t√†i li·ªáu..."
            ></textarea>
          </div>

          <div class="form-group">
            <label>M·ª©c b·∫£o m·∫≠t</label>
            <select
              [ngModel]="uploadConfidentiality()"
              (ngModelChange)="uploadConfidentiality.set($event)"
            >
              <option value="Normal">B√¨nh th∆∞·ªùng</option>
              <option value="Restricted">H·∫°n ch·∫ø</option>
              <option value="VeryRestricted">R·∫•t h·∫°n ch·∫ø</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label>Tags (ph√¢n c√°ch b·ªüi d·∫•u ph·∫©y)</label>
            <input
              type="text"
              [ngModel]="uploadTags()"
              (ngModelChange)="uploadTags.set($event)"
              placeholder="x√©t nghi·ªám, k·∫øt qu·∫£, 2026"
            />
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="btn btn-outline" (click)="closeUploadDialog()">H·ªßy</button>
        <button
          class="btn btn-primary"
          (click)="uploadDocument()"
          [disabled]="!selectedFile() || uploading()"
        >
          @if (uploading()) {
            <span class="spinner"></span> ƒêang t·∫£i l√™n...
          } @else {
            üì§ T·∫£i l√™n
          }
        </button>
      </div>
    </div>
  }
</div>
