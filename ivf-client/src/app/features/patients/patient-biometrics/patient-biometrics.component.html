<div class="biometrics-container">
    <header class="page-header">
        <a [routerLink]="['/patients', patientId()]" class="back-link">â† Quay láº¡i há»“ sÆ¡</a>
        <h1>ğŸ“· Sinh tráº¯c há»c</h1>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn" [class.active]="activeTab() === 'photo'" (click)="setTab('photo')">
            ğŸ“¸ áº¢nh chÃ¢n dung
        </button>
        <button class="tab-btn" [class.active]="activeTab() === 'fingerprint'" (click)="setTab('fingerprint')">
            ğŸ‘† VÃ¢n tay
        </button>
    </nav>

    <!-- Photo Tab -->
    @if (activeTab() === 'photo') {
    <section class="card photo-section">
        <h2>áº¢nh chÃ¢n dung bá»‡nh nhÃ¢n</h2>

        <div class="photo-container">
            @if (hasPhoto()) {
            <div class="photo-preview">
                <img [src]="photoUrl()" alt="áº¢nh bá»‡nh nhÃ¢n" />
            </div>
            } @else {
            <div class="photo-placeholder">
                <span class="placeholder-icon">ğŸ‘¤</span>
                <p>ChÆ°a cÃ³ áº£nh</p>
            </div>
            }
        </div>

        <div class="photo-actions">
            <input type="file" #fileInput accept="image/*" (change)="onFileSelected($event)" hidden />
            <button class="btn btn-primary" (click)="openFileSelector()" [disabled]="uploading()">
                ğŸ“ Chá»n file
            </button>
            <button class="btn btn-secondary" (click)="openWebcam()" [disabled]="uploading()">
                ğŸ“· Chá»¥p webcam
            </button>
            @if (hasPhoto()) {
            <button class="btn btn-danger" (click)="deletePhoto()">
                ğŸ—‘ï¸ XÃ³a áº£nh
            </button>
            }
        </div>

        @if (uploading()) {
        <div class="loading-indicator">
            <span class="spinner"></span> Äang táº£i lÃªn...
        </div>
        }

        <!-- Webcam Modal -->
        @if (showWebcam()) {
        <div class="modal-overlay" (click)="closeWebcam()">
            <div class="modal-content webcam-modal" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h3>ğŸ“· Chá»¥p áº£nh tá»« webcam</h3>
                    <button class="close-btn" (click)="closeWebcam()">Ã—</button>
                </div>
                <div class="modal-body">
                    <video #videoElement autoplay playsinline></video>
                    <canvas #canvasElement hidden></canvas>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" (click)="closeWebcam()">Há»§y</button>
                    <button class="btn btn-primary" (click)="captureFromWebcam()">ğŸ“¸ Chá»¥p</button>
                </div>
            </div>
        </div>
        }
    </section>
    }

    <!-- Fingerprint Tab -->
    @if (activeTab() === 'fingerprint') {
    <section class="card fingerprint-section">
        <h2>ÄÄƒng kÃ½ vÃ¢n tay</h2>

        <!-- SDK Selection -->
        <div class="sdk-selector">
            <div class="mode-toggle">
                <label class="toggle-label">
                    <input type="checkbox" [checked]="useSignalR()" (change)="toggleSignalRMode()">
                    <span>DÃ¹ng á»©ng dá»¥ng Desktop (SignalR)</span>
                </label>
            </div>

            @if (!useSignalR()) {
            <label>Chá»n thiáº¿t bá»‹:</label>
            <div class="sdk-options">
                <button class="sdk-btn" [class.active]="selectedSdk() === 1" (click)="selectSdk(1)">
                    DigitalPersona
                </button>
                <button class="sdk-btn" [class.active]="selectedSdk() === 2" (click)="selectSdk(2)">
                    SecuGen
                </button>
            </div>
            }
            <div class="sdk-status" [class.ready]="sdkReady()">
                {{ sdkStatus() }}
            </div>
        </div>

        <!-- Finger Selection -->
        <div class="form-group finger-selector-wrapper">
            <label class="section-label">Chá»n ngÃ³n tay:</label>
            <app-hand-finger-selector [selected]="selectedFinger" [enrolledFingers]="enrolledFingerTypes"
                (fingerSelected)="selectedFinger.set($event)">
            </app-hand-finger-selector>

            <div class="selected-finger-label">
                Äang chá»n: <strong>{{ getFingerTypeName(selectedFinger().toString()) }}</strong>
            </div>
        </div>

        <!-- Capture Area -->
        <div class="capture-area">
            <div class="fingerprint-preview" [class.has-data]="capturedData()">
                @if (fingerprintPreview()) {
                <img [src]="fingerprintPreview()" alt="Fingerprint preview" class="fp-preview-img">
                } @else if (capturedData()) {
                <span class="fp-icon success">âœ…</span>
                <p>ÄÃ£ chá»¥p vÃ¢n tay</p>
                } @else {
                <span class="fp-icon">ğŸ‘†</span>
                <p>Äáº·t ngÃ³n tay lÃªn thiáº¿t bá»‹</p>
                }
            </div>

            @if (captureProgress()) {
            <div class="capture-progress">
                <span class="progress-text">{{ captureProgress() }}</span>
            </div>
            }

            <div class="capture-actions">
                @if (useSignalR() && sdkReady()) {
                <button class="btn btn-warning btn-lg" (click)="verifyFingerprint()" [disabled]="capturing()">
                    âš¡ XÃ¡c thá»±c nhanh
                </button>
                }

                <button class="btn btn-primary btn-lg" (click)="captureFingerprint()"
                    [disabled]="capturing() || !sdkReady()">
                    @if (capturing()) {
                    <span class="spinner"></span> Äang chá»¥p...
                    } @else {
                    ğŸ‘† Chá»¥p vÃ¢n tay
                    }
                </button>
                @if (capturing() && useSignalR()) {
                <button class="btn btn-secondary" (click)="cancelCapture()">
                    âŒ Há»§y
                </button>
                }
                @if (capturedData()) {
                <button class="btn btn-success" (click)="registerFingerprint()">
                    ğŸ’¾ LÆ°u vÃ¢n tay
                </button>
                }
            </div>
        </div>

        <!-- Registered Fingerprints -->
        <div class="registered-fingerprints">
            <h3>VÃ¢n tay Ä‘Ã£ Ä‘Äƒng kÃ½ ({{ fingerprints().length }})</h3>
            @if (fingerprints().length > 0) {
            <div class="fp-list">
                @for (fp of fingerprints(); track fp.id) {
                <div class="fp-item">
                    <span class="fp-icon small">ğŸ‘†</span>
                    <div class="fp-info">
                        <strong>{{ getFingerTypeName(fp.fingerType) }}</strong>
                        <span class="fp-meta">
                            {{ getSdkTypeName(fp.sdkType) }} â€¢ Cháº¥t lÆ°á»£ng: {{ fp.quality }}%
                        </span>
                    </div>
                    <button class="btn btn-sm btn-danger" (click)="deleteFingerprint(fp)">ğŸ—‘ï¸</button>
                </div>
                }
            </div>
            } @else {
            <p class="empty-state-text">ChÆ°a cÃ³ vÃ¢n tay nÃ o Ä‘Æ°á»£c Ä‘Äƒng kÃ½</p>
            }
        </div>
    </section>
    }
</div>