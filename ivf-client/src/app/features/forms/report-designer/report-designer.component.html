<div class="designer-container">
  @if (report) {
    <!-- ===== Top Toolbar ===== -->
    <header class="designer-toolbar">
      <div class="toolbar-left">
        <button class="btn btn-ghost btn-sm" (click)="goBack()">‚Üê Quay l·∫°i</button>
        <div class="toolbar-title">
          <h1>üé® Report Designer</h1>
          <span class="report-name">{{ report.name }}</span>
        </div>
      </div>

      <div class="toolbar-center">
        <div class="toolbar-history">
          <button
            class="btn btn-ghost btn-sm"
            (click)="undo()"
            [disabled]="!canUndo"
            title="Ho√†n t√°c (Ctrl+Z)"
          >
            ‚Ü©
          </button>
          <button
            class="btn btn-ghost btn-sm"
            (click)="redo()"
            [disabled]="!canRedo"
            title="L√†m l·∫°i (Ctrl+Y)"
          >
            ‚Ü™
          </button>
        </div>

        <!-- Snap-to-grid & grid toggles -->
        <div class="toolbar-snap">
          <button
            class="btn btn-ghost btn-sm"
            [class.active]="snapToGrid"
            (click)="toggleSnapToGrid()"
            title="B·∫Øt l∆∞·ªõi (Snap to Grid)"
          >
            ‚äû
          </button>
          <button
            class="btn btn-ghost btn-sm"
            [class.active]="showGrid"
            (click)="toggleShowGrid()"
            title="Hi·ªán l∆∞·ªõi"
          >
            ‚äü
          </button>
          <button
            class="btn btn-ghost btn-sm"
            [class.active]="showRulers"
            (click)="toggleRulers()"
            title="Th∆∞·ªõc k·∫ª (Rulers)"
          >
            üìè
          </button>
        </div>

        <!-- Zoom controls -->
        <div class="toolbar-zoom">
          <button class="btn btn-ghost btn-sm" (click)="zoomOut()" title="Thu nh·ªè">‚àí</button>
          <span class="zoom-label" (click)="resetZoom()" title="Reset zoom">{{ zoomLevel }}%</span>
          <button class="btn btn-ghost btn-sm" (click)="zoomIn()" title="Ph√≥ng to">+</button>
        </div>

        <button
          class="btn btn-ghost btn-sm mode-btn"
          [class.active]="mode === 'design'"
          (click)="mode = 'design'"
        >
          üñäÔ∏è DESIGN
        </button>
        <button
          class="btn btn-ghost btn-sm mode-btn"
          [class.active]="mode === 'preview'"
          (click)="toggleMode()"
        >
          üëÅÔ∏è PREVIEW
        </button>
      </div>

      <div class="toolbar-right">
        @if (isDirty) {
          <span class="tag tag-red">‚óè Ch∆∞a l∆∞u</span>
        }
        <button class="btn btn-secondary btn-sm" (click)="exportPdf()">üìÑ PDF</button>
        <button class="btn btn-secondary btn-sm" (click)="save()" [disabled]="isSaving || !isDirty">
          üíæ L∆∞u
        </button>
        <button class="btn btn-primary btn-sm" (click)="saveAndPreview()" [disabled]="isSaving">
          ‚ñ∂Ô∏è L∆∞u & Xem
        </button>
      </div>
    </header>

    <!-- ===== Multi-tab bar (Phase 3) ===== -->
    @if (design.tabs?.length) {
      <div class="tab-bar">
        <button
          class="btn btn-ghost btn-sm tab-item"
          [class.active]="!activeTabId"
          (click)="selectTab(null)"
        >
          üìã Ch√≠nh
        </button>
        @for (tab of design.tabs; track tab.id; let i = $index) {
          <button
            class="btn btn-ghost btn-sm tab-item"
            [class.active]="activeTabId === tab.id"
            (click)="selectTab(tab.id)"
          >
            {{ tab.name }}
            <span class="tab-close" (click)="removeTab(i); $event.stopPropagation()">‚úï</span>
          </button>
        }
        <button class="btn btn-ghost btn-sm" (click)="addTab()">+ Tab</button>
      </div>
    }

    <div class="designer-body">
      <!-- ===== LEFT: Side Panel ===== -->
      <aside class="side-panel" [class.collapsed]="sidePanelCollapsed">
        <!-- Side panel tabs -->
        <div class="side-tabs">
          <button
            class="side-tab"
            [class.active]="sidePanel === 'toolbox'"
            (click)="sidePanel = 'toolbox'"
            title="C√¥ng c·ª•"
          >
            üß∞
          </button>
          <button
            class="side-tab"
            [class.active]="sidePanel === 'properties'"
            (click)="sidePanel = 'properties'"
            title="Thu·ªôc t√≠nh"
          >
            ‚öôÔ∏è
          </button>
          <button
            class="side-tab"
            [class.active]="sidePanel === 'explorer'"
            (click)="sidePanel = 'explorer'"
            title="Report Explorer"
          >
            üóÇÔ∏è
          </button>
          <button
            class="side-tab"
            [class.active]="sidePanel === 'data'"
            (click)="sidePanel = 'data'"
            title="D·ªØ li·ªáu"
          >
            üìä
          </button>
          <button
            class="side-tab"
            [class.active]="sidePanel === 'parameters'"
            (click)="sidePanel = 'parameters'"
            title="Tham s·ªë"
          >
            üîß
          </button>
          <button
            class="side-tab"
            [class.active]="sidePanel === 'templates'"
            (click)="sidePanel = 'templates'"
            title="M·∫´u"
          >
            üìö
          </button>
          <button
            class="side-tab"
            [class.active]="sidePanel === 'tabs'"
            (click)="sidePanel = 'tabs'"
            title="Tab"
          >
            üìë
          </button>
          <button
            class="side-tab"
            [class.active]="sidePanel === 'crosstab'"
            (click)="sidePanel = 'crosstab'"
            title="Cross-tab"
          >
            üìê
          </button>
        </div>

        <div class="side-content">
          <!-- ===== TOOLBOX PANEL ===== -->
          @if (sidePanel === 'toolbox') {
            <div class="panel-section">
              <h3>üß∞ C√¥ng c·ª•</h3>
              <div class="toolbox-grid">
                @for (item of TOOLBOX_ITEMS; track item.type) {
                  <div
                    class="toolbox-item"
                    draggable="true"
                    (dragstart)="
                      $event.dataTransfer?.setData('toolboxType', item.type);
                      onToolboxDragStart(item)
                    "
                    (dragend)="onToolboxDragEnd()"
                    (dblclick)="selectedBandId ? addControlToBand(selectedBandId, item) : null"
                  >
                    <span class="toolbox-icon">{{ item.icon }}</span>
                    <span class="toolbox-label">{{ item.label }}</span>
                  </div>
                }
              </div>

              <h4>Th√™m band</h4>
              <div class="band-add-btns">
                @for (bt of getAvailableBandTypes(); track bt) {
                  <button class="btn btn-tertiary btn-sm" (click)="addBand(bt)">
                    + {{ getBandLabel(bt) }}
                  </button>
                }
              </div>
            </div>
          }

          <!-- ===== PROPERTIES PANEL ===== -->
          @if (sidePanel === 'properties') {
            <div class="panel-section">
              @if (selectedControl) {
                <!-- Property Grid Header -->
                <div class="pgrid-header">
                  <span class="pgrid-header-icon">{{ getControlIcon(selectedControl.type) }}</span>
                  <span class="pgrid-header-name">{{ selectedControl.type }}</span>
                  <span class="pgrid-header-id">{{ selectedControl.id }}</span>
                </div>

                <!-- ‚îÄ‚îÄ General Section ‚îÄ‚îÄ -->
                <div class="pgrid-section" [class.collapsed]="propSections['general']">
                  <div
                    class="pgrid-section-header"
                    (click)="propSections['general'] = !propSections['general']"
                  >
                    <span class="pgrid-arrow">{{ propSections['general'] ? '‚ñ∂' : '‚ñº' }}</span>
                    Chung
                  </div>
                  @if (!propSections['general']) {
                    <div class="pgrid-row">
                      <div class="pgrid-label">Lo·∫°i</div>
                      <div class="pgrid-value">
                        <input
                          type="text"
                          [value]="selectedControl.type"
                          disabled
                          class="pgrid-input"
                        />
                      </div>
                    </div>

                    @if (selectedControl.type === 'label' || selectedControl.type === 'richText') {
                      <div class="pgrid-row pgrid-row-tall">
                        <div class="pgrid-label">N·ªôi dung</div>
                        <div class="pgrid-value">
                          <textarea
                            [(ngModel)]="selectedControl.text"
                            (ngModelChange)="markDirty()"
                            class="pgrid-textarea"
                            rows="3"
                          ></textarea>
                        </div>
                      </div>
                    }

                    @if (selectedControl.type === 'field') {
                      <div class="pgrid-row">
                        <div class="pgrid-label">Tr∆∞·ªùng</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.dataField"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            @for (f of dataFieldOptions; track f.key) {
                              <option [value]="f.key">{{ f.label }}</option>
                            }
                          </select>
                        </div>
                      </div>
                    }

                    @if (selectedControl.type === 'expression') {
                      <div class="pgrid-row">
                        <div class="pgrid-label">Bi·ªÉu th·ª©c</div>
                        <div class="pgrid-value pgrid-value-btn">
                          <input
                            type="text"
                            [(ngModel)]="selectedControl.expression"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                          />
                          <button
                            class="pgrid-fx"
                            (click)="openExpressionEditor(selectedControl.expression ?? '')"
                          >
                            fx
                          </button>
                        </div>
                      </div>
                    }

                    @if (selectedControl.type === 'image') {
                      <div class="pgrid-row">
                        <div class="pgrid-label">URL ·∫£nh</div>
                        <div class="pgrid-value">
                          <input
                            type="text"
                            [(ngModel)]="selectedControl.imageUrl"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                            placeholder="https://..."
                          />
                        </div>
                      </div>
                    }

                    @if (selectedControl.type === 'shape') {
                      <div class="pgrid-row">
                        <div class="pgrid-label">H√¨nh</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.shapeType"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            <option value="rectangle">Ch·ªØ nh·∫≠t</option>
                            <option value="ellipse">Elip</option>
                            <option value="triangle">Tam gi√°c</option>
                          </select>
                        </div>
                      </div>
                    }

                    @if (selectedControl.type === 'barcode') {
                      <div class="pgrid-row">
                        <div class="pgrid-label">Barcode</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.barcodeType"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            <option value="qr">QR Code</option>
                            <option value="code128">Code 128</option>
                            <option value="ean13">EAN-13</option>
                          </select>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">Gi√° tr·ªã</div>
                        <div class="pgrid-value">
                          <input
                            type="text"
                            [(ngModel)]="selectedControl.barcodeValue"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                          />
                        </div>
                      </div>
                    }

                    @if (selectedControl.type === 'signatureZone') {
                      <div class="pgrid-row">
                        <div class="pgrid-label">Vai tr√≤ k√Ω</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.signatureRole"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            <option value="current_user">Ng∆∞·ªùi k√Ω hi·ªán t·∫°i</option>
                            <option value="technician">K·ªπ thu·∫≠t vi√™n</option>
                            <option value="department_head">Tr∆∞·ªüng khoa</option>
                            <option value="doctor">B√°c sƒ© ch·ªâ ƒë·ªãnh</option>
                            <option value="director">Gi√°m ƒë·ªëc</option>
                          </select>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">Ti√™u ƒë·ªÅ</div>
                        <div class="pgrid-value">
                          <input
                            type="text"
                            [(ngModel)]="selectedControl.text"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                            placeholder="VD: K·ª∏ THU·∫¨T VI√äN"
                          />
                        </div>
                      </div>
                    }

                    @if (
                      selectedControl.format !== undefined ||
                      selectedControl.type === 'field' ||
                      selectedControl.type === 'currentDate'
                    ) {
                      <div class="pgrid-row">
                        <div class="pgrid-label">ƒê·ªãnh d·∫°ng</div>
                        <div class="pgrid-value">
                          <input
                            type="text"
                            [(ngModel)]="selectedControl.format"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                            placeholder="dd/MM/yyyy"
                          />
                        </div>
                      </div>
                    }
                  }
                </div>

                <!-- ‚îÄ‚îÄ Layout Section ‚îÄ‚îÄ -->
                <div class="pgrid-section" [class.collapsed]="propSections['layout']">
                  <div
                    class="pgrid-section-header"
                    (click)="propSections['layout'] = !propSections['layout']"
                  >
                    <span class="pgrid-arrow">{{ propSections['layout'] ? '‚ñ∂' : '‚ñº' }}</span>
                    V·ªã tr√≠ & K√≠ch th∆∞·ªõc
                  </div>
                  @if (!propSections['layout']) {
                    <div class="pgrid-row">
                      <div class="pgrid-label">X</div>
                      <div class="pgrid-value">
                        <input
                          type="number"
                          [(ngModel)]="selectedControl.x"
                          (ngModelChange)="markDirty()"
                          class="pgrid-input"
                        />
                      </div>
                    </div>
                    <div class="pgrid-row">
                      <div class="pgrid-label">Y</div>
                      <div class="pgrid-value">
                        <input
                          type="number"
                          [(ngModel)]="selectedControl.y"
                          (ngModelChange)="markDirty()"
                          class="pgrid-input"
                        />
                      </div>
                    </div>
                    <div class="pgrid-row">
                      <div class="pgrid-label">R·ªông</div>
                      <div class="pgrid-value">
                        <input
                          type="number"
                          [(ngModel)]="selectedControl.width"
                          (ngModelChange)="markDirty()"
                          class="pgrid-input"
                        />
                      </div>
                    </div>
                    <div class="pgrid-row">
                      <div class="pgrid-label">Cao</div>
                      <div class="pgrid-value">
                        <input
                          type="number"
                          [(ngModel)]="selectedControl.height"
                          (ngModelChange)="markDirty()"
                          class="pgrid-input"
                        />
                      </div>
                    </div>
                  }
                </div>

                <!-- ‚îÄ‚îÄ Style Section ‚îÄ‚îÄ -->
                @if (selectedControl.style) {
                  <div class="pgrid-section" [class.collapsed]="propSections['style']">
                    <div
                      class="pgrid-section-header"
                      (click)="propSections['style'] = !propSections['style']"
                    >
                      <span class="pgrid-arrow">{{ propSections['style'] ? '‚ñ∂' : '‚ñº' }}</span>
                      Ki·ªÉu d√°ng
                    </div>
                    @if (!propSections['style']) {
                      <div class="pgrid-row">
                        <div class="pgrid-label">C·ª° ch·ªØ</div>
                        <div class="pgrid-value">
                          <input
                            type="number"
                            [(ngModel)]="selectedControl.style.fontSize"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                            min="6"
                            max="72"
                          />
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">Font</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.style.fontFamily"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            <option value="">M·∫∑c ƒë·ªãnh</option>
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Roboto">Roboto</option>
                          </select>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">ƒê·∫≠m</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.style.fontWeight"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            <option value="normal">Th∆∞·ªùng</option>
                            <option value="bold">ƒê·∫≠m</option>
                          </select>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">Nghi√™ng</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.style.fontStyle"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            <option value="normal">Th∆∞·ªùng</option>
                            <option value="italic">Nghi√™ng</option>
                          </select>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">CƒÉn ch·ªânh</div>
                        <div class="pgrid-value">
                          <div class="pgrid-align-btns">
                            <button
                              class="pgrid-align"
                              [class.active]="selectedControl.style.textAlign === 'left'"
                              (click)="selectedControl.style.textAlign = 'left'; markDirty()"
                            >
                              ‚¨Ö
                            </button>
                            <button
                              class="pgrid-align"
                              [class.active]="selectedControl.style.textAlign === 'center'"
                              (click)="selectedControl.style.textAlign = 'center'; markDirty()"
                            >
                              ‚â°
                            </button>
                            <button
                              class="pgrid-align"
                              [class.active]="selectedControl.style.textAlign === 'right'"
                              (click)="selectedControl.style.textAlign = 'right'; markDirty()"
                            >
                              ‚û°
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">M√†u ch·ªØ</div>
                        <div class="pgrid-value pgrid-value-color">
                          <input
                            type="color"
                            [ngModel]="selectedControl.style.color || '#000000'"
                            (ngModelChange)="selectedControl.style.color = $event; markDirty()"
                            class="pgrid-color"
                          />
                          <span class="pgrid-color-hex">{{
                            selectedControl.style.color || '#000000'
                          }}</span>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">M√†u n·ªÅn</div>
                        <div class="pgrid-value pgrid-value-color">
                          <input
                            type="color"
                            [ngModel]="selectedControl.style.backgroundColor || '#ffffff'"
                            (ngModelChange)="
                              selectedControl.style.backgroundColor = $event; markDirty()
                            "
                            class="pgrid-color"
                          />
                          <span class="pgrid-color-hex">{{
                            selectedControl.style.backgroundColor || '#ffffff'
                          }}</span>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">Vi·ªÅn</div>
                        <div class="pgrid-value">
                          <select
                            [(ngModel)]="selectedControl.style.borderStyle"
                            (ngModelChange)="markDirty()"
                            class="pgrid-select"
                          >
                            <option value="none">Kh√¥ng</option>
                            <option value="solid">Li·ªÅn</option>
                            <option value="dashed">N√©t ƒë·ª©t</option>
                            <option value="dotted">Ch·∫•m</option>
                          </select>
                        </div>
                      </div>
                      <div class="pgrid-row">
                        <div class="pgrid-label">N√©t vi·ªÅn</div>
                        <div class="pgrid-value">
                          <input
                            type="number"
                            [(ngModel)]="selectedControl.style.borderWidth"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                            min="0"
                            max="10"
                          />
                        </div>
                      </div>
                      @if (
                        selectedControl.style.borderStyle &&
                        selectedControl.style.borderStyle !== 'none'
                      ) {
                        <div class="pgrid-row">
                          <div class="pgrid-label">M√†u vi·ªÅn</div>
                          <div class="pgrid-value pgrid-value-color">
                            <input
                              type="color"
                              [ngModel]="selectedControl.style.borderColor || '#000000'"
                              (ngModelChange)="
                                selectedControl.style.borderColor = $event; markDirty()
                              "
                              class="pgrid-color"
                            />
                            <span class="pgrid-color-hex">{{
                              selectedControl.style.borderColor || '#000000'
                            }}</span>
                          </div>
                        </div>
                      }
                      <div class="pgrid-row">
                        <div class="pgrid-label">Padding</div>
                        <div class="pgrid-value">
                          <input
                            type="number"
                            [(ngModel)]="selectedControl.style.padding"
                            (ngModelChange)="markDirty()"
                            class="pgrid-input"
                            min="0"
                            max="40"
                          />
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- ‚îÄ‚îÄ Actions ‚îÄ‚îÄ -->
                <div class="pgrid-actions">
                  <button
                    class="btn btn-secondary btn-sm"
                    (click)="duplicateControl(selectedControl.id)"
                  >
                    üìã Nh√¢n b·∫£n
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="removeControl(selectedControl.id)">
                    üóëÔ∏è X√≥a
                  </button>
                </div>

                <!-- ‚îÄ‚îÄ Layout Section (DevExpress-style) ‚îÄ‚îÄ -->
                <div class="pgrid-section" [class.collapsed]="propSections['layoutOps']">
                  <div
                    class="pgrid-section-header"
                    (click)="propSections['layoutOps'] = !propSections['layoutOps']"
                  >
                    <span class="pgrid-arrow">{{ propSections['layoutOps'] ? '‚ñ∂' : '‚ñº' }}</span>
                    Layout
                  </div>
                  @if (!propSections['layoutOps']) {
                    <div class="pgrid-layout-toolbar">
                      <div class="layout-group">
                        <span class="layout-group-label">Alignment</span>
                        <div class="layout-btn-row">
                          <button
                            class="layout-btn"
                            (click)="alignLeft()"
                            [disabled]="!hasMultipleSelected"
                            title="CƒÉn tr√°i (Align Left)"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <line
                                x1="2"
                                y1="1"
                                x2="2"
                                y2="15"
                                stroke="currentColor"
                                stroke-width="1.5"
                              />
                              <rect
                                x="4"
                                y="3"
                                width="10"
                                height="3"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect x="4" y="9" width="6" height="3" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                          <button
                            class="layout-btn"
                            (click)="alignCenter()"
                            [disabled]="!hasMultipleSelected"
                            title="CƒÉn gi·ªØa ngang (Align Center)"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <line
                                x1="8"
                                y1="1"
                                x2="8"
                                y2="15"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-dasharray="2,1"
                              />
                              <rect
                                x="3"
                                y="3"
                                width="10"
                                height="3"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect x="5" y="9" width="6" height="3" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                          <button
                            class="layout-btn"
                            (click)="alignRight()"
                            [disabled]="!hasMultipleSelected"
                            title="CƒÉn ph·∫£i (Align Right)"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <line
                                x1="14"
                                y1="1"
                                x2="14"
                                y2="15"
                                stroke="currentColor"
                                stroke-width="1.5"
                              />
                              <rect
                                x="2"
                                y="3"
                                width="10"
                                height="3"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect x="6" y="9" width="6" height="3" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                          <button
                            class="layout-btn"
                            (click)="alignTop()"
                            [disabled]="!hasMultipleSelected"
                            title="CƒÉn tr√™n (Align Top)"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <line
                                x1="1"
                                y1="2"
                                x2="15"
                                y2="2"
                                stroke="currentColor"
                                stroke-width="1.5"
                              />
                              <rect
                                x="3"
                                y="4"
                                width="3"
                                height="10"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect x="9" y="4" width="3" height="6" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                          <button
                            class="layout-btn"
                            (click)="alignMiddle()"
                            [disabled]="!hasMultipleSelected"
                            title="CƒÉn gi·ªØa d·ªçc (Align Middle)"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <line
                                x1="1"
                                y1="8"
                                x2="15"
                                y2="8"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-dasharray="2,1"
                              />
                              <rect
                                x="3"
                                y="3"
                                width="3"
                                height="10"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect x="9" y="5" width="3" height="6" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                          <button
                            class="layout-btn"
                            (click)="alignBottom()"
                            [disabled]="!hasMultipleSelected"
                            title="CƒÉn d∆∞·ªõi (Align Bottom)"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <line
                                x1="1"
                                y1="14"
                                x2="15"
                                y2="14"
                                stroke="currentColor"
                                stroke-width="1.5"
                              />
                              <rect
                                x="3"
                                y="2"
                                width="3"
                                height="10"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect x="9" y="6" width="3" height="6" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                        </div>
                      </div>
                      <div class="layout-group">
                        <span class="layout-group-label">Distribute</span>
                        <div class="layout-btn-row">
                          <button
                            class="layout-btn"
                            (click)="distributeHorizontal()"
                            [disabled]="selectedControlIds.size < 3"
                            title="Ph√¢n b·ªë ƒë·ªÅu ngang"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <rect x="1" y="4" width="3" height="8" fill="currentColor" rx="0.5" />
                              <rect
                                x="6.5"
                                y="4"
                                width="3"
                                height="8"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect
                                x="12"
                                y="4"
                                width="3"
                                height="8"
                                fill="currentColor"
                                rx="0.5"
                              />
                            </svg>
                          </button>
                          <button
                            class="layout-btn"
                            (click)="distributeVertical()"
                            [disabled]="selectedControlIds.size < 3"
                            title="Ph√¢n b·ªë ƒë·ªÅu d·ªçc"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <rect x="4" y="1" width="8" height="3" fill="currentColor" rx="0.5" />
                              <rect
                                x="4"
                                y="6.5"
                                width="8"
                                height="3"
                                fill="currentColor"
                                rx="0.5"
                              />
                              <rect
                                x="4"
                                y="12"
                                width="8"
                                height="3"
                                fill="currentColor"
                                rx="0.5"
                              />
                            </svg>
                          </button>
                        </div>
                      </div>
                      <div class="layout-group">
                        <span class="layout-group-label">K√≠ch th∆∞·ªõc</span>
                        <div class="layout-btn-row">
                          <button
                            class="layout-btn layout-btn-text"
                            (click)="makeSameWidth()"
                            [disabled]="!hasMultipleSelected"
                            title="C√πng r·ªông"
                          >
                            W=
                          </button>
                          <button
                            class="layout-btn layout-btn-text"
                            (click)="makeSameHeight()"
                            [disabled]="!hasMultipleSelected"
                            title="C√πng cao"
                          >
                            H=
                          </button>
                          <button
                            class="layout-btn layout-btn-text"
                            (click)="makeSameSize()"
                            [disabled]="!hasMultipleSelected"
                            title="C√πng k√≠ch th∆∞·ªõc"
                          >
                            WH=
                          </button>
                        </div>
                      </div>
                      <div class="layout-group">
                        <span class="layout-group-label">Center in band</span>
                        <div class="layout-btn-row">
                          <button
                            class="layout-btn"
                            (click)="centerInBandHorizontal()"
                            title="Gi·ªØa ngang trong band"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <rect
                                x="1"
                                y="1"
                                width="14"
                                height="14"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1"
                                rx="1"
                              />
                              <rect x="5" y="6" width="6" height="4" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                          <button
                            class="layout-btn"
                            (click)="centerInBandVertical()"
                            title="Gi·ªØa d·ªçc trong band"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16">
                              <rect
                                x="1"
                                y="1"
                                width="14"
                                height="14"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1"
                                rx="1"
                              />
                              <rect x="6" y="4" width="4" height="8" fill="currentColor" rx="0.5" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  }
                </div>

                <!-- ‚îÄ‚îÄ Arrangement Section ‚îÄ‚îÄ -->
                <div class="pgrid-section" [class.collapsed]="propSections['arrangement']">
                  <div
                    class="pgrid-section-header"
                    (click)="propSections['arrangement'] = !propSections['arrangement']"
                  >
                    <span class="pgrid-arrow">{{ propSections['arrangement'] ? '‚ñ∂' : '‚ñº' }}</span>
                    Arrangement
                  </div>
                  @if (!propSections['arrangement']) {
                    <div class="pgrid-layout-toolbar">
                      <div class="layout-btn-row">
                        <button
                          class="layout-btn"
                          (click)="bringToFront()"
                          title="ƒê∆∞a l√™n tr√™n c√πng (Bring to Front)"
                        >
                          <svg width="16" height="16" viewBox="0 0 16 16">
                            <rect
                              x="1"
                              y="6"
                              width="8"
                              height="8"
                              fill="#ccc"
                              stroke="#999"
                              stroke-width="0.5"
                              rx="0.5"
                            />
                            <rect
                              x="5"
                              y="2"
                              width="8"
                              height="8"
                              fill="currentColor"
                              stroke="currentColor"
                              stroke-width="0.5"
                              rx="0.5"
                            />
                          </svg>
                        </button>
                        <button
                          class="layout-btn"
                          (click)="sendToBack()"
                          title="ƒê∆∞a xu·ªëng d∆∞·ªõi c√πng (Send to Back)"
                        >
                          <svg width="16" height="16" viewBox="0 0 16 16">
                            <rect
                              x="5"
                              y="2"
                              width="8"
                              height="8"
                              fill="#ccc"
                              stroke="#999"
                              stroke-width="0.5"
                              rx="0.5"
                            />
                            <rect
                              x="1"
                              y="6"
                              width="8"
                              height="8"
                              fill="currentColor"
                              stroke="currentColor"
                              stroke-width="0.5"
                              rx="0.5"
                            />
                          </svg>
                        </button>
                        <button
                          class="layout-btn"
                          (click)="bringForward()"
                          [disabled]="hasMultipleSelected"
                          title="ƒê∆∞a l√™n 1 l·ªõp"
                        >
                          ‚Üë
                        </button>
                        <button
                          class="layout-btn"
                          (click)="sendBackward()"
                          [disabled]="hasMultipleSelected"
                          title="ƒê∆∞a xu·ªëng 1 l·ªõp"
                        >
                          ‚Üì
                        </button>
                      </div>
                    </div>
                  }
                </div>
              } @else if (selectedBand) {
                <!-- Band Properties Grid -->
                <div class="pgrid-header">
                  <span class="pgrid-header-icon">üìê</span>
                  <span class="pgrid-header-name">{{ getBandLabel(selectedBand.type) }}</span>
                </div>
                <div class="pgrid-section">
                  <div class="pgrid-section-header">
                    <span class="pgrid-arrow">‚ñº</span>
                    Thu·ªôc t√≠nh band
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Lo·∫°i</div>
                    <div class="pgrid-value">
                      <input
                        type="text"
                        [value]="getBandLabel(selectedBand.type)"
                        disabled
                        class="pgrid-input"
                      />
                    </div>
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Cao (px)</div>
                    <div class="pgrid-value">
                      <input
                        type="number"
                        [(ngModel)]="selectedBand.height"
                        (ngModelChange)="markDirty()"
                        class="pgrid-input"
                        min="20"
                        max="800"
                      />
                    </div>
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Hi·ªÉn th·ªã</div>
                    <div class="pgrid-value pgrid-value-check">
                      <input
                        type="checkbox"
                        [(ngModel)]="selectedBand.visible"
                        (ngModelChange)="markDirty()"
                      />
                    </div>
                  </div>
                  @if (selectedBand.type === 'groupHeader' || selectedBand.type === 'groupFooter') {
                    <div class="pgrid-row">
                      <div class="pgrid-label">Nh√≥m theo</div>
                      <div class="pgrid-value">
                        <select
                          [(ngModel)]="selectedBand.groupField"
                          (ngModelChange)="markDirty()"
                          class="pgrid-select"
                        >
                          <option value="">-- Ch·ªçn --</option>
                          @for (f of dataFieldOptions; track f.key) {
                            <option [value]="f.key">{{ f.label }}</option>
                          }
                        </select>
                      </div>
                    </div>
                  }
                  <div class="pgrid-row">
                    <div class="pgrid-label">M√†u n·ªÅn</div>
                    <div class="pgrid-value pgrid-value-color">
                      <input
                        type="color"
                        [ngModel]="selectedBand.backgroundColor || '#ffffff'"
                        (ngModelChange)="selectedBand.backgroundColor = $event; markDirty()"
                        class="pgrid-color"
                      />
                      <span class="pgrid-color-hex">{{
                        selectedBand.backgroundColor || 'none'
                      }}</span>
                    </div>
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Gi·ªØ trang</div>
                    <div class="pgrid-value pgrid-value-check">
                      <input
                        type="checkbox"
                        [(ngModel)]="selectedBand.keepTogether"
                        (ngModelChange)="markDirty()"
                      />
                    </div>
                  </div>
                  @if (selectedBand.type === 'pageHeader' || selectedBand.type === 'pageFooter') {
                    <div class="pgrid-row">
                      <div class="pgrid-label">L·∫∑p trang</div>
                      <div class="pgrid-value pgrid-value-check">
                        <input
                          type="checkbox"
                          [(ngModel)]="selectedBand.repeatOnEveryPage"
                          (ngModelChange)="markDirty()"
                        />
                      </div>
                    </div>
                  }
                </div>
                <div class="pgrid-actions">
                  <button class="btn btn-secondary btn-sm" (click)="addSubReport(selectedBand.id)">
                    üìé Sub-report
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="removeBand(selectedBand.id)">
                    üóëÔ∏è X√≥a band
                  </button>
                </div>
              } @else {
                <!-- Page Settings Grid -->
                <div class="pgrid-header">
                  <span class="pgrid-header-icon">üìÑ</span>
                  <span class="pgrid-header-name">C√†i ƒë·∫∑t trang</span>
                </div>
                <div class="pgrid-section">
                  <div class="pgrid-section-header">
                    <span class="pgrid-arrow">‚ñº</span>
                    Trang
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Kh·ªï gi·∫•y</div>
                    <div class="pgrid-value">
                      <select
                        [(ngModel)]="design.pageSettings.size"
                        (ngModelChange)="markDirty()"
                        class="pgrid-select"
                      >
                        <option value="A4">A4</option>
                        <option value="A5">A5</option>
                        <option value="Letter">Letter</option>
                      </select>
                    </div>
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">H∆∞·ªõng</div>
                    <div class="pgrid-value">
                      <select
                        [(ngModel)]="design.pageSettings.orientation"
                        (ngModelChange)="markDirty()"
                        class="pgrid-select"
                      >
                        <option value="portrait">D·ªçc</option>
                        <option value="landscape">Ngang</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="pgrid-section">
                  <div class="pgrid-section-header">
                    <span class="pgrid-arrow">‚ñº</span>
                    L·ªÅ (pt)
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Tr√™n</div>
                    <div class="pgrid-value">
                      <input
                        type="number"
                        [(ngModel)]="design.pageSettings.margins.top"
                        (ngModelChange)="markDirty()"
                        class="pgrid-input"
                      />
                    </div>
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">D∆∞·ªõi</div>
                    <div class="pgrid-value">
                      <input
                        type="number"
                        [(ngModel)]="design.pageSettings.margins.bottom"
                        (ngModelChange)="markDirty()"
                        class="pgrid-input"
                      />
                    </div>
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Tr√°i</div>
                    <div class="pgrid-value">
                      <input
                        type="number"
                        [(ngModel)]="design.pageSettings.margins.left"
                        (ngModelChange)="markDirty()"
                        class="pgrid-input"
                      />
                    </div>
                  </div>
                  <div class="pgrid-row">
                    <div class="pgrid-label">Ph·∫£i</div>
                    <div class="pgrid-value">
                      <input
                        type="number"
                        [(ngModel)]="design.pageSettings.margins.right"
                        (ngModelChange)="markDirty()"
                        class="pgrid-input"
                      />
                    </div>
                  </div>
                </div>
              }
            </div>
          }

          <!-- ===== DATA SOURCE PANEL ===== -->
          @if (sidePanel === 'data') {
            <div class="panel-section">
              <h3>üìä Tr∆∞·ªùng d·ªØ li·ªáu</h3>
              <p class="hint-text">K√©o tr∆∞·ªùng v√†o band ho·∫∑c double-click ƒë·ªÉ th√™m</p>
              <div class="data-fields-list">
                @for (f of dataFieldOptions; track f.key) {
                  <div
                    class="data-field-item"
                    draggable="true"
                    (dragstart)="
                      $event.dataTransfer?.setData('toolboxType', 'field');
                      $event.dataTransfer?.setData('dataField', f.key)
                    "
                    (dblclick)="
                      selectedBandId
                        ? addControlToBand(selectedBandId, {
                            type: 'field',
                            icon: 'üìä',
                            label: f.label,
                            defaultWidth: 150,
                            defaultHeight: 24,
                          })
                        : null
                    "
                  >
                    <span class="df-icon">üìä</span>
                    <span class="df-name">{{ f.label }}</span>
                    <span class="df-key">{{ f.key }}</span>
                  </div>
                }
              </div>

              @if (design.subReports?.length) {
                <h4>üìé Sub-reports</h4>
                @for (sr of design.subReports; track sr.id; let i = $index) {
                  <div class="sub-report-item">
                    <input
                      type="text"
                      [(ngModel)]="sr.name"
                      (ngModelChange)="markDirty()"
                      class="prop-input"
                    />
                    <button class="btn btn-danger-ghost btn-sm" (click)="removeSubReport(i)">
                      ‚úï
                    </button>
                  </div>
                }
              }
            </div>
          }

          <!-- ===== PARAMETERS PANEL (Phase 3) ===== -->
          @if (sidePanel === 'parameters') {
            <div class="panel-section">
              <h3>üîß Tham s·ªë b√°o c√°o</h3>
              <button class="btn btn-primary btn-sm" (click)="addParameter()">
                + Th√™m tham s·ªë
              </button>

              @if (!design.parameters.length) {
                <p class="hint-text">Tham s·ªë cho ph√©p ng∆∞·ªùi d√πng nh·∫≠p gi√° tr·ªã khi xem b√°o c√°o.</p>
              }

              @for (param of design.parameters; track param.name; let i = $index) {
                <div class="param-card">
                  <div class="param-header">
                    <input
                      type="text"
                      [(ngModel)]="param.name"
                      (ngModelChange)="markDirty()"
                      class="prop-input"
                      placeholder="T√™n..."
                    />
                    <button class="btn btn-danger-ghost btn-sm" (click)="removeParameter(i)">
                      ‚úï
                    </button>
                  </div>
                  <div class="prop-group">
                    <label>Nh√£n hi·ªÉn th·ªã</label>
                    <input
                      type="text"
                      [(ngModel)]="param.label"
                      (ngModelChange)="markDirty()"
                      class="prop-input"
                    />
                  </div>
                  <div class="prop-row">
                    <div class="prop-group half">
                      <label>Ki·ªÉu</label>
                      <select
                        [(ngModel)]="param.type"
                        (ngModelChange)="markDirty()"
                        class="prop-select"
                      >
                        <option value="text">VƒÉn b·∫£n</option>
                        <option value="number">S·ªë</option>
                        <option value="date">Ng√†y</option>
                        <option value="dropdown">Dropdown</option>
                      </select>
                    </div>
                    <div class="prop-group half">
                      <label>Gi√° tr·ªã m·∫∑c ƒë·ªãnh</label>
                      <input
                        type="text"
                        [(ngModel)]="param.defaultValue"
                        (ngModelChange)="markDirty()"
                        class="prop-input"
                      />
                    </div>
                  </div>
                  <div class="prop-group">
                    <label class="checkbox-prop">
                      <input
                        type="checkbox"
                        [(ngModel)]="param.required"
                        (ngModelChange)="markDirty()"
                      />
                      B·∫Øt bu·ªôc
                    </label>
                  </div>
                </div>
              }
            </div>
          }

          <!-- ===== TEMPLATES PANEL (Phase 3) ===== -->
          @if (sidePanel === 'templates') {
            <div class="panel-section">
              <h3>üìö Th∆∞ vi·ªán m·∫´u</h3>
              <p class="hint-text">Ch·ªçn m·∫´u ƒë·ªÉ √°p d·ª•ng thi·∫øt k·∫ø c√≥ s·∫µn.</p>
              @for (cat of templateCategories; track cat) {
                <h4>{{ cat }}</h4>
                @for (tpl of templateLibrary; track tpl.id) {
                  @if (tpl.category === cat) {
                    <div class="template-card" (click)="applyTemplate(tpl)">
                      <div class="tpl-icon">üìÑ</div>
                      <div class="tpl-info">
                        <span class="tpl-name">{{ tpl.name }}</span>
                        <span class="tpl-desc">{{ tpl.description }}</span>
                      </div>
                    </div>
                  }
                }
              }
            </div>
          }

          <!-- ===== TABS PANEL (Phase 3: multi-page) ===== -->
          @if (sidePanel === 'tabs') {
            <div class="panel-section">
              <h3>üìë ƒêa trang (Tabs)</h3>
              <button class="btn btn-primary btn-sm" (click)="addTab()">+ Th√™m tab</button>
              <p class="hint-text">M·ªói tab l√† m·ªôt trang b√°o c√°o ri√™ng.</p>
              @if (design.tabs?.length) {
                @for (tab of design.tabs; track tab.id; let i = $index) {
                  <div
                    class="tab-card"
                    [class.active]="activeTabId === tab.id"
                    (click)="selectTab(tab.id)"
                  >
                    <input
                      type="text"
                      [(ngModel)]="tab.name"
                      (ngModelChange)="markDirty()"
                      class="prop-input"
                    />
                    <button
                      class="btn btn-danger-ghost btn-sm"
                      (click)="removeTab(i); $event.stopPropagation()"
                    >
                      ‚úï
                    </button>
                  </div>
                }
              }
            </div>
          }

          <!-- ===== CROSS-TAB PANEL (Phase 3) ===== -->
          @if (sidePanel === 'crosstab') {
            <div class="panel-section">
              <h3>üìê Cross-Tab / Pivot</h3>
              @if (!design.crossTab) {
                <button class="btn btn-primary btn-sm" (click)="initCrossTab()">
                  + T·∫°o Cross-Tab
                </button>
                <p class="hint-text">B·∫£ng ch√©o ƒë·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu theo 2 chi·ªÅu.</p>
              } @else {
                <div class="prop-group">
                  <label>Tr∆∞·ªùng h√†ng (Row)</label>
                  <select
                    [(ngModel)]="design.crossTab.rowFields[0]"
                    (ngModelChange)="markDirty()"
                    class="prop-select"
                  >
                    <option value="">-- Ch·ªçn --</option>
                    @for (f of dataFieldOptions; track f.key) {
                      <option [value]="f.key">{{ f.label }}</option>
                    }
                  </select>
                </div>
                <div class="prop-group">
                  <label>Tr∆∞·ªùng c·ªôt (Column)</label>
                  <select
                    [(ngModel)]="design.crossTab.columnFields[0]"
                    (ngModelChange)="markDirty()"
                    class="prop-select"
                  >
                    <option value="">-- Ch·ªçn --</option>
                    @for (f of dataFieldOptions; track f.key) {
                      <option [value]="f.key">{{ f.label }}</option>
                    }
                  </select>
                </div>
                <div class="prop-group">
                  <label>Tr∆∞·ªùng gi√° tr·ªã</label>
                  <select
                    [(ngModel)]="design.crossTab.dataField"
                    (ngModelChange)="markDirty()"
                    class="prop-select"
                  >
                    <option value="">-- Ch·ªçn --</option>
                    @for (f of dataFieldOptions; track f.key) {
                      <option [value]="f.key">{{ f.label }}</option>
                    }
                  </select>
                </div>
                <div class="prop-group">
                  <label>Ph√©p t·ªïng h·ª£p</label>
                  <select
                    [(ngModel)]="design.crossTab.aggregation"
                    (ngModelChange)="markDirty()"
                    class="prop-select"
                  >
                    <option value="count">ƒê·∫øm</option>
                    <option value="sum">T·ªïng</option>
                    <option value="avg">Trung b√¨nh</option>
                    <option value="min">Min</option>
                    <option value="max">Max</option>
                  </select>
                </div>
                <div class="prop-group">
                  <label class="checkbox-prop">
                    <input
                      type="checkbox"
                      [(ngModel)]="design.crossTab.showRowTotals"
                      (ngModelChange)="markDirty()"
                    />
                    T·ªïng h√†ng
                  </label>
                </div>
                <div class="prop-group">
                  <label class="checkbox-prop">
                    <input
                      type="checkbox"
                      [(ngModel)]="design.crossTab.showColumnTotals"
                      (ngModelChange)="markDirty()"
                    />
                    T·ªïng c·ªôt
                  </label>
                </div>
                <div class="prop-group">
                  <label class="checkbox-prop">
                    <input
                      type="checkbox"
                      [(ngModel)]="design.crossTab.showGrandTotal"
                      (ngModelChange)="markDirty()"
                    />
                    T·ªïng c·ªông
                  </label>
                </div>
                <button class="btn btn-danger btn-sm" (click)="removeCrossTab()">
                  üóëÔ∏è X√≥a Cross-Tab
                </button>
              }
            </div>
          }
          <!-- ===== REPORT EXPLORER PANEL ===== -->
          @if (sidePanel === 'explorer') {
            <div class="panel-section explorer-panel">
              <h3>üóÇÔ∏è Report Explorer</h3>
              <p class="hint-text">C·∫•u tr√∫c c√¢y hi·ªÉn th·ªã t·∫•t c·∫£ band v√† control</p>

              <div class="explorer-tree">
                <!-- Report root -->
                <div class="explorer-node explorer-root">
                  <span class="explorer-toggle">‚ñº</span>
                  <span class="explorer-icon">üìÑ</span>
                  <span class="explorer-name">Report</span>
                  <span class="explorer-meta"
                    >{{ design.pageSettings.size }}
                    {{ design.pageSettings.orientation === 'landscape' ? 'Ngang' : 'D·ªçc' }}</span
                  >
                </div>

                <!-- Bands -->
                @for (band of design.bands; track band.id; let bi = $index) {
                  <div class="explorer-band-group">
                    <!-- Band node -->
                    <div
                      class="explorer-node explorer-band-node"
                      [class.selected]="selectedBandId === band.id && selectedControlIds.size === 0"
                      [class.hidden-node]="!band.visible"
                      (click)="selectBand(band.id)"
                    >
                      <span
                        class="explorer-toggle"
                        (click)="toggleExplorerBand(band.id); $event.stopPropagation()"
                      >
                        {{ isExplorerBandExpanded(band.id) ? '‚ñº' : '‚ñ∂' }}
                      </span>
                      <span
                        class="explorer-icon explorer-band-icon"
                        [class]="getBandIconClass(band.type)"
                        >‚ñ¶</span
                      >
                      <span class="explorer-name">{{ getBandLabel(band.type) }}</span>
                      @if (band.groupField) {
                        <span class="explorer-group-field"
                          >: {{ getDataFieldLabel(band.groupField) }}</span
                        >
                      }
                      <span class="explorer-meta">{{ band.height }}px</span>
                      <span class="explorer-badge">{{ band.controls.length }}</span>

                      <!-- Band actions on hover -->
                      <div class="explorer-actions">
                        <button
                          class="explorer-action-btn"
                          (click)="toggleBandVisibility(band); $event.stopPropagation()"
                          [title]="band.visible ? '·∫®n' : 'Hi·ªán'"
                        >
                          {{ band.visible ? 'üëÅÔ∏è' : 'üö´' }}
                        </button>
                        <button
                          class="explorer-action-btn"
                          (click)="moveBandUp(band.id); $event.stopPropagation()"
                          [disabled]="bi === 0"
                          title="Di chuy·ªÉn l√™n"
                        >
                          ‚ñ≤
                        </button>
                        <button
                          class="explorer-action-btn"
                          (click)="moveBandDown(band.id); $event.stopPropagation()"
                          [disabled]="bi === design.bands.length - 1"
                          title="Di chuy·ªÉn xu·ªëng"
                        >
                          ‚ñº
                        </button>
                        <button
                          class="explorer-action-btn explorer-action-danger"
                          (click)="removeBand(band.id); $event.stopPropagation()"
                          title="X√≥a band"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>

                    <!-- Controls within band -->
                    @if (isExplorerBandExpanded(band.id)) {
                      <div class="explorer-children">
                        @for (ctrl of band.controls; track ctrl.id; let ci = $index) {
                          <div
                            class="explorer-node explorer-control-node"
                            [class.selected]="isControlSelected(ctrl.id)"
                            (click)="
                              selectControl(ctrl.id, band.id, $event); $event.stopPropagation()
                            "
                          >
                            <span class="explorer-icon">{{ getControlIcon(ctrl.type) }}</span>

                            @if (explorerEditingId === ctrl.id) {
                              <input
                                class="explorer-rename-input"
                                [(ngModel)]="explorerEditingName"
                                (blur)="finishRenameControl(ctrl)"
                                (keydown.enter)="finishRenameControl(ctrl)"
                                (keydown.escape)="cancelRenameControl()"
                                (click)="$event.stopPropagation()"
                                autofocus
                              />
                            } @else {
                              <span class="explorer-name" [title]="getControlDisplayName(ctrl)">
                                {{ getControlDisplayName(ctrl) }}
                              </span>
                            }

                            <span class="explorer-size-info">{{ getControlSizeInfo(ctrl) }}</span>

                            <!-- Control actions on hover -->
                            <div class="explorer-actions">
                              <button
                                class="explorer-action-btn"
                                (click)="startRenameControl(ctrl, $event)"
                                title="ƒê·ªïi t√™n"
                              >
                                ‚úèÔ∏è
                              </button>
                              <button
                                class="explorer-action-btn"
                                (click)="moveControlUp(band.id, ctrl.id); $event.stopPropagation()"
                                [disabled]="ci === 0"
                                title="Di chuy·ªÉn l√™n"
                              >
                                ‚ñ≤
                              </button>
                              <button
                                class="explorer-action-btn"
                                (click)="
                                  moveControlDown(band.id, ctrl.id); $event.stopPropagation()
                                "
                                [disabled]="ci === band.controls.length - 1"
                                title="Di chuy·ªÉn xu·ªëng"
                              >
                                ‚ñº
                              </button>
                              <button
                                class="explorer-action-btn"
                                (click)="duplicateControl(ctrl.id); $event.stopPropagation()"
                                title="Nh√¢n b·∫£n"
                              >
                                üìã
                              </button>
                              <button
                                class="explorer-action-btn explorer-action-danger"
                                (click)="removeControl(ctrl.id); $event.stopPropagation()"
                                title="X√≥a"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          </div>
                        }

                        @if (band.controls.length === 0) {
                          <div class="explorer-node explorer-empty">
                            <span class="explorer-icon">‚Äî</span>
                            <span class="explorer-name empty-text">(tr·ªëng)</span>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }

                <!-- Styles node -->
                @if (design.styles?.length) {
                  <div class="explorer-node explorer-section-node">
                    <span class="explorer-toggle">‚ñ∂</span>
                    <span class="explorer-icon">üé®</span>
                    <span class="explorer-name">Styles</span>
                    <span class="explorer-badge">{{ design.styles.length }}</span>
                  </div>
                }

                <!-- Cross-Band Controls -->
                @if (design.crossTab) {
                  <div class="explorer-node explorer-section-node">
                    <span class="explorer-toggle">‚ñ∂</span>
                    <span class="explorer-icon">üìê</span>
                    <span class="explorer-name">Cross-Tab</span>
                  </div>
                }

                <!-- Sub-Reports -->
                @if (design.subReports?.length) {
                  <div class="explorer-node explorer-section-node">
                    <span class="explorer-toggle">‚ñ∂</span>
                    <span class="explorer-icon">üìé</span>
                    <span class="explorer-name">Sub-Reports</span>
                    <span class="explorer-badge">{{ design.subReports?.length }}</span>
                  </div>
                }

                <!-- Data Sources -->
                <div class="explorer-node explorer-section-node">
                  <span class="explorer-toggle">‚ñ∂</span>
                  <span class="explorer-icon">üóÑÔ∏è</span>
                  <span class="explorer-name">Data Sources</span>
                  <span class="explorer-badge">{{ dataFieldOptions.length }}</span>
                </div>
              </div>
            </div>
          }
        </div>
      </aside>

      <!-- ===== Canvas wrapper with toggle ===== -->
      <div class="canvas-wrapper">
        <button
          class="panel-toggle"
          (click)="toggleSidePanel()"
          [title]="sidePanelCollapsed ? 'M·ªü panel' : 'Thu g·ªçn panel'"
        >
          {{ sidePanelCollapsed ? '‚ñ∂' : '‚óÄ' }}
        </button>

        <!-- ===== CENTER: Canvas (DESIGN mode) ===== -->
        @if (mode === 'design') {
          <main class="design-canvas-area">
            <div class="canvas-scroll">
              <!-- Horizontal ruler -->
              @if (showRulers) {
                <div class="ruler-corner"></div>
                <div class="ruler ruler-h" [style.width.px]="pageWidthPx">
                  @for (tick of getRulerTicks(pageWidthPx); track tick.pos) {
                    <div class="ruler-tick" [class.major]="tick.major" [style.left.px]="tick.pos">
                      @if (tick.major) {
                        <span class="ruler-label">{{ tick.label }}</span>
                      }
                    </div>
                  }
                </div>
              }

              <div class="canvas-body-row">
                <!-- Vertical ruler -->
                @if (showRulers) {
                  <div class="ruler ruler-v" [style.height.px]="totalCanvasHeight">
                    @for (tick of getRulerTicks(totalCanvasHeight); track tick.pos) {
                      <div class="ruler-tick" [class.major]="tick.major" [style.top.px]="tick.pos">
                        @if (tick.major) {
                          <span class="ruler-label">{{ tick.label }}</span>
                        }
                      </div>
                    }
                  </div>
                }

                <!-- Band label strip (vertical, like DevExpress) -->
                <div class="band-label-strip">
                  @for (band of design.bands; track band.id) {
                    <div
                      class="band-label-vertical"
                      [class.band-header]="
                        band.type === 'pageHeader' || band.type === 'reportHeader'
                      "
                      [class.band-detail]="band.type === 'detail'"
                      [class.band-footer]="
                        band.type === 'pageFooter' || band.type === 'reportFooter'
                      "
                      [class.band-group-h]="band.type === 'groupHeader'"
                      [class.band-group-f]="band.type === 'groupFooter'"
                      [class.selected]="selectedBandId === band.id"
                      [style.height.px]="band.height + 30"
                      (click)="selectBand(band.id); $event.stopPropagation()"
                      [title]="getBandLabel(band.type)"
                    >
                      <span class="band-label-text">{{ getBandShortLabel(band.type) }}</span>
                    </div>
                  }
                </div>

                <!-- Page canvas -->
                <div
                  class="page-canvas"
                  [style.width.px]="pageWidthPx"
                  [style.transform]="'scale(' + zoomLevel / 100 + ')'"
                  [style.transform-origin]="'top left'"
                >
                  @for (band of design.bands; track band.id) {
                    <div
                      class="band-wrapper"
                      [class.selected]="selectedBandId === band.id"
                      [class.hidden-band]="!band.visible"
                      (click)="selectBand(band.id); $event.stopPropagation()"
                    >
                      <!-- Band separator bar (compact, actions on hover) -->
                      <div
                        class="band-label band-separator"
                        [class.band-header]="
                          band.type === 'pageHeader' || band.type === 'reportHeader'
                        "
                        [class.band-detail]="band.type === 'detail'"
                        [class.band-footer]="
                          band.type === 'pageFooter' || band.type === 'reportFooter'
                        "
                        [class.band-group-h]="band.type === 'groupHeader'"
                        [class.band-group-f]="band.type === 'groupFooter'"
                      >
                        <span class="band-sep-name">{{ getBandLabel(band.type) }}</span>
                        @if (band.groupField) {
                          <span class="band-group-field"
                            >: {{ getDataFieldLabel(band.groupField) }}</span
                          >
                        }
                        <span class="band-size">{{ band.height }}px</span>
                        <div class="band-actions">
                          <button
                            class="band-btn"
                            (click)="toggleBandVisibility(band); $event.stopPropagation()"
                            title="·∫®n/Hi·ªán"
                          >
                            {{ band.visible ? 'üëÅÔ∏è' : 'üö´' }}
                          </button>
                          <button
                            class="band-btn"
                            (click)="resizeBand(band, -10); $event.stopPropagation()"
                            title="Thu nh·ªè"
                          >
                            ‚àí
                          </button>
                          <button
                            class="band-btn"
                            (click)="resizeBand(band, 10); $event.stopPropagation()"
                            title="Ph√≥ng to"
                          >
                            +
                          </button>
                          <button
                            class="band-btn danger"
                            (click)="removeBand(band.id); $event.stopPropagation()"
                            title="X√≥a"
                          >
                            ‚úï
                          </button>
                        </div>
                      </div>

                      <!-- Band canvas (drop zone) -->
                      <div
                        class="band-canvas"
                        [class.show-grid]="showGrid"
                        [style.height.px]="band.height"
                        [style.background-color]="band.backgroundColor || 'transparent'"
                        [style.--grid-size]="gridSize + 'px'"
                        (dragover)="onBandDragOver($event)"
                        (drop)="onBandDrop($event, band.id)"
                        (mousedown)="onBandCanvasMouseDown($event, band.id)"
                        (mousemove)="onBandCanvasMouseMove($event, band.id)"
                        (contextmenu)="onBandContextMenu($event, band.id)"
                      >
                        @for (ctrl of band.controls; track ctrl.id) {
                          <div
                            class="control-wrapper"
                            [class.selected]="isControlSelected(ctrl.id)"
                            [class.multi-selected]="
                              isControlSelected(ctrl.id) && hasMultipleSelected
                            "
                            [ngStyle]="getControlStyle(ctrl)"
                            (click)="
                              selectControl(ctrl.id, band.id, $event); $event.stopPropagation()
                            "
                            (contextmenu)="onContextMenu($event, ctrl.id, band.id)"
                            cdkDrag
                            [cdkDragFreeDragPosition]="{ x: 0, y: 0 }"
                            (cdkDragStarted)="onControlDragStart(ctrl)"
                            (cdkDragMoved)="onControlDragMove(ctrl, $event, band.id)"
                            (cdkDragEnded)="onControlDragEnd(ctrl, $event)"
                          >
                            <!-- Control content preview -->
                            @switch (ctrl.type) {
                              @case ('label') {
                                <span class="ctrl-label">{{ ctrl.text }}</span>
                              }
                              @case ('field') {
                                <span class="ctrl-field"
                                  >[{{ getDataFieldLabel(ctrl.dataField ?? '') }}]</span
                                >
                              }
                              @case ('expression') {
                                <span class="ctrl-expr">fx: {{ ctrl.expression }}</span>
                              }
                              @case ('image') {
                                <span class="ctrl-image">üñºÔ∏è Image</span>
                              }
                              @case ('shape') {
                                <div class="ctrl-shape" [class]="'shape-' + ctrl.shapeType"></div>
                              }
                              @case ('line') {
                                <hr
                                  class="ctrl-line"
                                  [style.border-color]="ctrl.style?.borderColor ?? '#94a3b8'"
                                />
                              }
                              @case ('barcode') {
                                <span class="ctrl-barcode"
                                  >{{ ctrl.barcodeType === 'qr' ? '‚äû' : '|||' }}
                                  {{ ctrl.barcodeType?.toUpperCase() }}</span
                                >
                              }
                              @case ('chart') {
                                <span class="ctrl-chart">üìà Chart</span>
                              }
                              @case ('table') {
                                <span class="ctrl-table">‚ñ¶ Table</span>
                              }
                              @case ('checkbox') {
                                <span class="ctrl-checkbox">‚òë Checkbox</span>
                              }
                              @case ('pageNumber') {
                                <span class="ctrl-system">Trang #</span>
                              }
                              @case ('totalPages') {
                                <span class="ctrl-system">##</span>
                              }
                              @case ('currentDate') {
                                <span class="ctrl-system"
                                  >üìÖ {{ ctrl.format || 'dd/MM/yyyy' }}</span
                                >
                              }
                              @case ('richText') {
                                <span class="ctrl-richtext">{{ ctrl.text || 'Rich Text...' }}</span>
                              }
                              @case ('signatureZone') {
                                <div class="ctrl-signature-zone">
                                  <span class="sig-icon">‚úçÔ∏è</span>
                                  <span class="sig-label">{{ ctrl.text || 'Ch·ªØ k√Ω' }}</span>
                                  <span class="sig-hint">(K√Ω v√† ghi r√µ h·ªç t√™n)</span>
                                </div>
                              }
                              @default {
                                <span>{{ ctrl.type }}</span>
                              }
                            }

                            <!-- Resize handles on selected (all 8 directions) -->
                            @if (isControlSelected(ctrl.id) && !hasMultipleSelected) {
                              <div
                                class="resize-handle resize-n"
                                (mousedown)="onResizeStart($event, 'n', ctrl)"
                              ></div>
                              <div
                                class="resize-handle resize-s"
                                (mousedown)="onResizeStart($event, 's', ctrl)"
                              ></div>
                              <div
                                class="resize-handle resize-e"
                                (mousedown)="onResizeStart($event, 'e', ctrl)"
                              ></div>
                              <div
                                class="resize-handle resize-w"
                                (mousedown)="onResizeStart($event, 'w', ctrl)"
                              ></div>
                              <div
                                class="resize-handle resize-ne"
                                (mousedown)="onResizeStart($event, 'ne', ctrl)"
                              ></div>
                              <div
                                class="resize-handle resize-nw"
                                (mousedown)="onResizeStart($event, 'nw', ctrl)"
                              ></div>
                              <div
                                class="resize-handle resize-se"
                                (mousedown)="onResizeStart($event, 'se', ctrl)"
                              ></div>
                              <div
                                class="resize-handle resize-sw"
                                (mousedown)="onResizeStart($event, 'sw', ctrl)"
                              ></div>
                            }
                          </div>
                        }

                        @if (!band.controls.length) {
                          <div class="band-empty-hint">K√©o th·∫£ control v√†o ƒë√¢y</div>
                        }

                        <!-- Alignment snap guide lines -->
                        @for (guide of guideLines; track $index) {
                          @if (guide.bandId === band.id) {
                            @if (guide.orientation === 'v') {
                              <div
                                class="snap-guide snap-guide-v"
                                [style.left.px]="guide.pos"
                              ></div>
                            } @else {
                              <div class="snap-guide snap-guide-h" [style.top.px]="guide.pos"></div>
                            }
                          }
                        }

                        <!-- Rubber-band selection rectangle -->
                        @if (isRubberBanding && rubberBandBandId === band.id) {
                          <div
                            class="rubber-band"
                            [style.left.px]="rubberBandRect.x"
                            [style.top.px]="rubberBandRect.y"
                            [style.width.px]="rubberBandRect.w"
                            [style.height.px]="rubberBandRect.h"
                          ></div>
                        }
                      </div>
                    </div>
                  }
                </div>
                <!-- /page-canvas -->
              </div>
              <!-- /canvas-body-row -->
            </div>
            <!-- /canvas-scroll -->
          </main>
        }

        <!-- ===== CENTER: Preview mode ===== -->
        @if (mode === 'preview') {
          <main class="preview-area">
            @if (isLoadingPreview) {
              <div class="preview-loading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
              </div>
            } @else if (previewData?.data?.length) {
              <!-- Parameters dialog -->
              @if (showParametersDialog) {
                <div class="params-dialog-overlay" (click)="showParametersDialog = false">
                  <div class="params-dialog" (click)="$event.stopPropagation()">
                    <h3>üîß Nh·∫≠p tham s·ªë</h3>
                    @for (p of design.parameters; track p.name) {
                      <div class="param-input-group">
                        <label
                          >{{ p.label }}
                          @if (p.required) {
                            <span class="required">*</span>
                          }
                        </label>
                        @if (p.type === 'date') {
                          <input
                            type="date"
                            [(ngModel)]="parameterValues[p.name]"
                            class="prop-input"
                          />
                        } @else if (p.type === 'number') {
                          <input
                            type="number"
                            [(ngModel)]="parameterValues[p.name]"
                            class="prop-input"
                          />
                        } @else if (p.type === 'dropdown') {
                          <select [(ngModel)]="parameterValues[p.name]" class="prop-select">
                            @for (opt of p.options ?? []; track opt.value) {
                              <option [value]="opt.value">{{ opt.label }}</option>
                            }
                          </select>
                        } @else {
                          <input
                            type="text"
                            [(ngModel)]="parameterValues[p.name]"
                            class="prop-input"
                          />
                        }
                      </div>
                    }
                    <div class="params-actions">
                      <button class="btn btn-primary btn-sm" (click)="showParametersDialog = false">
                        √Åp d·ª•ng
                      </button>
                    </div>
                  </div>
                </div>
              }

              <div
                class="preview-page"
                [style.width]="design.pageSettings.orientation === 'landscape' ? '1100px' : '800px'"
              >
                <!-- Render each band -->
                @for (band of design.bands; track band.id) {
                  @if (band.visible) {
                    @if (band.type === 'detail') {
                      <!-- Detail band repeats for each data row -->
                      @for (row of previewData!.data; track $index) {
                        <div
                          class="preview-band preview-detail"
                          [style.min-height.px]="band.height"
                        >
                          @for (ctrl of band.controls; track ctrl.id) {
                            <div class="preview-control" [ngStyle]="getControlStyle(ctrl)">
                              {{ renderControlPreview(ctrl, row, previewData!.data) }}
                            </div>
                          }
                        </div>
                      }
                    } @else if (band.type === 'groupHeader' && band.groupField) {
                      <!-- Group header renders once per unique group value -->
                      <!-- Simplified: show all unique group values -->
                    } @else {
                      <!-- Static bands: pageHeader, pageFooter, reportHeader, reportFooter -->
                      <div
                        class="preview-band"
                        [class]="'preview-' + band.type"
                        [style.min-height.px]="band.height"
                        [style.background-color]="band.backgroundColor || 'transparent'"
                      >
                        @for (ctrl of band.controls; track ctrl.id) {
                          <div class="preview-control" [ngStyle]="getControlStyle(ctrl)">
                            {{
                              renderControlPreview(
                                ctrl,
                                previewData!.data[0] ?? {},
                                previewData!.data
                              )
                            }}
                          </div>
                        }
                      </div>
                    }
                  }
                }

                <!-- Cross-Tab preview -->
                @if (crossTabData) {
                  <div class="crosstab-preview">
                    <h4>üìê Cross-Tab</h4>
                    <table class="crosstab-table">
                      <thead>
                        <tr>
                          <th></th>
                          @for (hdr of crossTabData.headers; track hdr) {
                            <th>{{ hdr }}</th>
                          }
                          @if (design.crossTab?.showRowTotals) {
                            <th>T·ªïng</th>
                          }
                        </tr>
                      </thead>
                      <tbody>
                        @for (row of crossTabData.rows; track row.label) {
                          <tr>
                            <td class="crosstab-row-label">{{ row.label }}</td>
                            @for (val of row.values; track $index) {
                              <td>{{ val }}</td>
                            }
                            @if (design.crossTab?.showRowTotals) {
                              <td class="crosstab-total">{{ sumArray(row.values) }}</td>
                            }
                          </tr>
                        }
                      </tbody>
                      @if (design.crossTab?.showColumnTotals) {
                        <tfoot>
                          <tr>
                            <td class="crosstab-total">T·ªïng</td>
                            @for (t of crossTabData.totals; track $index) {
                              <td class="crosstab-total">{{ t }}</td>
                            }
                            @if (design.crossTab?.showGrandTotal) {
                              <td class="crosstab-grand">Œ£</td>
                            }
                          </tr>
                        </tfoot>
                      }
                    </table>
                  </div>
                }
              </div>
            } @else {
              <div class="preview-empty">
                <p>Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xem tr∆∞·ªõc.</p>
                <button class="btn btn-primary btn-sm" (click)="loadPreviewData()">
                  üîÑ T·∫£i l·∫°i
                </button>
              </div>
            }
          </main>
        }
      </div>
      <!-- end canvas-wrapper -->
    </div>

    <!-- ===== Context Menu ===== -->
    @if (showContextMenu) {
      <div
        class="context-menu-overlay"
        (click)="closeContextMenu()"
        (contextmenu)="$event.preventDefault(); closeContextMenu()"
      >
        <div
          class="context-menu"
          [style.left.px]="contextMenuPos.x"
          [style.top.px]="contextMenuPos.y"
          (click)="$event.stopPropagation()"
        >
          @if (selectedControlIds.size > 0) {
            <button class="ctx-item" (click)="copySelected(); closeContextMenu()">
              <span class="ctx-icon">üìã</span> Sao ch√©p <span class="ctx-shortcut">Ctrl+C</span>
            </button>
            <button class="ctx-item" (click)="cutSelected(); closeContextMenu()">
              <span class="ctx-icon">‚úÇÔ∏è</span> C·∫Øt <span class="ctx-shortcut">Ctrl+X</span>
            </button>
            <button
              class="ctx-item"
              (click)="pasteControls(); closeContextMenu()"
              [disabled]="clipboard.length === 0"
            >
              <span class="ctx-icon">üìÑ</span> D√°n <span class="ctx-shortcut">Ctrl+V</span>
            </button>
            <div class="ctx-separator"></div>
            <button
              class="ctx-item"
              (click)="duplicateControl(selectedControlId!); closeContextMenu()"
              [disabled]="hasMultipleSelected"
            >
              <span class="ctx-icon">üìã</span> Nh√¢n b·∫£n <span class="ctx-shortcut">Ctrl+D</span>
            </button>
            <button class="ctx-item ctx-danger" (click)="deleteSelected(); closeContextMenu()">
              <span class="ctx-icon">üóëÔ∏è</span> X√≥a <span class="ctx-shortcut">Del</span>
            </button>
            <div class="ctx-separator"></div>
            <button class="ctx-item" (click)="bringToFront(); closeContextMenu()">
              <span class="ctx-icon">‚¨ÜÔ∏è</span> ƒê∆∞a l√™n tr√™n c√πng
            </button>
            <button class="ctx-item" (click)="sendToBack(); closeContextMenu()">
              <span class="ctx-icon">‚¨áÔ∏è</span> ƒê∆∞a xu·ªëng d∆∞·ªõi c√πng
            </button>
            @if (hasMultipleSelected) {
              <div class="ctx-separator"></div>
              <button class="ctx-item" (click)="alignLeft(); closeContextMenu()">
                <span class="ctx-icon">‚´∑</span> CƒÉn tr√°i
              </button>
              <button class="ctx-item" (click)="alignTop(); closeContextMenu()">
                <span class="ctx-icon">‚´†</span> CƒÉn tr√™n
              </button>
              <button class="ctx-item" (click)="makeSameSize(); closeContextMenu()">
                <span class="ctx-icon">‚äû</span> C√πng k√≠ch th∆∞·ªõc
              </button>
            }
          } @else {
            <button
              class="ctx-item"
              (click)="pasteControls(); closeContextMenu()"
              [disabled]="clipboard.length === 0"
            >
              <span class="ctx-icon">üìÑ</span> D√°n <span class="ctx-shortcut">Ctrl+V</span>
            </button>
            <button class="ctx-item" (click)="selectAllInBand(); closeContextMenu()">
              <span class="ctx-icon">‚òë</span> Ch·ªçn t·∫•t c·∫£ <span class="ctx-shortcut">Ctrl+A</span>
            </button>
          }
        </div>
      </div>
    }

    <!-- ===== Multi-selection status bar ===== -->
    @if (mode === 'design' && selectedControlIds.size > 1) {
      <div class="multi-select-bar">
        <span class="tag tag-blue">{{ selectedControlIds.size }} controls ƒë√£ ch·ªçn</span>
        <button class="btn btn-ghost btn-sm" (click)="alignLeft()" title="CƒÉn tr√°i">
          ‚´∑ CƒÉn tr√°i
        </button>
        <button class="btn btn-ghost btn-sm" (click)="alignTop()" title="CƒÉn tr√™n">
          ‚´† CƒÉn tr√™n
        </button>
        <button
          class="btn btn-ghost btn-sm"
          (click)="distributeHorizontal()"
          [disabled]="selectedControlIds.size < 3"
          title="Ph√¢n b·ªë ƒë·ªÅu ngang"
        >
          ‚Üî Ph√¢n b·ªë H
        </button>
        <button
          class="btn btn-ghost btn-sm"
          (click)="distributeVertical()"
          [disabled]="selectedControlIds.size < 3"
          title="Ph√¢n b·ªë ƒë·ªÅu d·ªçc"
        >
          ‚Üï Ph√¢n b·ªë V
        </button>
        <button class="btn btn-ghost btn-sm" (click)="makeSameSize()" title="C√πng k√≠ch th∆∞·ªõc">
          ‚äû C√πng size
        </button>
        <button
          class="btn btn-danger-ghost btn-sm"
          (click)="deleteSelected()"
          title="X√≥a t·∫•t c·∫£ ƒë√£ ch·ªçn"
        >
          üóëÔ∏è X√≥a
        </button>
      </div>
    }

    <!-- ===== Expression Editor Dialog ===== -->
    @if (showExpressionEditor) {
      <div class="expr-dialog-overlay" (click)="showExpressionEditor = false">
        <div class="expr-dialog" (click)="$event.stopPropagation()">
          <h3>üìù Tr√¨nh so·∫°n bi·ªÉu th·ª©c</h3>
          <textarea
            [(ngModel)]="expressionValue"
            class="expr-textarea"
            rows="4"
            placeholder='VD: [Data.patientName], Iif([Data.score]>80,"Pass","Fail")'
          ></textarea>

          <div class="expr-snippets">
            <h4>Tr∆∞·ªùng d·ªØ li·ªáu</h4>
            <div class="snippet-grid">
              @for (f of dataFieldOptions; track f.key) {
                <span
                  class="tag tag-blue snippet-tag"
                  (click)="insertExpressionSnippet('[Data.' + f.key + ']')"
                >
                  {{ f.label }}
                </span>
              }
            </div>

            <h4>H√†m</h4>
            <div class="snippet-grid">
              <span class="tag tag-teal snippet-tag" (click)="insertExpressionSnippet('Count()')">
                Count()
              </span>
              <span
                class="tag tag-teal snippet-tag"
                (click)="insertExpressionSnippet('Sum(fieldKey)')"
              >
                Sum()
              </span>
              <span
                class="tag tag-teal snippet-tag"
                (click)="insertExpressionSnippet('Avg(fieldKey)')"
              >
                Avg()
              </span>
              <span
                class="tag tag-teal snippet-tag"
                (click)="insertExpressionSnippet('Min(fieldKey)')"
              >
                Min()
              </span>
              <span
                class="tag tag-teal snippet-tag"
                (click)="insertExpressionSnippet('Max(fieldKey)')"
              >
                Max()
              </span>
              <span
                class="tag tag-teal snippet-tag"
                (click)="insertExpressionSnippet('Upper(text)')"
              >
                Upper()
              </span>
              <span
                class="tag tag-teal snippet-tag"
                (click)="insertExpressionSnippet('Lower(text)')"
              >
                Lower()
              </span>
              <span
                class="tag tag-teal snippet-tag"
                (click)="insertExpressionSnippet('Iif(condition,trueVal,falseVal)')"
              >
                Iif()
              </span>
            </div>

            <h4>To√°n t·ª≠</h4>
            <div class="snippet-grid">
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' + ')"
                >+</span
              >
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' - ')"
                >‚àí</span
              >
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' * ')"
                >√ó</span
              >
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' / ')"
                >/</span
              >
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' &gt; ')"
                >&gt;</span
              >
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' &lt; ')"
                >&lt;</span
              >
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' == ')"
                >=</span
              >
              <span class="tag tag-gray snippet-tag" (click)="insertExpressionSnippet(' != ')"
                >‚â†</span
              >
            </div>
          </div>

          <div class="expr-actions">
            <button class="btn btn-secondary btn-sm" (click)="showExpressionEditor = false">
              H·ªßy
            </button>
            <button class="btn btn-primary btn-sm" (click)="applyExpression()">√Åp d·ª•ng</button>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="loading">
      <div class="spinner"></div>
      <p>ƒêang t·∫£i thi·∫øt k·∫ø...</p>
    </div>
  }
</div>
