<div class="form-builder-container">
    <!-- Header -->
    <header class="builder-header">
        <div class="header-left">
            <button class="back-btn" (click)="goBack()">‚Üê Quay l·∫°i</button>
            <input type="text" class="form-name-input" [(ngModel)]="formName" placeholder="T√™n bi·ªÉu m·∫´u..."
                (blur)="saveFormSettings()">
        </div>
        <div class="header-right">
            <button class="btn btn-secondary" (click)="preview()">üëÅÔ∏è Xem tr∆∞·ªõc</button>
            @if (templateId && !template?.isPublished) {
            <button class="btn btn-success" (click)="publish()">üì§ Xu·∫•t b·∫£n</button>
            }
            <button class="btn btn-primary" (click)="save()">üíæ L∆∞u</button>
        </div>
    </header>

    <div class="builder-content">
        <!-- Field Palette -->
        <aside class="field-palette">
            <h3>C√°c lo·∫°i tr∆∞·ªùng</h3>
            <div class="field-types">
                @for (fieldType of fieldTypes; track fieldType.type) {
                <button class="field-type-btn" draggable="true" (dragstart)="onDragStart($event, fieldType.type)"
                    (click)="addField(fieldType.type)">
                    <span class="field-icon">{{ fieldType.icon }}</span>
                    <span>{{ fieldType.label }}</span>
                </button>
                }
            </div>

            <div class="palette-section">
                <h4>C√†i ƒë·∫∑t bi·ªÉu m·∫´u</h4>
                <div class="form-group">
                    <label>Danh m·ª•c</label>
                    <select [(ngModel)]="selectedCategoryId" (change)="saveFormSettings()">
                        @for (cat of categories; track cat.id) {
                        <option [value]="cat.id">{{ cat.name }}</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <textarea [(ngModel)]="formDescription" placeholder="M√¥ t·∫£ bi·ªÉu m·∫´u..."
                        (blur)="saveFormSettings()"></textarea>
                </div>
            </div>
        </aside>

        <!-- Form Canvas -->
        <main class="form-canvas">
            <div class="canvas-header">
                <h2>{{ formName || 'Bi·ªÉu m·∫´u m·ªõi' }}</h2>
                <p>{{ formDescription || 'K√©o th·∫£ c√°c tr∆∞·ªùng t·ª´ b√™n tr√°i ƒë·ªÉ x√¢y d·ª±ng bi·ªÉu m·∫´u' }}</p>
            </div>

            <div class="fields-container grid-layout" cdkDropList (cdkDropListDropped)="onDropField($event)"
                (dragover)="onDragOver($event)" (drop)="onDrop($event)">

                @if (fields.length === 0) {
                <div class="empty-canvas">
                    <div class="drop-zone">
                        <span class="drop-icon">üì•</span>
                        <p>K√©o tr∆∞·ªùng v√†o ƒë√¢y ho·∫∑c click v√†o lo·∫°i tr∆∞·ªùng b√™n tr√°i</p>
                    </div>
                </div>
                }

                @for (field of fields; track field.id || field.fieldKey; let i = $index) {
                <div class="field-item" cdkDrag [style.grid-column]="'span ' + getFieldColSpan(field)"
                    [class.selected]="selectedField?.id === field.id || selectedField?.fieldKey === field.fieldKey"
                    [class.col-1]="getFieldColSpan(field) === 1" [class.col-2]="getFieldColSpan(field) === 2"
                    [class.col-3]="getFieldColSpan(field) === 3" [class.col-4]="getFieldColSpan(field) === 4"
                    (click)="selectField(field)">
                    <div class="field-header">
                        <div class="drag-handle" cdkDragHandle>‚ãÆ‚ãÆ</div>
                        <span class="col-indicator" title="Chi·ªÅu r·ªông c·ªôt">{{ getFieldColSpan(field) }}/4</span>
                        <button class="delete-btn" (click)="deleteField(field, $event)">üóëÔ∏è</button>
                    </div>
                    <div class="field-preview">
                        <label>
                            {{ field.label }}
                            @if (field.isRequired) {
                            <span class="required">*</span>
                            }
                        </label>
                        @switch (field.fieldType) {
                        @case (FieldType.Text) {
                        <input type="text" [placeholder]="field.placeholder || ''"
                            [style.height]="getFieldHeight(field)" disabled>
                        }
                        @case (FieldType.TextArea) {
                        <textarea [placeholder]="field.placeholder || ''" [style.height]="getFieldHeight(field)"
                            disabled></textarea>
                        }
                        @case (FieldType.Number) {
                        <input type="number" [placeholder]="field.placeholder || ''" disabled>
                        }
                        @case (FieldType.Date) {
                        <input type="date" disabled>
                        }
                        @case (FieldType.Dropdown) {
                        <select disabled>
                            <option>-- Ch·ªçn --</option>
                        </select>
                        }
                        @case (FieldType.Radio) {
                        <div class="radio-preview">
                            @for (opt of getOptions(field); track opt.value) {
                            <label><input type="radio" disabled> {{ opt.label }}</label>
                            }
                        </div>
                        }
                        @case (FieldType.Checkbox) {
                        <div class="checkbox-preview">
                            @for (opt of getOptions(field); track opt.value) {
                            <label><input type="checkbox" disabled> {{ opt.label }}</label>
                            }
                            @if (getOptions(field).length === 0) {
                            <label><input type="checkbox" disabled> {{ field.placeholder || 'Checkbox' }}</label>
                            }
                        </div>
                        }
                        @case (FieldType.Tags) {
                        <div class="tags-preview">
                            @if (getOptions(field).length > 0) {
                            @for (opt of getOptions(field); track opt.value) {
                            <span class="tag-badge">üè∑Ô∏è {{ opt.label }}</span>
                            }
                            } @else {
                            <span class="tags-placeholder">üè∑Ô∏è Ch·ªçn t·ª´ danh s√°ch concepts...</span>
                            }
                        </div>
                        }
                        @case (FieldType.Rating) {
                        <div class="rating-preview">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                        }
                        @case (FieldType.Section) {
                        <hr class="section-divider">
                        }
                        @default {
                        <input type="text" disabled [placeholder]="getFieldTypeLabel(field.fieldType)">
                        }
                        }
                        @if (field.helpText) {
                        <small class="help-text">{{ field.helpText }}</small>
                        }
                    </div>
                </div>
                }
            </div>
        </main>

        <!-- Field Properties Panel -->
        @if (selectedField) {
        <aside class="properties-panel">
            <div class="panel-header">
                <h3>Thu·ªôc t√≠nh tr∆∞·ªùng</h3>
                <button class="close-btn" (click)="selectedField = null">‚úï</button>
            </div>

            <div class="panel-body">
                <div class="form-group">
                    <label>Nh√£n</label>
                    <input type="text" [(ngModel)]="selectedField.label" (blur)="updateField()">

                    <!-- Inline Concept Search -->
                    <div class="concept-link-section">
                        @if (selectedField.id && getLinkedConcept(selectedField.id)) {
                        <div class="linked-concept-badge">
                            <span class="concept-tag">
                                üîó {{ getLinkedConcept(selectedField.id)!.code }}
                                <span class="concept-display">{{ getLinkedConcept(selectedField.id)!.display }}</span>
                            </span>
                            @for (mapping of getLinkedConcept(selectedField.id)!.mappings; track mapping.id) {
                            @if (mapping.targetSystem === 'SNOMED CT') {
                            <span class="snomed-tag">SNOMED: {{ mapping.targetCode }}</span>
                            }
                            }
                            <button class="remove-concept-btn" (click)="unlinkConcept(selectedField)"
                                title="B·ªè li√™n k·∫øt">‚úï</button>
                        </div>
                        } @else {
                        <div class="concept-search-inline">
                            <input type="text" class="concept-search-input" placeholder="üîç T√¨m concept y khoa..."
                                [(ngModel)]="conceptSearchTerm" (input)="searchConcepts()"
                                (focus)="showConceptDropdown = true">

                            @if (showConceptDropdown && conceptSearchResults.length > 0) {
                            <div class="concept-dropdown">
                                @for (concept of conceptSearchResults; track concept.id) {
                                <div class="concept-option" (click)="selectConcept(concept)">
                                    <span class="concept-code">{{ concept.code }}</span>
                                    <span class="concept-name">{{ concept.display }}</span>
                                    @for (mapping of concept.mappings; track mapping.id) {
                                    @if (mapping.targetSystem === 'SNOMED CT') {
                                    <span class="snomed-mini">SNOMED</span>
                                    }
                                    }
                                </div>
                                }
                            </div>
                            }

                            @if (showConceptDropdown && conceptSearchTerm && conceptSearchResults.length === 0 &&
                            !isSearchingConcepts) {
                            <div class="concept-dropdown">
                                <div class="no-results">Kh√¥ng t√¨m th·∫•y concept</div>
                            </div>
                            }
                        </div>
                        }
                    </div>
                </div>

                <div class="form-group">
                    <label>Key (ƒë·ªãnh danh)</label>
                    <input type="text" [(ngModel)]="selectedField.fieldKey" (blur)="updateField()">
                </div>

                <div class="form-group">
                    <label>Placeholder</label>
                    <input type="text" [(ngModel)]="selectedField.placeholder" (blur)="updateField()">
                </div>

                <div class="form-group">
                    <label>G·ª£i √Ω</label>
                    <input type="text" [(ngModel)]="selectedField.helpText" (blur)="updateField()">
                </div>

                <div class="form-group">
                    <label>Gi√° tr·ªã m·∫∑c ƒë·ªãnh</label>
                    <input type="text" [(ngModel)]="selectedField.defaultValue" (blur)="updateField()">
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" [(ngModel)]="selectedField.isRequired" (change)="updateField()">
                        B·∫Øt bu·ªôc
                    </label>
                </div>



                @if (hasOptions(selectedField.fieldType)) {
                <div class="options-section">
                    <label>C√°c l·ª±a ch·ªçn</label>
                    <div class="options-list">
                        @for (opt of editableOptions; track i; let i = $index) {
                        <div class="option-row">
                            <div class="option-inputs">
                                <input type="text" [(ngModel)]="opt.value" placeholder="Value" (blur)="saveOptions()"
                                    class="opt-value">
                                <input type="text" [(ngModel)]="opt.label" placeholder="Label" (blur)="saveOptions()"
                                    class="opt-label">
                            </div>

                            <!-- Concept Search for this option -->
                            <div class="option-concept">
                                @if (opt.conceptId) {
                                <div class="linked-concept-info">
                                    <span class="concept-badge" [title]="opt.conceptCode">
                                        üîó {{ opt.conceptDisplay || opt.conceptCode }}
                                    </span>
                                    <button type="button" class="unlink-btn" (click)="unlinkOptionConcept(i)"
                                        title="B·ªè li√™n k·∫øt">‚úï</button>
                                </div>
                                } @else {
                                <div class="concept-search-wrapper">
                                    <input type="text" class="concept-search-input" placeholder="üîç T√¨m concept..."
                                        [(ngModel)]="optionConceptSearch[i]" (input)="searchConceptsForOption(i)"
                                        (focus)="activeOptionSearchIndex = i">
                                    @if (activeOptionSearchIndex === i && optionConceptResults[i] &&
                                    optionConceptResults[i].length > 0) {
                                    <div class="concept-dropdown">
                                        @for (concept of optionConceptResults[i] || []; track concept.id) {
                                        <div class="concept-option" (click)="selectConceptForOption(i, concept)">
                                            <span class="concept-code">{{ concept.code }}</span>
                                            <span class="concept-name">{{ concept.display }}</span>
                                        </div>
                                        }
                                    </div>
                                    }
                                </div>
                                }
                            </div>

                            <button type="button" class="remove-option-btn" (click)="removeOption(i)"
                                title="X√≥a">üóëÔ∏è</button>
                        </div>
                        }
                    </div>
                    <button type="button" class="add-option-btn" (click)="addOption()">+ Th√™m l·ª±a ch·ªçn</button>
                    <small>M·ªói option c√≥ th·ªÉ li√™n k·∫øt v·ªõi Concept ƒë·ªÉ ph·ª•c v·ª• b√°o c√°o/th·ªëng k√™</small>
                </div>
                }

                <div class="section-divider">
                    <span>üìê B·ªë c·ª•c</span>
                </div>

                <div class="layout-controls">
                    <div class="form-group">
                        <label>Chi·ªÅu r·ªông</label>
                        <div class="width-buttons">
                            <button type="button" [class.active]="selectedFieldColSpan === '1'"
                                (click)="setColSpan('1')" title="25%">¬º</button>
                            <button type="button" [class.active]="selectedFieldColSpan === '2'"
                                (click)="setColSpan('2')" title="50%">¬Ω</button>
                            <button type="button" [class.active]="selectedFieldColSpan === '3'"
                                (click)="setColSpan('3')" title="75%">¬æ</button>
                            <button type="button" [class.active]="selectedFieldColSpan === '4'"
                                (click)="setColSpan('4')" title="100%">1</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Chi·ªÅu cao</label>
                        <select [(ngModel)]="selectedFieldHeight" (change)="updateFieldLayout()">
                            <option value="auto">T·ª± ƒë·ªông</option>
                            <option value="small">Nh·ªè (60px)</option>
                            <option value="medium">V·ª´a (100px)</option>
                            <option value="large">L·ªõn (150px)</option>
                            <option value="xlarge">R·∫•t l·ªõn (200px)</option>
                        </select>
                    </div>

                    <!-- Conditional Logic Section -->
                    <div class="section-divider">
                        <span>üîÄ Logic hi·ªÉn th·ªã</span>
                    </div>

                    <div class="logic-controls">
                        <button class="btn-logic-toggle" [class.active]="showLogicEditor" (click)="toggleLogicEditor()">
                            {{ selectedField.conditionalLogicJson ? '‚úÖ ƒê√£ thi·∫øt l·∫≠p logic' : '+ Th√™m ƒëi·ªÅu ki·ªán hi·ªÉn th·ªã'
                            }}
                        </button>

                        @if (showLogicEditor) {
                        <div class="logic-editor">
                            <div class="logic-header">
                                <select [(ngModel)]="currentLogic.action" (change)="saveLogic()">
                                    <option value="show">Hi·ªán</option>
                                    <option value="hide">·∫®n</option>
                                </select>
                                <span>tr∆∞·ªùng n√†y khi:</span>
                            </div>

                            @if (currentLogic.conditions.length > 0) {
                            <div class="logic-operator">
                                <select [(ngModel)]="currentLogic.logic" (change)="saveLogic()">
                                    <option value="AND">T·∫•t c·∫£ (AND)</option>
                                    <option value="OR">B·∫•t k·ª≥ (OR)</option>
                                </select>
                                <span>ƒëi·ªÅu ki·ªán sau ƒë√∫ng:</span>
                            </div>
                            }

                            <div class="conditions-list">
                                @for (cond of currentLogic.conditions; track $index) {
                                <div class="condition-row">
                                    <div class="condition-inputs">
                                        <select [(ngModel)]="cond.fieldId" (change)="saveLogic()" class="cond-field">
                                            <option value="" disabled>-- Ch·ªçn tr∆∞·ªùng --</option>
                                            @for (f of getAvailableTriggerFields(); track f.id) {
                                            <option [value]="f.id">{{ f.label }}</option>
                                            }
                                        </select>

                                        <select [(ngModel)]="cond.operator" (change)="saveLogic()" class="cond-op">
                                            <option value="eq">B·∫±ng</option>
                                            <option value="neq">Kh√°c</option>
                                            <option value="gt">L·ªõn h∆°n</option>
                                            <option value="lt">Nh·ªè h∆°n</option>
                                            <option value="contains">Ch·ª©a</option>
                                        </select>

                                        @if (getOptionsForCondition(cond.fieldId); as options) {
                                        <select [(ngModel)]="cond.value" (change)="saveLogic()" class="cond-val">
                                            <option value="" disabled>-- Ch·ªçn gi√° tr·ªã --</option>
                                            @for (opt of options; track opt.value) {
                                            <option [value]="opt.value">{{ opt.label }}</option>
                                            }
                                        </select>
                                        } @else {
                                        <input type="text" [(ngModel)]="cond.value" (blur)="saveLogic()"
                                            placeholder="Gi√° tr·ªã" class="cond-val">
                                        }
                                    </div>
                                    <button class="remove-cond-btn" (click)="removeCondition($index)">üóëÔ∏è</button>
                                </div>
                                }
                            </div>

                            <button class="add-cond-btn" (click)="addCondition()">+ Th√™m ƒëi·ªÅu ki·ªán</button>

                            @if (getAvailableTriggerFields().length === 0) {
                            <small class="warning-text">‚ö†Ô∏è C·∫ßn c√≥ tr∆∞·ªùng ph√≠a tr√™n ƒë·ªÉ t·∫°o ƒëi·ªÅu ki·ªán.</small>
                            }
                        </div>
                        }
                    </div>
                </div>
            </div>
        </aside>
        }
    </div>

    <!-- Concept Picker Modal -->
    <app-concept-picker [isOpen]="showConceptPicker" [fieldId]="selectedFieldForConcept?.id"
        (conceptLinked)="onConceptLinked($event)" (closed)="showConceptPicker = false">
    </app-concept-picker>
</div>