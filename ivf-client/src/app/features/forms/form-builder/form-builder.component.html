<div class="form-builder-container">
  <!-- Header -->
  <header class="builder-header">
    <div class="header-left">
      <button class="back-btn" (click)="goBack()">â† Quay láº¡i</button>
      <input
        type="text"
        class="form-name-input"
        [(ngModel)]="formName"
        placeholder="TÃªn biá»ƒu máº«u..."
        (blur)="saveFormSettings()"
      />
    </div>
    <div class="header-right">
      <button class="btn btn-link-config" (click)="openLinkedFieldConfig()" *ngIf="templateId" title="Cáº¥u hÃ¬nh liÃªn káº¿t dá»¯ liá»‡u giá»¯a cÃ¡c form">
        ğŸ”— LiÃªn káº¿t
      </button>
      <button class="btn btn-secondary" (click)="preview()">ğŸ‘ï¸ Xem trÆ°á»›c</button>
      @if (templateId && !template?.isPublished) {
        <button class="btn btn-success" (click)="publish()">ğŸ“¤ Xuáº¥t báº£n</button>
      }
      <button class="btn btn-primary" (click)="save()">ğŸ’¾ LÆ°u</button>
    </div>
  </header>

  <div class="builder-content">
    <!-- Field Palette (Sub-component) -->
    <aside class="field-palette">
      <app-field-palette
        [categories]="categories"
        [selectedCategoryId]="selectedCategoryId"
        (fieldAdded)="addField($event)"
        (fieldDragStart)="onDragStart($event.event, $event.type)"
        (categoryChanged)="selectedCategoryId = $event; saveFormSettings()"
      ></app-field-palette>

      <div class="palette-section">
        <h4>MÃ´ táº£</h4>
        <div class="form-group">
          <textarea
            [(ngModel)]="formDescription"
            placeholder="MÃ´ táº£ biá»ƒu máº«u..."
            (blur)="saveFormSettings()"
          ></textarea>
        </div>
      </div>
    </aside>

    <!-- Form Canvas -->
    <main class="form-canvas">
      <div class="canvas-header">
        <h2>{{ formName || 'Biá»ƒu máº«u má»›i' }}</h2>
        <p>{{ formDescription || 'KÃ©o tháº£ cÃ¡c trÆ°á»ng tá»« bÃªn trÃ¡i Ä‘á»ƒ xÃ¢y dá»±ng biá»ƒu máº«u' }}</p>
      </div>

      <div
        class="fields-container grid-layout"
        cdkDropList
        (cdkDropListDropped)="onDropField($event)"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event)"
      >
        @if (fields.length === 0) {
          <div class="empty-canvas">
            <div class="drop-zone">
              <span class="drop-icon">ğŸ“¥</span>
              <p>KÃ©o trÆ°á»ng vÃ o Ä‘Ã¢y hoáº·c click vÃ o loáº¡i trÆ°á»ng bÃªn trÃ¡i</p>
            </div>
          </div>
        }

        @for (field of fields; track field.id || field.fieldKey; let i = $index) {
          <app-field-preview
            cdkDrag
            [field]="field"
            [isSelected]="selectedField?.id === field.id || selectedField?.fieldKey === field.fieldKey"
            [style.grid-column]="'span ' + getFieldColSpan(field)"
            [class.col-1]="getFieldColSpan(field) === 1"
            [class.col-2]="getFieldColSpan(field) === 2"
            [class.col-3]="getFieldColSpan(field) === 3"
            [class.col-4]="getFieldColSpan(field) === 4"
            (click)="selectField(field)"
            (deleted)="deleteField(field)"
            (cloned)="cloneField(field)"
          ></app-field-preview>
        }
      </div>
    </main>

    <!-- Field Properties Panel (Sub-component) -->
    <app-field-properties-panel
      [field]="selectedField"
      [fields]="fields"
      [linkedConcepts]="linkedConcepts"
      (fieldUpdated)="onFieldPropertiesUpdated($event)"
      (closed)="deselectField()"
      (conceptLinked)="onConceptLinked($event)"
      (conceptUnlinked)="onConceptUnlinked($event)"
    ></app-field-properties-panel>
  </div>

  <!-- Concept Picker Modal -->
  <app-concept-picker
    [isOpen]="showConceptPicker"
    [fieldId]="selectedFieldForConcept?.id"
    (conceptLinked)="onConceptLinked({fieldId: selectedFieldForConcept?.id || '', concept: $event})"
    (closed)="showConceptPicker = false"
  >
  </app-concept-picker>

  <!-- Linked Field Config Modal -->
  <app-linked-field-config
    [templateId]="templateId || ''"
    [fields]="fields"
    [isOpen]="showLinkedFieldConfig"
    (closed)="showLinkedFieldConfig = false"
  >
  </app-linked-field-config>
</div>
