<div class="form-builder-container">
  <!-- Header -->
  <header class="builder-header">
    <div class="header-left">
      <button class="back-btn" (click)="goBack()">‚Üê Quay l·∫°i</button>
      <input
        type="text"
        class="form-name-input"
        [(ngModel)]="formName"
        placeholder="T√™n bi·ªÉu m·∫´u..."
        (blur)="saveFormSettings()"
      />
    </div>
    <div class="header-right">
      <button class="btn btn-secondary" (click)="preview()">üëÅÔ∏è Xem tr∆∞·ªõc</button>
      @if (templateId && !template?.isPublished) {
        <button class="btn btn-success" (click)="publish()">üì§ Xu·∫•t b·∫£n</button>
      }
      <button class="btn btn-primary" (click)="save()">üíæ L∆∞u</button>
    </div>
  </header>

  <div class="builder-content">
    <!-- Field Palette -->
    <aside class="field-palette">
      <h3>C√°c lo·∫°i tr∆∞·ªùng</h3>
      <div class="field-types">
        @for (fieldType of fieldTypes; track fieldType.type) {
          <button
            class="field-type-btn"
            draggable="true"
            (dragstart)="onDragStart($event, fieldType.type)"
            (click)="addField(fieldType.type)"
          >
            <span class="field-icon">{{ fieldType.icon }}</span>
            <span>{{ fieldType.label }}</span>
          </button>
        }
      </div>

      <div class="palette-section">
        <h4>C√†i ƒë·∫∑t bi·ªÉu m·∫´u</h4>
        <div class="form-group">
          <label>Danh m·ª•c</label>
          <select [(ngModel)]="selectedCategoryId" (change)="saveFormSettings()">
            @for (cat of categories; track cat.id) {
              <option [value]="cat.id">{{ cat.name }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label>M√¥ t·∫£</label>
          <textarea
            [(ngModel)]="formDescription"
            placeholder="M√¥ t·∫£ bi·ªÉu m·∫´u..."
            (blur)="saveFormSettings()"
          ></textarea>
        </div>
      </div>
    </aside>

    <!-- Form Canvas -->
    <main class="form-canvas">
      <div class="canvas-header">
        <h2>{{ formName || 'Bi·ªÉu m·∫´u m·ªõi' }}</h2>
        <p>{{ formDescription || 'K√©o th·∫£ c√°c tr∆∞·ªùng t·ª´ b√™n tr√°i ƒë·ªÉ x√¢y d·ª±ng bi·ªÉu m·∫´u' }}</p>
      </div>

      <div
        class="fields-container grid-layout"
        cdkDropList
        (cdkDropListDropped)="onDropField($event)"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event)"
      >
        @if (fields.length === 0) {
          <div class="empty-canvas">
            <div class="drop-zone">
              <span class="drop-icon">üì•</span>
              <p>K√©o tr∆∞·ªùng v√†o ƒë√¢y ho·∫∑c click v√†o lo·∫°i tr∆∞·ªùng b√™n tr√°i</p>
            </div>
          </div>
        }

        @for (field of fields; track field.id || field.fieldKey; let i = $index) {
          <div
            class="field-item"
            cdkDrag
            [style.grid-column]="'span ' + getFieldColSpan(field)"
            [class.selected]="
              selectedField?.id === field.id || selectedField?.fieldKey === field.fieldKey
            "
            [class.col-1]="getFieldColSpan(field) === 1"
            [class.col-2]="getFieldColSpan(field) === 2"
            [class.col-3]="getFieldColSpan(field) === 3"
            [class.col-4]="getFieldColSpan(field) === 4"
            (click)="selectField(field)"
          >
            <div class="field-header">
              <div class="drag-handle" cdkDragHandle>‚ãÆ‚ãÆ</div>
              <span class="col-indicator" title="Chi·ªÅu r·ªông c·ªôt"
                >{{ getFieldColSpan(field) }}/4</span
              >
              <button class="clone-btn" (click)="cloneField(field, $event)" title="Nh√¢n b·∫£n">
                üìã
              </button>
              <button class="delete-btn" (click)="deleteField(field, $event)">üóëÔ∏è</button>
            </div>
            <div class="field-preview">
              <label>
                {{ field.label }}
                @if (field.isRequired) {
                  <span class="required">*</span>
                }
              </label>
              @switch (field.fieldType) {
                @case (FieldType.Text) {
                  <input
                    type="text"
                    [placeholder]="field.placeholder || ''"
                    [style.height]="getFieldHeight(field)"
                    disabled
                  />
                }
                @case (FieldType.TextArea) {
                  <textarea
                    [placeholder]="field.placeholder || ''"
                    [style.height]="getFieldHeight(field)"
                    disabled
                  ></textarea>
                }
                @case (FieldType.Number) {
                  <input type="number" [placeholder]="field.placeholder || ''" disabled />
                }
                @case (FieldType.Decimal) {
                  <input
                    type="number"
                    step="0.01"
                    [placeholder]="field.placeholder || ''"
                    disabled
                  />
                }
                @case (FieldType.Date) {
                  <input type="date" disabled />
                }
                @case (FieldType.DateTime) {
                  <input type="datetime-local" disabled />
                }
                @case (FieldType.Time) {
                  <input type="time" disabled />
                }
                @case (FieldType.Dropdown) {
                  <select disabled>
                    <option>-- Ch·ªçn --</option>
                  </select>
                }
                @case (FieldType.Radio) {
                  <div class="radio-preview">
                    @for (opt of getOptions(field); track opt.value) {
                      <label><input type="radio" disabled /> {{ opt.label }}</label>
                    }
                  </div>
                }
                @case (FieldType.Checkbox) {
                  <div class="checkbox-preview">
                    @for (opt of getOptions(field); track opt.value) {
                      <label><input type="checkbox" disabled /> {{ opt.label }}</label>
                    }
                    @if (getOptions(field).length === 0) {
                      <label
                        ><input type="checkbox" disabled />
                        {{ field.placeholder || 'Checkbox' }}</label
                      >
                    }
                  </div>
                }
                @case (FieldType.Tags) {
                  <div class="tags-preview">
                    @if (getOptions(field).length > 0) {
                      @for (opt of getOptions(field); track opt.value) {
                        <span class="tag-badge">üè∑Ô∏è {{ opt.label }}</span>
                      }
                    } @else {
                      <span class="tags-placeholder">üè∑Ô∏è Ch·ªçn t·ª´ danh s√°ch concepts...</span>
                    }
                  </div>
                }
                @case (FieldType.Rating) {
                  <div class="rating-preview">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                }
                @case (FieldType.MultiSelect) {
                  <select multiple disabled style="min-height: 60px">
                    @for (opt of getOptions(field); track opt.value) {
                      <option>{{ opt.label }}</option>
                    }
                  </select>
                }
                @case (FieldType.Section) {
                  <hr class="section-divider" />
                }
                @case (FieldType.Label) {
                  <p class="label-text" style="color: #64748b; font-style: italic">
                    {{ field.label }}
                  </p>
                }
                @case (FieldType.PageBreak) {
                  <div class="page-break-preview">
                    <div class="page-break-line"></div>
                    <span class="page-break-label">üìÑ Ng·∫Øt trang</span>
                    <div class="page-break-line"></div>
                  </div>
                }
                @case (FieldType.Address) {
                  <div class="address-preview">
                    @for (sub of getSubFields(field); track sub.key) {
                      <div
                        class="address-subfield"
                        [style.flex]="'0 0 ' + (sub.width || 100) + '%'"
                      >
                        <small>{{ sub.label }}</small>
                        <input type="text" disabled [placeholder]="sub.label" />
                      </div>
                    }
                    @if (getSubFields(field).length === 0) {
                      <div class="address-subfield" style="flex: 0 0 100%">
                        <small>ƒê∆∞·ªùng</small>
                        <input type="text" disabled placeholder="ƒê∆∞·ªùng / s·ªë nh√†" />
                      </div>
                      <div class="address-subfield" style="flex: 0 0 50%">
                        <small>Ph∆∞·ªùng/X√£</small>
                        <input type="text" disabled placeholder="Ph∆∞·ªùng/X√£" />
                      </div>
                      <div class="address-subfield" style="flex: 0 0 50%">
                        <small>Qu·∫≠n/Huy·ªán</small>
                        <input type="text" disabled placeholder="Qu·∫≠n/Huy·ªán" />
                      </div>
                      <div class="address-subfield" style="flex: 0 0 50%">
                        <small>T·ªânh/TP</small>
                        <input type="text" disabled placeholder="T·ªânh/TP" />
                      </div>
                      <div class="address-subfield" style="flex: 0 0 50%">
                        <small>Qu·ªëc gia</small>
                        <input type="text" disabled placeholder="Qu·ªëc gia" />
                      </div>
                    }
                  </div>
                }
                @case (FieldType.Hidden) {
                  <div class="hidden-preview" style="padding:8px;background:#f1f5f9;border-radius:6px;color:#64748b;font-style:italic;font-size:12px">
                    üëÅÔ∏è‚Äçüó®Ô∏è Tr∆∞·ªùng ·∫©n ‚Äî kh√¥ng hi·ªÉn th·ªã cho ng∆∞·ªùi d√πng
                  </div>
                }
                @case (FieldType.Slider) {
                  <input type="range" min="0" max="100" disabled style="width:100%" />
                }
                @case (FieldType.Calculated) {
                  <div style="padding:8px;background:#eff6ff;border-radius:6px;color:#3b82f6;font-size:12px">
                    üßÆ Gi√° tr·ªã t·ª± ƒë·ªông = <em>c√¥ng th·ª©c t√≠nh</em>
                  </div>
                }
                @case (FieldType.RichText) {
                  <div style="border:1px dashed #cbd5e1;border-radius:6px;padding:12px;min-height:80px;color:#94a3b8;font-size:12px">
                    üìù Tr√¨nh so·∫°n th·∫£o vƒÉn b·∫£n phong ph√∫ (WYSIWYG)
                  </div>
                }
                @case (FieldType.Signature) {
                  <div style="border:2px dashed #cbd5e1;border-radius:6px;padding:20px;text-align:center;color:#94a3b8;min-height:80px;display:flex;align-items:center;justify-content:center">
                    ‚úçÔ∏è V√πng k√Ω t√™n
                  </div>
                }
                @case (FieldType.Lookup) {
                  <div style="position:relative">
                    <input type="text" disabled placeholder="üîç T√¨m ki·∫øm..." style="width:100%" />
                  </div>
                }
                @case (FieldType.Repeater) {
                  <div style="border:1px solid #e2e8f0;border-radius:6px;padding:8px">
                    <div style="display:flex;gap:8px;margin-bottom:4px">
                      <input type="text" disabled placeholder="C·ªôt 1" style="flex:1" />
                      <input type="text" disabled placeholder="C·ªôt 2" style="flex:1" />
                    </div>
                    <button disabled style="font-size:12px;color:#3b82f6;background:none;border:none;cursor:pointer">üîÅ + Th√™m d√≤ng</button>
                  </div>
                }
                @default {
                  <input type="text" disabled [placeholder]="getFieldTypeLabel(field.fieldType)" />
                }
              }
              @if (field.helpText) {
                <small class="help-text">{{ field.helpText }}</small>
              }
            </div>
          </div>
        }
      </div>
    </main>

    <!-- Field Properties Panel -->
    @if (selectedField) {
      <aside class="properties-panel">
        <div class="panel-header">
          <h3>Thu·ªôc t√≠nh tr∆∞·ªùng</h3>
          <button class="close-btn" (click)="selectedField = null">‚úï</button>
        </div>

        <div class="panel-body">
          <div class="form-group">
            <label>Nh√£n</label>
            <input type="text" [(ngModel)]="selectedField.label" (blur)="updateField()" />

            <!-- Inline Concept Search -->
            <div class="concept-link-section">
              @if (selectedField.id && getLinkedConcept(selectedField.id)) {
                <div class="linked-concept-badge">
                  <span class="concept-tag">
                    üîó {{ getLinkedConcept(selectedField.id)!.code }}
                    <span class="concept-display">{{
                      getLinkedConcept(selectedField.id)!.display
                    }}</span>
                  </span>
                  @for (mapping of getLinkedConcept(selectedField.id)!.mappings; track mapping.id) {
                    @if (mapping.targetSystem === 'SNOMED CT') {
                      <span class="snomed-tag">SNOMED: {{ mapping.targetCode }}</span>
                    }
                  }
                  <button
                    class="remove-concept-btn"
                    (click)="unlinkConcept(selectedField)"
                    title="B·ªè li√™n k·∫øt"
                  >
                    ‚úï
                  </button>
                </div>
              } @else {
                <div class="concept-search-inline">
                  <input
                    type="text"
                    class="concept-search-input"
                    placeholder="üîç T√¨m concept y khoa..."
                    [(ngModel)]="conceptSearchTerm"
                    (input)="searchConcepts()"
                    (focus)="showConceptDropdown = true"
                  />

                  @if (showConceptDropdown && conceptSearchResults.length > 0) {
                    <div class="concept-dropdown">
                      @for (concept of conceptSearchResults; track concept.id) {
                        <div class="concept-option" (click)="selectConcept(concept)">
                          <span class="concept-code">{{ concept.code }}</span>
                          <span class="concept-name">{{ concept.display }}</span>
                          @for (mapping of concept.mappings; track mapping.id) {
                            @if (mapping.targetSystem === 'SNOMED CT') {
                              <span class="snomed-mini">SNOMED</span>
                            }
                          }
                        </div>
                      }
                    </div>
                  }

                  @if (
                    showConceptDropdown &&
                    conceptSearchTerm &&
                    conceptSearchResults.length === 0 &&
                    !isSearchingConcepts
                  ) {
                    <div class="concept-dropdown">
                      <div class="no-results">Kh√¥ng t√¨m th·∫•y concept</div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>

          <div class="form-group">
            <label>Key (ƒë·ªãnh danh)</label>
            <input type="text" [(ngModel)]="selectedField.fieldKey" (blur)="updateField()" />
          </div>

          <div class="form-group">
            <label>Placeholder</label>
            <input type="text" [(ngModel)]="selectedField.placeholder" (blur)="updateField()" />
          </div>

          <div class="form-group">
            <label>G·ª£i √Ω</label>
            <input type="text" [(ngModel)]="selectedField.helpText" (blur)="updateField()" />
          </div>

          <div class="form-group">
            <label>Gi√° tr·ªã m·∫∑c ƒë·ªãnh</label>
            <input type="text" [(ngModel)]="selectedField.defaultValue" (blur)="updateField()" />
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="selectedField.isRequired"
                (change)="updateField()"
              />
              B·∫Øt bu·ªôc
            </label>
          </div>

          <!-- Validation Rules Section -->
          <div class="section-divider">
            <span>‚úÖ Quy t·∫Øc x√°c th·ª±c</span>
          </div>

          <div class="validation-rules">
            @if (isValidationApplicable('minLength')) {
              <div class="form-group">
                <label>ƒê·ªô d√†i t·ªëi thi·ªÉu</label>
                <input
                  type="number"
                  min="0"
                  [ngModel]="getValidationValue('minLength')"
                  (blur)="setValidationRule('minLength', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: 3"
                />
              </div>
            }
            @if (isValidationApplicable('maxLength')) {
              <div class="form-group">
                <label>ƒê·ªô d√†i t·ªëi ƒëa</label>
                <input
                  type="number"
                  min="0"
                  [ngModel]="getValidationValue('maxLength')"
                  (blur)="setValidationRule('maxLength', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: 255"
                />
              </div>
            }
            @if (isValidationApplicable('min')) {
              <div class="form-group">
                <label>Gi√° tr·ªã t·ªëi thi·ªÉu</label>
                <input
                  type="number"
                  [ngModel]="getValidationValue('min')"
                  (blur)="setValidationRule('min', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: 0"
                />
              </div>
            }
            @if (isValidationApplicable('max')) {
              <div class="form-group">
                <label>Gi√° tr·ªã t·ªëi ƒëa</label>
                <input
                  type="number"
                  [ngModel]="getValidationValue('max')"
                  (blur)="setValidationRule('max', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: 100"
                />
              </div>
            }
            @if (isValidationApplicable('pattern')) {
              <div class="form-group">
                <label>M·∫´u regex</label>
                <input
                  type="text"
                  [ngModel]="getValidationValue('pattern')"
                  (blur)="setValidationRule('pattern', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: ^[A-Z].*"
                />
                <small>Bi·ªÉu th·ª©c ch√≠nh quy ƒë·ªÉ ki·ªÉm tra ƒë·ªãnh d·∫°ng</small>
              </div>
            }
            @if (isValidationApplicable('email')) {
              <div class="form-group checkbox-group">
                <label>
                  <input
                    type="checkbox"
                    [ngModel]="!!getValidationRule('email')"
                    (change)="setValidationRule('email', $any($event.target).checked || undefined)"
                  />
                  Ki·ªÉm tra email h·ª£p l·ªá
                </label>
              </div>
            }
          </div>

          @if (hasOptions(selectedField.fieldType)) {
            <div class="options-section">
              <label>C√°c l·ª±a ch·ªçn</label>
              <div class="options-list">
                @for (opt of editableOptions; track i; let i = $index) {
                  <div class="option-row">
                    <div class="option-inputs">
                      <input
                        type="text"
                        [(ngModel)]="opt.value"
                        placeholder="Value"
                        (blur)="saveOptions()"
                        class="opt-value"
                      />
                      <input
                        type="text"
                        [(ngModel)]="opt.label"
                        placeholder="Label"
                        (blur)="saveOptions()"
                        class="opt-label"
                      />
                    </div>

                    <!-- Concept Search for this option -->
                    <div class="option-concept">
                      @if (opt.conceptId) {
                        <div class="linked-concept-info">
                          <span class="concept-badge" [title]="opt.conceptCode">
                            üîó {{ opt.conceptDisplay || opt.conceptCode }}
                          </span>
                          <button
                            type="button"
                            class="unlink-btn"
                            (click)="unlinkOptionConcept(i)"
                            title="B·ªè li√™n k·∫øt"
                          >
                            ‚úï
                          </button>
                        </div>
                      } @else {
                        <div class="concept-search-wrapper">
                          <input
                            type="text"
                            class="concept-search-input"
                            placeholder="üîç T√¨m concept..."
                            [(ngModel)]="optionConceptSearch[i]"
                            (input)="searchConceptsForOption(i)"
                            (focus)="activeOptionSearchIndex = i"
                          />
                          @if (
                            activeOptionSearchIndex === i &&
                            optionConceptResults[i] &&
                            optionConceptResults[i].length > 0
                          ) {
                            <div class="concept-dropdown">
                              @for (concept of optionConceptResults[i] || []; track concept.id) {
                                <div
                                  class="concept-option"
                                  (click)="selectConceptForOption(i, concept)"
                                >
                                  <span class="concept-code">{{ concept.code }}</span>
                                  <span class="concept-name">{{ concept.display }}</span>
                                </div>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>

                    <button
                      type="button"
                      class="remove-option-btn"
                      (click)="removeOption(i)"
                      title="X√≥a"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                }
              </div>
              <button type="button" class="add-option-btn" (click)="addOption()">
                + Th√™m l·ª±a ch·ªçn
              </button>
              <small>M·ªói option c√≥ th·ªÉ li√™n k·∫øt v·ªõi Concept ƒë·ªÉ ph·ª•c v·ª• b√°o c√°o/th·ªëng k√™</small>
            </div>
          }

          @if (selectedField.fieldType === FieldType.Address) {
            <div class="options-section">
              <label>üè† C√°c tr∆∞·ªùng con (sub-fields)</label>
              <div class="options-list">
                @for (sub of editableSubFields; track i; let i = $index) {
                  <div class="option-row">
                    <div class="option-inputs">
                      <input
                        type="text"
                        [(ngModel)]="sub.key"
                        placeholder="Key (vd: street)"
                        (blur)="saveSubFields()"
                        class="opt-value"
                      />
                      <input
                        type="text"
                        [(ngModel)]="sub.label"
                        placeholder="Nh√£n"
                        (blur)="saveSubFields()"
                        class="opt-label"
                      />
                      <input
                        type="number"
                        [(ngModel)]="sub.width"
                        placeholder="%"
                        (blur)="saveSubFields()"
                        style="width: 60px"
                        min="10"
                        max="100"
                      />
                    </div>
                    <label style="font-size: 12px; margin-left: 8px">
                      <input
                        type="checkbox"
                        [(ngModel)]="sub.required"
                        (change)="saveSubFields()"
                      />
                      B·∫Øt bu·ªôc
                    </label>
                    <button
                      type="button"
                      class="remove-option-btn"
                      (click)="removeSubField(i)"
                      title="X√≥a"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                }
              </div>
              <button type="button" class="add-option-btn" (click)="addSubField()">
                + Th√™m tr∆∞·ªùng con
              </button>
              <button
                type="button"
                class="add-option-btn"
                (click)="loadDefaultAddressFields()"
                style="margin-left: 8px"
              >
                üìã M·∫∑c ƒë·ªãnh (ƒê·ªãa ch·ªâ VN)
              </button>
              <small>M·ªói sub-field c√≥ key, nh√£n, v√† ƒë·ªô r·ªông (%)</small>
            </div>
          }

          <!-- Slider config -->
          @if (selectedField.fieldType === FieldType.Slider) {
            <div class="options-section">
              <label>üéöÔ∏è C·∫•u h√¨nh thanh tr∆∞·ª£t</label>
              <div class="form-group">
                <label>Min</label>
                <input type="number" [ngModel]="getSliderConfig('min')" (blur)="setSliderConfig('min', $any($event.target).value)" />
              </div>
              <div class="form-group">
                <label>Max</label>
                <input type="number" [ngModel]="getSliderConfig('max')" (blur)="setSliderConfig('max', $any($event.target).value)" />
              </div>
              <div class="form-group">
                <label>Step</label>
                <input type="number" [ngModel]="getSliderConfig('step')" (blur)="setSliderConfig('step', $any($event.target).value)" />
              </div>
              <div class="form-group">
                <label>ƒê∆°n v·ªã</label>
                <input type="text" [ngModel]="getSliderConfig('unit')" (blur)="setSliderConfig('unit', $any($event.target).value)" placeholder="vd: kg, cm, %" />
              </div>
            </div>
          }

          <!-- Calculated field config -->
          @if (selectedField.fieldType === FieldType.Calculated) {
            <div class="options-section">
              <label>üßÆ C·∫•u h√¨nh c√¥ng th·ª©c</label>
              <div class="form-group">
                <label>C√¥ng th·ª©c</label>
                <input type="text" [ngModel]="getCalcConfig('formula')" (blur)="setCalcConfig('formula', $any($event.target).value)" [placeholder]="'vd: {weight} / ({height}/100)^2'" />
                <small>D√πng {{ '{' }}fieldKey{{ '}' }} ƒë·ªÉ tham chi·∫øu tr∆∞·ªùng kh√°c</small>
              </div>
              <div class="form-group">
                <label>S·ªë th·∫≠p ph√¢n</label>
                <input type="number" min="0" max="6" [ngModel]="getCalcConfig('decimalPlaces')" (blur)="setCalcConfig('decimalPlaces', $any($event.target).value)" />
              </div>
              <div class="form-group">
                <label>ƒê∆°n v·ªã</label>
                <input type="text" [ngModel]="getCalcConfig('unit')" (blur)="setCalcConfig('unit', $any($event.target).value)" placeholder="vd: kg/m¬≤, ml" />
              </div>
            </div>
          }

          <!-- Hidden field config -->
          @if (selectedField.fieldType === FieldType.Hidden) {
            <div class="options-section">
              <label>üëÅÔ∏è‚Äçüó®Ô∏è C·∫•u h√¨nh tr∆∞·ªùng ·∫©n</label>
              <div class="form-group">
                <label>Gi√° tr·ªã m·∫∑c ƒë·ªãnh / Token</label>
                <input type="text" [(ngModel)]="selectedField.defaultValue" (blur)="updateField()" [placeholder]="'vd: {currentUser}, {currentDate}'" />
                <small>Tokens: {{ '{' }}currentUser{{ '}' }}, {{ '{' }}currentDate{{ '}' }}, {{ '{' }}currentTime{{ '}' }}, ho·∫∑c gi√° tr·ªã c·ªë ƒë·ªãnh</small>
              </div>
            </div>
          }

          <!-- Repeater config -->
          @if (selectedField.fieldType === FieldType.Repeater) {
            <div class="options-section">
              <label>üîÅ C·∫•u h√¨nh l·∫∑p nh√≥m</label>
              <div class="form-group">
                <label>S·ªë d√≤ng t·ªëi thi·ªÉu</label>
                <input type="number" min="0" max="50" [ngModel]="getRepeaterConfig('minRows')" (blur)="setRepeaterConfig('minRows', $any($event.target).value)" />
              </div>
              <div class="form-group">
                <label>S·ªë d√≤ng t·ªëi ƒëa</label>
                <input type="number" min="1" max="100" [ngModel]="getRepeaterConfig('maxRows')" (blur)="setRepeaterConfig('maxRows', $any($event.target).value)" />
              </div>
              <label>C√°c c·ªôt</label>
              <div class="options-list">
                @for (col of getRepeaterFields(); track $index; let i = $index) {
                  <div class="option-row">
                    <div class="option-inputs">
                      <input type="text" [ngModel]="col.key" (blur)="updateRepeaterField(i, 'key', $any($event.target).value)" placeholder="Key" class="opt-value" />
                      <input type="text" [ngModel]="col.label" (blur)="updateRepeaterField(i, 'label', $any($event.target).value)" placeholder="Nh√£n" class="opt-label" />
                      <select [ngModel]="col.type" (change)="updateRepeaterField(i, 'type', $any($event.target).value)" style="width:80px">
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="date">Date</option>
                        <option value="dropdown">Dropdown</option>
                      </select>
                    </div>
                    <button type="button" class="remove-option-btn" (click)="removeRepeaterField(i)">üóëÔ∏è</button>
                  </div>
                }
              </div>
              <button type="button" class="add-option-btn" (click)="addRepeaterField()">+ Th√™m c·ªôt</button>
            </div>
          }

          <div class="section-divider">
            <span>üìê B·ªë c·ª•c</span>
          </div>

          <div class="layout-controls">
            <div class="form-group">
              <label>Chi·ªÅu r·ªông</label>
              <div class="width-buttons">
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '1'"
                  (click)="setColSpan('1')"
                  title="25%"
                >
                  ¬º
                </button>
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '2'"
                  (click)="setColSpan('2')"
                  title="50%"
                >
                  ¬Ω
                </button>
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '3'"
                  (click)="setColSpan('3')"
                  title="75%"
                >
                  ¬æ
                </button>
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '4'"
                  (click)="setColSpan('4')"
                  title="100%"
                >
                  1
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Chi·ªÅu cao</label>
              <select [(ngModel)]="selectedFieldHeight" (change)="updateFieldLayout()">
                <option value="auto">T·ª± ƒë·ªông</option>
                <option value="small">Nh·ªè (60px)</option>
                <option value="medium">V·ª´a (100px)</option>
                <option value="large">L·ªõn (150px)</option>
                <option value="xlarge">R·∫•t l·ªõn (200px)</option>
              </select>
            </div>

            <!-- Conditional Logic Section -->
            <div class="section-divider">
              <span>üîÄ Logic hi·ªÉn th·ªã</span>
            </div>

            <div class="logic-controls">
              <button
                class="btn-logic-toggle"
                [class.active]="showLogicEditor"
                (click)="toggleLogicEditor()"
              >
                {{
                  selectedField.conditionalLogicJson
                    ? '‚úÖ ƒê√£ thi·∫øt l·∫≠p logic'
                    : '+ Th√™m ƒëi·ªÅu ki·ªán hi·ªÉn th·ªã'
                }}
              </button>

              @if (showLogicEditor) {
                <div class="logic-editor">
                  <div class="logic-header">
                    <select [(ngModel)]="currentLogic.action" (change)="saveLogic()">
                      <option value="show">Hi·ªán</option>
                      <option value="hide">·∫®n</option>
                    </select>
                    <span>tr∆∞·ªùng n√†y khi:</span>
                  </div>

                  @if (currentLogic.conditions.length > 0) {
                    <div class="logic-operator">
                      <select [(ngModel)]="currentLogic.logic" (change)="saveLogic()">
                        <option value="AND">T·∫•t c·∫£ (AND)</option>
                        <option value="OR">B·∫•t k·ª≥ (OR)</option>
                      </select>
                      <span>ƒëi·ªÅu ki·ªán sau ƒë√∫ng:</span>
                    </div>
                  }

                  <div class="conditions-list">
                    @for (cond of currentLogic.conditions; track $index) {
                      <div class="condition-row">
                        <div class="condition-inputs">
                          <select
                            [(ngModel)]="cond.fieldId"
                            (change)="saveLogic()"
                            class="cond-field"
                          >
                            <option value="" disabled>-- Ch·ªçn tr∆∞·ªùng --</option>
                            @for (f of getAvailableTriggerFields(); track f.id) {
                              <option [value]="f.id">{{ f.label }}</option>
                            }
                          </select>

                          <select
                            [(ngModel)]="cond.operator"
                            (change)="saveLogic()"
                            class="cond-op"
                          >
                            <option value="eq">B·∫±ng</option>
                            <option value="neq">Kh√°c</option>
                            <option value="gt">L·ªõn h∆°n</option>
                            <option value="lt">Nh·ªè h∆°n</option>
                            <option value="contains">Ch·ª©a</option>
                          </select>

                          @if (getOptionsForCondition(cond.fieldId); as options) {
                            <select
                              [(ngModel)]="cond.value"
                              (change)="saveLogic()"
                              class="cond-val"
                            >
                              <option value="" disabled>-- Ch·ªçn gi√° tr·ªã --</option>
                              @for (opt of options; track opt.value) {
                                <option [value]="opt.value">{{ opt.label }}</option>
                              }
                            </select>
                          } @else {
                            <input
                              type="text"
                              [(ngModel)]="cond.value"
                              (blur)="saveLogic()"
                              placeholder="Gi√° tr·ªã"
                              class="cond-val"
                            />
                          }
                        </div>
                        <button class="remove-cond-btn" (click)="removeCondition($index)">
                          üóëÔ∏è
                        </button>
                      </div>
                    }
                  </div>

                  <button class="add-cond-btn" (click)="addCondition()">+ Th√™m ƒëi·ªÅu ki·ªán</button>

                  @if (getAvailableTriggerFields().length === 0) {
                    <small class="warning-text">‚ö†Ô∏è C·∫ßn c√≥ tr∆∞·ªùng ph√≠a tr√™n ƒë·ªÉ t·∫°o ƒëi·ªÅu ki·ªán.</small>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </aside>
    }
  </div>

  <!-- Concept Picker Modal -->
  <app-concept-picker
    [isOpen]="showConceptPicker"
    [fieldId]="selectedFieldForConcept?.id"
    (conceptLinked)="onConceptLinked($event)"
    (closed)="showConceptPicker = false"
  >
  </app-concept-picker>
</div>
