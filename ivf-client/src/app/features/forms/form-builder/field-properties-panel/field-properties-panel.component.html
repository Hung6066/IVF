@if (field) {
  <aside class="properties-panel">
    <div class="panel-header">
      <h3>Thu·ªôc t√≠nh tr∆∞·ªùng</h3>
      <button class="close-btn" (click)="close()">‚úï</button>
    </div>

    <!-- Tabs Navigation -->
    <div class="panel-tabs">
      <button
        class="panel-tab"
        [class.active]="activeTab === 'basic'"
        (click)="activeTab = 'basic'"
      >
        üìù C∆° b·∫£n
      </button>
      <button
        class="panel-tab"
        [class.active]="activeTab === 'validation'"
        (click)="activeTab = 'validation'"
      >
        ‚úÖ X√°c th·ª±c
      </button>
      <button
        class="panel-tab"
        [class.active]="activeTab === 'layout'"
        (click)="activeTab = 'layout'"
      >
        üìê B·ªë c·ª•c
      </button>
    </div>

    <div class="panel-body">
      <!-- ==================== TAB: C∆† B·∫¢N ==================== -->
      @if (activeTab === 'basic') {
        <div class="tab-content">
          <div class="form-group">
            <label>Nh√£n</label>
            <input type="text" [(ngModel)]="field.label" (blur)="emitUpdate()" />

            <!-- Inline Concept Search -->
            <div class="concept-link-section">
              @if (field.id && getLinkedConcept(field.id)) {
                <div class="linked-concept-badge">
                  <span class="concept-tag">
                    üîó {{ getLinkedConcept(field.id)!.code }}
                    <span class="concept-display">{{ getLinkedConcept(field.id)!.display }}</span>
                  </span>
                  @for (mapping of getLinkedConcept(field.id)!.mappings; track mapping.id) {
                    @if (mapping.targetSystem === 'SNOMED CT') {
                      <span class="snomed-tag">SNOMED: {{ mapping.targetCode }}</span>
                    }
                  }
                  <button class="remove-concept-btn" (click)="unlinkConcept()" title="B·ªè li√™n k·∫øt">
                    ‚úï
                  </button>
                </div>
              } @else {
                <div class="concept-search-inline">
                  <input
                    type="text"
                    class="concept-search-input"
                    placeholder="üîç T√¨m concept y khoa..."
                    [(ngModel)]="conceptSearchTerm"
                    (input)="searchConcepts()"
                    (focus)="showConceptDropdown = true"
                  />
                  @if (showConceptDropdown && conceptSearchResults.length > 0) {
                    <div class="concept-dropdown">
                      @for (concept of conceptSearchResults; track concept.id) {
                        <div class="concept-option" (click)="selectConcept(concept)">
                          <span class="concept-code">{{ concept.code }}</span>
                          <span class="concept-name">{{ concept.display }}</span>
                          @for (mapping of concept.mappings; track mapping.id) {
                            @if (mapping.targetSystem === 'SNOMED CT') {
                              <span class="snomed-mini">SNOMED</span>
                            }
                          }
                        </div>
                      }
                    </div>
                  }
                  @if (
                    showConceptDropdown &&
                    conceptSearchTerm &&
                    conceptSearchResults.length === 0 &&
                    !isSearchingConcepts
                  ) {
                    <div class="concept-dropdown">
                      <div class="no-results">Kh√¥ng t√¨m th·∫•y concept</div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>

          <div class="form-group">
            <label>Key (ƒë·ªãnh danh)</label>
            <input type="text" [(ngModel)]="field.fieldKey" (blur)="emitUpdate()" />
          </div>

          <div class="form-group">
            <label>Placeholder</label>
            <input type="text" [(ngModel)]="field.placeholder" (blur)="emitUpdate()" />
          </div>

          <div class="form-group">
            <label>G·ª£i √Ω</label>
            <input type="text" [(ngModel)]="field.helpText" (blur)="emitUpdate()" />
          </div>

          <div class="form-group">
            <label>Gi√° tr·ªã m·∫∑c ƒë·ªãnh</label>
            <input type="text" [(ngModel)]="field.defaultValue" (blur)="emitUpdate()" />
          </div>

          <!-- Options section for Dropdown/Radio/Checkbox/Tags/MultiSelect -->
          @if (hasOptions(field.fieldType)) {
            <div class="options-section">
              <label>C√°c l·ª±a ch·ªçn</label>
              <div class="options-list">
                @for (opt of editableOptions; track i; let i = $index) {
                  <div class="option-row">
                    <div class="option-inputs">
                      <input
                        type="text"
                        [(ngModel)]="opt.value"
                        placeholder="Value"
                        (blur)="saveOptions()"
                        class="opt-value"
                      />
                      <input
                        type="text"
                        [(ngModel)]="opt.label"
                        placeholder="Label"
                        (blur)="saveOptions()"
                        class="opt-label"
                      />
                    </div>
                    <div class="option-concept">
                      @if (opt.conceptId) {
                        <div class="linked-concept-info">
                          <span class="concept-badge" [title]="opt.conceptCode"
                            >üîó {{ opt.conceptDisplay || opt.conceptCode }}</span
                          >
                          <button
                            type="button"
                            class="unlink-btn"
                            (click)="unlinkOptionConcept(i)"
                            title="B·ªè li√™n k·∫øt"
                          >
                            ‚úï
                          </button>
                        </div>
                      } @else {
                        <div class="concept-search-wrapper">
                          <input
                            type="text"
                            class="concept-search-input"
                            placeholder="üîç T√¨m concept..."
                            [(ngModel)]="optionConceptSearch[i]"
                            (input)="searchConceptsForOption(i)"
                            (focus)="activeOptionSearchIndex = i"
                          />
                          @if (
                            activeOptionSearchIndex === i &&
                            optionConceptResults[i] &&
                            optionConceptResults[i].length > 0
                          ) {
                            <div class="concept-dropdown">
                              @for (concept of optionConceptResults[i] || []; track concept.id) {
                                <div
                                  class="concept-option"
                                  (click)="selectConceptForOption(i, concept)"
                                >
                                  <span class="concept-code">{{ concept.code }}</span>
                                  <span class="concept-name">{{ concept.display }}</span>
                                </div>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                    <button
                      type="button"
                      class="remove-option-btn"
                      (click)="removeOption(i)"
                      title="X√≥a"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                }
              </div>
              <button type="button" class="add-option-btn" (click)="addOption()">
                + Th√™m l·ª±a ch·ªçn
              </button>
              <small>M·ªói option c√≥ th·ªÉ li√™n k·∫øt v·ªõi Concept ƒë·ªÉ ph·ª•c v·ª• b√°o c√°o/th·ªëng k√™</small>
            </div>
          }

          <!-- Address sub-fields -->
          @if (field.fieldType === FieldType.Address) {
            <div class="options-section">
              <label>üè† C√°c tr∆∞·ªùng con (sub-fields)</label>
              <div class="options-list">
                @for (sub of editableSubFields; track i; let i = $index) {
                  <div class="option-row">
                    <div class="option-inputs">
                      <input
                        type="text"
                        [(ngModel)]="sub.key"
                        placeholder="Key (vd: street)"
                        (blur)="saveSubFields()"
                        class="opt-value"
                      />
                      <input
                        type="text"
                        [(ngModel)]="sub.label"
                        placeholder="Nh√£n"
                        (blur)="saveSubFields()"
                        class="opt-label"
                      />
                      <input
                        type="number"
                        [(ngModel)]="sub.width"
                        placeholder="%"
                        (blur)="saveSubFields()"
                        style="width: 60px"
                        min="10"
                        max="100"
                      />
                    </div>
                    <label style="font-size: 12px; margin-left: 8px">
                      <input
                        type="checkbox"
                        [(ngModel)]="sub.required"
                        (change)="saveSubFields()"
                      />
                      B·∫Øt bu·ªôc
                    </label>
                    <button
                      type="button"
                      class="remove-option-btn"
                      (click)="removeSubField(i)"
                      title="X√≥a"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                }
              </div>
              <button type="button" class="add-option-btn" (click)="addSubField()">
                + Th√™m tr∆∞·ªùng con
              </button>
              <button
                type="button"
                class="add-option-btn"
                (click)="loadDefaultAddressFields()"
                style="margin-left: 8px"
              >
                üìã M·∫∑c ƒë·ªãnh (ƒê·ªãa ch·ªâ VN)
              </button>
              <small>M·ªói sub-field c√≥ key, nh√£n, v√† ƒë·ªô r·ªông (%)</small>
            </div>
          }

          <!-- Slider config -->
          @if (field.fieldType === FieldType.Slider) {
            <div class="options-section">
              <label>üéöÔ∏è C·∫•u h√¨nh thanh tr∆∞·ª£t</label>
              <div class="form-group">
                <label>Min</label
                ><input
                  type="number"
                  [ngModel]="getSliderConfig('min')"
                  (blur)="setSliderConfig('min', $any($event.target).value)"
                />
              </div>
              <div class="form-group">
                <label>Max</label
                ><input
                  type="number"
                  [ngModel]="getSliderConfig('max')"
                  (blur)="setSliderConfig('max', $any($event.target).value)"
                />
              </div>
              <div class="form-group">
                <label>Step</label
                ><input
                  type="number"
                  [ngModel]="getSliderConfig('step')"
                  (blur)="setSliderConfig('step', $any($event.target).value)"
                />
              </div>
              <div class="form-group">
                <label>ƒê∆°n v·ªã</label
                ><input
                  type="text"
                  [ngModel]="getSliderConfig('unit')"
                  (blur)="setSliderConfig('unit', $any($event.target).value)"
                  placeholder="vd: kg, cm, %"
                />
              </div>
            </div>
          }

          <!-- Calculated field config -->
          @if (field.fieldType === FieldType.Calculated) {
            <div class="options-section">
              <label>üßÆ C·∫•u h√¨nh c√¥ng th·ª©c</label>
              <div class="form-group">
                <label>C√¥ng th·ª©c</label
                ><input
                  type="text"
                  [ngModel]="getCalcConfig('formula')"
                  (blur)="setCalcConfig('formula', $any($event.target).value)"
                  [placeholder]="'vd: {weight} / ({height}/100)^2'"
                /><small>D√πng {{ '{' }}fieldKey{{ '}' }} ƒë·ªÉ tham chi·∫øu tr∆∞·ªùng kh√°c</small>
              </div>
              <div class="form-group">
                <label>S·ªë th·∫≠p ph√¢n</label
                ><input
                  type="number"
                  min="0"
                  max="6"
                  [ngModel]="getCalcConfig('decimalPlaces')"
                  (blur)="setCalcConfig('decimalPlaces', $any($event.target).value)"
                />
              </div>
              <div class="form-group">
                <label>ƒê∆°n v·ªã</label
                ><input
                  type="text"
                  [ngModel]="getCalcConfig('unit')"
                  (blur)="setCalcConfig('unit', $any($event.target).value)"
                  placeholder="vd: kg/m¬≤, ml"
                />
              </div>
            </div>
          }

          <!-- Hidden field config -->
          @if (field.fieldType === FieldType.Hidden) {
            <div class="options-section">
              <label>üëÅÔ∏è‚Äçüó®Ô∏è C·∫•u h√¨nh tr∆∞·ªùng ·∫©n</label>
              <div class="form-group">
                <label>Gi√° tr·ªã m·∫∑c ƒë·ªãnh / Token</label
                ><input
                  type="text"
                  [(ngModel)]="field.defaultValue"
                  (blur)="emitUpdate()"
                  [placeholder]="'vd: {currentUser}, {currentDate}'"
                /><small
                  >Tokens: {{ '{' }}currentUser{{ '}' }}, {{ '{' }}currentDate{{ '}' }},
                  {{ '{' }}currentTime{{ '}' }}, ho·∫∑c gi√° tr·ªã c·ªë ƒë·ªãnh</small
                >
              </div>
            </div>
          }

          <!-- Repeater config -->
          @if (field.fieldType === FieldType.Repeater) {
            <div class="options-section">
              <label>üîÅ C·∫•u h√¨nh l·∫∑p nh√≥m</label>
              <div class="form-group">
                <label>S·ªë d√≤ng t·ªëi thi·ªÉu</label
                ><input
                  type="number"
                  min="0"
                  max="50"
                  [ngModel]="getRepeaterConfig('minRows')"
                  (blur)="setRepeaterConfig('minRows', $any($event.target).value)"
                />
              </div>
              <div class="form-group">
                <label>S·ªë d√≤ng t·ªëi ƒëa</label
                ><input
                  type="number"
                  min="1"
                  max="100"
                  [ngModel]="getRepeaterConfig('maxRows')"
                  (blur)="setRepeaterConfig('maxRows', $any($event.target).value)"
                />
              </div>
              <label>C√°c c·ªôt</label>
              <div class="options-list">
                @for (col of getRepeaterFields(); track $index; let i = $index) {
                  <div class="option-row">
                    <div class="option-inputs">
                      <input
                        type="text"
                        [ngModel]="col.key"
                        (blur)="updateRepeaterField(i, 'key', $any($event.target).value)"
                        placeholder="Key"
                        class="opt-value"
                      />
                      <input
                        type="text"
                        [ngModel]="col.label"
                        (blur)="updateRepeaterField(i, 'label', $any($event.target).value)"
                        placeholder="Nh√£n"
                        class="opt-label"
                      />
                      <select
                        [ngModel]="col.type"
                        (change)="updateRepeaterField(i, 'type', $any($event.target).value)"
                        style="width: 80px"
                      >
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="date">Date</option>
                        <option value="dropdown">Dropdown</option>
                      </select>
                    </div>
                    <button
                      type="button"
                      class="remove-option-btn"
                      (click)="removeRepeaterField(i)"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                }
              </div>
              <button type="button" class="add-option-btn" (click)="addRepeaterField()">
                + Th√™m c·ªôt
              </button>
            </div>
          }
        </div>
      }

      <!-- ==================== TAB: X√ÅC TH·ª∞C ==================== -->
      @if (activeTab === 'validation') {
        <div class="tab-content">
          <div class="tab-section-header">
            <span class="tab-section-icon">‚úÖ</span>
            <div>
              <h4>Quy t·∫Øc x√°c th·ª±c</h4>
              <p>Thi·∫øt l·∫≠p r√†ng bu·ªôc d·ªØ li·ªáu cho tr∆∞·ªùng</p>
            </div>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="field.isRequired" (change)="emitUpdate()" />
              B·∫Øt bu·ªôc nh·∫≠p
            </label>
          </div>

          <div class="validation-rules">
            @if (isValidationApplicable('minLength')) {
              <div class="form-group">
                <label>ƒê·ªô d√†i t·ªëi thi·ªÉu</label
                ><input
                  type="number"
                  min="0"
                  [ngModel]="getValidationValue('minLength')"
                  (blur)="setValidationRule('minLength', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: 3"
                />
              </div>
            }
            @if (isValidationApplicable('maxLength')) {
              <div class="form-group">
                <label>ƒê·ªô d√†i t·ªëi ƒëa</label
                ><input
                  type="number"
                  min="0"
                  [ngModel]="getValidationValue('maxLength')"
                  (blur)="setValidationRule('maxLength', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: 255"
                />
              </div>
            }
            @if (isValidationApplicable('min')) {
              <div class="validation-row">
                <div class="form-group">
                  <label>Gi√° tr·ªã t·ªëi thi·ªÉu</label
                  ><input
                    type="number"
                    [ngModel]="getValidationValue('min')"
                    (blur)="setValidationRule('min', $any($event.target).value)"
                    placeholder="V√≠ d·ª•: 0"
                  />
                </div>
                @if (isValidationApplicable('max')) {
                  <div class="form-group">
                    <label>Gi√° tr·ªã t·ªëi ƒëa</label
                    ><input
                      type="number"
                      [ngModel]="getValidationValue('max')"
                      (blur)="setValidationRule('max', $any($event.target).value)"
                      placeholder="V√≠ d·ª•: 100"
                    />
                  </div>
                }
              </div>
            }
            @if (isValidationApplicable('pattern')) {
              <div class="form-group">
                <label>M·∫´u regex</label
                ><input
                  type="text"
                  [ngModel]="getValidationValue('pattern')"
                  (blur)="setValidationRule('pattern', $any($event.target).value)"
                  placeholder="V√≠ d·ª•: ^[A-Z].*"
                /><small>Bi·ªÉu th·ª©c ch√≠nh quy ƒë·ªÉ ki·ªÉm tra ƒë·ªãnh d·∫°ng</small>
              </div>
            }
            @if (isValidationApplicable('email')) {
              <div class="form-group checkbox-group">
                <label
                  ><input
                    type="checkbox"
                    [ngModel]="!!getValidationRule('email')"
                    (change)="setValidationRule('email', $any($event.target).checked || undefined)"
                  />
                  Ki·ªÉm tra email h·ª£p l·ªá</label
                >
              </div>
            }
          </div>

          @if (
            !isValidationApplicable('minLength') &&
            !isValidationApplicable('maxLength') &&
            !isValidationApplicable('min') &&
            !isValidationApplicable('max') &&
            !isValidationApplicable('pattern') &&
            !isValidationApplicable('email')
          ) {
            <div class="empty-tab-message">
              <span>üì≠</span>
              <p>Lo·∫°i tr∆∞·ªùng n√†y kh√¥ng c√≥ quy t·∫Øc x√°c th·ª±c b·ªï sung</p>
            </div>
          }
        </div>
      }

      <!-- ==================== TAB: B·ªê C·ª§C ==================== -->
      @if (activeTab === 'layout') {
        <div class="tab-content">
          <div class="tab-section-header">
            <span class="tab-section-icon">üìê</span>
            <div>
              <h4>B·ªë c·ª•c & Logic</h4>
              <p>Chi·ªÅu r·ªông, chi·ªÅu cao v√† logic hi·ªÉn th·ªã</p>
            </div>
          </div>

          <div class="layout-controls">
            <div class="form-group">
              <label>Chi·ªÅu r·ªông</label>
              <div class="width-buttons">
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '1'"
                  (click)="setColSpan('1')"
                  title="25%"
                >
                  ¬º
                </button>
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '2'"
                  (click)="setColSpan('2')"
                  title="50%"
                >
                  ¬Ω
                </button>
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '3'"
                  (click)="setColSpan('3')"
                  title="75%"
                >
                  ¬æ
                </button>
                <button
                  type="button"
                  [class.active]="selectedFieldColSpan === '4'"
                  (click)="setColSpan('4')"
                  title="100%"
                >
                  1
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Chi·ªÅu cao</label>
              <select [(ngModel)]="selectedFieldHeight" (change)="updateFieldLayout()">
                <option value="auto">T·ª± ƒë·ªông</option>
                <option value="small">Nh·ªè (60px)</option>
                <option value="medium">V·ª´a (100px)</option>
                <option value="large">L·ªõn (150px)</option>
                <option value="xlarge">R·∫•t l·ªõn (200px)</option>
              </select>
            </div>
          </div>

          <!-- Conditional Logic Section -->
          <div class="logic-section-divider">
            <span class="tab-section-icon">üîÄ</span>
            <span>Logic hi·ªÉn th·ªã</span>
          </div>

          <div class="logic-controls">
            <button
              class="btn-logic-toggle"
              [class.active]="showLogicEditor"
              (click)="toggleLogicEditor()"
            >
              {{
                field.conditionalLogicJson ? '‚úÖ ƒê√£ thi·∫øt l·∫≠p logic' : '+ Th√™m ƒëi·ªÅu ki·ªán hi·ªÉn th·ªã'
              }}
            </button>

            @if (showLogicEditor) {
              <div class="logic-editor">
                <div class="logic-header">
                  <select [(ngModel)]="currentLogic.action" (change)="saveLogic()">
                    <option value="show">Hi·ªán</option>
                    <option value="hide">·∫®n</option>
                  </select>
                  <span>tr∆∞·ªùng n√†y khi:</span>
                </div>

                @if (currentLogic.conditions.length > 0) {
                  <div class="logic-operator">
                    <select [(ngModel)]="currentLogic.logic" (change)="saveLogic()">
                      <option value="AND">T·∫•t c·∫£ (AND)</option>
                      <option value="OR">B·∫•t k·ª≥ (OR)</option>
                    </select>
                    <span>ƒëi·ªÅu ki·ªán sau ƒë√∫ng:</span>
                  </div>
                }

                <div class="conditions-list">
                  @for (cond of currentLogic.conditions; track $index) {
                    <div class="condition-row">
                      <div class="condition-inputs">
                        <select
                          [(ngModel)]="cond.fieldId"
                          (change)="saveLogic()"
                          class="cond-field"
                        >
                          <option value="" disabled>-- Ch·ªçn tr∆∞·ªùng --</option>
                          @for (f of getAvailableTriggerFields(); track f.id) {
                            <option [value]="f.id">{{ f.label }}</option>
                          }
                        </select>
                        <div class="condition-op-val">
                          <select
                            [(ngModel)]="cond.operator"
                            (change)="saveLogic()"
                            class="cond-op"
                          >
                            <option value="eq">B·∫±ng</option>
                            <option value="neq">Kh√°c</option>
                            <option value="gt">L·ªõn h∆°n</option>
                            <option value="lt">Nh·ªè h∆°n</option>
                            <option value="contains">Ch·ª©a</option>
                          </select>
                          @if (getOptionsForCondition(cond.fieldId); as options) {
                            <select
                              [(ngModel)]="cond.value"
                              (change)="saveLogic()"
                              class="cond-val"
                            >
                              <option value="" disabled>-- Gi√° tr·ªã --</option>
                              @for (opt of options; track opt.value) {
                                <option [value]="opt.value">{{ opt.label }}</option>
                              }
                            </select>
                          } @else {
                            <input
                              type="text"
                              [(ngModel)]="cond.value"
                              (blur)="saveLogic()"
                              placeholder="Gi√° tr·ªã"
                              class="cond-val"
                            />
                          }
                        </div>
                      </div>
                      <button class="remove-cond-btn" (click)="removeCondition($index)">üóëÔ∏è</button>
                    </div>
                  }
                </div>

                <button class="add-cond-btn" (click)="addCondition()">+ Th√™m ƒëi·ªÅu ki·ªán</button>

                @if (getAvailableTriggerFields().length === 0) {
                  <small class="warning-text">‚ö†Ô∏è C·∫ßn c√≥ tr∆∞·ªùng ph√≠a tr√™n ƒë·ªÉ t·∫°o ƒëi·ªÅu ki·ªán.</small>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </aside>
}
