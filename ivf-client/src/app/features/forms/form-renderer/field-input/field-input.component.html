<div [formGroup]="form">
  <!-- Label -->
  @if (field.fieldType !== FieldType.Section && field.fieldType !== FieldType.Label) {
    <label class="field-label">
      {{ field.label }}
      @if (field.isRequired) {
        <span class="required">*</span>
      }
      @if (isLinked && linkedDataInfo) {
        <span
          class="linked-data-badge"
          [class.concept-link]="
            linkedDataInfo.conceptId &&
            linkedDataInfo.conceptId !== '00000000-0000-0000-0000-000000000000'
          "
          [class.config-link]="
            !linkedDataInfo.conceptId ||
            linkedDataInfo.conceptId === '00000000-0000-0000-0000-000000000000'
          "
          [title]="
            (linkedDataInfo.conceptId &&
            linkedDataInfo.conceptId !== '00000000-0000-0000-0000-000000000000'
              ? 'üß¨ Auto-link (c√πng concept) t·ª´: '
              : '‚öôÔ∏è Config-link t·ª´: ') +
            linkedDataInfo.sourceFormName +
            ' (' +
            (linkedDataInfo.capturedAt | date: 'dd/MM/yyyy') +
            ')'
          "
        >
          {{
            linkedDataInfo.conceptId &&
            linkedDataInfo.conceptId !== '00000000-0000-0000-0000-000000000000'
              ? 'üß¨'
              : '‚öôÔ∏è'
          }}
          {{ linkedDataInfo.sourceFormName }}
          <button
            type="button"
            class="linked-clear-btn"
            (click)="onClearLinkedValue()"
            title="X√≥a gi√° tr·ªã li√™n k·∫øt"
          >
            ‚úï
          </button>
        </span>
      }
    </label>
  }

  <!-- Field Input -->
  @switch (field.fieldType) {
    @case (FieldType.Text) {
      <input
        type="text"
        [formControlName]="field.id"
        [placeholder]="field.placeholder || ''"
        [style.height]="getHeight()"
        class="form-input"
      />
    }
    @case (FieldType.TextArea) {
      <textarea
        [formControlName]="field.id"
        [placeholder]="field.placeholder || ''"
        [style.height]="getHeight()"
        [style.min-height]="getHeight()"
        class="form-textarea"
      ></textarea>
    }
    @case (FieldType.Number) {
      <input
        type="number"
        [formControlName]="field.id"
        [placeholder]="field.placeholder || ''"
        class="form-input"
      />
    }
    @case (FieldType.Decimal) {
      <input
        type="number"
        step="0.01"
        [formControlName]="field.id"
        [placeholder]="field.placeholder || ''"
        class="form-input"
      />
    }
    @case (FieldType.Date) {
      <input type="date" [formControlName]="field.id" class="form-input" />
    }
    @case (FieldType.DateTime) {
      <input type="datetime-local" [formControlName]="field.id" class="form-input" />
    }
    @case (FieldType.Time) {
      <input type="time" [formControlName]="field.id" class="form-input" />
    }
    @case (FieldType.Dropdown) {
      <select [formControlName]="field.id" class="form-select">
        <option value="">-- Ch·ªçn --</option>
        @for (opt of getOptions(field); track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    }
    @case (FieldType.MultiSelect) {
      <select [formControlName]="field.id" class="form-select" multiple>
        @for (opt of getOptions(field); track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    }
    @case (FieldType.Radio) {
      <div class="radio-group">
        @for (opt of getOptions(field); track opt.value) {
          <label class="radio-option">
            <input type="radio" [formControlName]="field.id" [value]="opt.value" />
            <span>{{ opt.label }}</span>
          </label>
        }
      </div>
    }
    @case (FieldType.Checkbox) {
      @if (getOptions(field).length > 0) {
        <div class="checkbox-group">
          @for (opt of getOptions(field); track opt.value) {
            <label class="checkbox-option">
              <input
                type="checkbox"
                [checked]="isCheckboxChecked(opt.value)"
                (change)="onCheckboxChange(opt.value, $event)"
              />
              <span>{{ opt.label }}</span>
            </label>
          }
        </div>
      } @else {
        <label class="checkbox-option">
          <input type="checkbox" [formControlName]="field.id" />
          <span>{{ field.placeholder || field.label }}</span>
        </label>
      }
    }
    @case (FieldType.Rating) {
      <div class="rating-input">
        @for (star of [1, 2, 3, 4, 5]; track star) {
          <button
            type="button"
            class="star-btn"
            [class.active]="form.get(field.id)?.value >= star"
            (click)="setRating(star)"
          >
            ‚≠ê
          </button>
        }
      </div>
    }
    @case (FieldType.Section) {
      <div class="section-header">
        <h3>{{ field.label }}</h3>
        @if (field.helpText) {
          <p>{{ field.helpText }}</p>
        }
      </div>
    }
    @case (FieldType.Label) {
      <div class="label-field">
        <p>{{ field.label }}</p>
      </div>
    }
    @case (FieldType.FileUpload) {
      <input type="file" (change)="onFileChange($event)" class="form-file" />
    }
    @case (FieldType.Tags) {
      <div class="mention-input-wrapper">
        <div
          class="mention-editor"
          #mentionEditor
          contenteditable="true"
          [attr.data-placeholder]="'Nh·∫≠p text v√† g√µ @ ƒë·ªÉ ch√®n concept tag...'"
          (input)="onContentEditableInput($event)"
          (keydown)="onContentEditableKeydown($event)"
          (blur)="onMentionBlur()"
        ></div>

        @if (showMentionDropdown) {
          <div class="mention-dropdown">
            @for (concept of mentionSearchResults; track concept.id) {
              <div class="mention-dropdown-item" (mousedown)="insertMentionTag(concept)">
                <span class="mention-code">{{ concept.code }}</span>
                <span class="mention-name">{{ concept.name }}</span>
              </div>
            }
            @if (mentionSearchResults.length === 0) {
              <div class="mention-dropdown-empty">Kh√¥ng t√¨m th·∫•y concept</div>
            }
          </div>
        }
      </div>
    }
    @case (FieldType.Address) {
      <div class="address-field" [formGroupName]="field.id">
        @for (sub of getAddrSubFields(); track sub.key) {
          <div
            class="address-subfield"
            [style.flex]="'0 0 calc(' + (sub.width || 100) + '% - 8px)'"
          >
            <small>
              {{ sub.label }}
              @if (sub.required) {
                <span class="required">*</span>
              }
            </small>
            <input
              type="text"
              [formControlName]="sub.key"
              [placeholder]="sub.label"
              class="form-input"
            />
          </div>
        }
      </div>
    }
    @case (FieldType.Hidden) {
      <!-- Hidden field: not visible to user -->
    }
    @case (FieldType.Slider) {
      <div class="slider-field">
        <input
          type="range"
          [formControlName]="field.id"
          [min]="getSliderCfg().min"
          [max]="getSliderCfg().max"
          [step]="getSliderCfg().step"
          class="form-slider"
          (input)="onSliderChange($event)"
        />
        <div class="slider-labels">
          <span>{{ getSliderCfg().min }}</span>
          <strong class="slider-value">{{ getSliderDisplayValue() }}</strong>
          <span>{{ getSliderCfg().max }}</span>
        </div>
      </div>
    }
    @case (FieldType.Calculated) {
      <div class="calculated-field">
        <div class="calculated-value">üßÆ {{ form.get(field.id)?.value || 'ƒêang t√≠nh...' }}</div>
      </div>
    }
    @case (FieldType.RichText) {
      <div
        class="richtext-field"
        contenteditable="true"
        [innerHTML]="form.get(field.id)?.value || ''"
        (input)="form.get(field.id)?.setValue($any($event.target).innerHTML)"
        [attr.data-placeholder]="field.placeholder || 'Nh·∫≠p n·ªôi dung...'"
        class="form-richtext"
      ></div>
    }
    @case (FieldType.Signature) {
      <div class="signature-field">
        <canvas
          #signatureCanvas
          width="400"
          height="150"
          class="signature-canvas"
          (mousedown)="initSignatureCanvas()"
        ></canvas>
        <div class="signature-actions">
          <button type="button" class="btn-clear-sig" (click)="clearSignature()">
            üóëÔ∏è X√≥a ch·ªØ k√Ω
          </button>
          @if (form.get(field.id)?.value) {
            <span class="sig-status">‚úÖ ƒê√£ k√Ω</span>
          }
        </div>
      </div>
    }
    @case (FieldType.Lookup) {
      <div class="lookup-field">
        <div class="lookup-input-wrapper">
          <input
            type="text"
            class="form-input"
            [(ngModel)]="lookupSearchQuery"
            [ngModelOptions]="{ standalone: true }"
            (input)="searchLookupOptions()"
            (focus)="onLookupFocus()"
            (blur)="onLookupBlur()"
            [placeholder]="field.placeholder || 'üîç T√¨m ki·∫øm...'"
          />
          @if (lookupActive && lookupResults.length) {
            <div class="lookup-dropdown">
              @for (opt of lookupResults; track opt.value) {
                <div class="lookup-option" (mousedown)="selectLookupOption(opt)">
                  {{ opt.label }}
                </div>
              }
            </div>
          }
        </div>
        @if (form.get(field.id)?.value) {
          <div class="lookup-selected">‚úÖ {{ getLookupDisplayLabel() }}</div>
        }
      </div>
    }
    @case (FieldType.Repeater) {
      <div class="repeater-field">
        <table class="repeater-table">
          <thead>
            <tr>
              @for (col of getRepeaterCfg().fields; track col.key) {
                <th>{{ col.label }}</th>
              }
              <th style="width: 40px"></th>
            </tr>
          </thead>
          <tbody>
            @for (row of repeaterRows; track $index; let ri = $index) {
              <tr>
                @for (col of getRepeaterCfg().fields; track col.key) {
                  <td>
                    @if (col.type === 'number') {
                      <input
                        type="number"
                        [(ngModel)]="$any(row)[col.key]"
                        [ngModelOptions]="{ standalone: true }"
                        (input)="onRepeaterCellChange()"
                        class="form-input"
                      />
                    } @else if (col.type === 'date') {
                      <input
                        type="date"
                        [(ngModel)]="$any(row)[col.key]"
                        [ngModelOptions]="{ standalone: true }"
                        (input)="onRepeaterCellChange()"
                        class="form-input"
                      />
                    } @else {
                      <input
                        type="text"
                        [(ngModel)]="$any(row)[col.key]"
                        [ngModelOptions]="{ standalone: true }"
                        (input)="onRepeaterCellChange()"
                        class="form-input"
                      />
                    }
                  </td>
                }
                <td>
                  <button
                    type="button"
                    class="btn-remove-row"
                    (click)="removeRepeaterRow(ri)"
                    title="X√≥a d√≤ng"
                  >
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
        @if ((repeaterRows.length || 0) < getRepeaterCfg().maxRows) {
          <button type="button" class="btn-add-row" (click)="addRepeaterRow()">+ Th√™m d√≤ng</button>
        }
      </div>
    }
  }

  <!-- Help text -->
  @if (field.helpText && field.fieldType !== FieldType.Section) {
    <small class="help-text">{{ field.helpText }}</small>
  }

  <!-- Validation errors -->
  @if (hasError()) {
    @for (err of getFieldErrors(); track err) {
      <small class="error-text">{{ err }}</small>
    }
  }
</div>
