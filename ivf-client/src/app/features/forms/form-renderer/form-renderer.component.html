<div class="form-renderer-container">
  @if (template) {
    <div class="form-card">
      <div class="form-header">
        <h1>{{ template.name }}</h1>
        @if (template.description) {
          <p class="description">{{ template.description }}</p>
        }
      </div>

      <!-- Patient context bar -->
      <app-patient-context-bar
        [selectedPatient]="selectedPatient"
        [linkedData]="linkedData"
        [patientSearchQuery]="patientSearchQuery"
        [patientSearchResults]="patientSearchResults"
        [showPatientDropdown]="showPatientDropdown"
        (searchInput)="onPatientSearchInput($event)"
        (patientSelected)="selectPatient($event)"
        (patientCleared)="clearPatient()"
        (dropdownHidden)="hidePatientDropdown()"
      />

      <form [formGroup]="form" (ngSubmit)="submit()">
        <!-- Multi-page progress bar -->
        @if (isMultiPage) {
          <div class="page-progress">
            <div class="progress-steps">
              @for (page of pages; track $index) {
                <button
                  type="button"
                  class="step-dot"
                  [class.active]="$index === currentPageIndex"
                  [class.completed]="$index < currentPageIndex"
                  (click)="goToPage($index)"
                  [title]="'Trang ' + ($index + 1)"
                >
                  {{ $index + 1 }}
                </button>
                @if ($index < pages.length - 1) {
                  <div class="step-connector" [class.completed]="$index < currentPageIndex"></div>
                }
              }
            </div>
            <div class="progress-info">Trang {{ currentPageIndex + 1 }} / {{ totalPages }}</div>
          </div>
        }

        <div class="form-fields-grid">
          @for (field of isMultiPage ? currentPageFields : fields; track field.id) {
            @if (isFieldVisible(field.id)) {
              <app-field-input
                [field]="field"
                [form]="form"
                [isLinked]="isLinkedField(field.id)"
                [linkedDataInfo]="getLinkedDataInfo(field.id)"
                (fileChanged)="onFieldFileChanged($event)"
                (linkedValueCleared)="clearLinkedValue($event)"
              />
            }
          }
        </div>

        <!-- Entry Preview / Review Step -->
        @if (showReview) {
          <app-form-review
            [fields]="fields"
            [form]="form"
            [fileValues]="fileValues"
            (editClicked)="showReview = false"
          />
        }

        <app-form-actions-bar
          [isMultiPage]="isMultiPage"
          [isFirstPage]="isFirstPage"
          [isLastPage]="isLastPage"
          [isEditMode]="isEditMode"
          [isSubmitting]="isSubmitting"
          [showReview]="showReview"
          [autoSaveEnabled]="autoSaveEnabled"
          [autoSaveStatus]="autoSaveStatus"
          [lastAutoSavedAt]="lastAutoSavedAt"
          (cancelClicked)="cancel()"
          (saveDraftClicked)="saveDraftToDb()"
          (prevPageClicked)="prevPage()"
          (nextPageClicked)="nextPage()"
          (toggleReviewClicked)="toggleReview()"
          (clearDraftClicked)="clearDraft()"
          (submitClicked)="submit()"
        />
      </form>
    </div>
  } @else {
    <div class="loading">
      <div class="spinner-large"></div>
      <p>Đang tải biểu mẫu...</p>
    </div>
  }
</div>
