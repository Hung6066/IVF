<div class="conv-container">
  <!-- Progress bar -->
  <div class="conv-progress-bar">
    <div class="conv-progress-fill" [style.width.%]="progress"></div>
  </div>

  @if (template) {
    <!-- Completion screen -->
    @if (isComplete) {
      <div class="conv-complete">
        <div class="complete-icon">üéâ</div>
        <h2>G·ª≠i th√†nh c√¥ng!</h2>
        <p>
          C·∫£m ∆°n b·∫°n ƒë√£ ho√†n th√†nh bi·ªÉu m·∫´u <strong>{{ template.name }}</strong
          >.
        </p>
        <div class="complete-actions">
          <button class="conv-btn conv-btn-primary" (click)="goToResponses()">
            üìä Xem ph·∫£n h·ªìi
          </button>
          <button class="conv-btn conv-btn-ghost" (click)="goToForms()">‚Üê V·ªÅ danh s√°ch</button>
        </div>
      </div>
    }

    <!-- Review screen -->
    @else if (showReview) {
      <div class="conv-review" [class.entering]="animationState === 'entering'">
        <div class="conv-review-header">
          <h2>üìã Xem l·∫°i c√¢u tr·∫£ l·ªùi</h2>
          <p>Ki·ªÉm tra l·∫°i tr∆∞·ªõc khi g·ª≠i</p>
        </div>
        <div class="review-list">
          @for (cf of chatFields; track cf.field.id; let i = $index) {
            <div class="review-item" (click)="goToField(i)">
              <div class="review-label">{{ cf.field.label }}</div>
              <div class="review-value">{{ cf.answer || getDisplayAnswer(cf) }}</div>
              <span class="review-edit">‚úèÔ∏è</span>
            </div>
          }
        </div>
        <div class="conv-review-actions">
          <button class="conv-btn conv-btn-ghost" (click)="prev()">‚Üê Quay l·∫°i</button>
          <button
            class="conv-btn conv-btn-primary conv-btn-submit"
            (click)="submit()"
            [disabled]="isSubmitting"
          >
            @if (isSubmitting) {
              <span class="conv-spinner"></span> ƒêang g·ª≠i...
            } @else {
              üöÄ G·ª≠i ph·∫£n h·ªìi
            }
          </button>
        </div>
      </div>
    }

    <!-- Conversational field -->
    @else if (currentChatField) {
      <div class="conv-chat-area">
        <!-- Previous answers (scrollable history) -->
        <div class="conv-history">
          @for (cf of answeredFields; track cf.field.id; let i = $index) {
            <div class="conv-bubble-row">
              <div class="conv-bubble conv-bubble-question">
                <span class="bubble-number">{{ i + 1 }}</span>
                {{ cf.field.label }}
              </div>
              <div class="conv-bubble conv-bubble-answer">
                {{ cf.answer }}
              </div>
            </div>
          }
        </div>

        <!-- Current question -->
        <div
          class="conv-current"
          [class.entering]="animationState === 'entering'"
          [class.exiting]="animationState === 'exiting'"
        >
          <div class="conv-question">
            <div class="conv-question-number">{{ currentIndex + 1 }} / {{ chatFields.length }}</div>
            <h2 class="conv-question-text">
              {{ currentChatField.field.label }}
              @if (currentChatField.field.isRequired) {
                <span class="conv-required">*</span>
              }
            </h2>
            @if (currentChatField.field.helpText) {
              <p class="conv-help">{{ currentChatField.field.helpText }}</p>
            }
            @if (currentChatField.field.placeholder) {
              <p class="conv-placeholder-hint">{{ currentChatField.field.placeholder }}</p>
            }
          </div>

          <div class="conv-field-input">
            @switch (currentChatField.field.fieldType) {
              @case (FieldType.Text) {
                <input
                  type="text"
                  class="conv-input"
                  [formControl]="$any(currentChatField.control)"
                  [placeholder]="currentChatField.field.placeholder || 'Nh·∫≠p c√¢u tr·∫£ l·ªùi...'"
                  autocomplete="off"
                />
              }
              @case (FieldType.TextArea) {
                <textarea
                  class="conv-textarea"
                  [formControl]="$any(currentChatField.control)"
                  [placeholder]="currentChatField.field.placeholder || 'Nh·∫≠p n·ªôi dung...'"
                  rows="4"
                ></textarea>
              }
              @case (FieldType.Number) {
                <input
                  type="number"
                  class="conv-input"
                  [formControl]="$any(currentChatField.control)"
                  [placeholder]="currentChatField.field.placeholder || '0'"
                />
              }
              @case (FieldType.Decimal) {
                <input
                  type="number"
                  step="0.01"
                  class="conv-input"
                  [formControl]="$any(currentChatField.control)"
                  [placeholder]="currentChatField.field.placeholder || '0.00'"
                />
              }
              @case (FieldType.Date) {
                <input
                  type="date"
                  class="conv-input"
                  [formControl]="$any(currentChatField.control)"
                />
              }
              @case (FieldType.DateTime) {
                <input
                  type="datetime-local"
                  class="conv-input"
                  [formControl]="$any(currentChatField.control)"
                />
              }
              @case (FieldType.Time) {
                <input
                  type="time"
                  class="conv-input"
                  [formControl]="$any(currentChatField.control)"
                />
              }
              @case (FieldType.Dropdown) {
                <div class="conv-options-list">
                  @for (opt of getOptions(currentChatField.field); track opt.value) {
                    <button
                      type="button"
                      class="conv-option-btn"
                      [class.selected]="currentChatField.control.value === opt.value"
                      (click)="$any(currentChatField.control).setValue(opt.value)"
                    >
                      <span class="option-check">{{
                        currentChatField.control.value === opt.value ? '‚óè' : '‚óã'
                      }}</span>
                      {{ opt.label }}
                    </button>
                  }
                </div>
              }
              @case (FieldType.Radio) {
                <div class="conv-options-list">
                  @for (opt of getOptions(currentChatField.field); track opt.value) {
                    <button
                      type="button"
                      class="conv-option-btn"
                      [class.selected]="currentChatField.control.value === opt.value"
                      (click)="$any(currentChatField.control).setValue(opt.value)"
                    >
                      <span class="option-check">{{
                        currentChatField.control.value === opt.value ? '‚óè' : '‚óã'
                      }}</span>
                      {{ opt.label }}
                    </button>
                  }
                </div>
              }
              @case (FieldType.MultiSelect) {
                <div class="conv-options-list multi">
                  @for (opt of getOptions(currentChatField.field); track opt.value) {
                    <button
                      type="button"
                      class="conv-option-btn"
                      [class.selected]="isCheckboxChecked(currentChatField, opt.value)"
                      (click)="onCheckboxChange(currentChatField, opt.value, $event)"
                    >
                      <span class="option-check">{{
                        isCheckboxChecked(currentChatField, opt.value) ? '‚òë' : '‚òê'
                      }}</span>
                      {{ opt.label }}
                    </button>
                  }
                </div>
              }
              @case (FieldType.Checkbox) {
                @if (getOptions(currentChatField.field).length > 0) {
                  <div class="conv-options-list multi">
                    @for (opt of getOptions(currentChatField.field); track opt.value) {
                      <button
                        type="button"
                        class="conv-option-btn"
                        [class.selected]="isCheckboxChecked(currentChatField, opt.value)"
                        (click)="onCheckboxChange(currentChatField, opt.value, $event)"
                      >
                        <span class="option-check">{{
                          isCheckboxChecked(currentChatField, opt.value) ? '‚òë' : '‚òê'
                        }}</span>
                        {{ opt.label }}
                      </button>
                    }
                  </div>
                } @else {
                  <div class="conv-options-list">
                    <button
                      type="button"
                      class="conv-option-btn"
                      [class.selected]="currentChatField.control.value === true"
                      (click)="$any(currentChatField.control).setValue(true)"
                    >
                      <span class="option-check">{{
                        currentChatField.control.value === true ? '‚óè' : '‚óã'
                      }}</span>
                      C√≥
                    </button>
                    <button
                      type="button"
                      class="conv-option-btn"
                      [class.selected]="currentChatField.control.value === false"
                      (click)="$any(currentChatField.control).setValue(false)"
                    >
                      <span class="option-check">{{
                        currentChatField.control.value === false ? '‚óè' : '‚óã'
                      }}</span>
                      Kh√¥ng
                    </button>
                  </div>
                }
              }
              @case (FieldType.Rating) {
                <div class="conv-rating">
                  @for (star of [1, 2, 3, 4, 5]; track star) {
                    <button
                      type="button"
                      class="conv-star"
                      [class.active]="currentChatField.control.value >= star"
                      (click)="setRating(currentChatField, star)"
                    >
                      ‚≠ê
                    </button>
                  }
                </div>
              }
              @case (FieldType.FileUpload) {
                <div class="conv-file">
                  <input
                    type="file"
                    (change)="onFileChange($event, currentChatField)"
                    class="conv-file-input"
                    id="conv-file"
                  />
                  <label for="conv-file" class="conv-file-label"> üìÅ Ch·ªçn file </label>
                  @if (fileValues[currentChatField.field.id]) {
                    <span class="conv-file-name">{{
                      fileValues[currentChatField.field.id].name
                    }}</span>
                  }
                </div>
              }
              @case (FieldType.Tags) {
                <input
                  type="text"
                  class="conv-input"
                  [formControl]="$any(currentChatField.control)"
                  placeholder="Nh·∫≠p tags, ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y..."
                />
              }
              @case (FieldType.Address) {
                <div class="conv-address" [formGroup]="$any(currentChatField.control)">
                  @for (sub of getAddressSubFields(currentChatField.field); track sub.key) {
                    <div class="conv-address-field">
                      <label
                        >{{ sub.label }}
                        @if (sub.required) {
                          <span class="conv-required">*</span>
                        }
                      </label>
                      <input
                        type="text"
                        class="conv-input"
                        [formControlName]="sub.key"
                        [placeholder]="sub.label"
                      />
                    </div>
                  }
                </div>
              }
              @case (FieldType.Slider) {
                <div class="conv-slider-field">
                  <input
                    type="range"
                    class="conv-slider"
                    [min]="getSliderConfig(currentChatField.field).min"
                    [max]="getSliderConfig(currentChatField.field).max"
                    [step]="getSliderConfig(currentChatField.field).step"
                    [value]="currentChatField.control.value"
                    (input)="onSliderChange(currentChatField, $event)"
                  />
                  <div class="conv-slider-labels">
                    <span>{{ getSliderConfig(currentChatField.field).min }}</span>
                    <span class="conv-slider-value">{{ currentChatField.control.value }}{{ getSliderConfig(currentChatField.field).unit ? ' ' + getSliderConfig(currentChatField.field).unit : '' }}</span>
                    <span>{{ getSliderConfig(currentChatField.field).max }}</span>
                  </div>
                </div>
              }
              @case (FieldType.RichText) {
                <textarea
                  class="conv-textarea"
                  [formControl]="$any(currentChatField.control)"
                  [placeholder]="currentChatField.field.placeholder || 'Nh·∫≠p n·ªôi dung vƒÉn b·∫£n...'"
                  rows="5"
                ></textarea>
              }
              @case (FieldType.Signature) {
                <div class="conv-signature-field">
                  <canvas
                    class="conv-signature-canvas"
                    width="400"
                    height="150"
                    (mousedown)="initSignatureCanvas(currentChatField, $event)"
                    (mousemove)="drawSignature(currentChatField, $event)"
                    (mouseup)="endSignatureDraw(currentChatField)"
                    (mouseleave)="endSignatureDraw(currentChatField)"
                    (touchstart)="initSignatureCanvas(currentChatField, $event)"
                    (touchmove)="drawSignature(currentChatField, $event)"
                    (touchend)="endSignatureDraw(currentChatField)"
                  ></canvas>
                  <div class="conv-signature-actions">
                    <button type="button" class="conv-btn conv-btn-ghost" (click)="clearSignature(currentChatField)">üóëÔ∏è X√≥a ch·ªØ k√Ω</button>
                    @if (currentChatField.control.value) {
                      <span class="conv-sig-status">‚úÖ ƒê√£ k√Ω</span>
                    }
                  </div>
                </div>
              }
              @case (FieldType.Lookup) {
                <div class="conv-lookup-field">
                  <input
                    type="text"
                    class="conv-input"
                    [value]="lookupSearchQueries[currentChatField.field.id] || getLookupDisplayLabel(currentChatField)"
                    (input)="searchLookupOptions(currentChatField, $any($event.target).value)"
                    placeholder="üîç T√¨m ki·∫øm..."
                    autocomplete="off"
                  />
                  @if (lookupSearchResults[currentChatField.field.id]?.length) {
                    <div class="conv-lookup-dropdown">
                      @for (opt of lookupSearchResults[currentChatField.field.id]; track opt.value) {
                        <button type="button" class="conv-lookup-option" (click)="selectLookupOption(currentChatField, opt)">
                          {{ opt.label }}
                        </button>
                      }
                    </div>
                  }
                  @if (currentChatField.control.value) {
                    <div class="conv-lookup-selected">‚úÖ {{ getLookupDisplayLabel(currentChatField) }}</div>
                  }
                </div>
              }
            }

            <!-- Errors -->
            @if (hasError(currentChatField)) {
              <div class="conv-errors">
                @for (err of getErrors(currentChatField); track err) {
                  <span class="conv-error">‚ö†Ô∏è {{ err }}</span>
                }
              </div>
            }
          </div>

          <!-- Navigation -->
          <div class="conv-nav">
            @if (currentIndex > 0) {
              <button type="button" class="conv-btn conv-btn-ghost" (click)="prev()">
                ‚Üê Quay l·∫°i
              </button>
            } @else {
              <button type="button" class="conv-btn conv-btn-ghost" (click)="cancel()">
                ‚úï H·ªßy
              </button>
            }

            <button type="button" class="conv-btn conv-btn-primary" (click)="next()">
              @if (currentIndex === chatFields.length - 1) {
                Xem l·∫°i ‚Üí
              } @else {
                Ti·∫øp t·ª•c ‚Üí
              }
            </button>
          </div>

          @if (showKeyHint) {
            <div class="conv-key-hint">Nh·∫•n <kbd>Enter ‚Üµ</kbd> ƒë·ªÉ ti·∫øp t·ª•c</div>
          }
        </div>
      </div>
    }
  } @else {
    <div class="conv-loading">
      <div class="conv-spinner-lg"></div>
      <p>ƒêang t·∫£i bi·ªÉu m·∫´u...</p>
    </div>
  }

  <!-- Top bar -->
  <div class="conv-top-bar">
    <button class="conv-close" (click)="cancel()" title="ƒê√≥ng">‚úï</button>
    @if (template) {
      <span class="conv-title">{{ template.name }}</span>
    }
    <span class="conv-progress-text">{{ progress }}%</span>
  </div>
</div>
