<div class="linked-field-config-overlay" *ngIf="isOpen" (click)="close()">
  <div class="linked-field-config-panel" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="panel-header">
      <div class="header-title">
        <span class="header-icon">ğŸ”—</span>
        <h3>Cáº¥u hÃ¬nh liÃªn káº¿t dá»¯ liá»‡u</h3>
      </div>
      <p class="header-desc">LiÃªn káº¿t trÆ°á»ng dá»¯ liá»‡u tá»« form khÃ¡c sang form nÃ y</p>
      <button class="close-btn" (click)="close()" title="ÄÃ³ng">âœ•</button>
    </div>

    <!-- Body -->
    <div class="panel-body">
      <!-- Auto-link rule explanation -->
      <div class="auto-link-info">
        <div class="info-card concept-auto">
          <div class="info-icon">ğŸ§¬</div>
          <div class="info-content">
            <strong>Tá»± Ä‘á»™ng theo Concept</strong>
            <p>TrÆ°á»ng cÃ³ cÃ¹ng <b>Concept y khoa</b> sáº½ tá»± Ä‘á»™ng liÃªn káº¿t dá»¯ liá»‡u giá»¯a cÃ¡c form â€” khÃ´ng cáº§n cáº¥u hÃ¬nh.</p>
          </div>
        </div>
        <div class="info-card config-manual">
          <div class="info-icon">âš™ï¸</div>
          <div class="info-content">
            <strong>Cáº¥u hÃ¬nh thá»§ cÃ´ng</strong>
            <p>CÃ¡c trÆ°á»ng <b>khÃ´ng cÃ³ concept</b> hoáº·c cáº§n liÃªn káº¿t Ä‘áº·c biá»‡t â†’ thÃªm liÃªn káº¿t bÃªn dÆ°á»›i.</p>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading-state" *ngIf="isLoading">
        <div class="spinner"></div>
        <span>Äang táº£i...</span>
      </div>

      <!-- Existing links grouped by target field -->
      <div class="links-section" *ngIf="!isLoading">
        <!-- Concept auto-linked fields summary -->
        <div class="concept-fields-summary" *ngIf="getConceptLinkedFields().length > 0">
          <div class="section-title">
            <span>ğŸ§¬ Auto-link (cÃ¹ng Concept)</span>
            <span class="badge auto">{{ getConceptLinkedFields().length }}</span>
          </div>
          <div class="auto-link-list">
            <div class="auto-link-item" *ngFor="let f of getConceptLinkedFields()">
              <span class="field-label">{{ f.label }}</span>
              <span class="concept-tag">{{ f.conceptId }}</span>
            </div>
          </div>
        </div>

        <div class="section-title">
          <span>âš™ï¸ LiÃªn káº¿t cáº¥u hÃ¬nh</span>
          <span class="badge">{{ linkedSources.length }}</span>
        </div>

        <!-- Empty state -->
        <div class="empty-state" *ngIf="linkedSources.length === 0 && !showAddForm">
          <div class="empty-icon">ğŸ“­</div>
          <p>ChÆ°a cÃ³ liÃªn káº¿t nÃ o</p>
          <small>ThÃªm liÃªn káº¿t Ä‘á»ƒ tá»± Ä‘á»™ng Ä‘iá»n dá»¯ liá»‡u tá»« form khÃ¡c</small>
        </div>

        <!-- Grouped links -->
        <div class="field-group" *ngFor="let group of getLinkedSourcesByField()">
          <div class="field-group-header">
            <span class="field-name">ğŸ¯ {{ group.fieldLabel }}</span>
            <span class="link-count">{{ group.sources.length }} liÃªn káº¿t</span>
          </div>

          <div class="source-item" *ngFor="let source of group.sources">
            <div class="source-info">
              <div class="source-path">
                <span class="source-template">{{ source.sourceTemplateName }}</span>
                <span class="arrow">â†’</span>
                <span class="source-field">{{ source.sourceFieldLabel }}</span>
              </div>
              <div class="source-meta">
                <span class="flow-badge" [attr.data-flow]="source.flowType">
                  {{ getFlowTypeIcon(source.flowType) }} {{ getFlowTypeLabel(source.flowType) }}
                </span>
                <span class="priority-badge" *ngIf="source.priority > 0">
                  P{{ source.priority }}
                </span>
                <span class="description-text" *ngIf="source.description">
                  {{ source.description }}
                </span>
              </div>
            </div>
            <div class="source-actions">
              <button class="action-btn edit-btn" (click)="editLink(source)" title="Sá»­a">
                âœï¸
              </button>
              <button class="action-btn delete-btn" (click)="deleteLink(source)" title="XÃ³a">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        </div>

        <!-- Add button -->
        <button class="add-link-btn" *ngIf="!showAddForm" (click)="openAddForm()">
          <span class="plus-icon">+</span>
          ThÃªm liÃªn káº¿t má»›i
        </button>
      </div>

      <!-- Add/Edit form -->
      <div class="add-form" *ngIf="showAddForm">
        <div class="form-title">
          {{ editingLinkId ? 'âœï¸ Chá»‰nh sá»­a liÃªn káº¿t' : 'â• ThÃªm liÃªn káº¿t má»›i' }}
        </div>

        <!-- Target field -->
        <div class="form-group">
          <label>ğŸ¯ TrÆ°á»ng Ä‘Ã­ch (nháº­n dá»¯ liá»‡u)</label>
          <select [(ngModel)]="newLink.targetFieldId" [disabled]="!!editingLinkId">
            <option value="">-- Chá»n trÆ°á»ng Ä‘Ã­ch --</option>
            <option *ngFor="let field of getTargetFields()" [value]="field.id">
              {{ field.label }} ({{ getFieldTypeLabel(field.fieldType) }})
            </option>
          </select>
        </div>

        <!-- Source template -->
        <div class="form-group">
          <label>ğŸ“‹ Form nguá»“n</label>
          <select [(ngModel)]="newLink.sourceTemplateId" (ngModelChange)="onSourceTemplateChange()">
            <option value="">-- Chá»n form nguá»“n --</option>
            <option *ngFor="let tmpl of getAvailableSourceTemplates()" [value]="tmpl.id">
              {{ tmpl.name }}
            </option>
          </select>
        </div>

        <!-- Source field -->
        <div class="form-group" *ngIf="newLink.sourceTemplateId">
          <label>ğŸ“ TrÆ°á»ng nguá»“n (láº¥y dá»¯ liá»‡u tá»«)</label>
          <select [(ngModel)]="newLink.sourceFieldId">
            <option value="">-- Chá»n trÆ°á»ng nguá»“n --</option>
            <option *ngFor="let field of sourceFields" [value]="field.id">
              {{ field.label }} ({{ getFieldTypeLabel(field.fieldType) }})
            </option>
          </select>
          <small class="field-hint" *ngIf="sourceFields.length === 0">
            KhÃ´ng cÃ³ trÆ°á»ng dá»¯ liá»‡u trong form nÃ y
          </small>
        </div>

        <!-- Flow type -->
        <div class="form-group">
          <label>âš™ï¸ Kiá»ƒu liÃªn káº¿t</label>
          <div class="flow-type-options">
            <label class="flow-option" *ngFor="let ft of flowTypes"
                   [class.selected]="newLink.flowType === ft.value">
              <input type="radio" name="flowType"
                     [value]="ft.value"
                     [(ngModel)]="newLink.flowType" />
              <span class="flow-option-content">
                <span class="flow-icon">{{ ft.icon }}</span>
                <span class="flow-label">{{ ft.label }}</span>
                <span class="flow-desc">{{ ft.desc }}</span>
              </span>
            </label>
          </div>
        </div>

        <!-- Priority -->
        <div class="form-group">
          <label>ğŸ”¢ Äá»™ Æ°u tiÃªn (0 = máº·c Ä‘á»‹nh)</label>
          <input type="number" min="0" max="100"
                 [(ngModel)]="newLink.priority" />
        </div>

        <!-- Description -->
        <div class="form-group">
          <label>ğŸ“ MÃ´ táº£ (tÃ¹y chá»n)</label>
          <input type="text"
                 [(ngModel)]="newLink.description"
                 placeholder="VD: Láº¥y ngÃ y sinh tá»« form Ä‘Äƒng kÃ½..."  />
        </div>

        <!-- Form actions -->
        <div class="form-actions">
          <button class="cancel-btn" (click)="cancelAdd()" [disabled]="isSaving">
            Há»§y
          </button>
          <button class="save-btn" (click)="saveLink()"
                  [disabled]="isSaving || !newLink.targetFieldId || !newLink.sourceTemplateId || !newLink.sourceFieldId">
            <span *ngIf="isSaving" class="spinner-small"></span>
            {{ editingLinkId ? 'Cáº­p nháº­t' : 'Táº¡o liÃªn káº¿t' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
