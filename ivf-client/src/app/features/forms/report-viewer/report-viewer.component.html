<div class="report-viewer-container">
    @if (reportData) {
    <header class="report-header">
        <div class="header-content">
            <h1>{{ reportData.template.name }}</h1>
            <p>{{ reportData.template.description }}</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" (click)="exportCSV()">üì• Xu·∫•t CSV</button>
            <button class="btn btn-secondary" (click)="print()">üñ®Ô∏è In</button>
        </div>
    </header>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>T·ª´ ng√†y:</label>
            <input type="date" [(ngModel)]="filterFrom" (change)="reload()">
        </div>
        <div class="filter-group">
            <label>ƒê·∫øn ng√†y:</label>
            <input type="date" [(ngModel)]="filterTo" (change)="reload()">
        </div>
        <button class="btn btn-primary" (click)="reload()">üîÑ T·∫£i l·∫°i</button>
    </div>

    <!-- Summary Cards -->
    @if (reportData.summary) {
    <div class="summary-cards">
        <div class="summary-card">
            <span class="card-icon">üìä</span>
            <div class="card-content">
                <h3>{{ reportData.summary.totalResponses }}</h3>
                <p>T·ªïng ph·∫£n h·ªìi</p>
            </div>
        </div>
        @for (avg of getAverages(); track avg.key) {
        <div class="summary-card">
            <span class="card-icon">üìà</span>
            <div class="card-content">
                <h3>{{ avg.value | number:'1.2-2' }}</h3>
                <p>TB {{ avg.key }}</p>
            </div>
        </div>
        }
    </div>
    }

    <!-- Report Content -->
    <div class="report-content">
        @switch (reportData.template.reportType) {
        @case (ReportType.Table) {
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        @for (col of getColumns(); track col) {
                        <th>{{ col }}</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (row of reportData.data; track $index) {
                    <tr>
                        @for (col of getColumns(); track col) {
                        <td>{{ formatValue(row[col]) }}</td>
                        }
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }
        @case (ReportType.BarChart) {
        <div class="chart-container">
            <div class="simple-bar-chart">
                @for (item of getChartData(); track item.label) {
                <div class="bar-item">
                    <span class="bar-label">{{ item.label }}</span>
                    <div class="bar-track">
                        <div class="bar-fill" [style.width.%]="item.percentage"></div>
                    </div>
                    <span class="bar-value">{{ item.value }}</span>
                </div>
                }
            </div>
        </div>
        }
        @case (ReportType.PieChart) {
        <div class="chart-container">
            <div class="pie-legend">
                @for (item of getChartData(); track item.label) {
                <div class="legend-item">
                    <span class="legend-color" [style.background]="item.color"></span>
                    <span>{{ item.label }}: {{ item.value }} ({{ item.percentage | number:'1.1-1' }}%)</span>
                </div>
                }
            </div>
        </div>
        }
        @case (ReportType.Summary) {
        <div class="summary-report">
            <div class="stat-grid">
                @for (stat of getValueCounts(); track stat.key) {
                <div class="stat-item">
                    <span class="stat-value">{{ stat.count }}</span>
                    <span class="stat-label">{{ stat.key }}</span>
                </div>
                }
            </div>
        </div>
        }
        @default {
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        @for (col of getColumns(); track col) {
                        <th>{{ col }}</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (row of reportData.data; track $index) {
                    <tr>
                        @for (col of getColumns(); track col) {
                        <td>{{ formatValue(row[col]) }}</td>
                        }
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }
        }
    </div>
    } @else {
    <div class="loading">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i b√°o c√°o...</p>
    </div>
    }
</div>