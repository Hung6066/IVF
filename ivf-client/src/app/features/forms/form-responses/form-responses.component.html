<div class="responses-container">
    <header class="page-header">
        <div class="header-content">
            <h1>üìä Ph·∫£n h·ªìi bi·ªÉu m·∫´u</h1>
            <p>Xem v√† qu·∫£n l√Ω t·∫•t c·∫£ c√°c ph·∫£n h·ªìi ƒë√£ g·ª≠i</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" (click)="exportCSV()">üì• Xu·∫•t CSV</button>
        </div>
    </header>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Bi·ªÉu m·∫´u:</label>
            <select [(ngModel)]="filterTemplateId" (change)="onTemplateChange()">
                <option value="">T·∫•t c·∫£</option>
                @for (t of templates; track t.id) {
                <option [value]="t.id">{{ t.name }}</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>T·ª´ ng√†y:</label>
            <input type="date" [(ngModel)]="filterFrom" (change)="loadResponses()">
        </div>
        <div class="filter-group">
            <label>ƒê·∫øn ng√†y:</label>
            <input type="date" [(ngModel)]="filterTo" (change)="loadResponses()">
        </div>
        <div class="filter-group">
            <label>Tr·∫°ng th√°i:</label>
            <select [(ngModel)]="filterStatus" (change)="loadResponses()">
                <option value="">T·∫•t c·∫£</option>
                <option value="1">B·∫£n nh√°p</option>
                <option value="2">ƒê√£ g·ª≠i</option>
                <option value="3">ƒê√£ xem</option>
                <option value="4">ƒê√£ duy·ªát</option>
                <option value="5">T·ª´ ch·ªëi</option>
            </select>
        </div>
        <div class="filter-group view-toggle">
            <button class="toggle-btn" [class.active]="viewMode === 'table'" (click)="viewMode = 'table'">
                üìã B·∫£ng
            </button>
            <button class="toggle-btn" [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'">
                üì¶ Th·∫ª
            </button>
        </div>
    </div>

    <!-- Summary Stats -->
    @if (filterTemplateId && selectedTemplate) {
    <div class="stats-row">
        <div class="stat-card">
            <span class="stat-value">{{ totalResponses }}</span>
            <span class="stat-label">T·ªïng ph·∫£n h·ªìi</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ getStatusCount(ResponseStatus.Submitted) }}</span>
            <span class="stat-label">Ch·ªù duy·ªát</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ getStatusCount(ResponseStatus.Approved) }}</span>
            <span class="stat-label">ƒê√£ duy·ªát</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ selectedTemplate.fields?.length || 0 }}</span>
            <span class="stat-label">S·ªë tr∆∞·ªùng</span>
        </div>
    </div>
    }

    <!-- Multi-column Table View -->
    @if (viewMode === 'table') {
    <div class="responses-table-wrapper">
        <table class="responses-table">
            <thead>
                <tr>
                    <th class="sticky-col">STT</th>
                    <th class="sticky-col">Tr·∫°ng th√°i</th>
                    @if (!filterTemplateId) {
                    <th>Bi·ªÉu m·∫´u</th>
                    }
                    <th>B·ªánh nh√¢n</th>
                    <!-- Dynamic field columns -->
                    @if (selectedTemplate?.fields) {
                    @for (field of selectedTemplate!.fields!; track field.id) {
                    <th [style.min-width.px]="getColumnWidth(field)">{{ field.label }}</th>
                    }
                    }
                    <th>Ng√†y g·ª≠i</th>
                    <th class="sticky-col-right">Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @for (response of responses; track response.id; let i = $index) {
                <tr [class.even]="i % 2 === 0">
                    <td class="sticky-col">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                    <td class="sticky-col">
                        <span class="status-badge" [class]="getStatusClass(response.status)">
                            {{ getStatusLabel(response.status) }}
                        </span>
                    </td>
                    @if (!filterTemplateId) {
                    <td>{{ response.formTemplateName }}</td>
                    }
                    <td>{{ response.patientName || 'N/A' }}</td>
                    <!-- Dynamic field values -->
                    @if (selectedTemplate?.fields) {
                    @for (field of selectedTemplate!.fields!; track field.id) {
                    <td>{{ getFieldValue(response, field) }}</td>
                    }
                    }
                    <td>{{ response.submittedAt ? (response.submittedAt | date:'dd/MM/yyyy HH:mm') : '-' }}</td>
                    <td class="sticky-col-right">
                        <div class="actions">
                            <a [routerLink]="['/forms/responses', response.id]" class="btn-icon" title="Xem">üëÅÔ∏è</a>
                            @if (response.status === ResponseStatus.Submitted) {
                            <button class="btn-icon success" title="Duy·ªát" (click)="approve(response)">‚úÖ</button>
                            <button class="btn-icon danger" title="T·ª´ ch·ªëi" (click)="reject(response)">‚ùå</button>
                            }
                        </div>
                    </td>
                </tr>
                }

                @if (responses.length === 0) {
                <tr>
                    <td [attr.colspan]="getColumnCount()" class="empty-row">
                        <div class="empty-state">
                            <span class="icon">üì≠</span>
                            <p>Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o</p>
                        </div>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }

    <!-- Grid/Card View -->
    @if (viewMode === 'grid') {
    <div class="responses-grid">
        @for (response of responses; track response.id) {
        <div class="response-card" [class]="getStatusClass(response.status)">
            <div class="card-header">
                <span class="status-badge" [class]="getStatusClass(response.status)">
                    {{ getStatusLabel(response.status) }}
                </span>
                <span class="date">{{ response.submittedAt | date:'dd/MM/yyyy' }}</span>
            </div>
            <h3>{{ response.formTemplateName }}</h3>
            @if (response.patientName) {
            <p class="patient">üë§ {{ response.patientName }}</p>
            }

            <div class="field-values">
                @if (response.fieldValues) {
                @for (fv of response.fieldValues.slice(0, 4); track fv.formFieldId) {
                <div class="field-value-row">
                    <span class="label">{{ fv.fieldLabel }}:</span>
                    <span class="value">{{ getDisplayValue(fv) }}</span>
                </div>
                }
                @if (response.fieldValues.length > 4) {
                <div class="more-fields">+{{ response.fieldValues.length - 4 }} tr∆∞·ªùng kh√°c</div>
                }
                }
            </div>

            <div class="card-footer">
                <a [routerLink]="['/forms/responses', response.id]" class="btn btn-sm">Xem chi ti·∫øt</a>
                @if (response.status === ResponseStatus.Submitted) {
                <button class="btn btn-sm btn-success" (click)="approve(response)">Duy·ªát</button>
                }
            </div>
        </div>
        }
    </div>

    @if (responses.length === 0) {
    <div class="empty-state-centered">
        <span class="icon">üì≠</span>
        <h3>Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o</h3>
        <p>C√°c ph·∫£n h·ªìi s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y khi ng∆∞·ªùi d√πng g·ª≠i bi·ªÉu m·∫´u</p>
    </div>
    }
    }

    <!-- Pagination -->
    @if (totalResponses > pageSize) {
    <div class="pagination">
        <button (click)="prevPage()" [disabled]="currentPage === 1">‚Üê Tr∆∞·ªõc</button>
        <span>Trang {{ currentPage }} / {{ totalPages }} ({{ totalResponses }} ph·∫£n h·ªìi)</span>
        <button (click)="nextPage()" [disabled]="currentPage >= totalPages">Sau ‚Üí</button>
    </div>
    }
</div>