<div class="response-detail-container">
  @if (response && template) {
    <header class="detail-header">
      <div class="header-info">
        <a routerLink="/forms/responses" class="back-link">â† Quay láº¡i</a>
        <h1>{{ response.formTemplateName }}</h1>
        <div class="meta-info">
          <span class="status-badge" [class]="getStatusClass(response.status)">
            {{ getStatusLabel(response.status) }}
          </span>
          <span
            >ğŸ“…
            {{
              response.submittedAt
                ? 'Gá»­i: ' + (response.submittedAt | date: 'dd/MM/yyyy HH:mm')
                : 'Táº¡o: ' + (response.createdAt | date: 'dd/MM/yyyy HH:mm')
            }}</span
          >
          @if (response.patientName) {
            <span>ğŸ‘¤ {{ response.patientName }}</span>
          }
        </div>
      </div>
      <div class="header-actions">
        @if (response.status === ResponseStatus.Draft) {
          <a class="btn btn-primary" [routerLink]="['/forms/edit', response.id]"
            >ğŸ“ Tiáº¿p tá»¥c Ä‘iá»n</a
          >
        } @else {
          <a class="btn btn-primary" [routerLink]="['/forms/edit', response.id]">âœï¸ Sá»­a</a>
        }
        <button class="btn btn-secondary" (click)="print()">ğŸ–¨ï¸ In</button>
        <button class="btn btn-secondary" (click)="exportPdf()" [disabled]="isLoadingPdf">
          @if (isLoadingPdf) {
            <span class="btn-spinner"></span>
          } @else {
            ğŸ“„
          }
          PDF
        </button>
        <button class="btn btn-secondary" (click)="exportPdf(true)" [disabled]="isLoadingPdf" title="Xuáº¥t PDF cÃ³ kÃ½ sá»‘">
          @if (isLoadingPdf) {
            <span class="btn-spinner"></span>
          } @else {
            âœï¸
          }
          KÃ½ sá»‘
        </button>
        <button class="btn btn-danger-outline" (click)="deleteResponse()">ğŸ—‘ï¸ XÃ³a</button>
      </div>
    </header>

    <!-- Workflow Progress -->
    @if (response.status !== ResponseStatus.Rejected) {
      <div class="workflow-progress">
        <div class="workflow-steps">
          @for (step of workflowSteps; track step.status; let i = $index) {
            <div
              class="workflow-step"
              [class.completed]="isStepCompleted(i)"
              [class.active]="isStepActive(i)"
            >
              <div class="step-icon">{{ step.icon }}</div>
              <div class="step-label">{{ step.label }}</div>
            </div>
            @if (i < workflowSteps.length - 1) {
              <div class="workflow-connector" [class.completed]="isStepCompleted(i + 1)"></div>
            }
          }
        </div>
      </div>
    } @else {
      <div class="workflow-rejected">
        <span class="rejected-icon">âŒ</span>
        <span class="rejected-text">Pháº£n há»“i Ä‘Ã£ bá»‹ tá»« chá»‘i</span>
        @if (response.notes) {
          <span class="rejected-reason">LÃ½ do: {{ response.notes }}</span>
        }
      </div>
    }

    <!-- Review Actions -->
    @if (
      response.status === ResponseStatus.Submitted || response.status === ResponseStatus.Reviewed
    ) {
      <div class="review-actions-bar">
        <span class="review-label">HÃ nh Ä‘á»™ng xÃ©t duyá»‡t:</span>
        @if (response.status === ResponseStatus.Submitted) {
          <button class="btn btn-info" (click)="markAsReviewed()" [disabled]="isProcessing">
            ğŸ‘ï¸ ÄÃ¡nh dáº¥u Ä‘Ã£ xem
          </button>
        }
        <button class="btn btn-success" (click)="approve()" [disabled]="isProcessing">
          âœ… Duyá»‡t
        </button>
        <button class="btn btn-danger" (click)="openRejectDialog()" [disabled]="isProcessing">
          âŒ Tá»« chá»‘i
        </button>
      </div>
    }

    <div class="response-content">
      <div class="form-preview-card">
        <h2>Ná»™i dung pháº£n há»“i</h2>
        <div class="values-grid">
          @for (field of template.fields; track field.id) {
            <div
              class="value-item"
              [style.grid-column]="'span ' + getFieldColSpan(field)"
              [class.col-1]="getFieldColSpan(field) === 1"
              [class.col-2]="getFieldColSpan(field) === 2"
              [class.col-3]="getFieldColSpan(field) === 3"
              [class.col-4]="getFieldColSpan(field) === 4"
            >
              <label>
                {{ field.label }}
                @if (field.isRequired) {
                  <span class="required">*</span>
                }
              </label>
              @if (isTagsField(field)) {
                <div class="value tags-value" [innerHTML]="getTagsDisplayHtml(field)"></div>
              } @else {
                <div class="value" [innerHTML]="getFieldDisplayValue(field)"></div>
              }
            </div>
          }

          @if (!template.fields?.length) {
            <p class="no-data">KhÃ´ng cÃ³ trÆ°á»ng nÃ o</p>
          }
        </div>
      </div>
    </div>

    <!-- Reject Dialog Modal -->
    @if (showRejectDialog) {
      <div class="modal-backdrop" (click)="cancelReject()">
        <div class="modal-dialog" (click)="$event.stopPropagation()">
          <h3>âŒ Tá»« chá»‘i pháº£n há»“i</h3>
          <p>Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i:</p>
          <textarea
            [(ngModel)]="rejectNotes"
            placeholder="LÃ½ do tá»« chá»‘i..."
            rows="4"
            class="reject-textarea"
          ></textarea>
          <div class="modal-actions">
            <button class="btn btn-secondary modal-btn" (click)="cancelReject()">Há»§y</button>
            <button class="btn btn-danger" (click)="confirmReject()" [disabled]="isProcessing">
              XÃ¡c nháº­n tá»« chá»‘i
            </button>
          </div>
        </div>
      </div>
    }

    <!-- PDF Preview Modal -->
    @if (showPdfPreview && pdfPreviewUrl) {
      <div class="modal-backdrop pdf-backdrop" (click)="closePdfPreview()">
        <div class="pdf-preview-modal" (click)="$event.stopPropagation()">
          <div class="pdf-preview-header">
            <h3>ğŸ“„ {{ response.formTemplateName }}</h3>
            <div class="pdf-preview-actions">
              <button class="btn btn-pdf-download" (click)="downloadPdf()">â¬‡ï¸ Táº£i xuá»‘ng</button>
              <button class="btn btn-pdf-print" (click)="print()">ğŸ–¨ï¸ In</button>
              <button class="btn btn-pdf-close" (click)="closePdfPreview()">âœ•</button>
            </div>
          </div>
          <div class="pdf-preview-body">
            <iframe [src]="pdfPreviewUrl" class="pdf-iframe"></iframe>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="loading">
      <div class="spinner"></div>
      <p>Äang táº£i...</p>
    </div>
  }
</div>
