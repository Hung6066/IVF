<div class="page-container">
    <header class="page-header">
        <div class="header-content">
            <h1>üë• Qu·∫£n l√Ω nh√¢n s·ª±</h1>
            <p class="text-muted">Qu·∫£n l√Ω t√†i kho·∫£n, ph√¢n quy·ªÅn v√† tr·∫°ng th√°i ho·∫°t ƒë·ªông</p>
        </div>
        <button class="btn-primary" (click)="openModal()">
            <span class="icon">+</span> Th√™m t√†i kho·∫£n
        </button>
    </header>

    <!-- Filters -->
    <div class="filters-card">
        <div class="filter-group">
            <span class="search-icon">üîç</span>
            <input type="text" [(ngModel)]="search" (keyup.enter)="loadUsers()"
                placeholder="T√¨m ki·∫øm theo t√™n, username..." class="search-input">
        </div>

        <select [(ngModel)]="roleFilter" (change)="loadUsers()" class="filter-select">
            <option value="">T·∫•t c·∫£ vai tr√≤</option>
            @for (role of roles(); track role) {
            <option [value]="role">{{ role }}</option>
            }
        </select>

        <select [(ngModel)]="statusFilter" (change)="loadUsers()" class="filter-select">
            <option [ngValue]="undefined">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option [ngValue]="true">üü¢ Ho·∫°t ƒë·ªông</option>
            <option [ngValue]="false">üî¥ ƒê√£ kh√≥a</option>
        </select>

        <button class="btn-secondary" (click)="loadUsers()">√Åp d·ª•ng</button>
    </div>

    <!-- Table -->
    <div class="table-container">
        <table class="premium-table">
            <thead>
                <tr>
                    <th width="30%">Nh√¢n vi√™n</th>
                    <th>Username</th>
                    <th>Vai tr√≤</th>
                    <th>Khoa/Ph√≤ng</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-end">Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @for (user of users(); track user.id) {
                <tr class="hover-row">
                    <td>
                        <div class="user-cell">
                            <div class="avatar" [style.background-color]="getAvatarColor(user.fullName)">
                                {{ getInitials(user.fullName) }}
                            </div>
                            <div class="user-info">
                                <div class="fullname">{{ user.fullName }}</div>
                                <div class="email-muted">ID: {{ user.id.substring(0, 8) }}...</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="username-tag">@ {{ user.username }}</span></td>
                    <td>
                        <span class="role-badge" [class]="getRoleClass(user.role)">
                            {{ user.role }}
                        </span>
                    </td>
                    <td>{{ user.department || '‚Äî' }}</td>
                    <td>
                        <span class="status-indicator" [class.active]="user.isActive">
                            <span class="dot"></span>
                            {{ user.isActive ? 'Active' : 'Inactive' }}
                        </span>
                    </td>
                    <td class="text-end">
                        <div class="action-buttons">
                            <!-- Add Doctor Info Button -->
                            @if (user.role === 'Doctor') {
                            <button class="btn-icon doctor" (click)="openDoctorModal(user)"
                                title="C·∫≠p nh·∫≠t th√¥ng tin b√°c sƒ©">
                                ü©∫
                            </button>
                            }
                            <button class="btn-icon permissions" (click)="openPermissionsModal(user)"
                                title="Ph√¢n quy·ªÅn">
                                üîê
                            </button>
                            <button class="btn-icon edit" (click)="openModal(user)" title="Ch·ªânh s·ª≠a">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon delete" [class.restore]="!user.isActive" (click)="deleteUser(user)"
                                [title]="user.isActive ? 'Kh√≥a t√†i kho·∫£n' : 'Kh√¥i ph·ª•c t√†i kho·∫£n'">
                                {{ user.isActive ? 'üîí' : 'üîì' }}
                            </button>
                        </div>
                    </td>
                </tr>
                } @empty {
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-content">
                            <div class="empty-icon">üë•</div>
                            <h3>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</h3>
                            <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t√¨m ki·∫øm t·ª´ kh√≥a kh√°c</p>
                        </div>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-footer">
        <span class="text-muted">Hi·ªÉn th·ªã {{ users().length }} k·∫øt qu·∫£</span>
        <div class="pagination-buttons">
            <button class="btn-page" [disabled]="page === 1" (click)="changePage(-1)">‚Üê Tr∆∞·ªõc</button>
            <span class="page-number">{{ page }}</span>
            <button class="btn-page" [disabled]="users().length < pageSize" (click)="changePage(1)">Sau ‚Üí</button>
        </div>
    </div>
</div>

<!-- Modal -->
@if (showModal) {
<div class="modal-backdrop" (click)="closeModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ editingUser ? 'C·∫≠p nh·∫≠t th√¥ng tin' : 'Th√™m nh√¢n s·ª± m·ªõi' }}</h2>
            <button class="close-btn" (click)="closeModal()">√ó</button>
        </div>

        <form (ngSubmit)="saveUser()" class="modal-body">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label>H·ªç v√† t√™n <span class="required">*</span></label>
                    <input class="modern-input" [(ngModel)]="formData.fullName" name="fullName"
                        placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß" required>
                </div>

                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p <span class="required">*</span></label>
                    <input class="modern-input" [(ngModel)]="formData.username" name="username"
                        [disabled]="!!editingUser" placeholder="VD: nguyenvana" required>
                </div>

                @if (editingUser) {
                <div class="form-check full-width">
                    <label class="checkbox-label">
                        <input type="checkbox" [(ngModel)]="changePassword" name="changePass">
                        <span>ƒê·ªïi m·∫≠t kh·∫©u m·ªõi</span>
                    </label>
                </div>
                }

                <div class="form-group" [class.disabled-field]="editingUser && !changePassword">
                    <label>M·∫≠t kh·∫©u {{ editingUser ? '' : '*' }}</label>
                    <input class="modern-input" type="password" [(ngModel)]="formData.password" name="password"
                        [required]="!editingUser || changePassword" [disabled]="editingUser && !changePassword"
                        [placeholder]="editingUser ? (changePassword ? 'Nh·∫≠p m·∫≠t kh·∫©u m·ªõi' : 'Kh√¥ng thay ƒë·ªïi') : 'Nh·∫≠p m·∫≠t kh·∫©u'">
                </div>

                <div class="form-group">
                    <label>Vai tr√≤ <span class="required">*</span></label>
                    <select class="modern-select" [(ngModel)]="formData.role" name="role" required>
                        @for (role of roles(); track role) {
                        <option [value]="role">{{ role }}</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Khoa / Ph√≤ng ban</label>
                    <input class="modern-input" [(ngModel)]="formData.department" name="department"
                        placeholder="VD: Khoa Hi·∫øm Mu·ªôn">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-ghost" (click)="closeModal()">H·ªßy b·ªè</button>
                <button type="submit" class="btn-primary" [disabled]="loading()">
                    {{ loading() ? 'ƒêang l∆∞u...' : 'L∆∞u thay ƒë·ªïi' }}
                </button>
            </div>
        </form>
    </div>
</div>
}

<!-- Doctor Info Modal -->
@if (showDoctorModal) {
<div class="modal-backdrop" (click)="closeDoctorModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>ü©∫ C·∫≠p nh·∫≠t th√¥ng tin b√°c sƒ©</h2>
            <button class="close-btn" (click)="closeDoctorModal()">√ó</button>
        </div>

        <div class="modal-body">
            <p class="text-muted mb-4">C·∫≠p nh·∫≠t th√¥ng tin chuy√™n m√¥n cho t√†i kho·∫£n <strong>{{
                    selectedDoctorUser?.fullName }}</strong></p>

            <form (ngSubmit)="saveDoctorProfile()">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Chuy√™n khoa <span class="required">*</span></label>
                        <select class="modern-select" [(ngModel)]="doctorFormData.specialty" name="specialty" required>
                            <option value="IVF">IVF (Hi·∫øm mu·ªôn)</option>
                            <option value="Andrology">Nam khoa</option>
                            <option value="Gynecology">Ph·ª• s·∫£n</option>
                            <option value="Embryology">Ph√¥i h·ªçc</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>S·ªë ch·ª©ng ch·ªâ h√†nh ngh·ªÅ</label>
                        <input class="modern-input" [(ngModel)]="doctorFormData.licenseNumber" name="license"
                            placeholder="VD: 00123/BYT-CCHN">
                    </div>

                    <div class="form-group">
                        <label>Ph√≤ng kh√°m m·∫∑c ƒë·ªãnh</label>
                        <input class="modern-input" [(ngModel)]="doctorFormData.roomNumber" name="room"
                            placeholder="VD: P.201">
                    </div>

                    <div class="form-group">
                        <label>S·ªë ca t·ªëi ƒëa/ng√†y</label>
                        <input class="modern-input" type="number" [(ngModel)]="doctorFormData.maxPatientsPerDay"
                            name="maxPatients" min="1">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-ghost" (click)="closeDoctorModal()">H·ªßy b·ªè</button>
                    <button type="submit" class="btn-primary" [disabled]="loading()">
                        {{ loading() ? 'ƒêang l∆∞u...' : 'L∆∞u th√¥ng tin' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
}

<!-- Permissions Modal -->
@if (showPermissionsModal) {
<div class="modal-backdrop" (click)="closePermissionsModal()">
    <div class="modal-card permissions-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>üîê Ph√¢n quy·ªÅn cho {{ selectedPermissionUser?.fullName }}</h2>
            <button class="close-btn" (click)="closePermissionsModal()">√ó</button>
        </div>

        <div class="modal-body permissions-body">
            <div class="permission-groups">
                @for (group of permissionGroups; track group.name) {
                <div class="permission-group">
                    <h4 class="group-title">{{ group.name }}</h4>
                    <div class="permission-grid">
                        @for (perm of group.permissions; track perm) {
                        <label class="permission-checkbox">
                            <input type="checkbox" [checked]="userPermissions.includes(perm)"
                                (change)="togglePermission(perm)">
                            <span class="checkmark"></span>
                            <span class="perm-label">{{ formatPermission(perm) }}</span>
                        </label>
                        }
                    </div>
                </div>
                }
            </div>
        </div>

        <div class="modal-footer">
            <div class="perm-count">{{ userPermissions.length }} quy·ªÅn ƒë√£ ch·ªçn</div>
            <div class="footer-buttons">
                <button type="button" class="btn-ghost" (click)="closePermissionsModal()">H·ªßy b·ªè</button>
                <button type="button" class="btn-primary" [disabled]="loading()" (click)="savePermissions()">
                    {{ loading() ? 'ƒêang l∆∞u...' : 'L∆∞u ph√¢n quy·ªÅn' }}
                </button>
            </div>
        </div>
    </div>
</div>
}