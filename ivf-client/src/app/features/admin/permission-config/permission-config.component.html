<div class="permission-config-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h2>‚öôÔ∏è C·∫•u h√¨nh quy·ªÅn h·∫°n</h2>
      <p class="subtitle">Qu·∫£n l√Ω danh s√°ch quy·ªÅn h·∫°n trong h·ªá th·ªëng</p>
    </div>
    <div class="header-actions">
      <select class="filter-select" [(ngModel)]="groupFilter">
        <option value="">T·∫•t c·∫£ nh√≥m</option>
        @for (g of groups; track g) {
          <option [value]="g">{{ g }}</option>
        }
      </select>
      <button class="btn btn-primary" (click)="openAdd()"><span>Ôºã</span> Th√™m quy·ªÅn</button>
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="loading-bar">ƒêang t·∫£i...</div>
  }

  <!-- Groups -->
  @for (group of groupedItems; track group.groupCode) {
    <div class="group-section">
      <div class="group-header">
        <span class="group-icon">{{ group.groupIcon }}</span>
        <span class="group-name">{{ group.groupName }}</span>
        <span class="group-code">({{ group.groupCode }})</span>
        <span class="badge">{{ group.items.length }}</span>
      </div>

      <div class="permission-table">
        <table>
          <thead>
            <tr>
              <th class="col-code">M√£ quy·ªÅn</th>
              <th class="col-name">T√™n hi·ªÉn th·ªã</th>
              <th class="col-sort">Th·ª© t·ª±</th>
              <th class="col-status">Tr·∫°ng th√°i</th>
              <th class="col-actions">Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            @for (item of group.items; track item.id) {
              <tr [class.inactive]="!item.isActive">
                <td class="col-code">
                  <code>{{ item.code }}</code>
                </td>
                <td class="col-name">{{ item.displayName }}</td>
                <td class="col-sort">{{ item.sortOrder }}</td>
                <td class="col-status">
                  <button
                    class="toggle-btn"
                    [class.active]="item.isActive"
                    (click)="toggleActive(item)"
                    [title]="item.isActive ? 'ƒêang b·∫≠t' : 'ƒêang t·∫Øt'"
                  >
                    {{ item.isActive ? '‚úÖ' : '‚ùå' }}
                  </button>
                </td>
                <td class="col-actions">
                  <button class="btn-icon" title="S·ª≠a" (click)="openEdit(item)">‚úèÔ∏è</button>
                  <button class="btn-icon btn-danger" title="Xo√°" (click)="deleteItem(item)">
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  @if (!loading() && groupedItems.length === 0) {
    <div class="empty-state">
      <p>Kh√¥ng c√≥ quy·ªÅn n√†o{{ groupFilter ? ' trong nh√≥m n√†y' : '' }}.</p>
    </div>
  }
</div>

<!-- Modal -->
@if (showModal) {
  <div class="modal-backdrop" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingItem ? 'S·ª≠a quy·ªÅn' : 'Th√™m quy·ªÅn m·ªõi' }}</h3>
        <button class="btn-close" (click)="closeModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>M√£ quy·ªÅn (Code) <span class="required">*</span></label>
          <input
            type="text"
            [(ngModel)]="formData.code"
            [disabled]="!!editingItem"
            placeholder="VD: ViewReports"
            class="form-control"
          />
          @if (!editingItem) {
            <small class="hint">Kh√¥ng th·ªÉ thay ƒë·ªïi sau khi t·∫°o. D√πng PascalCase.</small>
          }
        </div>

        <div class="form-group">
          <label>T√™n hi·ªÉn th·ªã <span class="required">*</span></label>
          <input
            type="text"
            [(ngModel)]="formData.displayName"
            placeholder="VD: Xem b√°o c√°o"
            class="form-control"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>M√£ nh√≥m <span class="required">*</span></label>
            <input
              type="text"
              [(ngModel)]="formData.groupCode"
              placeholder="VD: report"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label>T√™n nh√≥m <span class="required">*</span></label>
            <input
              type="text"
              [(ngModel)]="formData.groupDisplayName"
              placeholder="VD: B√°o c√°o"
              class="form-control"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Icon nh√≥m</label>
            <input
              type="text"
              [(ngModel)]="formData.groupIcon"
              placeholder="VD: üìä"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label>Th·ª© t·ª± trong nh√≥m</label>
            <input type="number" [(ngModel)]="formData.sortOrder" class="form-control" />
          </div>
          <div class="form-group">
            <label>Th·ª© t·ª± nh√≥m</label>
            <input type="number" [(ngModel)]="formData.groupSortOrder" class="form-control" />
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModal()">Hu·ª∑</button>
        <button
          class="btn btn-primary"
          (click)="save()"
          [disabled]="
            saving() ||
            !formData.code ||
            !formData.displayName ||
            !formData.groupCode ||
            !formData.groupDisplayName
          "
        >
          {{ saving() ? 'ƒêang l∆∞u...' : editingItem ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi' }}
        </button>
      </div>
    </div>
  </div>
}
