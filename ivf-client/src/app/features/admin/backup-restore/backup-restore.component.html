<div class="backup-restore-page">
  <!-- Header -->
  <div class="page-header">
    <h2>üóÑÔ∏è Sao l∆∞u & Kh√¥i ph·ª•c</h2>
    <p class="subtitle">Qu·∫£n l√Ω backup/restore h·ªá th·ªëng</p>
  </div>

  <!-- Running operations banner -->
  @if (runningOps.length > 0) {
    <div class="running-banner">
      <span class="spinner"></span>
      <span>ƒêang ch·∫°y {{ runningOps.length }} thao t√°c...</span>
      <button class="btn btn-sm btn-outline" (click)="viewOperationLogs(runningOps[0].id)">
        Xem logs
      </button>
    </div>
  }

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab-group">
      <button [class.active]="activeTab === 'overview'" (click)="switchTab('overview')">
        üìä T·ªïng quan
      </button>
    </div>
    <span class="tab-divider"></span>
    <div class="tab-group">
      <span class="tab-group-label">Database</span>
      <button [class.active]="activeTab === 'db-overview'" (click)="switchTab('db-overview')">
        üêò PostgreSQL
      </button>
      <button [class.active]="activeTab === 'wal'" (click)="switchTab('wal')">üìù WAL</button>
      <button [class.active]="activeTab === 'replication'" (click)="switchTab('replication')">
        üîÑ Replication
      </button>
      <button
        [class.active]="activeTab === 'cloud-replication'"
        (click)="switchTab('cloud-replication')"
      >
        üåê Cloud Repl
      </button>
    </div>
    <span class="tab-divider"></span>
    <div class="tab-group">
      <span class="tab-group-label">Object Storage</span>
      <button [class.active]="activeTab === 'minio-overview'" (click)="switchTab('minio-overview')">
        üì¶ MinIO
      </button>
    </div>
    <span class="tab-divider"></span>
    <div class="tab-group">
      <span class="tab-group-label">Sao l∆∞u</span>
      <button [class.active]="activeTab === 'data'" (click)="switchTab('data')">üíæ D·ªØ li·ªáu</button>
      <button [class.active]="activeTab === 'strategies'" (click)="switchTab('strategies')">
        üìã Chi·∫øn l∆∞·ª£c
      </button>
      <button [class.active]="activeTab === 'schedule'" (click)="switchTab('schedule')">
        ‚è∞ L·ªãch t·ª± ƒë·ªông
      </button>
    </div>
    <span class="tab-divider"></span>
    <div class="tab-group">
      <span class="tab-group-label">PKI</span>
      <button [class.active]="activeTab === 'pki'" (click)="switchTab('pki')">
        üîê PKI / CA Keys
      </button>
    </div>
    <span class="tab-divider"></span>
    <div class="tab-group">
      <span class="tab-group-label">Gi√°m s√°t</span>
      <button [class.active]="activeTab === 'cloud'" (click)="switchTab('cloud')">‚òÅÔ∏è Cloud</button>
      <button [class.active]="activeTab === 'compliance'" (click)="switchTab('compliance')">
        üõ°Ô∏è 3-2-1
      </button>
      <button [class.active]="activeTab === 'history'" (click)="switchTab('history')">
        üìú L·ªãch s·ª≠
      </button>
    </div>
    @if (activeOperation()) {
      <span class="tab-divider"></span>
      <div class="tab-group">
        <button [class.active]="activeTab === 'live'" (click)="switchTab('live')">
          üìã Logs
          @if (activeOperation()?.status === 'Running') {
            <span class="spinner-sm"></span>
          }
        </button>
      </div>
    }
  </div>

  <!-- Tab content -->
  <div class="tab-content">
    <!-- ‚ïê‚ïê‚ïê Overview tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'overview') {
      <!-- System status cards -->
      <div class="overview-grid overview-grid-3">
        <!-- Database status -->
        <div class="card overview-card" (click)="switchTab('db-overview')">
          <div class="card-header">
            <h3>üêò PostgreSQL</h3>
            @if (dataStatus(); as ds) {
              <span
                class="badge"
                [ngClass]="ds.database.connected ? 'badge-success' : 'badge-danger'"
              >
                {{ ds.database.connected ? 'Online' : 'Offline' }}
              </span>
            }
          </div>
          <div class="card-body">
            @if (dataStatus(); as ds) {
              <div class="stat-grid stat-grid-2">
                <div class="stat">
                  <span class="stat-value">{{ formatSize(ds.database.sizeBytes) }}</span>
                  <span class="stat-label">Dung l∆∞·ª£ng</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{{ ds.database.tableCount }}</span>
                  <span class="stat-label">B·∫£ng</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{{ ds.backups.databaseBackups.length }}</span>
                  <span class="stat-label">B·∫£n sao l∆∞u</span>
                </div>
                <div class="stat">
                  <span class="stat-value">
                    @if (walStatus(); as ws) {
                      {{ ws.wal.isArchivingEnabled ? 'B·∫≠t' : 'T·∫Øt' }}
                    } @else {
                      ‚Äî
                    }
                  </span>
                  <span class="stat-label">WAL Archive</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">Nh·∫•n ƒë·ªÉ xem chi ti·∫øt...</p>
            }
          </div>
        </div>

        <!-- MinIO status -->
        <div class="card overview-card" (click)="switchTab('minio-overview')">
          <div class="card-header">
            <h3>üì¶ MinIO</h3>
            @if (dataStatus(); as ds) {
              <span class="badge" [ngClass]="ds.minio.connected ? 'badge-success' : 'badge-danger'">
                {{ ds.minio.connected ? 'Online' : 'Offline' }}
              </span>
            }
          </div>
          <div class="card-body">
            @if (dataStatus(); as ds) {
              <div class="stat-grid stat-grid-2">
                <div class="stat">
                  <span class="stat-value">{{ formatSize(ds.minio.totalSizeBytes) }}</span>
                  <span class="stat-label">T·ªïng dung l∆∞·ª£ng</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{{ ds.minio.totalObjects }}</span>
                  <span class="stat-label">Objects</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{{ ds.minio.buckets.length }}</span>
                  <span class="stat-label">Buckets</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{{ ds.backups.minioBackups.length }}</span>
                  <span class="stat-label">B·∫£n sao l∆∞u</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">Nh·∫•n ƒë·ªÉ xem chi ti·∫øt...</p>
            }
          </div>
        </div>

        <!-- PKI / CA status -->
        <div class="card overview-card" (click)="switchTab('pki')">
          <div class="card-header">
            <h3>üîê PKI / CA Keys</h3>
          </div>
          <div class="card-body">
            <div class="stat-grid stat-grid-2">
              <div class="stat">
                <span class="stat-value">{{ archives().length }}</span>
                <span class="stat-label">B·∫£n sao l∆∞u</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ operations().length }}</span>
                <span class="stat-label">Thao t√°c</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ runningOps.length }}</span>
                <span class="stat-label">ƒêang ch·∫°y</span>
              </div>
              @if (archives().length > 0) {
                <div class="stat">
                  <span class="stat-value">{{ formatSize(archives()[0].sizeBytes) }}</span>
                  <span class="stat-label">M·ªõi nh·∫•t</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="overview-grid overview-grid-2 mt-3">
        <!-- Backup actions -->
        <div class="card">
          <div class="card-header">
            <h3>‚ö° Thao t√°c nhanh</h3>
          </div>
          <div class="card-body">
            <div class="quick-action-list">
              <button
                class="btn btn-primary"
                [disabled]="dataBackupRunning"
                (click)="quickFullBackup()"
              >
                üíæ Sao l∆∞u DB + MinIO
              </button>
              <button class="btn btn-outline" [disabled]="loading()" (click)="startBackup(false)">
                üîê Sao l∆∞u PKI Keys
              </button>
              <button
                class="btn btn-outline"
                [disabled]="baseBackupRunning"
                (click)="createBaseBackup()"
              >
                üìù T·∫°o Base Backup (WAL)
              </button>
            </div>
          </div>
        </div>

        <!-- Compliance summary -->
        <div class="card">
          <div class="card-header">
            <h3>üõ°Ô∏è Tu√¢n th·ªß 3-2-1</h3>
            <button class="btn btn-sm btn-outline" (click)="switchTab('compliance')">
              Chi ti·∫øt ‚Üí
            </button>
          </div>
          <div class="card-body">
            @if (compliance(); as c) {
              <div class="compliance-mini">
                <div
                  class="compliance-mini-score"
                  [class.compliant]="c.isCompliant"
                  [class.non-compliant]="!c.isCompliant"
                >
                  {{ c.ruleScore }}/{{ c.maxRuleScore }}
                </div>
                <div class="compliance-mini-rules">
                  <span [class.passed]="c.copiesCount >= 3">{{ c.copiesCount }}/3 b·∫£n sao</span>
                  <span [class.passed]="c.storageTypesCount >= 2"
                    >{{ c.storageTypesCount }}/2 lo·∫°i</span
                  >
                  <span [class.passed]="c.offsiteCopiesCount >= 1"
                    >{{ c.offsiteCopiesCount }}/1 offsite</span
                  >
                </div>
              </div>
            } @else {
              <p class="text-muted">Nh·∫•n "Chi ti·∫øt" ƒë·ªÉ ki·ªÉm tra</p>
            }
          </div>
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Database Overview tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'db-overview') {
      <div class="overview-grid overview-grid-2">
        <!-- Database Info -->
        <div class="card">
          <div class="card-header">
            <h3>üêò Th√¥ng tin PostgreSQL</h3>
            <button class="btn btn-sm btn-outline" (click)="loadDataStatus()">üîÑ L√†m m·ªõi</button>
          </div>
          <div class="card-body">
            @if (dataStatus(); as ds) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">C∆° s·ªü d·ªØ li·ªáu</span>
                  <span>{{ ds.database.databaseName }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">K√≠ch th∆∞·ªõc</span>
                  <span class="badge badge-info">{{ formatSize(ds.database.sizeBytes) }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">S·ªë b·∫£ng</span>
                  <span>{{ ds.database.tableCount }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">K·∫øt n·ªëi</span>
                  <span
                    class="badge"
                    [ngClass]="ds.database.connected ? 'badge-success' : 'badge-danger'"
                  >
                    {{ ds.database.connected ? '‚úÖ ƒê√£ k·∫øt n·ªëi' : '‚ùå M·∫•t k·∫øt n·ªëi' }}
                  </span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }
          </div>
        </div>

        <!-- WAL summary -->
        <div class="card">
          <div class="card-header">
            <h3>üìù WAL & Archiving</h3>
            <button class="btn btn-sm btn-outline" (click)="switchTab('wal')">Chi ti·∫øt ‚Üí</button>
          </div>
          <div class="card-body">
            @if (walStatus(); as ws) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">WAL Level</span>
                  <code>{{ ws.wal.walLevel }}</code>
                </div>
                <div class="status-item">
                  <span class="status-label">Archive Mode</span>
                  <span
                    class="badge"
                    [class.badge-success]="ws.wal.isArchivingEnabled"
                    [class.badge-warning]="!ws.wal.isArchivingEnabled"
                  >
                    {{ ws.wal.archiveMode }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">Archived / Failed</span>
                  <span
                    >{{ ws.wal.archivedCount }}
                    <span class="text-muted">/</span>
                    <span [class.text-danger]="ws.wal.failedCount > 0">{{
                      ws.wal.failedCount
                    }}</span></span
                  >
                </div>
                <div class="status-item">
                  <span class="status-label">Current LSN</span>
                  <code>{{ ws.wal.currentLsn }}</code>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }
          </div>
        </div>
      </div>

      <!-- Replication summary -->
      <div class="card mt-3">
        <div class="card-header">
          <h3>üîÑ Replication</h3>
          <button class="btn btn-sm btn-outline" (click)="switchTab('replication')">
            Chi ti·∫øt ‚Üí
          </button>
        </div>
        <div class="card-body">
          @if (replicationStatus(); as rs) {
            <div class="stat-grid stat-grid-4">
              <div class="stat">
                <span class="stat-value">
                  <span
                    class="badge"
                    [class.badge-info]="rs.serverRole === 'primary'"
                    [class.badge-warning]="rs.serverRole === 'standby'"
                  >
                    {{ rs.serverRole }}
                  </span>
                </span>
                <span class="stat-label">Server Role</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ rs.replicationSlots.length }}</span>
                <span class="stat-label">Replication Slots</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ rs.connectedReplicas.length }}</span>
                <span class="stat-label">Replicas</span>
              </div>
              <div class="stat">
                <span class="stat-value">
                  <span
                    class="badge"
                    [class.badge-success]="rs.isReplicating"
                    [class.badge-secondary]="!rs.isReplicating"
                  >
                    {{ rs.isReplicating ? 'ƒêang ch·∫°y' : 'Kh√¥ng' }}
                  </span>
                </span>
                <span class="stat-label">Tr·∫°ng th√°i</span>
              </div>
            </div>
          } @else {
            <p class="text-muted">Nh·∫•n v√†o "Chi ti·∫øt" ƒë·ªÉ xem tr·∫°ng th√°i replication</p>
          }
        </div>
      </div>

      <!-- Database backups list -->
      @if (dataStatus(); as ds) {
        <div class="card mt-3">
          <div class="card-header">
            <h3>üíæ B·∫£n sao l∆∞u Database</h3>
            <div class="d-flex gap-2">
              <button
                class="btn btn-sm btn-primary"
                [disabled]="dataBackupRunning"
                (click)="quickDbBackup()"
              >
                {{ dataBackupRunning ? '‚è≥ ƒêang sao l∆∞u...' : 'üíæ Sao l∆∞u DB' }}
              </button>
            </div>
          </div>
          @if (ds.backups.databaseBackups.length > 0) {
            <table class="table">
              <thead>
                <tr>
                  <th>T√™n file</th>
                  <th>K√≠ch th∆∞·ªõc</th>
                  <th>Checksum</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
                @for (file of ds.backups.databaseBackups; track file.fileName) {
                  <tr>
                    <td>
                      <code>{{ file.fileName }}</code>
                    </td>
                    <td>{{ formatSize(file.sizeBytes) }}</td>
                    <td>
                      @if (file.checksum) {
                        <code class="checksum" title="SHA-256: {{ file.checksum }}"
                          >{{ file.checksum.substring(0, 16) }}‚Ä¶</code
                        >
                      } @else {
                        <span class="text-muted">‚Äî</span>
                      }
                    </td>
                    <td>{{ formatDate(file.createdAt) }}</td>
                    <td>
                      <div class="btn-group">
                        <button
                          class="btn btn-sm btn-outline"
                          (click)="validateBackup(file.fileName)"
                          [disabled]="validatingFile() === file.fileName"
                        >
                          {{
                            validatingFile() === file.fileName ? '‚è≥ Ki·ªÉm tra...' : 'üîç X√°c minh'
                          }}
                        </button>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="deleteDataBackup(file.fileName)"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="card-body empty">Ch∆∞a c√≥ b·∫£n sao l∆∞u database n√†o</div>
          }
        </div>
      }

      <!-- Validation result -->
      @if (validationResult(); as vr) {
        @if (vr.type === 'database') {
          <div
            class="card validation-result mt-3"
            [class.validation-valid]="vr.isValid"
            [class.validation-invalid]="!vr.isValid"
          >
            <div class="card-header">
              <h3>{{ vr.isValid ? '‚úÖ X√°c minh th√†nh c√¥ng' : '‚ùå X√°c minh th·∫•t b·∫°i' }}</h3>
              <button class="btn btn-sm btn-outline" (click)="dismissValidation()">‚úï ƒê√≥ng</button>
            </div>
            <div class="card-body">
              @if (vr.checksum) {
                <p>
                  <strong>SHA-256:</strong> <code class="checksum-full">{{ vr.checksum }}</code>
                </p>
              }
              @if (vr.error) {
                <p class="text-danger"><strong>L·ªói:</strong> {{ vr.error }}</p>
              }
              @if (vr.isValid) {
                <p>
                  üìä <strong>{{ vr.tableCount }}</strong> b·∫£ng,
                  <strong>{{ vr.rowCount?.toLocaleString() }}</strong> b·∫£n ghi
                </p>
              }
            </div>
          </div>
        }
      }
    }

    <!-- ‚ïê‚ïê‚ïê MinIO Overview tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'minio-overview') {
      <div class="overview-grid overview-grid-2">
        <!-- MinIO connection info -->
        <div class="card">
          <div class="card-header">
            <h3>üì¶ Th√¥ng tin MinIO</h3>
            <button class="btn btn-sm btn-outline" (click)="loadDataStatus()">üîÑ L√†m m·ªõi</button>
          </div>
          <div class="card-body">
            @if (dataStatus(); as ds) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">K·∫øt n·ªëi</span>
                  <span
                    class="badge"
                    [ngClass]="ds.minio.connected ? 'badge-success' : 'badge-danger'"
                  >
                    {{ ds.minio.connected ? '‚úÖ ƒê√£ k·∫øt n·ªëi' : '‚ùå M·∫•t k·∫øt n·ªëi' }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">T·ªïng objects</span>
                  <span>{{ ds.minio.totalObjects }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">T·ªïng dung l∆∞·ª£ng</span>
                  <span class="badge badge-info">{{ formatSize(ds.minio.totalSizeBytes) }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">S·ªë buckets</span>
                  <span>{{ ds.minio.buckets.length }}</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }
          </div>
        </div>

        <!-- Bucket details -->
        <div class="card">
          <div class="card-header">
            <h3>ü™£ Chi ti·∫øt Buckets</h3>
          </div>
          <div class="card-body">
            @if (dataStatus(); as ds) {
              @if (ds.minio.buckets.length > 0) {
                <table class="table">
                  <thead>
                    <tr>
                      <th>Bucket</th>
                      <th>Objects</th>
                      <th>Dung l∆∞·ª£ng</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (bucket of ds.minio.buckets; track bucket.name) {
                      <tr>
                        <td>
                          <code>{{ bucket.name }}</code>
                        </td>
                        <td>{{ bucket.objectCount }}</td>
                        <td>{{ formatSize(bucket.sizeBytes) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              } @else {
                <p class="text-muted">Kh√¥ng c√≥ bucket n√†o</p>
              }
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }
          </div>
        </div>
      </div>

      <!-- MinIO backups list -->
      @if (dataStatus(); as ds) {
        <div class="card mt-3">
          <div class="card-header">
            <h3>üíæ B·∫£n sao l∆∞u MinIO</h3>
            <div class="d-flex gap-2">
              <button
                class="btn btn-sm btn-primary"
                [disabled]="dataBackupRunning"
                (click)="quickMinioBackup()"
              >
                {{ dataBackupRunning ? '‚è≥ ƒêang sao l∆∞u...' : 'üíæ Sao l∆∞u MinIO' }}
              </button>
            </div>
          </div>
          @if (ds.backups.minioBackups.length > 0) {
            <table class="table">
              <thead>
                <tr>
                  <th>T√™n file</th>
                  <th>K√≠ch th∆∞·ªõc</th>
                  <th>Checksum</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
                @for (file of ds.backups.minioBackups; track file.fileName) {
                  <tr>
                    <td>
                      <code>{{ file.fileName }}</code>
                    </td>
                    <td>{{ formatSize(file.sizeBytes) }}</td>
                    <td>
                      @if (file.checksum) {
                        <code class="checksum" title="SHA-256: {{ file.checksum }}"
                          >{{ file.checksum.substring(0, 16) }}‚Ä¶</code
                        >
                      } @else {
                        <span class="text-muted">‚Äî</span>
                      }
                    </td>
                    <td>{{ formatDate(file.createdAt) }}</td>
                    <td>
                      <div class="btn-group">
                        <button
                          class="btn btn-sm btn-outline"
                          (click)="validateBackup(file.fileName)"
                          [disabled]="validatingFile() === file.fileName"
                        >
                          {{
                            validatingFile() === file.fileName ? '‚è≥ Ki·ªÉm tra...' : 'üîç X√°c minh'
                          }}
                        </button>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="deleteDataBackup(file.fileName)"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="card-body empty">Ch∆∞a c√≥ b·∫£n sao l∆∞u MinIO n√†o</div>
          }
        </div>
      }

      <!-- Validation result -->
      @if (validationResult(); as vr) {
        @if (vr.type === 'minio') {
          <div
            class="card validation-result mt-3"
            [class.validation-valid]="vr.isValid"
            [class.validation-invalid]="!vr.isValid"
          >
            <div class="card-header">
              <h3>{{ vr.isValid ? '‚úÖ X√°c minh th√†nh c√¥ng' : '‚ùå X√°c minh th·∫•t b·∫°i' }}</h3>
              <button class="btn btn-sm btn-outline" (click)="dismissValidation()">‚úï ƒê√≥ng</button>
            </div>
            <div class="card-body">
              @if (vr.checksum) {
                <p>
                  <strong>SHA-256:</strong> <code class="checksum-full">{{ vr.checksum }}</code>
                </p>
              }
              @if (vr.error) {
                <p class="text-danger"><strong>L·ªói:</strong> {{ vr.error }}</p>
              }
              @if (vr.isValid) {
                <p>
                  üì¶ <strong>{{ vr.bucketCount }}</strong> bucket,
                  <strong>{{ vr.entryCount?.toLocaleString() }}</strong> m·ª•c
                </p>
              }
            </div>
          </div>
        }
      }
    }

    <!-- ‚ïê‚ïê‚ïê PKI tab (backup + restore) ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'pki') {
      <!-- Backup section -->
      <div class="card">
        <div class="card-header">
          <h3>üíæ Sao l∆∞u PKI / CA Keys</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline" (click)="loadArchives()">üîÑ L√†m m·ªõi</button>
            <button
              class="btn btn-sm btn-primary"
              [disabled]="loading()"
              (click)="startBackup(false)"
            >
              @if (loading()) {
                <span class="spinner-sm"></span>
              }
              Sao l∆∞u ƒë·∫ßy ƒë·ªß
            </button>
            <button
              class="btn btn-sm btn-outline"
              [disabled]="loading()"
              (click)="startBackup(true)"
            >
              Ch·ªâ Keys
            </button>
          </div>
        </div>
        @if (archives().length === 0) {
          <div class="card-body empty">
            <p>Ch∆∞a c√≥ b·∫£n sao l∆∞u n√†o. Nh·∫•n "Sao l∆∞u ƒë·∫ßy ƒë·ªß" ƒë·ªÉ t·∫°o.</p>
          </div>
        } @else {
          <table class="table">
            <thead>
              <tr>
                <th>T√™n file</th>
                <th>K√≠ch th∆∞·ªõc</th>
                <th>Ng√†y t·∫°o</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (archive of archives(); track archive.fileName) {
                <tr>
                  <td>
                    <code>{{ archive.fileName }}</code>
                  </td>
                  <td>{{ formatSize(archive.sizeBytes) }}</td>
                  <td>{{ formatDate(archive.createdAt) }}</td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline"
                      (click)="selectArchiveForRestore(archive.fileName)"
                    >
                      üîÑ Kh√¥i ph·ª•c
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>

      <!-- Restore section -->
      <div class="card mt-3">
        <div class="card-header">
          <h3>üîÑ Kh√¥i ph·ª•c PKI t·ª´ backup</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Ch·ªçn b·∫£n sao l∆∞u:</label>
            <select [(ngModel)]="selectedArchive" class="form-control">
              <option value="">-- Ch·ªçn --</option>
              @for (archive of archives(); track archive.fileName) {
                <option [value]="archive.fileName">
                  {{ archive.fileName }} ({{ formatSize(archive.sizeBytes) }})
                </option>
              }
            </select>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="restoreDryRun" />
              Ch·∫°y th·ª≠ (dry-run) ‚Äî kh√¥ng thay ƒë·ªïi d·ªØ li·ªáu
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="restoreKeysOnly" />
              Ch·ªâ kh√¥i ph·ª•c keys ‚Äî b·ªè qua d·ªØ li·ªáu container
            </label>
          </div>

          @if (!restoreDryRun) {
            <div class="warning-box">
              ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> Kh√¥i ph·ª•c s·∫Ω ghi ƒë√® database EJBCA & SignServer. Sau kh√¥i
              ph·ª•c c·∫ßn restart containers v√† re-apply mTLS/TSA.
            </div>
          }

          <div class="btn-group">
            <button
              class="btn btn-primary"
              [disabled]="!selectedArchive || loading()"
              (click)="startRestore()"
            >
              @if (loading()) {
                <span class="spinner-sm"></span>
              }
              {{ restoreDryRun ? 'Ch·∫°y th·ª≠' : 'B·∫Øt ƒë·∫ßu kh√¥i ph·ª•c' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê History tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'history') {
      <div class="card">
        <div class="card-header">
          <h3>L·ªãch s·ª≠ thao t√°c</h3>
          <button class="btn btn-sm btn-outline" (click)="loadOperations()">L√†m m·ªõi</button>
        </div>
        @if (recentOps.length === 0) {
          <div class="card-body empty">
            <p>Ch∆∞a c√≥ thao t√°c n√†o.</p>
          </div>
        } @else {
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Lo·∫°i</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                <th>B·∫Øt ƒë·∫ßu</th>
                <th>Th·ªùi gian</th>
                <th>Archive</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (op of recentOps; track op.id) {
                <tr>
                  <td>
                    <code class="op-id">{{ op.id }}</code>
                  </td>
                  <td>
                    <span
                      class="type-badge"
                      [class.backup]="op.type === 'Backup'"
                      [class.restore]="op.type === 'Restore'"
                    >
                      {{ op.type === 'Backup' ? 'üíæ Backup' : 'üîÑ Restore' }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getStatusBadgeClass(op.status)">
                      @if (op.status === 'Running') {
                        <span class="spinner-sm"></span>
                      }
                      {{ op.status }}
                    </span>
                  </td>
                  <td>{{ op.startedBy }}</td>
                  <td>{{ formatDate(op.startedAt) }}</td>
                  <td>{{ formatDuration(op) }}</td>
                  <td>
                    @if (op.archivePath) {
                      <code class="archive-name">{{ op.archivePath }}</code>
                    }
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline" (click)="viewOperationLogs(op.id)">
                      Logs
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Schedule tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'schedule') {
      <div class="schedule-grid">
        <!-- Schedule config card -->
        <div class="card">
          <div class="card-header">
            <h3>‚è∞ C·∫•u h√¨nh l·ªãch t·ª± ƒë·ªông</h3>
          </div>
          <div class="card-body">
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" [(ngModel)]="scheduleEnabled" />
                B·∫≠t sao l∆∞u t·ª± ƒë·ªông
              </label>
            </div>

            <div class="form-group">
              <label>Bi·ªÉu th·ª©c Cron (UTC)</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="scheduleCron"
                placeholder="0 2 * * *"
              />
              <div class="cron-hint">
                {{ describeCron(scheduleCron) }}
              </div>
              <div class="cron-examples">
                <span class="cron-example" (click)="scheduleCron = '0 2 * * *'">H√†ng ng√†y 2h</span>
                <span class="cron-example" (click)="scheduleCron = '0 3 * * 0'"
                  >CN h√†ng tu·∫ßn 3h</span
                >
                <span class="cron-example" (click)="scheduleCron = '0 1 1 * *'"
                  >Ng√†y 1 h√†ng th√°ng</span
                >
                <span class="cron-example" (click)="scheduleCron = '0 */6 * * *'">M·ªói 6 gi·ªù</span>
              </div>
            </div>

            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" [(ngModel)]="scheduleKeysOnly" />
                Ch·ªâ sao l∆∞u keys (b·ªè qua DB)
              </label>
            </div>

            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" [(ngModel)]="scheduleCloudSync" />
                ‚òÅÔ∏è T·ª± ƒë·ªông ƒë·ªìng b·ªô cloud sau backup
              </label>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Gi·ªØ l·∫°i (ng√†y)</label>
                <input
                  type="number"
                  class="form-control"
                  [(ngModel)]="scheduleRetentionDays"
                  min="1"
                  max="365"
                />
              </div>
              <div class="form-group">
                <label>T·ªëi ƒëa b·∫£n sao</label>
                <input
                  type="number"
                  class="form-control"
                  [(ngModel)]="scheduleMaxCount"
                  min="1"
                  max="500"
                />
              </div>
            </div>

            <div class="btn-group">
              <button class="btn btn-primary" (click)="saveSchedule()" [disabled]="scheduleSaving">
                @if (scheduleSaving) {
                  <span class="spinner-sm"></span>
                }
                L∆∞u c·∫•u h√¨nh
              </button>
              <button class="btn btn-outline" (click)="loadSchedule()">ƒê·∫∑t l·∫°i</button>
            </div>
          </div>
        </div>

        <!-- Schedule status card -->
        <div class="card">
          <div class="card-header">
            <h3>üìä Tr·∫°ng th√°i</h3>
          </div>
          <div class="card-body">
            @if (schedule(); as s) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">Tr·∫°ng th√°i</span>
                  <span class="badge" [ngClass]="s.enabled ? 'badge-success' : 'badge-secondary'">
                    {{ s.enabled ? '‚úÖ ƒêang b·∫≠t' : '‚è∏Ô∏è ƒê√£ t·∫Øt' }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">L·ªãch</span>
                  <span>{{ describeCron(s.cronExpression) }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">Cloud sync</span>
                  <span
                    class="badge"
                    [ngClass]="s.cloudSyncEnabled ? 'badge-success' : 'badge-secondary'"
                  >
                    {{ s.cloudSyncEnabled ? '‚òÅÔ∏è B·∫≠t' : '‚è∏Ô∏è T·∫Øt' }}
                  </span>
                </div>
                @if (s.nextScheduledRun) {
                  <div class="status-item">
                    <span class="status-label">Ch·∫°y ti·∫øp theo</span>
                    <span>{{ formatDate(s.nextScheduledRun) }}</span>
                  </div>
                }
                @if (s.lastScheduledRun) {
                  <div class="status-item">
                    <span class="status-label">Ch·∫°y g·∫ßn nh·∫•t</span>
                    <span>{{ formatDate(s.lastScheduledRun) }}</span>
                  </div>
                }
                @if (s.lastScheduledOperationId) {
                  <div class="status-item">
                    <span class="status-label">Operation ID</span>
                    <button
                      class="btn btn-sm btn-outline"
                      (click)="viewOperationLogs(s.lastScheduledOperationId!)"
                    >
                      Xem logs
                    </button>
                  </div>
                }
                <div class="status-item">
                  <span class="status-label">Ch√≠nh s√°ch x√≥a</span>
                  <span>Gi·ªØ {{ s.retentionDays }} ng√†y, t·ªëi ƒëa {{ s.maxBackupCount }} b·∫£n</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }

            <div class="btn-group mt-3">
              <button class="btn btn-outline" (click)="runCleanup()" [disabled]="cleanupRunning">
                @if (cleanupRunning) {
                  <span class="spinner-sm"></span>
                }
                üßπ D·ªçn d·∫πp ngay
              </button>
              <button class="btn btn-outline" (click)="loadSchedule()">üîÑ L√†m m·ªõi</button>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Cloud tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'cloud') {
      <!-- Cloud Config Card -->
      <div class="card mb-3">
        <div class="card-header">
          <h3>‚öôÔ∏è C·∫•u h√¨nh Cloud Provider</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Provider</label>
              <select [(ngModel)]="cloudConfigProvider" class="form-control">
                <option value="MinIO">MinIO (S3-compatible)</option>
                <option value="S3">AWS S3</option>
                <option value="Azure">Azure Blob Storage</option>
                <option value="GCS">Google Cloud Storage</option>
              </select>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" [(ngModel)]="cloudConfigCompression" />
                N√©n Brotli tr∆∞·ªõc khi upload
              </label>
            </div>
          </div>

          <!-- S3 / MinIO Settings -->
          @if (cloudConfigProvider === 'MinIO' || cloudConfigProvider === 'S3') {
            <h4 class="mt-2">
              ü™£ {{ cloudConfigProvider === 'MinIO' ? 'MinIO' : 'AWS S3' }} Settings
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Region</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigS3Region"
                  class="form-control"
                  placeholder="us-east-1"
                />
              </div>
              <div class="form-group">
                <label>Bucket Name</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigS3Bucket"
                  class="form-control"
                  placeholder="ivf-backups"
                />
              </div>
              <div class="form-group">
                <label>Access Key</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigS3AccessKey"
                  class="form-control"
                  placeholder="Access Key"
                />
              </div>
              <div class="form-group">
                <label>Secret Key</label>
                <input
                  type="password"
                  [(ngModel)]="cloudConfigS3SecretKey"
                  class="form-control"
                  placeholder="Secret Key"
                />
              </div>
              @if (cloudConfigProvider === 'MinIO') {
                <div class="form-group">
                  <label>Service URL</label>
                  <input
                    type="text"
                    [(ngModel)]="cloudConfigS3ServiceUrl"
                    class="form-control"
                    placeholder="http://localhost:9000"
                  />
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" [(ngModel)]="cloudConfigS3ForcePathStyle" />
                    Force Path Style
                  </label>
                </div>
              }
            </div>
          }

          <!-- Azure Settings -->
          @if (cloudConfigProvider === 'Azure') {
            <h4 class="mt-2">‚òÅÔ∏è Azure Blob Storage Settings</h4>
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Connection String</label>
                <input
                  type="password"
                  [(ngModel)]="cloudConfigAzureConnStr"
                  class="form-control"
                  placeholder="DefaultEndpointsProtocol=https;..."
                />
              </div>
              <div class="form-group">
                <label>Container Name</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigAzureContainer"
                  class="form-control"
                  placeholder="ivf-backups"
                />
              </div>
            </div>
          }

          <!-- GCS Settings -->
          @if (cloudConfigProvider === 'GCS') {
            <h4 class="mt-2">üåê Google Cloud Storage Settings</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Project ID</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigGcsProjectId"
                  class="form-control"
                  placeholder="my-project-id"
                />
              </div>
              <div class="form-group">
                <label>Bucket Name</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigGcsBucket"
                  class="form-control"
                  placeholder="ivf-backups"
                />
              </div>
              <div class="form-group full-width">
                <label>Credentials Path (JSON key file)</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigGcsCredentialsPath"
                  class="form-control"
                  placeholder="/path/to/service-account.json"
                />
              </div>
            </div>
          }

          <!-- Test connection result -->
          @if (cloudTestResult(); as tr) {
            <div class="test-result mt-1">
              <span class="badge" [ngClass]="tr.connected ? 'badge-success' : 'badge-danger'">
                {{ tr.connected ? '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng' : '‚ùå K·∫øt n·ªëi th·∫•t b·∫°i' }} ‚Äî
                {{ tr.provider }}
              </span>
            </div>
          }

          <div class="btn-group mt-2">
            <button
              class="btn btn-outline"
              [disabled]="cloudConfigTesting"
              (click)="testCloudConnection()"
            >
              @if (cloudConfigTesting) {
                <span class="spinner-sm"></span> ƒêang ki·ªÉm tra...
              } @else {
                üîå Test k·∫øt n·ªëi
              }
            </button>
            <button
              class="btn btn-primary"
              [disabled]="cloudConfigSaving"
              (click)="saveCloudConfig()"
            >
              @if (cloudConfigSaving) {
                <span class="spinner-sm"></span> ƒêang l∆∞u...
              } @else {
                üíæ L∆∞u c·∫•u h√¨nh
              }
            </button>
          </div>
        </div>
      </div>

      <div class="schedule-grid">
        <!-- Cloud status card -->
        <div class="card">
          <div class="card-header">
            <h3>‚òÅÔ∏è Tr·∫°ng th√°i Cloud</h3>
            <button class="btn btn-sm btn-outline" (click)="loadCloudData()">üîÑ L√†m m·ªõi</button>
          </div>
          <div class="card-body">
            @if (cloudStatus(); as cs) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">Provider</span>
                  <span class="badge badge-info">{{ cs.providerName }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">K·∫øt n·ªëi</span>
                  <span class="badge" [ngClass]="cs.connected ? 'badge-success' : 'badge-danger'">
                    {{ cs.connected ? '‚úÖ ƒê√£ k·∫øt n·ªëi' : '‚ùå M·∫•t k·∫øt n·ªëi' }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">N√©n d·ªØ li·ªáu</span>
                  <span
                    class="badge"
                    [ngClass]="cs.compressionEnabled ? 'badge-success' : 'badge-secondary'"
                  >
                    {{ cs.compressionEnabled ? 'üóúÔ∏è Brotli (b·∫≠t)' : '‚è∏Ô∏è T·∫Øt' }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">S·ªë b·∫£n sao</span>
                  <span>{{ cs.backupCount }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">T·ªïng dung l∆∞·ª£ng</span>
                  <span>{{ formatSize(cs.totalSizeBytes) }}</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang ki·ªÉm tra k·∫øt n·ªëi...</p>
            }
          </div>
        </div>

        <!-- Upload to cloud card -->
        <div class="card">
          <div class="card-header">
            <h3>‚¨ÜÔ∏è Upload l√™n Cloud</h3>
          </div>
          <div class="card-body">
            @if (archives().length === 0) {
              <p class="text-muted">Ch∆∞a c√≥ b·∫£n sao l∆∞u local n√†o</p>
            } @else {
              <p>Ch·ªçn b·∫£n sao l∆∞u local ƒë·ªÉ upload (c√≥ n√©n Brotli):</p>
              <div class="archive-upload-list">
                @for (archive of archives(); track archive.fileName) {
                  <div class="archive-upload-item">
                    <div class="archive-upload-info">
                      <code>{{ archive.fileName }}</code>
                      <span class="text-muted">{{ formatSize(archive.sizeBytes) }}</span>
                    </div>
                    <button
                      class="btn btn-sm btn-primary"
                      [disabled]="cloudUploading() !== null"
                      (click)="uploadToCloud(archive.fileName)"
                    >
                      @if (cloudUploading() === archive.fileName) {
                        <span class="spinner-sm"></span> ƒêang n√©n & upload...
                      } @else {
                        ‚¨ÜÔ∏è Upload
                      }
                    </button>
                  </div>
                }
              </div>
            }

            <!-- Upload result -->
            @if (lastUploadResult(); as ur) {
              <div class="compression-stats">
                <h4>üìä K·∫øt qu·∫£ upload & n√©n</h4>
                <div class="stat-grid">
                  <div class="stat">
                    <span class="stat-value">{{ formatSize(ur.originalSizeBytes) }}</span>
                    <span class="stat-label">G·ªëc</span>
                  </div>
                  @if (ur.compressedSizeBytes) {
                    <div class="stat">
                      <span class="stat-value">{{ formatSize(ur.compressedSizeBytes) }}</span>
                      <span class="stat-label">Sau n√©n</span>
                    </div>
                    <div class="stat">
                      <span class="stat-value">{{ ur.compressionRatioPercent?.toFixed(1) }}%</span>
                      <span class="stat-label">T·ª∑ l·ªá n√©n</span>
                    </div>
                    <div class="stat">
                      <span class="stat-value">{{ ur.compressionDurationMs }}ms</span>
                      <span class="stat-label">Th·ªùi gian n√©n</span>
                    </div>
                  }
                  <div class="stat">
                    <span class="stat-value">{{ formatSize(ur.cloudSizeBytes) }}</span>
                    <span class="stat-label">Tr√™n Cloud</span>
                  </div>
                </div>
                @if (ur.compressedSizeBytes && ur.originalSizeBytes > ur.compressedSizeBytes) {
                  <div class="compression-savings">
                    üí∞ Ti·∫øt ki·ªám:
                    {{ formatSize(ur.originalSizeBytes - ur.compressedSizeBytes) }} ({{
                      (100 - (ur.compressionRatioPercent ?? 100)).toFixed(1)
                    }}%)
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Cloud backups list -->
      <div class="card mt-3">
        <div class="card-header">
          <h3>üì¶ B·∫£n sao l∆∞u tr√™n Cloud</h3>
          <button class="btn btn-sm btn-outline" (click)="loadCloudData()">L√†m m·ªõi</button>
        </div>
        @if (cloudBackups().length === 0) {
          <div class="card-body empty">
            <p>Ch∆∞a c√≥ b·∫£n sao l∆∞u n√†o tr√™n cloud.</p>
          </div>
        } @else {
          <table class="table">
            <thead>
              <tr>
                <th>Object Key</th>
                <th>K√≠ch th∆∞·ªõc</th>
                <th>Ng√†y s·ª≠a ƒë·ªïi</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (obj of cloudBackups(); track obj.objectKey) {
                <tr>
                  <td>
                    <code>{{ obj.fileName }}</code>
                    @if (obj.fileName.endsWith('.br')) {
                      <span class="badge badge-info ml-1">üóúÔ∏è Brotli</span>
                    }
                  </td>
                  <td>{{ formatSize(obj.sizeBytes) }}</td>
                  <td>{{ formatDate(obj.lastModified) }}</td>
                  <td>
                    <div class="btn-group">
                      <button
                        class="btn btn-sm btn-outline"
                        [disabled]="cloudDownloading() !== null"
                        (click)="downloadFromCloud(obj.objectKey)"
                      >
                        @if (cloudDownloading() === obj.objectKey) {
                          <span class="spinner-sm"></span>
                        }
                        ‚¨áÔ∏è T·∫£i v·ªÅ
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        (click)="deleteFromCloud(obj.objectKey)"
                      >
                        üóëÔ∏è X√≥a
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Data backup tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'data') {
      <div class="overview-grid">
        <!-- Database status card -->
        <div class="card">
          <div class="card-header">
            <h3>üêò PostgreSQL</h3>
            <button class="btn btn-sm btn-outline" (click)="loadDataStatus()">üîÑ L√†m m·ªõi</button>
          </div>
          <div class="card-body">
            @if (dataStatus(); as ds) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">C∆° s·ªü d·ªØ li·ªáu</span>
                  <span>{{ ds.database.databaseName }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">K√≠ch th∆∞·ªõc</span>
                  <span class="badge badge-info">{{ formatSize(ds.database.sizeBytes) }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">S·ªë b·∫£ng</span>
                  <span>{{ ds.database.tableCount }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">K·∫øt n·ªëi</span>
                  <span
                    class="badge"
                    [ngClass]="ds.database.connected ? 'badge-success' : 'badge-danger'"
                  >
                    {{ ds.database.connected ? '‚úÖ ƒê√£ k·∫øt n·ªëi' : '‚ùå M·∫•t k·∫øt n·ªëi' }}
                  </span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }
          </div>
        </div>

        <!-- MinIO status card -->
        <div class="card">
          <div class="card-header">
            <h3>üì¶ MinIO</h3>
          </div>
          <div class="card-body">
            @if (dataStatus(); as ds) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">T·ªïng objects</span>
                  <span>{{ ds.minio.totalObjects }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">T·ªïng dung l∆∞·ª£ng</span>
                  <span class="badge badge-info">{{ formatSize(ds.minio.totalSizeBytes) }}</span>
                </div>
                @for (bucket of ds.minio.buckets; track bucket.name) {
                  <div class="status-item">
                    <span class="status-label">{{ bucket.name }}</span>
                    <span>{{ bucket.objectCount }} obj ¬∑ {{ formatSize(bucket.sizeBytes) }}</span>
                  </div>
                }
                <div class="status-item">
                  <span class="status-label">K·∫øt n·ªëi</span>
                  <span
                    class="badge"
                    [ngClass]="ds.minio.connected ? 'badge-success' : 'badge-danger'"
                  >
                    {{ ds.minio.connected ? '‚úÖ ƒê√£ k·∫øt n·ªëi' : '‚ùå M·∫•t k·∫øt n·ªëi' }}
                  </span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }
          </div>
        </div>
      </div>

      <!-- Backup controls -->
      <div class="card mt-3">
        <div class="card-header">
          <h3>üíæ T·∫°o b·∫£n sao l∆∞u d·ªØ li·ªáu</h3>
        </div>
        <div class="card-body">
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="dataIncludeDatabase" />
              üêò Sao l∆∞u PostgreSQL (pg_dump)
            </label>
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="dataIncludeMinio" />
              üì¶ Sao l∆∞u MinIO (t·ªáp l∆∞u tr·ªØ)
            </label>
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="dataUploadToCloud" />
              ‚òÅÔ∏è Upload l√™n Cloud sau khi sao l∆∞u
            </label>
          </div>
          <button
            class="btn btn-primary mt-2"
            [disabled]="dataBackupRunning || (!dataIncludeDatabase && !dataIncludeMinio)"
            (click)="startDataBackup()"
          >
            @if (dataBackupRunning) {
              <span class="spinner-sm"></span> ƒêang sao l∆∞u...
            } @else {
              üíæ B·∫Øt ƒë·∫ßu sao l∆∞u
            }
          </button>
        </div>
      </div>

      <!-- Database backup files -->
      @if (dataStatus(); as ds) {
        @if (ds.backups.databaseBackups.length > 0) {
          <div class="card mt-3">
            <div class="card-header">
              <h3>üêò B·∫£n sao l∆∞u PostgreSQL</h3>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>T√™n file</th>
                  <th>K√≠ch th∆∞·ªõc</th>
                  <th>Checksum</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
                @for (file of ds.backups.databaseBackups; track file.fileName) {
                  <tr>
                    <td>
                      <code>{{ file.fileName }}</code>
                    </td>
                    <td>{{ formatSize(file.sizeBytes) }}</td>
                    <td>
                      @if (file.checksum) {
                        <code class="checksum" title="SHA-256: {{ file.checksum }}"
                          >{{ file.checksum.substring(0, 16) }}‚Ä¶</code
                        >
                      } @else {
                        <span class="text-muted">‚Äî</span>
                      }
                    </td>
                    <td>{{ formatDate(file.createdAt) }}</td>
                    <td>
                      <div class="btn-group">
                        <button
                          class="btn btn-sm btn-outline"
                          (click)="selectedDbBackup = file.fileName"
                          [class.btn-primary]="selectedDbBackup === file.fileName"
                        >
                          {{
                            selectedDbBackup === file.fileName ? '‚úÖ ƒê√£ ch·ªçn' : 'üîÑ Ch·ªçn kh√¥i ph·ª•c'
                          }}
                        </button>
                        <button
                          class="btn btn-sm btn-outline"
                          (click)="validateBackup(file.fileName)"
                          [disabled]="validatingFile() === file.fileName"
                        >
                          {{
                            validatingFile() === file.fileName
                              ? '‚è≥ ƒêang ki·ªÉm tra...'
                              : 'üîç X√°c minh'
                          }}
                        </button>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="deleteDataBackup(file.fileName)"
                        >
                          üóëÔ∏è X√≥a
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }

        @if (ds.backups.minioBackups.length > 0) {
          <div class="card mt-3">
            <div class="card-header">
              <h3>üì¶ B·∫£n sao l∆∞u MinIO</h3>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>T√™n file</th>
                  <th>K√≠ch th∆∞·ªõc</th>
                  <th>Checksum</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
                @for (file of ds.backups.minioBackups; track file.fileName) {
                  <tr>
                    <td>
                      <code>{{ file.fileName }}</code>
                    </td>
                    <td>{{ formatSize(file.sizeBytes) }}</td>
                    <td>
                      @if (file.checksum) {
                        <code class="checksum" title="SHA-256: {{ file.checksum }}"
                          >{{ file.checksum.substring(0, 16) }}‚Ä¶</code
                        >
                      } @else {
                        <span class="text-muted">‚Äî</span>
                      }
                    </td>
                    <td>{{ formatDate(file.createdAt) }}</td>
                    <td>
                      <div class="btn-group">
                        <button
                          class="btn btn-sm btn-outline"
                          (click)="selectedMinioBackup = file.fileName"
                          [class.btn-primary]="selectedMinioBackup === file.fileName"
                        >
                          {{
                            selectedMinioBackup === file.fileName
                              ? '‚úÖ ƒê√£ ch·ªçn'
                              : 'üîÑ Ch·ªçn kh√¥i ph·ª•c'
                          }}
                        </button>
                        <button
                          class="btn btn-sm btn-outline"
                          (click)="validateBackup(file.fileName)"
                          [disabled]="validatingFile() === file.fileName"
                        >
                          {{
                            validatingFile() === file.fileName
                              ? '‚è≥ ƒêang ki·ªÉm tra...'
                              : 'üîç X√°c minh'
                          }}
                        </button>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="deleteDataBackup(file.fileName)"
                        >
                          üóëÔ∏è X√≥a
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }

        <!-- Validation result panel -->
        @if (validationResult(); as vr) {
          <div
            class="card validation-result mt-3"
            [class.validation-valid]="vr.isValid"
            [class.validation-invalid]="!vr.isValid"
          >
            <div class="card-header">
              <h3>{{ vr.isValid ? '‚úÖ X√°c minh th√†nh c√¥ng' : '‚ùå X√°c minh th·∫•t b·∫°i' }}</h3>
              <button class="btn btn-sm btn-outline" (click)="dismissValidation()">‚úï ƒê√≥ng</button>
            </div>
            <div class="card-body">
              @if (vr.checksum) {
                <p>
                  <strong>SHA-256:</strong> <code class="checksum-full">{{ vr.checksum }}</code>
                </p>
              }
              @if (vr.error) {
                <p class="text-danger"><strong>L·ªói:</strong> {{ vr.error }}</p>
              }
              @if (vr.type === 'database' && vr.isValid) {
                <p>
                  üìä <strong>{{ vr.tableCount }}</strong> b·∫£ng,
                  <strong>{{ vr.rowCount?.toLocaleString() }}</strong> b·∫£n ghi
                </p>
              }
              @if (vr.type === 'minio' && vr.isValid) {
                <p>
                  üì¶ <strong>{{ vr.bucketCount }}</strong> bucket,
                  <strong>{{ vr.entryCount?.toLocaleString() }}</strong> m·ª•c
                </p>
              }
            </div>
          </div>
        }

        <!-- Restore button -->
        @if (selectedDbBackup || selectedMinioBackup) {
          <div class="card mt-3">
            <div class="card-header">
              <h3>üîÑ Kh√¥i ph·ª•c d·ªØ li·ªáu</h3>
            </div>
            <div class="card-body">
              @if (selectedDbBackup) {
                <p>
                  üêò Database: <code>{{ selectedDbBackup }}</code>
                </p>
              }
              @if (selectedMinioBackup) {
                <p>
                  üì¶ MinIO: <code>{{ selectedMinioBackup }}</code>
                </p>
              }
              <button
                class="btn btn-danger mt-1"
                [disabled]="dataRestoreRunning"
                (click)="startDataRestore()"
              >
                @if (dataRestoreRunning) {
                  <span class="spinner-sm"></span> ƒêang kh√¥i ph·ª•c...
                } @else {
                  üîÑ B·∫Øt ƒë·∫ßu kh√¥i ph·ª•c
                }
              </button>
            </div>
          </div>
        }
      }
    }

    <!-- ‚ïê‚ïê‚ïê Strategies tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'strategies') {
      <div class="card">
        <div class="card-header d-flex justify-between align-center">
          <h3>üìã Chi·∫øn l∆∞·ª£c sao l∆∞u d·ªØ li·ªáu</h3>
          <button class="btn btn-primary btn-sm" (click)="openNewStrategyForm()">+ T·∫°o m·ªõi</button>
        </div>
        <div class="card-body">
          <!-- Strategy Form -->
          @if (showStrategyForm) {
            <div class="strategy-form mb-4">
              <h4>{{ editingStrategyId ? '‚úèÔ∏è Ch·ªânh s·ª≠a chi·∫øn l∆∞·ª£c' : '‚ûï T·∫°o chi·∫øn l∆∞·ª£c m·ªõi' }}</h4>

              <div class="form-grid">
                <div class="form-group">
                  <label>T√™n chi·∫øn l∆∞·ª£c *</label>
                  <input
                    type="text"
                    [(ngModel)]="strategyForm.name"
                    placeholder="VD: Sao l∆∞u h√†ng ng√†y"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label>M√¥ t·∫£</label>
                  <input
                    type="text"
                    [(ngModel)]="strategyForm.description"
                    placeholder="M√¥ t·∫£ t√πy ch·ªçn"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label>Cron Expression *</label>
                  <input
                    type="text"
                    [(ngModel)]="strategyForm.cronExpression"
                    placeholder="0 2 * * *"
                    class="form-control"
                  />
                  <small class="text-muted">{{ describeCron(strategyForm.cronExpression) }}</small>
                </div>

                <div class="form-group">
                  <label>Gi·ªØ l·∫°i (ng√†y)</label>
                  <input
                    type="number"
                    [(ngModel)]="strategyForm.retentionDays"
                    min="1"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label>S·ªë b·∫£n sao l∆∞u t·ªëi ƒëa</label>
                  <input
                    type="number"
                    [(ngModel)]="strategyForm.maxBackupCount"
                    min="1"
                    class="form-control"
                  />
                </div>
              </div>

              <div class="checkbox-group mt-2">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="strategyForm.includeDatabase" />
                  üóÑÔ∏è Database (PostgreSQL)
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="strategyForm.includeMinio" />
                  üì¶ MinIO Object Storage
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="strategyForm.uploadToCloud" />
                  ‚òÅÔ∏è Upload l√™n Cloud
                </label>
              </div>

              <div class="mt-3 d-flex gap-2">
                <button
                  class="btn btn-primary btn-sm"
                  [disabled]="strategySaving || !strategyForm.name.trim()"
                  (click)="saveStrategy()"
                >
                  @if (strategySaving) {
                    <span class="spinner-sm"></span> ƒêang l∆∞u...
                  } @else {
                    üíæ L∆∞u
                  }
                </button>
                <button class="btn btn-secondary btn-sm" (click)="cancelStrategyForm()">H·ªßy</button>
              </div>
            </div>
          }

          <!-- Strategy List -->
          @if (strategies().length === 0 && !showStrategyForm) {
            <div class="empty-state">
              <p>Ch∆∞a c√≥ chi·∫øn l∆∞·ª£c sao l∆∞u n√†o.</p>
              <p class="text-muted">
                T·∫°o chi·∫øn l∆∞·ª£c ƒë·ªÉ t·ª± ƒë·ªông sao l∆∞u database v√† MinIO theo l·ªãch.
              </p>
            </div>
          }

          @for (s of strategies(); track s.id) {
            <div class="strategy-card" [class.strategy-disabled]="!s.enabled">
              <div class="strategy-header">
                <div class="strategy-info">
                  <h4>
                    {{ s.name }}
                    @if (!s.enabled) {
                      <span class="badge badge-secondary">T·∫Øt</span>
                    }
                  </h4>
                  @if (s.description) {
                    <p class="text-muted mb-0">{{ s.description }}</p>
                  }
                </div>
                <div class="strategy-actions">
                  <button
                    class="btn btn-sm"
                    [class.btn-success]="!s.enabled"
                    [class.btn-warning]="s.enabled"
                    (click)="toggleStrategy(s)"
                    [title]="s.enabled ? 'T·∫Øt' : 'B·∫≠t'"
                  >
                    {{ s.enabled ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}
                  </button>
                  <button class="btn btn-primary btn-sm" (click)="runStrategy(s)" title="Ch·∫°y ngay">
                    üöÄ
                  </button>
                  <button class="btn btn-secondary btn-sm" (click)="editStrategy(s)" title="S·ª≠a">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="deleteStrategy(s)" title="X√≥a">
                    üóëÔ∏è
                  </button>
                </div>
              </div>

              <div class="strategy-details">
                <div class="detail-chips">
                  @if (s.includeDatabase) {
                    <span class="chip chip-db">üóÑÔ∏è Database</span>
                  }
                  @if (s.includeMinio) {
                    <span class="chip chip-minio">üì¶ MinIO</span>
                  }
                  @if (s.uploadToCloud) {
                    <span class="chip chip-cloud">‚òÅÔ∏è Cloud</span>
                  }
                </div>

                <div class="detail-row">
                  <span>‚è∞ L·ªãch: {{ describeCron(s.cronExpression) }}</span>
                  <span
                    >üìÖ Gi·ªØ: {{ s.retentionDays }} ng√†y / t·ªëi ƒëa {{ s.maxBackupCount }} b·∫£n</span
                  >
                </div>

                @if (s.lastRunAt) {
                  <div class="detail-row last-run">
                    <span>
                      L·∫ßn ch·∫°y cu·ªëi: {{ formatDate(s.lastRunAt) }}
                      <span class="badge" [ngClass]="getStatusBadgeClass(s.lastRunStatus || '')">
                        {{ s.lastRunStatus }}
                      </span>
                    </span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê 3-2-1 Compliance tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'compliance') {
      <div class="card">
        <div class="card-header">
          <h3>üõ°Ô∏è Quy t·∫Øc 3-2-1 Backup</h3>
          <button
            class="btn btn-sm btn-outline"
            (click)="loadCompliance()"
            [disabled]="complianceLoading"
          >
            {{ complianceLoading ? 'ƒêang t·∫£i...' : 'üîÑ L√†m m·ªõi' }}
          </button>
        </div>
        <div class="card-body">
          @if (compliance(); as c) {
            <!-- Score -->
            <div class="compliance-score-row">
              <div class="compliance-score-card">
                <div
                  class="score-circle"
                  [style.border-color]="getComplianceColor(c.ruleScore, c.maxRuleScore)"
                >
                  <span
                    class="score-value"
                    [style.color]="getComplianceColor(c.ruleScore, c.maxRuleScore)"
                  >
                    {{ c.ruleScore }}/{{ c.maxRuleScore }}
                  </span>
                </div>
                <div class="score-label">3-2-1 Score</div>
                <div
                  class="score-badge"
                  [class.compliant]="c.isCompliant"
                  [class.non-compliant]="!c.isCompliant"
                >
                  {{ c.isCompliant ? '‚úÖ Tu√¢n th·ªß' : '‚ö†Ô∏è Ch∆∞a ƒë·∫°t' }}
                </div>
              </div>
              <div class="compliance-rule-cards">
                <div class="rule-card" [class.passed]="c.copiesCount >= 3">
                  <div class="rule-number">{{ c.copiesCount }}/3</div>
                  <div class="rule-label">B·∫£n sao d·ªØ li·ªáu</div>
                </div>
                <div class="rule-card" [class.passed]="c.storageTypesCount >= 2">
                  <div class="rule-number">{{ c.storageTypesCount }}/2</div>
                  <div class="rule-label">Lo·∫°i l∆∞u tr·ªØ</div>
                </div>
                <div class="rule-card" [class.passed]="c.offsiteCopiesCount >= 1">
                  <div class="rule-number">{{ c.offsiteCopiesCount }}/1</div>
                  <div class="rule-label">Offsite</div>
                </div>
              </div>
            </div>

            <!-- Checks -->
            <h4 class="section-subtitle">Ki·ªÉm tra chi ti·∫øt</h4>
            <div class="compliance-checks">
              @for (check of c.checks; track check.id) {
                <div
                  class="compliance-check"
                  [class.passed]="check.passed"
                  [class.failed]="!check.passed"
                >
                  <span class="check-icon">{{ check.passed ? '‚úÖ' : '‚ùå' }}</span>
                  <div class="check-content">
                    <div class="check-label">{{ check.label }}</div>
                    <div class="check-detail">{{ check.detail }}</div>
                  </div>
                </div>
              }
            </div>

            <!-- Recommendations -->
            @if (c.recommendations.length > 0) {
              <h4 class="section-subtitle">üí° Khuy·∫øn ngh·ªã</h4>
              <div class="recommendations">
                @for (rec of c.recommendations; track rec) {
                  <div class="recommendation-item"><span>‚Üí</span> {{ rec }}</div>
                }
              </div>
            }

            <!-- Summary stats -->
            <h4 class="section-subtitle">T·ªïng k·∫øt</h4>
            <div class="stat-grid stat-grid-5">
              <div class="stat">
                <span class="stat-value">{{ c.summary.totalDbBackups }}</span>
                <span class="stat-label">DB Backups</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ c.summary.totalMinioBackups }}</span>
                <span class="stat-label">MinIO Backups</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ c.summary.totalBaseBackups }}</span>
                <span class="stat-label">Base Backups</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ c.summary.totalPkiBackups }}</span>
                <span class="stat-label">PKI Backups</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ c.summary.replicaCount }}</span>
                <span class="stat-label">Replicas</span>
              </div>
            </div>
          } @else if (complianceLoading) {
            <div class="card-body empty"><span class="spinner"></span> ƒêang ki·ªÉm tra...</div>
          } @else {
            <div class="card-body empty">Nh·∫•n "L√†m m·ªõi" ƒë·ªÉ ki·ªÉm tra tu√¢n th·ªß 3-2-1</div>
          }
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê WAL tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'wal') {
      <div class="card">
        <div class="card-header">
          <h3>üìù WAL ‚Äî Write-Ahead Log</h3>
          <button class="btn btn-sm btn-outline" (click)="loadWalStatus()" [disabled]="walLoading">
            {{ walLoading ? 'ƒêang t·∫£i...' : 'üîÑ L√†m m·ªõi' }}
          </button>
        </div>
        <div class="card-body">
          @if (walStatus(); as ws) {
            <div class="overview-grid">
              <!-- WAL Configuration -->
              <div class="card mb-0">
                <div class="card-header"><h3>C·∫•u h√¨nh WAL</h3></div>
                <div class="card-body">
                  <table class="table">
                    <tbody>
                      <tr>
                        <td>WAL Level</td>
                        <td>
                          <code>{{ ws.wal.walLevel }}</code>
                        </td>
                      </tr>
                      <tr>
                        <td>Archive Mode</td>
                        <td>
                          <span
                            class="badge"
                            [class.badge-success]="ws.wal.isArchivingEnabled"
                            [class.badge-warning]="!ws.wal.isArchivingEnabled"
                          >
                            {{ ws.wal.archiveMode }}
                          </span>
                        </td>
                      </tr>
                      <tr>
                        <td>Archive Command</td>
                        <td>
                          <code class="code-sm">{{ ws.wal.archiveCommand || '(none)' }}</code>
                        </td>
                      </tr>
                      <tr>
                        <td>Archive Timeout</td>
                        <td>{{ ws.wal.archiveTimeout }}s</td>
                      </tr>
                      <tr>
                        <td>Segment Size</td>
                        <td>{{ ws.wal.walSegmentSize }}</td>
                      </tr>
                      <tr>
                        <td>Current LSN</td>
                        <td>
                          <code>{{ ws.wal.currentLsn }}</code>
                        </td>
                      </tr>
                      <tr>
                        <td>WAL Written</td>
                        <td>{{ formatSize(ws.wal.walBytesWritten) }}</td>
                      </tr>
                    </tbody>
                  </table>
                  @if (!ws.wal.isArchivingEnabled) {
                    <button
                      class="btn btn-primary mt-2"
                      (click)="enableWalArchiving()"
                      [disabled]="walEnabling"
                    >
                      {{ walEnabling ? 'ƒêang b·∫≠t...' : '‚ö° B·∫≠t WAL Archiving' }}
                    </button>
                  }
                </div>
              </div>

              <!-- Archive Stats -->
              <div class="card mb-0">
                <div class="card-header"><h3>Th·ªëng k√™ Archive</h3></div>
                <div class="card-body">
                  <div class="stat-grid">
                    <div class="stat">
                      <span class="stat-value">{{ ws.wal.archivedCount }}</span>
                      <span class="stat-label">WAL Archived</span>
                    </div>
                    <div class="stat">
                      <span class="stat-value">{{ ws.wal.failedCount }}</span>
                      <span class="stat-label">Failed</span>
                    </div>
                    <div class="stat">
                      <span class="stat-value">{{ ws.archive.fileCount }}</span>
                      <span class="stat-label">Archive Files</span>
                    </div>
                    <div class="stat">
                      <span class="stat-value">{{ formatSize(ws.archive.totalSizeBytes) }}</span>
                      <span class="stat-label">Archive Size</span>
                    </div>
                  </div>
                  @if (ws.wal.lastArchivedWal) {
                    <p class="text-muted text-sm mt-2">
                      WAL m·ªõi nh·∫•t: <code>{{ ws.wal.lastArchivedWal }}</code> ({{
                        ws.wal.lastArchivedTime
                      }})
                    </p>
                  }
                  <div class="d-flex gap-2 mt-3">
                    <button
                      class="btn btn-sm btn-outline"
                      (click)="switchWal()"
                      [disabled]="walSwitching"
                    >
                      {{ walSwitching ? '...' : 'üîÑ Switch WAL' }}
                    </button>
                    <button
                      class="btn btn-sm btn-primary"
                      (click)="createBaseBackup()"
                      [disabled]="baseBackupRunning"
                    >
                      {{ baseBackupRunning ? 'ƒêang t·∫°o...' : 'üíæ T·∫°o Base Backup' }}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Base Backups list -->
            @if (baseBackups().length > 0) {
              <div class="card mt-3">
                <div class="card-header"><h3>Base Backups (pg_basebackup)</h3></div>
                <div class="card-body">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>T√™n file</th>
                        <th>K√≠ch th∆∞·ªõc</th>
                        <th>Th·ªùi gian</th>
                        <th>Checksum</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (b of baseBackups(); track b.fileName) {
                        <tr>
                          <td>{{ b.fileName }}</td>
                          <td>{{ formatSize(b.sizeBytes) }}</td>
                          <td>{{ formatDate(b.createdAt) }}</td>
                          <td>
                            <code class="code-xs">{{
                              b.checksum ? b.checksum.substring(0, 16) + '...' : '‚Äî'
                            }}</code>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            }

            <!-- WAL Archives (hourly backup) -->
            @if (walArchives(); as wa) {
              <div class="card mt-3">
                <div class="card-header">
                  <h3>üì¶ WAL Archives (Hourly Log Backup)</h3>
                  <span class="badge badge-primary"
                    >{{ wa.totalCount }} file ¬∑ {{ formatSize(wa.totalSizeBytes) }}</span
                  >
                </div>
                <div class="card-body">
                  @if (wa.files.length > 0) {
                    <table class="table">
                      <thead>
                        <tr>
                          <th>T√™n file</th>
                          <th>K√≠ch th∆∞·ªõc</th>
                          <th>Th·ªùi gian</th>
                          <th>Checksum</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (f of wa.files; track f.fileName) {
                          <tr>
                            <td>
                              <code>{{ f.fileName }}</code>
                            </td>
                            <td>{{ formatSize(f.sizeBytes) }}</td>
                            <td>{{ formatDate(f.createdAt) }}</td>
                            <td>
                              <code class="code-xs">{{
                                f.checksum ? f.checksum.substring(0, 16) + '...' : '‚Äî'
                              }}</code>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  } @else {
                    <p class="empty-text">
                      Ch∆∞a c√≥ WAL archive. Scheduler ch·∫°y m·ªói gi·ªù khi WAL archiving ƒë√£ b·∫≠t.
                    </p>
                  }
                </div>
              </div>
            }

            <!-- PITR Restore -->
            <div class="card mt-3">
              <div class="card-header">
                <h3>‚è±Ô∏è PITR ‚Äî Point-in-Time Recovery</h3>
                <button class="btn btn-sm btn-outline" (click)="togglePitrPanel()">
                  {{ showPitrPanel ? '‚ñ≤ ·∫®n' : '‚ñº M·ªü r·ªông' }}
                </button>
              </div>
              @if (showPitrPanel) {
                <div class="card-body">
                  <p class="text-muted text-sm mb-3">
                    Kh√¥i ph·ª•c database t·ª´ base backup + WAL t·ªõi m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ ho·∫∑c m·ªõi nh·∫•t.
                  </p>

                  <div class="pitr-form-grid">
                    <!-- Base Backup Selection -->
                    <div class="form-group">
                      <label>Base Backup</label>
                      <select [(ngModel)]="pitrSelectedBackup" class="form-control">
                        <option value="">-- Ch·ªçn base backup --</option>
                        @for (b of baseBackups(); track b.fileName) {
                          <option [value]="b.fileName">
                            {{ b.fileName }} ({{ formatSize(b.sizeBytes) }})
                          </option>
                        }
                      </select>
                    </div>

                    <!-- Target Time -->
                    <div class="form-group">
                      <label
                        >Th·ªùi ƒëi·ªÉm kh√¥i ph·ª•c
                        <small class="text-muted">(ƒë·ªÉ tr·ªëng = latest)</small></label
                      >
                      <input
                        type="datetime-local"
                        [(ngModel)]="pitrTargetTime"
                        class="form-control"
                        placeholder="ƒê·ªÉ tr·ªëng = restore t·ªõi m·ªõi nh·∫•t"
                      />
                    </div>
                  </div>

                  <div class="checkbox-group mt-3 mb-3">
                    <label class="checkbox-label">
                      <input type="checkbox" [(ngModel)]="pitrDryRun" />
                      <span
                        >Dry Run
                        <small class="text-muted">(ch·ªâ ki·ªÉm tra, kh√¥ng th·ª±c thi)</small></span
                      >
                    </label>
                  </div>

                  <div class="d-flex gap-2">
                    <button
                      class="btn btn-primary"
                      (click)="startPitrRestore()"
                      [disabled]="pitrRestoreRunning || !pitrSelectedBackup"
                    >
                      {{
                        pitrRestoreRunning
                          ? '‚è≥ ƒêang ch·∫°y...'
                          : pitrDryRun
                            ? 'üîç Dry-Run PITR'
                            : 'üöÄ Ch·∫°y PITR Restore'
                      }}
                    </button>
                  </div>

                  <!-- PITR Logs -->
                  @if (pitrLogs().length > 0) {
                    <div class="pitr-log-panel" #logContainer>
                      @for (log of pitrLogs(); track $index) {
                        <div class="pitr-log-line" [class]="getLogLevelClass(log.level)">
                          <span class="log-time">{{ log.timestamp | date: 'HH:mm:ss' }}</span>
                          <span class="log-level">[{{ log.level }}]</span>
                          <span class="log-msg">{{ log.message }}</span>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          } @else if (walLoading) {
            <div class="card-body empty"><span class="spinner"></span> ƒêang t·∫£i...</div>
          } @else {
            <div class="card-body empty">Nh·∫•n "L√†m m·ªõi" ƒë·ªÉ xem tr·∫°ng th√°i WAL</div>
          }
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Replication tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'replication') {
      <div class="card">
        <div class="card-header">
          <h3>üîÑ Streaming Replication</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline" (click)="loadReplicationGuide()">
              üìñ H∆∞·ªõng d·∫´n
            </button>
            <button
              class="btn btn-sm btn-primary"
              (click)="activateReplication()"
              [disabled]="replicationActivating"
            >
              {{ replicationActivating ? 'ƒêang k√≠ch ho·∫°t...' : 'üöÄ K√≠ch ho·∫°t Replication' }}
            </button>
            <button
              class="btn btn-sm btn-outline"
              (click)="loadReplicationStatus()"
              [disabled]="replicationLoading"
            >
              {{ replicationLoading ? 'ƒêang t·∫£i...' : 'üîÑ L√†m m·ªõi' }}
            </button>
          </div>
        </div>
        <div class="card-body">
          @if (replicationStatus(); as rs) {
            <div class="overview-grid">
              <!-- Server Info -->
              <div class="card mb-0">
                <div class="card-header"><h3>Server Info</h3></div>
                <div class="card-body">
                  <table class="table">
                    <tbody>
                      <tr>
                        <td>Server Role</td>
                        <td>
                          <span
                            class="badge"
                            [class.badge-info]="rs.serverRole === 'primary'"
                            [class.badge-warning]="rs.serverRole === 'standby'"
                          >
                            {{ rs.serverRole }}
                          </span>
                        </td>
                      </tr>
                      <tr>
                        <td>Current LSN</td>
                        <td>
                          <code>{{ rs.currentLsn }}</code>
                        </td>
                      </tr>
                      <tr>
                        <td>Max WAL Senders</td>
                        <td>{{ rs.maxWalSenders }}</td>
                      </tr>
                      <tr>
                        <td>Max Replication Slots</td>
                        <td>{{ rs.maxReplicationSlots }}</td>
                      </tr>
                      <tr>
                        <td>Synchronous Standby</td>
                        <td>{{ rs.synchronousStandbyNames || '(none)' }}</td>
                      </tr>
                      <tr>
                        <td>Replicating</td>
                        <td>
                          <span
                            class="badge"
                            [class.badge-success]="rs.isReplicating"
                            [class.badge-secondary]="!rs.isReplicating"
                          >
                            {{ rs.isReplicating ? 'C√≥' : 'Kh√¥ng' }}
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Replication Slots -->
              <div class="card mb-0">
                <div class="card-header"><h3>Replication Slots</h3></div>
                <div class="card-body">
                  @if (rs.replicationSlots.length > 0) {
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Slot</th>
                          <th>Type</th>
                          <th>Active</th>
                          <th>Retained</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (slot of rs.replicationSlots; track slot.slotName) {
                          <tr>
                            <td>
                              <code>{{ slot.slotName }}</code>
                            </td>
                            <td>{{ slot.slotType }}</td>
                            <td>
                              <span
                                class="badge"
                                [class.badge-success]="slot.active"
                                [class.badge-secondary]="!slot.active"
                              >
                                {{ slot.active ? 'Active' : 'Inactive' }}
                              </span>
                            </td>
                            <td>{{ formatSize(slot.retainedBytes) }}</td>
                            <td>
                              <button
                                class="btn btn-sm btn-danger"
                                (click)="dropReplicationSlot(slot.slotName)"
                              >
                                X√≥a
                              </button>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  } @else {
                    <p class="text-muted">Ch∆∞a c√≥ replication slot n√†o</p>
                  }
                  <div class="d-flex gap-2 align-center mt-2">
                    <input
                      type="text"
                      [(ngModel)]="newSlotName"
                      placeholder="T√™n slot m·ªõi..."
                      class="form-control slot-input"
                    />
                    <button
                      class="btn btn-sm btn-primary"
                      (click)="createReplicationSlot()"
                      [disabled]="!newSlotName.trim()"
                    >
                      + T·∫°o Slot
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Connected Replicas -->
            @if (rs.connectedReplicas.length > 0) {
              <div class="card mt-3">
                <div class="card-header"><h3>Standby Servers ƒëang k·∫øt n·ªëi</h3></div>
                <div class="card-body">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>App</th>
                        <th>Client</th>
                        <th>State</th>
                        <th>Sync</th>
                        <th>Lag</th>
                        <th>Uptime</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (r of rs.connectedReplicas; track r.pid) {
                        <tr>
                          <td>{{ r.applicationName }}</td>
                          <td>{{ r.clientAddress }}</td>
                          <td>
                            <span class="badge badge-info">{{ r.state }}</span>
                          </td>
                          <td>{{ r.syncState }}</td>
                          <td>{{ formatSize(r.lagBytes) }}</td>
                          <td>{{ formatUptime(r.uptimeSeconds) }}</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            }
          } @else if (replicationLoading) {
            <div class="card-body empty"><span class="spinner"></span> ƒêang t·∫£i...</div>
          } @else {
            <div class="card-body empty">Nh·∫•n "L√†m m·ªõi" ƒë·ªÉ xem tr·∫°ng th√°i replication</div>
          }

          <!-- Setup Guide -->
          @if (showReplicationGuide && replicationGuide(); as guide) {
            <div class="card mt-3">
              <div class="card-header">
                <h3>üìñ H∆∞·ªõng d·∫´n thi·∫øt l·∫≠p Streaming Replication</h3>
                <button class="btn btn-sm btn-outline" (click)="showReplicationGuide = false">
                  ƒê√≥ng
                </button>
              </div>
              <div class="card-body">
                @for (step of guide.steps; track step.title) {
                  <div class="guide-step">
                    <h4>{{ step.title }}</h4>
                    <p>{{ step.description }}</p>
                    <pre><code>{{ step.command }}</code></pre>
                  </div>
                }
                <div class="guide-step">
                  <h4>Docker Compose (Standby)</h4>
                  <pre><code>{{ guide.dockerComposeExample }}</code></pre>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Cloud Replication tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'cloud-replication') {
      @if (cloudReplLoading) {
        <p class="text-muted mt-3"><span class="spinner"></span> ƒêang t·∫£i...</p>
      } @else {
        <!-- DB Cloud Replication -->
        <div class="card mb-3">
          <div class="card-header">
            <div>
              <h3>üêò PostgreSQL External Replication</h3>
              <p class="text-muted">Replicate WAL ra cloud/server ngo√†i qua SSL/TLS</p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline" (click)="loadDbReplStatus()">
                üîÑ Refresh
              </button>
              <button class="btn btn-sm btn-outline" (click)="loadCloudReplGuide()">
                üìñ H∆∞·ªõng d·∫´n
              </button>
            </div>
          </div>
          <div class="card-body">
            <!-- DB Status -->
            @if (dbReplStatus(); as dbs) {
              <div class="status-list mb-3">
                <div class="status-item">
                  <span class="status-label">Tr·∫°ng th√°i</span>
                  <span
                    class="badge"
                    [ngClass]="dbs.enabled ? 'badge-success' : 'badge-secondary'"
                    >{{ dbs.enabled ? 'ƒê√£ k√≠ch ho·∫°t' : 'Ch∆∞a k√≠ch ho·∫°t' }}</span
                  >
                </div>
                <div class="status-item">
                  <span class="status-label">SSL</span>
                  <span
                    class="badge"
                    [ngClass]="dbs.sslEnabled ? 'badge-success' : 'badge-warning'"
                    >{{ dbs.sslEnabled ? 'B·∫≠t' : 'T·∫Øt' }}</span
                  >
                </div>
                <div class="status-item">
                  <span class="status-label">Current LSN</span>
                  <span class="code-sm">{{ dbs.currentLsn }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">Slot</span>
                  <span>{{ dbs.slotName || 'N/A' }}</span>
                  @if (dbs.slotStatus) {
                    <span class="badge badge-info ml-1">{{ dbs.slotStatus }}</span>
                  }
                </div>
                <div class="status-item">
                  <span class="status-label">Retained</span>
                  <span>{{ formatSize(dbs.slotRetainedBytes) }}</span>
                </div>
                @if (dbs.lastSyncAt) {
                  <div class="status-item">
                    <span class="status-label">L·∫ßn sync cu·ªëi</span>
                    <span>{{ formatDate(dbs.lastSyncAt) }}</span>
                    @if (dbs.lastSyncStatus) {
                      <span
                        class="badge ml-1"
                        [ngClass]="
                          dbs.lastSyncStatus === 'success' ? 'badge-success' : 'badge-warning'
                        "
                        >{{ dbs.lastSyncStatus }}</span
                      >
                    }
                  </div>
                }
              </div>

              <!-- External replicas -->
              @if (dbs.externalReplicas.length > 0) {
                <h4 class="mt-3">üåê External Replicas ({{ dbs.externalReplicas.length }})</h4>
                <table class="table mt-2">
                  <thead>
                    <tr>
                      <th>Client</th>
                      <th>App Name</th>
                      <th>State</th>
                      <th>Sent LSN</th>
                      <th>Replay LSN</th>
                      <th>Lag</th>
                      <th>Uptime</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (r of dbs.externalReplicas; track r.pid) {
                      <tr>
                        <td>{{ r.clientAddress }}</td>
                        <td>{{ r.applicationName }}</td>
                        <td>
                          <span
                            class="badge"
                            [ngClass]="r.state === 'streaming' ? 'badge-success' : 'badge-warning'"
                            >{{ r.state }}</span
                          >
                        </td>
                        <td class="code-sm">{{ r.sentLsn }}</td>
                        <td class="code-sm">{{ r.replayLsn }}</td>
                        <td>{{ formatSize(r.lagBytes) }}</td>
                        <td>{{ formatUptime(r.uptimeSeconds) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              }
            } @else {
              <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu tr·∫°ng th√°i. B·∫•m Refresh ƒë·ªÉ t·∫£i.</p>
            }

            <!-- DB Config Form -->
            <details class="mt-3">
              <summary class="btn btn-sm btn-outline">‚öôÔ∏è C·∫•u h√¨nh k·∫øt n·ªëi</summary>
              <div class="form-grid mt-2">
                <div class="form-group">
                  <label>B·∫≠t DB Replication</label>
                  <label class="toggle">
                    <input type="checkbox" [(ngModel)]="cloudReplDbForm.enabled" />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div class="form-group">
                  <label>Allowed IPs (pg_hba)</label>
                  <input
                    type="text"
                    [(ngModel)]="cloudReplDbForm.allowedIps"
                    placeholder="10.0.0.0/8, 172.16.0.0/12"
                  />
                </div>
                <div class="form-group">
                  <label>SSL Mode</label>
                  <select [(ngModel)]="cloudReplDbForm.sslMode">
                    <option value="require">require</option>
                    <option value="verify-ca">verify-ca</option>
                    <option value="verify-full">verify-full</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Slot Name</label>
                  <input type="text" [(ngModel)]="cloudReplDbForm.slotName" />
                </div>
                <div class="form-group">
                  <label>Replication User</label>
                  <input type="text" [(ngModel)]="cloudReplDbForm.remoteUser" />
                </div>
                <div class="form-group">
                  <label>Password</label>
                  <input
                    type="password"
                    [(ngModel)]="cloudReplDbForm.remotePassword"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                </div>
              </div>
              <div class="d-flex gap-2 mt-2">
                <button
                  class="btn btn-primary"
                  (click)="saveDbReplConfig()"
                  [disabled]="cloudReplDbSetting"
                >
                  {{ cloudReplDbSetting ? 'ƒêang l∆∞u...' : 'üíæ L∆∞u c·∫•u h√¨nh' }}
                </button>
                <button
                  class="btn btn-outline"
                  (click)="testDbReplication()"
                  [disabled]="cloudReplDbTesting"
                >
                  {{ cloudReplDbTesting ? 'ƒêang test...' : 'üîç Test k·∫øt n·ªëi' }}
                </button>
                <button
                  class="btn btn-success"
                  (click)="setupDbReplication()"
                  [disabled]="cloudReplDbSetting"
                >
                  {{ cloudReplDbSetting ? 'ƒêang thi·∫øt l·∫≠p...' : 'üöÄ Thi·∫øt l·∫≠p Replication' }}
                </button>
              </div>
            </details>

            <!-- Setup result -->
            @if (cloudReplSetupResult(); as result) {
              <div class="warning-box mt-3">
                <strong>{{ result.success ? '‚úÖ Thi·∫øt l·∫≠p th√†nh c√¥ng' : '‚ö†Ô∏è C√≥ l·ªói' }}</strong>
                <ul class="mt-1">
                  @for (step of result.steps; track step) {
                    <li>{{ step }}</li>
                  }
                </ul>
                @if (result.connectionInfo) {
                  <details class="mt-2">
                    <summary>üîó Th√¥ng tin k·∫øt n·ªëi cho Remote Standby</summary>
                    <div class="mt-1">
                      <p><strong>Base backup command:</strong></p>
                      <pre class="code-sm">{{ result.connectionInfo.baseBackupCommand }}</pre>
                      <p class="mt-2"><strong>primary_conninfo (postgresql.conf):</strong></p>
                      <pre class="code-sm">{{ result.connectionInfo.primaryConnInfo }}</pre>
                      <p class="mt-2"><strong>standby.signal:</strong></p>
                      <pre class="code-sm">{{ result.connectionInfo.standbySignalContent }}</pre>
                    </div>
                  </details>
                }
              </div>
            }
          </div>
        </div>

        <!-- MinIO Cloud Replication -->
        <div class="card mb-3">
          <div class="card-header">
            <div>
              <h3>üì¶ MinIO / S3 External Replication</h3>
              <p class="text-muted">Sync buckets ra S3-compatible storage qua TLS</p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline" (click)="loadMinioReplStatus()">
                üîÑ Refresh
              </button>
              <button
                class="btn btn-sm btn-success"
                (click)="syncMinioNow()"
                [disabled]="cloudReplMinioSyncing"
              >
                {{ cloudReplMinioSyncing ? '‚è≥ ƒêang sync...' : '‚ñ∂Ô∏è Sync ngay' }}
              </button>
            </div>
          </div>
          <div class="card-body">
            <!-- MinIO Status -->
            @if (minioReplStatus(); as ms) {
              <div class="status-list mb-3">
                <div class="status-item">
                  <span class="status-label">Tr·∫°ng th√°i</span>
                  <span
                    class="badge"
                    [ngClass]="ms.enabled ? 'badge-success' : 'badge-secondary'"
                    >{{ ms.enabled ? 'ƒê√£ k√≠ch ho·∫°t' : 'Ch∆∞a k√≠ch ho·∫°t' }}</span
                  >
                </div>
                <div class="status-item">
                  <span class="status-label">Remote Endpoint</span>
                  <span>{{ ms.remoteEndpoint || 'Ch∆∞a c·∫•u h√¨nh' }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">Remote Bucket</span>
                  <span>{{ ms.remoteBucket }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">SSL/TLS</span>
                  <span class="badge" [ngClass]="ms.useSsl ? 'badge-success' : 'badge-warning'">{{
                    ms.useSsl ? 'B·∫≠t' : 'T·∫Øt'
                  }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">Sync Mode</span>
                  <span>{{ ms.syncMode }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">Cron</span>
                  <span class="code-sm">{{ ms.syncCron || 'N/A' }}</span>
                </div>
                @if (ms.lastSyncAt) {
                  <div class="status-item">
                    <span class="status-label">L·∫ßn sync cu·ªëi</span>
                    <span>{{ formatDate(ms.lastSyncAt) }}</span>
                    <span
                      class="badge ml-1"
                      [ngClass]="
                        ms.lastSyncStatus === 'success' ? 'badge-success' : 'badge-warning'
                      "
                      >{{ ms.lastSyncStatus }}</span
                    >
                  </div>
                  <div class="status-item">
                    <span class="status-label">ƒê√£ sync</span>
                    <span>{{ ms.lastSyncFiles }} files / {{ formatSize(ms.lastSyncBytes) }}</span>
                  </div>
                }
              </div>

              <!-- Local buckets -->
              @if (ms.localBuckets.length > 0) {
                <h4 class="mt-2">üìÅ Local Buckets</h4>
                <table class="table mt-1">
                  <thead>
                    <tr>
                      <th>Bucket</th>
                      <th>Objects</th>
                      <th>Size</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (b of ms.localBuckets; track b.name) {
                      <tr>
                        <td>{{ b.name }}</td>
                        <td>{{ b.objectCount }}</td>
                        <td>{{ formatSize(b.sizeBytes) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              }
            } @else {
              <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu tr·∫°ng th√°i. B·∫•m Refresh ƒë·ªÉ t·∫£i.</p>
            }

            <!-- Sync result -->
            @if (minioSyncResult(); as sr) {
              <div class="warning-box mt-3">
                <strong>{{ sr.success ? '‚úÖ ƒê·ªìng b·ªô ho√†n t·∫•t' : '‚ö†Ô∏è C√≥ l·ªói' }}</strong>
                ‚Äî {{ sr.totalFiles }} files / {{ formatSize(sr.totalBytes) }}
                @if (sr.bucketResults.length > 0) {
                  <ul class="mt-1">
                    @for (br of sr.bucketResults; track br.bucket) {
                      <li>
                        <span
                          class="badge"
                          [ngClass]="br.success ? 'badge-success' : 'badge-danger'"
                          >{{ br.bucket }}</span
                        >
                        {{ br.filesSync }} files ‚Äî {{ br.message }}
                      </li>
                    }
                  </ul>
                }
              </div>
            }

            <!-- MinIO Config Form -->
            <details class="mt-3">
              <summary class="btn btn-sm btn-outline">‚öôÔ∏è C·∫•u h√¨nh MinIO Remote</summary>
              <div class="form-grid mt-2">
                <div class="form-group">
                  <label>B·∫≠t MinIO Replication</label>
                  <label class="toggle">
                    <input type="checkbox" [(ngModel)]="cloudReplMinioForm.enabled" />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div class="form-group">
                  <label>Remote Endpoint</label>
                  <input
                    type="text"
                    [(ngModel)]="cloudReplMinioForm.endpoint"
                    placeholder="s3.amazonaws.com ho·∫∑c minio.example.com:9000"
                  />
                </div>
                <div class="form-group">
                  <label>Access Key</label>
                  <input type="text" [(ngModel)]="cloudReplMinioForm.accessKey" />
                </div>
                <div class="form-group">
                  <label>Secret Key</label>
                  <input
                    type="password"
                    [(ngModel)]="cloudReplMinioForm.secretKey"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                </div>
                <div class="form-group">
                  <label>Bucket</label>
                  <input type="text" [(ngModel)]="cloudReplMinioForm.bucket" />
                </div>
                <div class="form-group">
                  <label>SSL/TLS</label>
                  <label class="toggle">
                    <input type="checkbox" [(ngModel)]="cloudReplMinioForm.useSsl" />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div class="form-group">
                  <label>Region</label>
                  <input type="text" [(ngModel)]="cloudReplMinioForm.region" />
                </div>
                <div class="form-group">
                  <label>Sync Mode</label>
                  <select [(ngModel)]="cloudReplMinioForm.syncMode">
                    <option value="incremental">Incremental (nhanh)</option>
                    <option value="full">Full (to√†n b·ªô)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Sync Cron</label>
                  <input
                    type="text"
                    [(ngModel)]="cloudReplMinioForm.syncCron"
                    placeholder="0 */2 * * *"
                  />
                </div>
              </div>
              <div class="d-flex gap-2 mt-2">
                <button
                  class="btn btn-primary"
                  (click)="saveMinioReplConfig()"
                  [disabled]="cloudReplMinioSetting"
                >
                  {{ cloudReplMinioSetting ? 'ƒêang l∆∞u...' : 'üíæ L∆∞u c·∫•u h√¨nh' }}
                </button>
                <button
                  class="btn btn-outline"
                  (click)="testMinioReplication()"
                  [disabled]="cloudReplMinioTesting"
                >
                  {{ cloudReplMinioTesting ? 'ƒêang test...' : 'üîç Test k·∫øt n·ªëi' }}
                </button>
                <button
                  class="btn btn-success"
                  (click)="setupMinioReplication()"
                  [disabled]="cloudReplMinioSetting"
                >
                  {{ cloudReplMinioSetting ? 'ƒêang thi·∫øt l·∫≠p...' : 'üöÄ Thi·∫øt l·∫≠p Remote' }}
                </button>
              </div>
            </details>
          </div>
        </div>

        <!-- Cloud Replication Guide -->
        @if (showCloudReplGuide) {
          <div class="card mb-3">
            <div class="card-header">
              <h3>üìñ H∆∞·ªõng d·∫´n thi·∫øt l·∫≠p Cloud Replication</h3>
              <button class="btn btn-sm btn-outline" (click)="showCloudReplGuide = false">
                ‚úï ƒê√≥ng
              </button>
            </div>
            <div class="card-body">
              @if (cloudReplGuide(); as guide) {
                <h4>üêò PostgreSQL Steps</h4>
                @for (step of guide.steps; track step.title) {
                  <div class="guide-step">
                    <h4>{{ step.title }}</h4>
                    <p>{{ step.description }}</p>
                    <pre><code>{{ step.command }}</code></pre>
                  </div>
                }
                <h4 class="mt-3">üì¶ MinIO Steps</h4>
                @for (step of guide.minioSteps; track step.title) {
                  <div class="guide-step">
                    <h4>{{ step.title }}</h4>
                    <p>{{ step.description }}</p>
                    <pre><code>{{ step.command }}</code></pre>
                  </div>
                }
                @if (guide.securityNotes.length > 0) {
                  <h4 class="mt-3">üîí L∆∞u √Ω b·∫£o m·∫≠t</h4>
                  <ul>
                    @for (note of guide.securityNotes; track note) {
                      <li>{{ note }}</li>
                    }
                  </ul>
                }
              } @else {
                <p class="text-muted"><span class="spinner"></span> ƒêang t·∫£i h∆∞·ªõng d·∫´n...</p>
              }
            </div>
          </div>
        }
      }
    }

    <!-- ‚ïê‚ïê‚ïê Live logs tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'live') {
      <div class="card log-card">
        <div class="card-header">
          <div class="log-header-left">
            <h3>
              @if (activeOperation(); as op) {
                {{ op.type === 'Backup' ? 'üíæ' : 'üîÑ' }}
                {{ op.id }}
              }
            </h3>
            @if (activeOperation(); as op) {
              <span class="badge" [ngClass]="getStatusBadgeClass(op.status)">
                @if (op.status === 'Running') {
                  <span class="spinner-sm"></span>
                }
                {{ op.status }}
              </span>
              <span class="text-muted">{{ formatDuration(op) }}</span>
            }
          </div>
          <div class="log-header-right">
            <label class="auto-scroll-toggle">
              <input type="checkbox" [(ngModel)]="autoScroll" />
              Auto-scroll
            </label>
            @if (activeOperation()?.status === 'Running') {
              <button class="btn btn-sm btn-danger" (click)="cancelOperation()">Hu·ª∑</button>
            }
          </div>
        </div>
        <div class="log-container" #logContainer>
          @for (line of logLines(); track $index) {
            <div class="log-line" [ngClass]="getLogLevelClass(line.level)">
              <span class="log-time">{{ line.timestamp | date: 'HH:mm:ss' }}</span>
              <span class="log-level">{{ line.level }}</span>
              <span class="log-msg">{{ line.message }}</span>
            </div>
          }
          @if (logLines().length === 0) {
            <div class="log-empty">ƒêang ch·ªù logs...</div>
          }
        </div>
        @if (activeOperation(); as op) {
          @if (op.errorMessage) {
            <div class="error-footer">‚ùå {{ op.errorMessage }}</div>
          }
          @if (op.status === 'Completed' && op.archivePath) {
            <div class="success-footer">
              ‚úÖ Ho√†n th√†nh ¬∑ Archive: <code>{{ op.archivePath }}</code>
            </div>
          }
        }
      </div>
    }
  </div>

  <!-- Confirm dialog -->
  @if (showConfirmDialog) {
    <div class="modal-overlay" (click)="confirmDialogNo()">
      <div class="modal-dialog" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚ö†Ô∏è X√°c nh·∫≠n</h3>
        </div>
        <div class="modal-body">
          <p>{{ confirmMessage }}</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="confirmDialogNo()">Hu·ª∑</button>
          <button class="btn btn-danger" (click)="confirmDialogYes()">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
  }
</div>
