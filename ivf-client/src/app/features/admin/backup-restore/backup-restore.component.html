<div class="backup-restore-page">
  <!-- Header -->
  <div class="page-header">
    <h2>üóÑÔ∏è Sao l∆∞u & Kh√¥i ph·ª•c</h2>
    <p class="subtitle">Qu·∫£n l√Ω backup/restore EJBCA & SignServer</p>
  </div>

  <!-- Running operations banner -->
  @if (runningOps.length > 0) {
    <div class="running-banner">
      <span class="spinner"></span>
      <span>ƒêang ch·∫°y {{ runningOps.length }} thao t√°c...</span>
      <button class="btn btn-sm btn-outline" (click)="viewOperationLogs(runningOps[0].id)">
        Xem logs
      </button>
    </div>
  }

  <!-- Tabs -->
  <div class="tabs">
    <button [class.active]="activeTab === 'overview'" (click)="switchTab('overview')">
      T·ªïng quan
    </button>
    <button [class.active]="activeTab === 'archives'" (click)="switchTab('archives')">
      B·∫£n sao l∆∞u
    </button>
    <button [class.active]="activeTab === 'restore'" (click)="switchTab('restore')">
      Kh√¥i ph·ª•c
    </button>
    <button [class.active]="activeTab === 'history'" (click)="switchTab('history')">L·ªãch s·ª≠</button>
    <button [class.active]="activeTab === 'schedule'" (click)="switchTab('schedule')">
      ‚è∞ L·ªãch t·ª± ƒë·ªông
    </button>
    <button [class.active]="activeTab === 'cloud'" (click)="switchTab('cloud')">‚òÅÔ∏è Cloud</button>
    @if (activeOperation()) {
      <button [class.active]="activeTab === 'live'" (click)="switchTab('live')">
        üìã Logs
        @if (activeOperation()?.status === 'Running') {
          <span class="spinner-sm"></span>
        }
      </button>
    }
  </div>

  <!-- Tab content -->
  <div class="tab-content">
    <!-- ‚ïê‚ïê‚ïê Overview tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'overview') {
      <div class="overview-grid">
        <!-- Backup card -->
        <div class="card">
          <div class="card-header">
            <h3>üíæ Sao l∆∞u m·ªõi</h3>
          </div>
          <div class="card-body">
            <p>T·∫°o b·∫£n sao l∆∞u ƒë·∫ßy ƒë·ªß bao g·ªìm:</p>
            <ul>
              <li>Certificate files & secrets</li>
              <li>EJBCA persistent data & DB</li>
              <li>SignServer persistent data & DB</li>
            </ul>
            <div class="btn-group">
              <button class="btn btn-primary" [disabled]="loading()" (click)="startBackup(false)">
                @if (loading()) {
                  <span class="spinner-sm"></span>
                }
                Sao l∆∞u ƒë·∫ßy ƒë·ªß
              </button>
              <button class="btn btn-outline" [disabled]="loading()" (click)="startBackup(true)">
                Ch·ªâ Keys
              </button>
            </div>
          </div>
        </div>

        <!-- Stats card -->
        <div class="card">
          <div class="card-header">
            <h3>üìä Th·ªëng k√™</h3>
          </div>
          <div class="card-body">
            <div class="stat-grid">
              <div class="stat">
                <span class="stat-value">{{ archives().length }}</span>
                <span class="stat-label">B·∫£n sao l∆∞u</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ operations().length }}</span>
                <span class="stat-label">Thao t√°c</span>
              </div>
              <div class="stat">
                <span class="stat-value">{{ runningOps.length }}</span>
                <span class="stat-label">ƒêang ch·∫°y</span>
              </div>
              @if (archives().length > 0) {
                <div class="stat">
                  <span class="stat-value">{{ formatSize(archives()[0].sizeBytes) }}</span>
                  <span class="stat-label">M·ªõi nh·∫•t</span>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Quick restore card -->
        <div class="card">
          <div class="card-header">
            <h3>üîÑ Kh√¥i ph·ª•c nhanh</h3>
          </div>
          <div class="card-body">
            @if (archives().length > 0) {
              <p>B·∫£n sao l∆∞u m·ªõi nh·∫•t:</p>
              <div class="archive-quick">
                <strong>{{ archives()[0].fileName }}</strong>
                <span class="text-muted"
                  >{{ formatSize(archives()[0].sizeBytes) }} ¬∑
                  {{ formatDate(archives()[0].createdAt) }}</span
                >
              </div>
              <div class="btn-group">
                <button
                  class="btn btn-outline"
                  (click)="selectArchiveForRestore(archives()[0].fileName)"
                >
                  Kh√¥i ph·ª•c
                </button>
              </div>
            } @else {
              <p class="text-muted">Ch∆∞a c√≥ b·∫£n sao l∆∞u n√†o</p>
            }
          </div>
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Archives tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'archives') {
      <div class="card">
        <div class="card-header">
          <h3>Danh s√°ch b·∫£n sao l∆∞u</h3>
          <button class="btn btn-sm btn-outline" (click)="loadArchives()">L√†m m·ªõi</button>
        </div>
        @if (archives().length === 0) {
          <div class="card-body empty">
            <p>Ch∆∞a c√≥ b·∫£n sao l∆∞u n√†o. Nh·∫•n "Sao l∆∞u ƒë·∫ßy ƒë·ªß" ƒë·ªÉ t·∫°o.</p>
          </div>
        } @else {
          <table class="table">
            <thead>
              <tr>
                <th>T√™n file</th>
                <th>K√≠ch th∆∞·ªõc</th>
                <th>Ng√†y t·∫°o</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (archive of archives(); track archive.fileName) {
                <tr>
                  <td>
                    <code>{{ archive.fileName }}</code>
                  </td>
                  <td>{{ formatSize(archive.sizeBytes) }}</td>
                  <td>{{ formatDate(archive.createdAt) }}</td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline"
                      (click)="selectArchiveForRestore(archive.fileName)"
                    >
                      Kh√¥i ph·ª•c
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Restore tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'restore') {
      <div class="card">
        <div class="card-header">
          <h3>üîÑ Kh√¥i ph·ª•c t·ª´ backup</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Ch·ªçn b·∫£n sao l∆∞u:</label>
            <select [(ngModel)]="selectedArchive" class="form-control">
              <option value="">-- Ch·ªçn --</option>
              @for (archive of archives(); track archive.fileName) {
                <option [value]="archive.fileName">
                  {{ archive.fileName }} ({{ formatSize(archive.sizeBytes) }})
                </option>
              }
            </select>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="restoreDryRun" />
              Ch·∫°y th·ª≠ (dry-run) ‚Äî kh√¥ng thay ƒë·ªïi d·ªØ li·ªáu
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="restoreKeysOnly" />
              Ch·ªâ kh√¥i ph·ª•c keys ‚Äî b·ªè qua d·ªØ li·ªáu container
            </label>
          </div>

          @if (!restoreDryRun) {
            <div class="warning-box">
              ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> Kh√¥i ph·ª•c s·∫Ω ghi ƒë√® database EJBCA & SignServer. Sau kh√¥i
              ph·ª•c c·∫ßn restart containers v√† re-apply mTLS/TSA.
            </div>
          }

          <div class="btn-group">
            <button
              class="btn btn-primary"
              [disabled]="!selectedArchive || loading()"
              (click)="startRestore()"
            >
              @if (loading()) {
                <span class="spinner-sm"></span>
              }
              {{ restoreDryRun ? 'Ch·∫°y th·ª≠' : 'B·∫Øt ƒë·∫ßu kh√¥i ph·ª•c' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê History tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'history') {
      <div class="card">
        <div class="card-header">
          <h3>L·ªãch s·ª≠ thao t√°c</h3>
          <button class="btn btn-sm btn-outline" (click)="loadOperations()">L√†m m·ªõi</button>
        </div>
        @if (recentOps.length === 0) {
          <div class="card-body empty">
            <p>Ch∆∞a c√≥ thao t√°c n√†o.</p>
          </div>
        } @else {
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Lo·∫°i</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                <th>B·∫Øt ƒë·∫ßu</th>
                <th>Th·ªùi gian</th>
                <th>Archive</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (op of recentOps; track op.id) {
                <tr>
                  <td>
                    <code class="op-id">{{ op.id }}</code>
                  </td>
                  <td>
                    <span
                      class="type-badge"
                      [class.backup]="op.type === 'Backup'"
                      [class.restore]="op.type === 'Restore'"
                    >
                      {{ op.type === 'Backup' ? 'üíæ Backup' : 'üîÑ Restore' }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getStatusBadgeClass(op.status)">
                      @if (op.status === 'Running') {
                        <span class="spinner-sm"></span>
                      }
                      {{ op.status }}
                    </span>
                  </td>
                  <td>{{ op.startedBy }}</td>
                  <td>{{ formatDate(op.startedAt) }}</td>
                  <td>{{ formatDuration(op) }}</td>
                  <td>
                    @if (op.archivePath) {
                      <code class="archive-name">{{ op.archivePath }}</code>
                    }
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline" (click)="viewOperationLogs(op.id)">
                      Logs
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Schedule tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'schedule') {
      <div class="schedule-grid">
        <!-- Schedule config card -->
        <div class="card">
          <div class="card-header">
            <h3>‚è∞ C·∫•u h√¨nh l·ªãch t·ª± ƒë·ªông</h3>
          </div>
          <div class="card-body">
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" [(ngModel)]="scheduleEnabled" />
                B·∫≠t sao l∆∞u t·ª± ƒë·ªông
              </label>
            </div>

            <div class="form-group">
              <label>Bi·ªÉu th·ª©c Cron (UTC)</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="scheduleCron"
                placeholder="0 2 * * *"
              />
              <div class="cron-hint">
                {{ describeCron(scheduleCron) }}
              </div>
              <div class="cron-examples">
                <span class="cron-example" (click)="scheduleCron = '0 2 * * *'">H√†ng ng√†y 2h</span>
                <span class="cron-example" (click)="scheduleCron = '0 3 * * 0'"
                  >CN h√†ng tu·∫ßn 3h</span
                >
                <span class="cron-example" (click)="scheduleCron = '0 1 1 * *'"
                  >Ng√†y 1 h√†ng th√°ng</span
                >
                <span class="cron-example" (click)="scheduleCron = '0 */6 * * *'">M·ªói 6 gi·ªù</span>
              </div>
            </div>

            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" [(ngModel)]="scheduleKeysOnly" />
                Ch·ªâ sao l∆∞u keys (b·ªè qua DB)
              </label>
            </div>

            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" [(ngModel)]="scheduleCloudSync" />
                ‚òÅÔ∏è T·ª± ƒë·ªông ƒë·ªìng b·ªô cloud sau backup
              </label>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Gi·ªØ l·∫°i (ng√†y)</label>
                <input
                  type="number"
                  class="form-control"
                  [(ngModel)]="scheduleRetentionDays"
                  min="1"
                  max="365"
                />
              </div>
              <div class="form-group">
                <label>T·ªëi ƒëa b·∫£n sao</label>
                <input
                  type="number"
                  class="form-control"
                  [(ngModel)]="scheduleMaxCount"
                  min="1"
                  max="500"
                />
              </div>
            </div>

            <div class="btn-group">
              <button class="btn btn-primary" (click)="saveSchedule()" [disabled]="scheduleSaving">
                @if (scheduleSaving) {
                  <span class="spinner-sm"></span>
                }
                L∆∞u c·∫•u h√¨nh
              </button>
              <button class="btn btn-outline" (click)="loadSchedule()">ƒê·∫∑t l·∫°i</button>
            </div>
          </div>
        </div>

        <!-- Schedule status card -->
        <div class="card">
          <div class="card-header">
            <h3>üìä Tr·∫°ng th√°i</h3>
          </div>
          <div class="card-body">
            @if (schedule(); as s) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">Tr·∫°ng th√°i</span>
                  <span class="badge" [ngClass]="s.enabled ? 'badge-success' : 'badge-secondary'">
                    {{ s.enabled ? '‚úÖ ƒêang b·∫≠t' : '‚è∏Ô∏è ƒê√£ t·∫Øt' }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">L·ªãch</span>
                  <span>{{ describeCron(s.cronExpression) }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">Cloud sync</span>
                  <span
                    class="badge"
                    [ngClass]="s.cloudSyncEnabled ? 'badge-success' : 'badge-secondary'"
                  >
                    {{ s.cloudSyncEnabled ? '‚òÅÔ∏è B·∫≠t' : '‚è∏Ô∏è T·∫Øt' }}
                  </span>
                </div>
                @if (s.nextScheduledRun) {
                  <div class="status-item">
                    <span class="status-label">Ch·∫°y ti·∫øp theo</span>
                    <span>{{ formatDate(s.nextScheduledRun) }}</span>
                  </div>
                }
                @if (s.lastScheduledRun) {
                  <div class="status-item">
                    <span class="status-label">Ch·∫°y g·∫ßn nh·∫•t</span>
                    <span>{{ formatDate(s.lastScheduledRun) }}</span>
                  </div>
                }
                @if (s.lastScheduledOperationId) {
                  <div class="status-item">
                    <span class="status-label">Operation ID</span>
                    <button
                      class="btn btn-sm btn-outline"
                      (click)="viewOperationLogs(s.lastScheduledOperationId!)"
                    >
                      Xem logs
                    </button>
                  </div>
                }
                <div class="status-item">
                  <span class="status-label">Ch√≠nh s√°ch x√≥a</span>
                  <span>Gi·ªØ {{ s.retentionDays }} ng√†y, t·ªëi ƒëa {{ s.maxBackupCount }} b·∫£n</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang t·∫£i...</p>
            }

            <div class="btn-group" style="margin-top: 16px">
              <button class="btn btn-outline" (click)="runCleanup()" [disabled]="cleanupRunning">
                @if (cleanupRunning) {
                  <span class="spinner-sm"></span>
                }
                üßπ D·ªçn d·∫πp ngay
              </button>
              <button class="btn btn-outline" (click)="loadSchedule()">üîÑ L√†m m·ªõi</button>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Cloud tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'cloud') {
      <!-- Cloud Config Card -->
      <div class="card" style="margin-bottom: 16px">
        <div class="card-header">
          <h3>‚öôÔ∏è C·∫•u h√¨nh Cloud Provider</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Provider</label>
              <select [(ngModel)]="cloudConfigProvider" class="form-control">
                <option value="MinIO">MinIO (S3-compatible)</option>
                <option value="S3">AWS S3</option>
                <option value="Azure">Azure Blob Storage</option>
                <option value="GCS">Google Cloud Storage</option>
              </select>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" [(ngModel)]="cloudConfigCompression" />
                N√©n Brotli tr∆∞·ªõc khi upload
              </label>
            </div>
          </div>

          <!-- S3 / MinIO Settings -->
          @if (cloudConfigProvider === 'MinIO' || cloudConfigProvider === 'S3') {
            <h4 style="margin-top: 12px">
              ü™£ {{ cloudConfigProvider === 'MinIO' ? 'MinIO' : 'AWS S3' }} Settings
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Region</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigS3Region"
                  class="form-control"
                  placeholder="us-east-1"
                />
              </div>
              <div class="form-group">
                <label>Bucket Name</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigS3Bucket"
                  class="form-control"
                  placeholder="ivf-backups"
                />
              </div>
              <div class="form-group">
                <label>Access Key</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigS3AccessKey"
                  class="form-control"
                  placeholder="Access Key"
                />
              </div>
              <div class="form-group">
                <label>Secret Key</label>
                <input
                  type="password"
                  [(ngModel)]="cloudConfigS3SecretKey"
                  class="form-control"
                  placeholder="Secret Key"
                />
              </div>
              @if (cloudConfigProvider === 'MinIO') {
                <div class="form-group">
                  <label>Service URL</label>
                  <input
                    type="text"
                    [(ngModel)]="cloudConfigS3ServiceUrl"
                    class="form-control"
                    placeholder="http://localhost:9000"
                  />
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" [(ngModel)]="cloudConfigS3ForcePathStyle" />
                    Force Path Style
                  </label>
                </div>
              }
            </div>
          }

          <!-- Azure Settings -->
          @if (cloudConfigProvider === 'Azure') {
            <h4 style="margin-top: 12px">‚òÅÔ∏è Azure Blob Storage Settings</h4>
            <div class="form-grid">
              <div class="form-group" style="grid-column: 1 / -1">
                <label>Connection String</label>
                <input
                  type="password"
                  [(ngModel)]="cloudConfigAzureConnStr"
                  class="form-control"
                  placeholder="DefaultEndpointsProtocol=https;..."
                />
              </div>
              <div class="form-group">
                <label>Container Name</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigAzureContainer"
                  class="form-control"
                  placeholder="ivf-backups"
                />
              </div>
            </div>
          }

          <!-- GCS Settings -->
          @if (cloudConfigProvider === 'GCS') {
            <h4 style="margin-top: 12px">üåê Google Cloud Storage Settings</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Project ID</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigGcsProjectId"
                  class="form-control"
                  placeholder="my-project-id"
                />
              </div>
              <div class="form-group">
                <label>Bucket Name</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigGcsBucket"
                  class="form-control"
                  placeholder="ivf-backups"
                />
              </div>
              <div class="form-group" style="grid-column: 1 / -1">
                <label>Credentials Path (JSON key file)</label>
                <input
                  type="text"
                  [(ngModel)]="cloudConfigGcsCredentialsPath"
                  class="form-control"
                  placeholder="/path/to/service-account.json"
                />
              </div>
            </div>
          }

          <!-- Test connection result -->
          @if (cloudTestResult(); as tr) {
            <div class="test-result" style="margin-top: 8px">
              <span class="badge" [ngClass]="tr.connected ? 'badge-success' : 'badge-danger'">
                {{ tr.connected ? '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng' : '‚ùå K·∫øt n·ªëi th·∫•t b·∫°i' }} ‚Äî
                {{ tr.provider }}
              </span>
            </div>
          }

          <div class="btn-group" style="margin-top: 12px">
            <button
              class="btn btn-outline"
              [disabled]="cloudConfigTesting"
              (click)="testCloudConnection()"
            >
              @if (cloudConfigTesting) {
                <span class="spinner-sm"></span> ƒêang ki·ªÉm tra...
              } @else {
                üîå Test k·∫øt n·ªëi
              }
            </button>
            <button
              class="btn btn-primary"
              [disabled]="cloudConfigSaving"
              (click)="saveCloudConfig()"
            >
              @if (cloudConfigSaving) {
                <span class="spinner-sm"></span> ƒêang l∆∞u...
              } @else {
                üíæ L∆∞u c·∫•u h√¨nh
              }
            </button>
          </div>
        </div>
      </div>

      <div class="schedule-grid">
        <!-- Cloud status card -->
        <div class="card">
          <div class="card-header">
            <h3>‚òÅÔ∏è Tr·∫°ng th√°i Cloud</h3>
            <button class="btn btn-sm btn-outline" (click)="loadCloudData()">üîÑ L√†m m·ªõi</button>
          </div>
          <div class="card-body">
            @if (cloudStatus(); as cs) {
              <div class="status-list">
                <div class="status-item">
                  <span class="status-label">Provider</span>
                  <span class="badge badge-info">{{ cs.providerName }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">K·∫øt n·ªëi</span>
                  <span class="badge" [ngClass]="cs.connected ? 'badge-success' : 'badge-danger'">
                    {{ cs.connected ? '‚úÖ ƒê√£ k·∫øt n·ªëi' : '‚ùå M·∫•t k·∫øt n·ªëi' }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">N√©n d·ªØ li·ªáu</span>
                  <span
                    class="badge"
                    [ngClass]="cs.compressionEnabled ? 'badge-success' : 'badge-secondary'"
                  >
                    {{ cs.compressionEnabled ? 'üóúÔ∏è Brotli (b·∫≠t)' : '‚è∏Ô∏è T·∫Øt' }}
                  </span>
                </div>
                <div class="status-item">
                  <span class="status-label">S·ªë b·∫£n sao</span>
                  <span>{{ cs.backupCount }}</span>
                </div>
                <div class="status-item">
                  <span class="status-label">T·ªïng dung l∆∞·ª£ng</span>
                  <span>{{ formatSize(cs.totalSizeBytes) }}</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">ƒêang ki·ªÉm tra k·∫øt n·ªëi...</p>
            }
          </div>
        </div>

        <!-- Upload to cloud card -->
        <div class="card">
          <div class="card-header">
            <h3>‚¨ÜÔ∏è Upload l√™n Cloud</h3>
          </div>
          <div class="card-body">
            @if (archives().length === 0) {
              <p class="text-muted">Ch∆∞a c√≥ b·∫£n sao l∆∞u local n√†o</p>
            } @else {
              <p>Ch·ªçn b·∫£n sao l∆∞u local ƒë·ªÉ upload (c√≥ n√©n Brotli):</p>
              <div class="archive-upload-list">
                @for (archive of archives(); track archive.fileName) {
                  <div class="archive-upload-item">
                    <div class="archive-upload-info">
                      <code>{{ archive.fileName }}</code>
                      <span class="text-muted">{{ formatSize(archive.sizeBytes) }}</span>
                    </div>
                    <button
                      class="btn btn-sm btn-primary"
                      [disabled]="cloudUploading() !== null"
                      (click)="uploadToCloud(archive.fileName)"
                    >
                      @if (cloudUploading() === archive.fileName) {
                        <span class="spinner-sm"></span> ƒêang n√©n & upload...
                      } @else {
                        ‚¨ÜÔ∏è Upload
                      }
                    </button>
                  </div>
                }
              </div>
            }

            <!-- Upload result -->
            @if (lastUploadResult(); as ur) {
              <div class="compression-stats">
                <h4>üìä K·∫øt qu·∫£ upload & n√©n</h4>
                <div class="stat-grid">
                  <div class="stat">
                    <span class="stat-value">{{ formatSize(ur.originalSizeBytes) }}</span>
                    <span class="stat-label">G·ªëc</span>
                  </div>
                  @if (ur.compressedSizeBytes) {
                    <div class="stat">
                      <span class="stat-value">{{ formatSize(ur.compressedSizeBytes) }}</span>
                      <span class="stat-label">Sau n√©n</span>
                    </div>
                    <div class="stat">
                      <span class="stat-value">{{ ur.compressionRatioPercent?.toFixed(1) }}%</span>
                      <span class="stat-label">T·ª∑ l·ªá n√©n</span>
                    </div>
                    <div class="stat">
                      <span class="stat-value">{{ ur.compressionDurationMs }}ms</span>
                      <span class="stat-label">Th·ªùi gian n√©n</span>
                    </div>
                  }
                  <div class="stat">
                    <span class="stat-value">{{ formatSize(ur.cloudSizeBytes) }}</span>
                    <span class="stat-label">Tr√™n Cloud</span>
                  </div>
                </div>
                @if (ur.compressedSizeBytes && ur.originalSizeBytes > ur.compressedSizeBytes) {
                  <div class="compression-savings">
                    üí∞ Ti·∫øt ki·ªám:
                    {{ formatSize(ur.originalSizeBytes - ur.compressedSizeBytes) }} ({{
                      (100 - (ur.compressionRatioPercent ?? 100)).toFixed(1)
                    }}%)
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Cloud backups list -->
      <div class="card" style="margin-top: 16px">
        <div class="card-header">
          <h3>üì¶ B·∫£n sao l∆∞u tr√™n Cloud</h3>
          <button class="btn btn-sm btn-outline" (click)="loadCloudData()">L√†m m·ªõi</button>
        </div>
        @if (cloudBackups().length === 0) {
          <div class="card-body empty">
            <p>Ch∆∞a c√≥ b·∫£n sao l∆∞u n√†o tr√™n cloud.</p>
          </div>
        } @else {
          <table class="table">
            <thead>
              <tr>
                <th>Object Key</th>
                <th>K√≠ch th∆∞·ªõc</th>
                <th>Ng√†y s·ª≠a ƒë·ªïi</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (obj of cloudBackups(); track obj.objectKey) {
                <tr>
                  <td>
                    <code>{{ obj.fileName }}</code>
                    @if (obj.fileName.endsWith('.br')) {
                      <span class="badge badge-info" style="margin-left: 6px">üóúÔ∏è Brotli</span>
                    }
                  </td>
                  <td>{{ formatSize(obj.sizeBytes) }}</td>
                  <td>{{ formatDate(obj.lastModified) }}</td>
                  <td>
                    <div class="btn-group">
                      <button
                        class="btn btn-sm btn-outline"
                        [disabled]="cloudDownloading() !== null"
                        (click)="downloadFromCloud(obj.objectKey)"
                      >
                        @if (cloudDownloading() === obj.objectKey) {
                          <span class="spinner-sm"></span>
                        }
                        ‚¨áÔ∏è T·∫£i v·ªÅ
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        (click)="deleteFromCloud(obj.objectKey)"
                      >
                        üóëÔ∏è X√≥a
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê Live logs tab ‚ïê‚ïê‚ïê -->
    @if (activeTab === 'live') {
      <div class="card log-card">
        <div class="card-header">
          <div class="log-header-left">
            <h3>
              @if (activeOperation(); as op) {
                {{ op.type === 'Backup' ? 'üíæ' : 'üîÑ' }}
                {{ op.id }}
              }
            </h3>
            @if (activeOperation(); as op) {
              <span class="badge" [ngClass]="getStatusBadgeClass(op.status)">
                @if (op.status === 'Running') {
                  <span class="spinner-sm"></span>
                }
                {{ op.status }}
              </span>
              <span class="text-muted">{{ formatDuration(op) }}</span>
            }
          </div>
          <div class="log-header-right">
            <label class="auto-scroll-toggle">
              <input type="checkbox" [(ngModel)]="autoScroll" />
              Auto-scroll
            </label>
            @if (activeOperation()?.status === 'Running') {
              <button class="btn btn-sm btn-danger" (click)="cancelOperation()">Hu·ª∑</button>
            }
          </div>
        </div>
        <div class="log-container" #logContainer>
          @for (line of logLines(); track $index) {
            <div class="log-line" [ngClass]="getLogLevelClass(line.level)">
              <span class="log-time">{{ line.timestamp | date: 'HH:mm:ss' }}</span>
              <span class="log-level">{{ line.level }}</span>
              <span class="log-msg">{{ line.message }}</span>
            </div>
          }
          @if (logLines().length === 0) {
            <div class="log-empty">ƒêang ch·ªù logs...</div>
          }
        </div>
        @if (activeOperation(); as op) {
          @if (op.errorMessage) {
            <div class="error-footer">‚ùå {{ op.errorMessage }}</div>
          }
          @if (op.status === 'Completed' && op.archivePath) {
            <div class="success-footer">
              ‚úÖ Ho√†n th√†nh ¬∑ Archive: <code>{{ op.archivePath }}</code>
            </div>
          }
        }
      </div>
    }
  </div>

  <!-- Confirm dialog -->
  @if (showConfirmDialog) {
    <div class="modal-overlay" (click)="confirmDialogNo()">
      <div class="modal-dialog" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚ö†Ô∏è X√°c nh·∫≠n</h3>
        </div>
        <div class="modal-body">
          <p>{{ confirmMessage }}</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="confirmDialogNo()">Hu·ª∑</button>
          <button class="btn btn-danger" (click)="confirmDialogYes()">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
  }
</div>
