<div class="dashboard-layout">
    <header class="page-header">
        <div class="header-title">
            <h1>üîî Qu·∫£n l√Ω th√¥ng b√°o</h1>
        </div>
        <div class="header-actions">
            <button class="btn-primary" (click)="showCreateModal = true">+ T·∫°o th√¥ng b√°o</button>
            <button class="btn-secondary" (click)="showBroadcastModal = true">üì¢ Ph√°t th√¥ng b√°o</button>
        </div>
    </header>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon info">üîî</div>
            <div class="stat-content">
                <div class="value">{{ notifications().length }}</div>
                <div class="label">T·ªïng th√¥ng b√°o</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">üì®</div>
            <div class="stat-content">
                <div class="value">{{ unreadCount() }}</div>
                <div class="label">Ch∆∞a ƒë·ªçc</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">‚úì</div>
            <div class="stat-content">
                <div class="value">{{ notifications().length - unreadCount() }}</div>
                <div class="label">ƒê√£ ƒë·ªçc</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card filter-card">
        <div class="filter-row">
            <div class="form-group">
                <label>Lo·∫°i th√¥ng b√°o</label>
                <select [(ngModel)]="filterType" (change)="applyFilters()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="Info">Th√¥ng tin</option>
                    <option value="Success">Th√†nh c√¥ng</option>
                    <option value="Warning">C·∫£nh b√°o</option>
                    <option value="Error">L·ªói</option>
                    <option value="AppointmentReminder">Nh·∫Øc l·ªãch h·∫πn</option>
                    <option value="QueueCalled">G·ªçi s·ªë</option>
                    <option value="CycleUpdate">C·∫≠p nh·∫≠t chu k·ª≥</option>
                    <option value="PaymentDue">Thanh to√°n</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tr·∫°ng th√°i</label>
                <select [(ngModel)]="filterRead" (change)="applyFilters()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="unread">Ch∆∞a ƒë·ªçc</option>
                    <option value="read">ƒê√£ ƒë·ªçc</option>
                </select>
            </div>
            <div class="form-group search-group">
                <label>T√¨m ki·∫øm</label>
                <input type="text" [(ngModel)]="searchTerm" (input)="applyFilters()"
                    placeholder="Ti√™u ƒë·ªÅ ho·∫∑c n·ªôi dung...">
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="card">
        <div class="section-header">
            <h2>Danh s√°ch th√¥ng b√°o</h2>
            @if (selectedIds().length > 0) {
            <button class="btn-danger-outline" (click)="markSelectedAsRead()">
                ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc ({{ selectedIds().length }})
            </button>
            }
        </div>

        <div class="notification-table">
            @for (notification of filteredNotifications(); track notification.id) {
            <div class="notification-row" [class.unread]="!notification.isRead">
                <div class="notification-checkbox">
                    <input type="checkbox" [checked]="selectedIds().includes(notification.id)"
                        (change)="toggleSelect(notification.id)">
                </div>
                <div class="notification-icon" [class]="notification.type.toLowerCase()">
                    {{ getTypeIcon(notification.type) }}
                </div>
                <div class="notification-content">
                    <div class="notification-header">
                        <span class="notification-title">{{ notification.title }}</span>
                        <span class="notification-type" [class]="notification.type.toLowerCase()">
                            {{ getTypeLabel(notification.type) }}
                        </span>
                    </div>
                    <div class="notification-message">{{ notification.message }}</div>
                    <div class="notification-meta">
                        <span class="notification-time">{{ formatTime(notification.createdAt) }}</span>
                        @if (notification.entityType) {
                        <span class="notification-entity">{{ notification.entityType }}</span>
                        }
                    </div>
                </div>
                <div class="notification-actions">
                    @if (!notification.isRead) {
                    <button class="btn-icon" title="ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc" (click)="markAsRead(notification)">‚úì</button>
                    }
                </div>
            </div>
            } @empty {
            <div class="empty-state">Kh√¥ng c√≥ th√¥ng b√°o n√†o</div>
            }
        </div>
    </div>

    <!-- Create Notification Modal -->
    @if (showCreateModal) {
    <div class="modal-overlay" (click)="showCreateModal = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>T·∫°o th√¥ng b√°o m·ªõi</h2>
                <button class="close-btn" (click)="showCreateModal = false">√ó</button>
            </div>

            <form (ngSubmit)="createNotification()">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>User ID</label>
                            <input class="form-control" [(ngModel)]="newNotification.userId" name="userId" required
                                placeholder="ID ng∆∞·ªùi nh·∫≠n">
                        </div>
                        <div class="form-group">
                            <label>Lo·∫°i th√¥ng b√°o</label>
                            <select class="form-control" [(ngModel)]="newNotification.type" name="type" required>
                                <option value="Info">Th√¥ng tin</option>
                                <option value="Success">Th√†nh c√¥ng</option>
                                <option value="Warning">C·∫£nh b√°o</option>
                                <option value="Error">L·ªói</option>
                                <option value="AppointmentReminder">Nh·∫Øc l·ªãch h·∫πn</option>
                                <option value="QueueCalled">G·ªçi s·ªë</option>
                                <option value="CycleUpdate">C·∫≠p nh·∫≠t chu k·ª≥</option>
                                <option value="PaymentDue">Thanh to√°n</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label>Ti√™u ƒë·ªÅ</label>
                            <input class="form-control" [(ngModel)]="newNotification.title" name="title" required>
                        </div>

                        <div class="form-group full-width">
                            <label>N·ªôi dung</label>
                            <textarea class="form-control" [(ngModel)]="newNotification.message" name="message" required
                                rows="3"></textarea>
                        </div>

                        <div class="form-group full-width">
                            <label>Link (t√πy ch·ªçn)</label>
                            <input class="form-control" [(ngModel)]="newNotification.actionUrl" name="actionUrl"
                                placeholder="/path/to/page">
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" (click)="showCreateModal = false">H·ªßy</button>
                    <button type="submit" class="btn-primary">T·∫°o th√¥ng b√°o</button>
                </div>
            </form>
        </div>
    </div>
    }

    <!-- Broadcast Notification Modal -->
    @if (showBroadcastModal) {
    <div class="modal-overlay" (click)="showBroadcastModal = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>üì¢ Ph√°t th√¥ng b√°o</h2>
                <button class="close-btn" (click)="showBroadcastModal = false">√ó</button>
            </div>

            <form (ngSubmit)="broadcastNotification()">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Ti√™u ƒë·ªÅ</label>
                            <input class="form-control" [(ngModel)]="broadcastData.title" name="title" required>
                        </div>

                        <div class="form-group full-width">
                            <label>N·ªôi dung</label>
                            <textarea class="form-control" [(ngModel)]="broadcastData.message" name="message" required
                                rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Lo·∫°i th√¥ng b√°o</label>
                            <select class="form-control" [(ngModel)]="broadcastData.type" name="type" required>
                                <option value="Info">Th√¥ng tin</option>
                                <option value="Success">Th√†nh c√¥ng</option>
                                <option value="Warning">C·∫£nh b√°o</option>
                                <option value="Error">L·ªói</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Nh√≥m ng∆∞·ªùi nh·∫≠n</label>
                            <select class="form-control" [(ngModel)]="broadcastData.role" name="role">
                                <option value="">T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
                                <option value="Admin">Admin</option>
                                <option value="Doctor">B√°c sƒ©</option>
                                <option value="Nurse">Y t√°</option>
                                <option value="Receptionist">L·ªÖ t√¢n</option>
                                <option value="LabTechnician">K·ªπ thu·∫≠t vi√™n</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" (click)="showBroadcastModal = false">H·ªßy</button>
                    <button type="submit" class="btn-primary">Ph√°t</button>
                </div>
            </form>
        </div>
    </div>
    }

    <!-- Success Toast -->
    @if (toastMessage()) {
    <div class="toast" [class]="toastType()">
        {{ toastMessage() }}
    </div>
    }
</div>