<div class="security-page">
  <div class="page-header">
    <h2>üìã S·ª± ki·ªán b·∫£o m·∫≠t</h2>
    <p class="subtitle">Chi ti·∫øt s·ª± ki·ªán Zero Trust ‚Äî T·∫•t c·∫£ ho·∫°t ƒë·ªông b·∫£o m·∫≠t</p>
  </div>

  <!-- View Toggle + Filters -->
  <div class="card filter-card">
    <div class="filter-top">
      <div class="view-toggle">
        <button class="toggle-btn" [class.active]="viewMode === 'all'" (click)="switchView('all')">
          üìä T·∫•t c·∫£
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'high-severity'"
          (click)="switchView('high-severity')"
        >
          üö® Nghi√™m tr·ªçng
        </button>
      </div>
      <div class="filter-actions">
        <button class="btn btn-sm btn-outline" (click)="clearFilters()">‚úï X√≥a l·ªçc</button>
        <button class="btn btn-sm btn-outline" (click)="loadEvents()" [disabled]="loading()">
          üîÑ L√†m m·ªõi
        </button>
      </div>
    </div>
    <div class="filter-row">
      <div class="form-group">
        <label>M·ª©c ƒë·ªô</label>
        <select [(ngModel)]="filterSeverity" (ngModelChange)="applyFilters()">
          <option value="">T·∫•t c·∫£</option>
          <option value="Critical">Critical</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
          <option value="Info">Info</option>
        </select>
      </div>
      <div class="form-group">
        <label>Lo·∫°i s·ª± ki·ªán</label>
        <select [(ngModel)]="filterType" (ngModelChange)="applyFilters()">
          <option value="">T·∫•t c·∫£</option>
          @for (cat of getEventCategories(); track cat) {
            <option [value]="cat">{{ cat }}</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label>ƒê·ªãa ch·ªâ IP</label>
        <input
          type="text"
          [(ngModel)]="filterIp"
          (ngModelChange)="applyFilters()"
          placeholder="L·ªçc theo IP..."
        />
      </div>
      <div class="form-group">
        <label>Ng∆∞·ªùi d√πng</label>
        <input
          type="text"
          [(ngModel)]="filterUser"
          (ngModelChange)="applyFilters()"
          placeholder="L·ªçc theo t√™n..."
        />
      </div>
      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select [(ngModel)]="filterBlocked" (ngModelChange)="applyFilters()">
          <option value="">T·∫•t c·∫£</option>
          <option value="blocked">B·ªã ch·∫∑n</option>
          <option value="allowed">Cho ph√©p</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Events Count -->
  <div class="results-count">
    Hi·ªÉn th·ªã {{ filteredEvents().length }} / {{ events().length }} s·ª± ki·ªán
  </div>

  <!-- Events Table -->
  <div class="card">
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Th·ªùi gian</th>
            <th>Lo·∫°i s·ª± ki·ªán</th>
            <th>M·ª©c ƒë·ªô</th>
            <th>Ng∆∞·ªùi d√πng</th>
            <th>IP</th>
            <th>ƒê∆∞·ªùng d·∫´n</th>
            <th>Risk Score</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Chi ti·∫øt</th>
          </tr>
        </thead>
        <tbody>
          @for (event of filteredEvents(); track event.id) {
            <tr [class.row-blocked]="event.isBlocked">
              <td class="time-cell">{{ formatDate(event.createdAt) }}</td>
              <td>
                <div class="event-type-cell">
                  <span class="event-icon">{{ getEventIcon(event.eventType) }}</span>
                  <span class="event-type">{{ formatEventType(event.eventType) }}</span>
                </div>
              </td>
              <td>
                <span class="badge" [ngClass]="getSeverityClass(event.severity)">
                  {{ event.severity }}
                </span>
              </td>
              <td>{{ event.username || '‚Äî' }}</td>
              <td class="ip-cell">{{ event.ipAddress || '‚Äî' }}</td>
              <td class="path-cell" [title]="event.requestPath || ''">
                {{ event.requestPath || '‚Äî' }}
              </td>
              <td>
                @if (event.riskScore !== null) {
                  <span
                    class="risk-score"
                    [class.risk-high]="event.riskScore! >= 50"
                    [class.risk-medium]="event.riskScore! >= 25 && event.riskScore! < 50"
                    [class.risk-low]="event.riskScore! < 25"
                  >
                    {{ event.riskScore }}
                  </span>
                } @else {
                  <span class="text-muted">‚Äî</span>
                }
              </td>
              <td>
                @if (event.isBlocked) {
                  <span class="badge severity-critical">üõë Ch·∫∑n</span>
                } @else {
                  <span class="badge severity-info">‚úì</span>
                }
              </td>
              <td>
                <button class="btn btn-xs btn-outline" (click)="showDetail(event)">üîç</button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="9" class="empty-state">Kh√¥ng c√≥ s·ª± ki·ªán n√†o ph√π h·ª£p</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Event Detail Modal -->
  @if (selectedEvent()) {
    <div class="modal-overlay" (click)="closeDetail()">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            {{ getEventIcon(selectedEvent()!.eventType) }}
            {{ formatEventType(selectedEvent()!.eventType) }}
          </h3>
          <button class="btn-close" (click)="closeDetail()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">M·ª©c ƒë·ªô</span>
              <span class="badge" [ngClass]="getSeverityClass(selectedEvent()!.severity)">
                {{ selectedEvent()!.severity }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Th·ªùi gian</span>
              <span>{{ formatDate(selectedEvent()!.createdAt) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Ng∆∞·ªùi d√πng</span>
              <span>{{ selectedEvent()!.username || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">IP</span>
              <span class="mono">{{ selectedEvent()!.ipAddress || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Qu·ªëc gia</span>
              <span>{{ selectedEvent()!.country || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Th√†nh ph·ªë</span>
              <span>{{ selectedEvent()!.city || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">ƒê∆∞·ªùng d·∫´n</span>
              <span class="mono">{{ selectedEvent()!.requestPath || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Ph∆∞∆°ng th·ª©c</span>
              <span>{{ selectedEvent()!.requestMethod || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Risk Score</span>
              <span>{{ selectedEvent()!.riskScore ?? '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">B·ªã ch·∫∑n</span>
              <span>{{ selectedEvent()!.isBlocked ? 'üõë C√≥' : '‚úì Kh√¥ng' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Correlation ID</span>
              <span class="mono small">{{ selectedEvent()!.correlationId || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Session ID</span>
              <span class="mono small">{{ selectedEvent()!.sessionId || '‚Äî' }}</span>
            </div>
          </div>

          @if (selectedEvent()!.userAgent) {
            <div class="detail-section">
              <span class="detail-label">User Agent</span>
              <p class="mono small ua-text">{{ selectedEvent()!.userAgent }}</p>
            </div>
          }

          @if (selectedEvent()!.deviceFingerprint) {
            <div class="detail-section">
              <span class="detail-label">Device Fingerprint</span>
              <p class="mono small">{{ selectedEvent()!.deviceFingerprint }}</p>
            </div>
          }

          @if (parseJson(selectedEvent()!.details); as details) {
            <div class="detail-section">
              <span class="detail-label">Chi ti·∫øt</span>
              <div class="json-view">
                @for (key of getObjectKeys(details); track key) {
                  <div class="json-row">
                    <span class="json-key">{{ key }}:</span>
                    <span class="json-value">{{ details[key] }}</span>
                  </div>
                }
              </div>
            </div>
          }

          @if (parseJson(selectedEvent()!.threatIndicators); as indicators) {
            <div class="detail-section">
              <span class="detail-label">Threat Indicators</span>
              <div class="json-view">
                @for (key of getObjectKeys(indicators); track key) {
                  <div class="json-row">
                    <span class="json-key">{{ key }}:</span>
                    <span class="json-value">{{ indicators[key] }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Loading -->
  @if (loading()) {
    <div class="loading-indicator">
      <div class="spinner"></div>
    </div>
  }
</div>
