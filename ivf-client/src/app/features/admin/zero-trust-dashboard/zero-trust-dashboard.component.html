<div class="zt-page">
  <div class="page-header">
    <h2>üõ°Ô∏è Zero Trust Dashboard</h2>
    <p class="subtitle">Qu·∫£n l√Ω ch√≠nh s√°ch truy c·∫≠p Zero Trust ‚Äî Never trust, always verify</p>
  </div>

  <!-- Summary Cards -->
  <div class="stats-grid">
    <div class="stat-card stat-blue">
      <div class="stat-icon">üìã</div>
      <div class="stat-info">
        <span class="stat-value">{{ policies().length }}</span>
        <span class="stat-label">T·ªïng policies</span>
      </div>
    </div>
    <div class="stat-card stat-green">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-info">
        <span class="stat-value">{{ activePolicies() }}</span>
        <span class="stat-label">ƒêang ho·∫°t ƒë·ªông</span>
      </div>
    </div>
    <div class="stat-card stat-red">
      <div class="stat-icon">üö´</div>
      <div class="stat-info">
        <span class="stat-value">{{ vpnBlockCount() }}</span>
        <span class="stat-label">Ch·∫∑n VPN/Tor</span>
      </div>
    </div>
    <div class="stat-card stat-purple">
      <div class="stat-icon">üì±</div>
      <div class="stat-info">
        <span class="stat-value">{{ trustedDeviceCount() }}</span>
        <span class="stat-label">Y√™u c·∫ßu thi·∫øt b·ªã tin c·∫≠y</span>
      </div>
    </div>
  </div>

  <!-- Policies Table -->
  <div class="card">
    <div class="card-header">
      <h3>üîê Ch√≠nh s√°ch Zero Trust</h3>
      <div class="header-actions">
        <button class="btn btn-sm btn-outline" (click)="loadPolicies()">üîÑ L√†m m·ªõi</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Action</th>
            <th>Auth Level</th>
            <th>Max Risk</th>
            <th class="col-center">Thi·∫øt b·ªã</th>
            <th class="col-center">VPN/Tor</th>
            <th class="col-center">GeoFence</th>
            <th class="col-center">Anomaly</th>
            <th class="col-center">Break Glass</th>
            <th>Active</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          @for (policy of policies(); track policy.id) {
            <tr>
              <td class="cell-bold">{{ policy.action }}</td>
              <td>
                <span class="badge" [ngClass]="getAuthLevelClass(policy.requiredAuthLevel)">
                  {{ policy.requiredAuthLevel }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="getRiskClass(policy.maxAllowedRisk)">
                  {{ policy.maxAllowedRisk }}
                </span>
              </td>
              <td class="col-center">
                <span
                  class="indicator"
                  [class.indicator-on]="policy.requireTrustedDevice"
                  [class.indicator-off]="!policy.requireTrustedDevice"
                >
                  {{ policy.requireTrustedDevice ? '‚úì' : '‚úó' }}
                </span>
              </td>
              <td class="col-center">
                <span
                  class="indicator"
                  [class.indicator-block]="policy.blockVpnTor"
                  [class.indicator-off]="!policy.blockVpnTor"
                >
                  {{ policy.blockVpnTor ? 'üö´' : '‚Äî' }}
                </span>
              </td>
              <td class="col-center">
                <span
                  class="indicator"
                  [class.indicator-info]="policy.requireGeoFence"
                  [class.indicator-off]="!policy.requireGeoFence"
                >
                  {{ policy.requireGeoFence ? 'üìç' : '‚Äî' }}
                </span>
              </td>
              <td class="col-center">
                <span
                  class="indicator"
                  [class.indicator-warn]="policy.blockAnomaly"
                  [class.indicator-off]="!policy.blockAnomaly"
                >
                  {{ policy.blockAnomaly ? '‚ö†' : '‚Äî' }}
                </span>
              </td>
              <td class="col-center">
                <span
                  class="indicator"
                  [class.indicator-glass]="policy.allowBreakGlassOverride"
                  [class.indicator-off]="!policy.allowBreakGlassOverride"
                >
                  {{ policy.allowBreakGlassOverride ? 'üîì' : '‚Äî' }}
                </span>
              </td>
              <td>
                <span
                  class="badge"
                  [class.badge-success]="policy.isActive"
                  [class.badge-secondary]="!policy.isActive"
                >
                  {{ policy.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>
                <div class="action-cell">
                  <button class="btn btn-xs btn-primary" (click)="editPolicy(policy)">
                    ‚úèÔ∏è S·ª≠a
                  </button>
                </div>
              </td>
            </tr>
          }
          @if (policies().length === 0) {
            <tr>
              <td colspan="10" class="empty-state">üîê Ch∆∞a c√≥ ch√≠nh s√°ch n√†o</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Policy Dialog -->
  @if (editingPolicy()) {
    <div class="modal-overlay" (click)="editingPolicy.set(false)">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úèÔ∏è Ch·ªânh s·ª≠a Policy: {{ editForm.action }}</h3>
          <button class="btn-close" (click)="editingPolicy.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Required Auth Level</label>
              <select [(ngModel)]="editForm.requiredAuthLevel">
                <option value="None">None</option>
                <option value="Session">Session</option>
                <option value="Password">Password</option>
                <option value="MFA">MFA</option>
                <option value="FreshSession">FreshSession</option>
                <option value="Biometric">Biometric</option>
              </select>
            </div>
            <div class="form-group">
              <label>Max Allowed Risk</label>
              <select [(ngModel)]="editForm.maxAllowedRisk">
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
          </div>

          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" [(ngModel)]="editForm.requireTrustedDevice" />
              <span>Require Trusted Device</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" [(ngModel)]="editForm.requireFreshSession" />
              <span>Require Fresh Session</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" [(ngModel)]="editForm.blockAnomaly" />
              <span>Block Anomaly</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" [(ngModel)]="editForm.requireGeoFence" />
              <span>Require GeoFence</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" [(ngModel)]="editForm.blockVpnTor" />
              <span>Block VPN/Tor</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" [(ngModel)]="editForm.allowBreakGlassOverride" />
              <span>Allow Break Glass</span>
            </label>
          </div>

          @if (editForm.requireGeoFence) {
            <div class="form-group" style="margin-top: 1rem">
              <label>Allowed Countries (comma-separated)</label>
              <input type="text" [(ngModel)]="editForm.allowedCountries" placeholder="VN,US,JP" />
            </div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="editingPolicy.set(false)">H·ªßy</button>
          <button class="btn btn-primary" (click)="savePolicy()" [disabled]="loading()">
            üíæ L∆∞u
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Access Check Test -->
  <div class="card">
    <div class="card-header">
      <h3>üß™ Ki·ªÉm tra truy c·∫≠p (Test)</h3>
    </div>
    <div class="card-body">
      <div class="access-check-form">
        <div class="form-group">
          <label>Action</label>
          <input type="text" [(ngModel)]="accessCheckAction" placeholder="e.g. patient:read" />
        </div>
        <button class="btn btn-purple" (click)="testAccess()" [disabled]="loading()">
          üîç Ki·ªÉm tra
        </button>
      </div>

      @if (accessDecision()) {
        <div
          class="decision-result"
          [class.decision-allowed]="accessDecision()!.allowed"
          [class.decision-denied]="!accessDecision()!.allowed"
        >
          <div class="decision-header">
            <span class="decision-icon">{{ accessDecision()!.allowed ? '‚úÖ' : '‚ùå' }}</span>
            <span class="decision-title">
              {{ accessDecision()!.allowed ? 'Cho ph√©p' : 'T·ª´ ch·ªëi' }}
            </span>
          </div>
          <div class="decision-details">
            <div class="detail-row">
              <span class="detail-label">Action:</span>
              <span>{{ accessDecision()!.action }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">L√Ω do:</span>
              <span>{{ accessDecision()!.reason }}</span>
            </div>
            @if (accessDecision()!.failedChecks.length > 0) {
              <div class="detail-row">
                <span class="detail-label">Ki·ªÉm tra th·∫•t b·∫°i:</span>
                <ul class="failed-checks">
                  @for (check of accessDecision()!.failedChecks; track check) {
                    <li>{{ check }}</li>
                  }
                </ul>
              </div>
            }
            @if (accessDecision()!.requiresStepUp) {
              <div class="stepup-warning">
                ‚ö† Y√™u c·∫ßu x√°c th·ª±c n√¢ng cao ({{ accessDecision()!.requiredAuthLevel }})
              </div>
            }
            @if (accessDecision()!.deviceRiskLevel) {
              <div class="detail-row">
                <span class="detail-label">Device Risk:</span>
                <span
                  >{{ accessDecision()!.deviceRiskLevel }} ({{
                    accessDecision()!.deviceRiskScore
                  }})</span
                >
              </div>
            }
            <div class="decision-time">{{ formatDate(accessDecision()!.decisionTime) }}</div>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Status Message -->
  @if (statusMessage()) {
    <div
      class="toast"
      [class.toast-success]="statusMessage()!.type === 'success'"
      [class.toast-error]="statusMessage()!.type === 'error'"
    >
      {{ statusMessage()!.text }}
    </div>
  }
</div>
