<div class="vault-page">
  <!-- ‚ïê‚ïê‚ïê Header ‚ïê‚ïê‚ïê -->
  <div class="page-header">
    <div class="header-left">
      <h2>üîê Qu·∫£n l√Ω Vault</h2>
      <p class="subtitle">Secrets, API Keys, Policies, Encryption & Zero Trust</p>
    </div>
    <div class="header-right">
      <span class="vault-badge" [class.vault-ok]="isHealthy()" [class.vault-err]="!isHealthy()">
        {{ isInitialized() ? 'üü¢ Unlocked' : 'üî¥ Locked' }}
      </span>
      <span class="provider-badge">Azure Key Vault</span>
      <button class="btn btn-sm btn-outline" (click)="refresh()">üîÑ Refresh</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Stats Strip ‚ïê‚ïê‚ïê -->
  <div class="stats-grid">
    <div
      class="stat-card"
      [class.stat-success]="isInitialized()"
      [class.stat-danger]="!isInitialized()"
    >
      <div class="stat-icon">üè¶</div>
      <div class="stat-info">
        <span class="stat-value">{{ isInitialized() ? 'Ho·∫°t ƒë·ªông' : 'Ch∆∞a kh·ªüi t·∫°o' }}</span>
        <span class="stat-label">Tr·∫°ng th√°i Vault</span>
      </div>
    </div>
    <div class="stat-card stat-info-card">
      <div class="stat-icon">üîë</div>
      <div class="stat-info">
        <span class="stat-value">{{ activeKeyCount() }}</span>
        <span class="stat-label">Active Keys</span>
      </div>
    </div>
    <div class="stat-card" [class.stat-success]="isHealthy()" [class.stat-danger]="!isHealthy()">
      <div class="stat-icon">üíì</div>
      <div class="stat-info">
        <span class="stat-value">{{ isHealthy() ? 'Healthy' : 'Unhealthy' }}</span>
        <span class="stat-label">Health</span>
      </div>
    </div>
    <div class="stat-card stat-info-card">
      <div class="stat-icon">üõ°Ô∏è</div>
      <div class="stat-info">
        <span class="stat-value">{{ activeZTPolicies() }}</span>
        <span class="stat-label">ZT Policies</span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Initialize Banner ‚ïê‚ïê‚ïê -->
  @if (!isInitialized()) {
    <div class="card card-warning">
      <div class="card-header"><h3>‚ö° Kh·ªüi t·∫°o Vault</h3></div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-group">
            <label>Master Password</label>
            <input
              type="password"
              [(ngModel)]="initForm.masterPassword"
              placeholder="Nh·∫≠p master password"
            />
          </div>
          <div class="form-group">
            <label>User ID</label>
            <input type="text" [(ngModel)]="initForm.userId" placeholder="Nh·∫≠p user ID" />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-warning" (click)="initializeVault()" [disabled]="loading()">
            üîì Kh·ªüi t·∫°o Vault
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê Tabs Bar ‚ïê‚ïê‚ïê -->
  <div class="tabs-bar">
    @for (tab of tabs; track tab.key) {
      <button
        class="tab-btn"
        [class.tab-active]="activeTab() === tab.key"
        (click)="onTabChange(tab.key)"
      >
        <span class="tab-icon">{{ tab.icon }}</span>
        <span class="tab-label">{{ tab.label }}</span>
      </button>
    }
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: Secrets ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'secrets') {
    <div class="tab-panel">
      <!-- Breadcrumb -->
      <div class="breadcrumb-bar">
        <button
          class="breadcrumb-item"
          [class.active]="breadcrumb().length === 0"
          (click)="navigateHome()"
        >
          üè† vault
        </button>
        @for (seg of breadcrumb(); track seg; let i = $index) {
          <span class="breadcrumb-sep">/</span>
          <button
            class="breadcrumb-item"
            [class.active]="i === breadcrumb().length - 1"
            (click)="navigateToBreadcrumb(i)"
          >
            {{ seg }}
          </button>
        }
        <div class="breadcrumb-actions">
          <button class="btn btn-sm btn-primary" (click)="showNewSecretDialog.set(true)">
            ‚ûï New Secret
          </button>
        </div>
      </div>

      <!-- Secrets Table -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 40px"></th>
              <th>T√™n</th>
              <th>Lo·∫°i</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            @for (entry of secrets(); track entry.name) {
              <tr>
                <td class="cell-icon">
                  @if (entry.type === 'folder') {
                    <span class="folder-icon">üìÅ</span>
                  } @else {
                    <span class="secret-icon">üîë</span>
                  }
                </td>
                <td class="cell-bold">
                  @if (entry.type === 'folder') {
                    <button class="link-btn" (click)="navigateToFolder(entry.name)">
                      {{ entry.name }}
                    </button>
                  } @else {
                    <button class="link-btn" (click)="viewSecret(entry.name)">
                      {{ entry.name }}
                    </button>
                  }
                </td>
                <td>
                  <span
                    class="badge"
                    [class.badge-folder]="entry.type === 'folder'"
                    [class.badge-secret]="entry.type === 'secret'"
                  >
                    {{ entry.type === 'folder' ? 'Folder' : 'Secret' }}
                  </span>
                </td>
                <td>
                  <div class="action-cell">
                    @if (entry.type === 'secret') {
                      <button class="btn btn-xs btn-outline" (click)="viewSecret(entry.name)">
                        üëÅ Xem
                      </button>
                      <button class="btn btn-xs btn-danger" (click)="deleteSecretEntry(entry.name)">
                        üóë X√≥a
                      </button>
                    } @else {
                      <button class="btn btn-xs btn-outline" (click)="navigateToFolder(entry.name)">
                        üìÇ M·ªü
                      </button>
                    }
                  </div>
                </td>
              </tr>
            }
            @if (secrets().length === 0) {
              <tr>
                <td colspan="4" class="empty-state">üìÇ Th∆∞ m·ª•c tr·ªëng</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: API Keys ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'api-keys') {
    <div class="tab-panel">
      <!-- Expiring Alert -->
      @if (expiringKeys().length > 0) {
        <div class="alert alert-danger">
          <div class="alert-title">‚ö† {{ expiringKeys().length }} key s·∫Øp h·∫øt h·∫°n (30 ng√†y)</div>
          @for (key of expiringKeys(); track key.id) {
            <div class="alert-item">
              <span class="key-name">{{ key.serviceName }}/{{ key.keyName }}</span>
              <span class="key-expiry">H·∫øt h·∫°n: {{ formatDate(key.expiresAt) }}</span>
            </div>
          }
        </div>
      }

      <!-- Create Key Card -->
      <div class="card">
        <div class="card-header">
          <h3>‚ûï T·∫°o Key m·ªõi</h3>
          <div class="header-actions">
            <button
              class="btn btn-sm btn-outline"
              (click)="showCreateKeyForm.set(!showCreateKeyForm())"
            >
              {{ showCreateKeyForm() ? '·∫®n' : 'Hi·ªán' }}
            </button>
          </div>
        </div>
        @if (showCreateKeyForm()) {
          <div class="card-body">
            <div class="form-grid form-grid-3">
              <div class="form-group">
                <label>Key Name</label>
                <input
                  type="text"
                  [(ngModel)]="createForm.keyName"
                  placeholder="e.g. api-key-main"
                />
              </div>
              <div class="form-group">
                <label>Service Name</label>
                <input
                  type="text"
                  [(ngModel)]="createForm.serviceName"
                  placeholder="e.g. backup-service"
                />
              </div>
              <div class="form-group">
                <label>Key Prefix</label>
                <input type="text" [(ngModel)]="createForm.keyPrefix" placeholder="e.g. ivf_" />
              </div>
              <div class="form-group">
                <label>Key Hash</label>
                <input type="text" [(ngModel)]="createForm.keyHash" placeholder="Hash value" />
              </div>
              <div class="form-group">
                <label>Environment</label>
                <select [(ngModel)]="createForm.environment">
                  <option value="Development">Development</option>
                  <option value="Staging">Staging</option>
                  <option value="Production">Production</option>
                </select>
              </div>
              <div class="form-group">
                <label>Chu k·ª≥ xoay (ng√†y)</label>
                <input
                  type="number"
                  [(ngModel)]="createForm.rotationIntervalDays"
                  placeholder="90"
                />
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" (click)="createKey()" [disabled]="loading()">
                üîë T·∫°o Key
              </button>
            </div>
          </div>
        }
      </div>

      <!-- Keys Table -->
      <div class="card">
        <div class="card-header">
          <h3>üìã Danh s√°ch API Keys</h3>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Service</th>
                <th>Key Name</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Version</th>
                <th>H·∫øt h·∫°n</th>
                <th>Xoay l·∫ßn cu·ªëi</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (key of vaultStatus()?.keys ?? []; track key.keyName + key.serviceName) {
                <tr>
                  <td class="cell-bold">{{ key.serviceName }}</td>
                  <td>{{ key.keyName }}</td>
                  <td>
                    <span
                      class="badge"
                      [class.badge-success]="key.isActive"
                      [class.badge-danger]="!key.isActive"
                    >
                      {{ key.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                  <td class="cell-mono">v{{ key.version }}</td>
                  <td>{{ key.expiresAt ? formatDate(key.expiresAt) : '‚Äî' }}</td>
                  <td>{{ key.lastRotatedAt ? formatDate(key.lastRotatedAt) : '‚Äî' }}</td>
                  <td>
                    <div class="action-cell">
                      <button class="btn btn-xs btn-primary" (click)="openRotateDialog(key)">
                        üîÑ Xoay
                      </button>
                    </div>
                  </td>
                </tr>
              }
              @if ((vaultStatus()?.keys ?? []).length === 0) {
                <tr>
                  <td colspan="7" class="empty-state">üîë Ch∆∞a c√≥ key n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Zero Trust ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'zero-trust') {
    <div class="tab-panel">
      <!-- Security Dashboard -->
      @if (securityDashboard(); as dashboard) {
        <div class="card">
          <div class="card-header"><h3>üõ°Ô∏è Security Dashboard</h3></div>
          <div class="card-body">
            <div class="zt-stats">
              <div class="zt-stat zt-stat-primary">
                <span class="zt-stat-value">{{ dashboard.securityScore }}</span>
                <span class="zt-stat-label">Security Score</span>
              </div>
              <div class="zt-stat">
                <span class="zt-stat-value">{{ dashboard.vaultStatus }}</span>
                <span class="zt-stat-label">Vault Status</span>
              </div>
              <div class="zt-stat">
                <span class="zt-stat-value">{{ dashboard.trustedDevices }}</span>
                <span class="zt-stat-label">Trusted Devices</span>
              </div>
              <div class="zt-stat">
                <span class="zt-stat-value">{{ dashboard.recentAlerts }}</span>
                <span class="zt-stat-label">Recent Alerts</span>
              </div>
              <div class="zt-stat">
                <span class="zt-stat-value">{{ dashboard.blockedAttempts }}</span>
                <span class="zt-stat-label">Blocked Attempts</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Security Events -->
        @if (dashboard.recentEvents.length > 0) {
          <div class="card mt-16">
            <div class="card-header"><h3>üìã Recent Security Events</h3></div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Th·ªùi gian</th>
                    <th>H√†nh ƒë·ªông</th>
                    <th>Resource</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody>
                  @for (ev of dashboard.recentEvents; track ev.id) {
                    <tr>
                      <td>{{ formatDate(ev.createdAt) }}</td>
                      <td>
                        <span class="badge badge-outline">{{ ev.action }}</span>
                      </td>
                      <td>{{ ev.resourceType || '‚Äî' }}</td>
                      <td>{{ ev.ipAddress || '‚Äî' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
      }

      <!-- ZT Stats -->
      <div class="zt-stats mt-16">
        <div class="zt-stat">
          <span class="zt-stat-value">{{ activeZTPolicies() }}</span>
          <span class="zt-stat-label">Active Policies</span>
        </div>
        <div class="zt-stat">
          <span class="zt-stat-value">{{ vpnBlockCount() }}</span>
          <span class="zt-stat-label">VPN/Tor Blocked</span>
        </div>
        <div class="zt-stat">
          <span class="zt-stat-value">{{ trustedDeviceCount() }}</span>
          <span class="zt-stat-label">Trusted Device Required</span>
        </div>
      </div>

      <!-- Access Check -->
      <div class="card">
        <div class="card-header"><h3>üß™ Ki·ªÉm tra truy c·∫≠p</h3></div>
        <div class="card-body">
          <div class="inline-form">
            <input
              type="text"
              [(ngModel)]="accessCheckAction"
              placeholder="Nh·∫≠p action (vd: ViewPatient)"
            />
            <button class="btn btn-primary" (click)="testAccess()" [disabled]="loading()">
              Ki·ªÉm tra
            </button>
          </div>
          @if (accessDecision()) {
            <div
              class="access-result"
              [class.access-granted]="accessDecision()!.allowed"
              [class.access-denied]="!accessDecision()!.allowed"
            >
              <div class="access-header">
                {{ accessDecision()!.allowed ? '‚úÖ GRANTED' : '‚ùå DENIED' }}
                ‚Äî {{ accessDecision()!.action }}
              </div>
              <div class="access-detail">
                <span>Auth Level: {{ accessDecision()!.requiredAuthLevel }}</span>
                <span>Risk: {{ accessDecision()!.deviceRiskLevel ?? 'N/A' }}</span>
              </div>
              @if (accessDecision()!.failedChecks.length) {
                <div class="access-failures">
                  <strong>Failed checks:</strong>
                  @for (c of accessDecision()!.failedChecks; track c) {
                    <span class="badge badge-danger">{{ c }}</span>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Policies Table -->
      <div class="card">
        <div class="card-header">
          <h3>üìã Zero Trust Policies</h3>
          <div class="header-actions">
            <button class="btn btn-sm btn-outline" (click)="loadZTPolicies()">üîÑ L√†m m·ªõi</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Action</th>
                <th>Auth Level</th>
                <th>Max Risk</th>
                <th>Trusted Device</th>
                <th>Fresh Session</th>
                <th>Block VPN/Tor</th>
                <th>Block Anomaly</th>
                <th>Geo Fence</th>
                <th>Active</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (p of ztPolicies(); track p.action) {
                <tr>
                  <td class="cell-bold">{{ p.action }}</td>
                  <td>
                    <span class="badge" [ngClass]="getAuthLevelClass(p.requiredAuthLevel)">
                      {{ p.requiredAuthLevel }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getRiskClass(p.maxAllowedRisk)">{{
                      p.maxAllowedRisk
                    }}</span>
                  </td>
                  <td class="cell-center">{{ p.requireTrustedDevice ? '‚úÖ' : '‚Äî' }}</td>
                  <td class="cell-center">{{ p.requireFreshSession ? '‚úÖ' : '‚Äî' }}</td>
                  <td class="cell-center">{{ p.blockVpnTor ? '‚úÖ' : '‚Äî' }}</td>
                  <td class="cell-center">{{ p.blockAnomaly ? '‚úÖ' : '‚Äî' }}</td>
                  <td class="cell-center">{{ p.requireGeoFence ? '‚úÖ' : '‚Äî' }}</td>
                  <td class="cell-center">
                    <span
                      class="badge"
                      [class.badge-success]="p.isActive"
                      [class.badge-danger]="!p.isActive"
                    >
                      {{ p.isActive ? 'Active' : 'Off' }}
                    </span>
                  </td>
                  <td>
                    <div class="action-cell">
                      <button class="btn btn-xs btn-primary" (click)="editPolicy(p)">‚úèÔ∏è S·ª≠a</button>
                    </div>
                  </td>
                </tr>
              }
              @if (ztPolicies().length === 0) {
                <tr>
                  <td colspan="10" class="empty-state">üõ°Ô∏è Ch∆∞a c√≥ ch√≠nh s√°ch n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Rotation ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'rotation') {
    <div class="tab-panel">
      <div class="card">
        <div class="card-header"><h3>üîÑ Key Rotation Schedule</h3></div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Service</th>
                <th>Key</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Xoay l·∫ßn cu·ªëi</th>
                <th>H·∫øt h·∫°n</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (key of vaultStatus()?.keys ?? []; track key.keyName + key.serviceName) {
                <tr>
                  <td class="cell-bold">{{ key.serviceName }}</td>
                  <td>{{ key.keyName }}</td>
                  <td>
                    <span
                      class="badge"
                      [class.badge-success]="key.isActive"
                      [class.badge-danger]="!key.isActive"
                    >
                      {{ key.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                  <td>{{ key.lastRotatedAt ? formatDate(key.lastRotatedAt) : '‚Äî' }}</td>
                  <td>{{ key.expiresAt ? formatDate(key.expiresAt) : '‚Äî' }}</td>
                  <td>
                    <div class="action-cell">
                      <button class="btn btn-xs btn-primary" (click)="openRotateDialog(key)">
                        üîÑ Xoay ngay
                      </button>
                    </div>
                  </td>
                </tr>
              }
              @if ((vaultStatus()?.keys ?? []).length === 0) {
                <tr>
                  <td colspan="6" class="empty-state">Ch∆∞a c√≥ key n√†o ƒë·ªÉ xoay</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Database ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'database') {
    <div class="tab-panel">
      <div class="section-header">
        <div>
          <h3>üóÑÔ∏è Database Credentials</h3>
          <p class="text-muted">Qu·∫£n l√Ω credentials cho database connections</p>
        </div>
        <button class="btn btn-sm btn-primary" (click)="showDbDialog.set(true)">
          ‚ûï Th√™m Database
        </button>
      </div>
      <div class="card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>T√™n</th>
                <th>Host</th>
                <th>Database</th>
                <th>Port</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (db of databaseSecrets(); track db.name) {
                <tr>
                  <td class="cell-bold"><span class="db-icon">üñ•Ô∏è</span> {{ db.name }}</td>
                  <td>{{ db.host || '‚Äî' }}</td>
                  <td>{{ db.database || '‚Äî' }}</td>
                  <td>{{ db.port || '‚Äî' }}</td>
                  <td>
                    <div class="action-cell">
                      <button
                        class="btn btn-xs btn-outline"
                        (click)="viewSecret('database/' + db.name)"
                      >
                        üëÅ Xem
                      </button>
                      <button class="btn btn-xs btn-danger" (click)="deleteDbSecret(db.name)">
                        üóë X√≥a
                      </button>
                    </div>
                  </td>
                </tr>
              }
              @if (databaseSecrets().length === 0) {
                <tr>
                  <td colspan="5" class="empty-state">üóÑÔ∏è Ch∆∞a c√≥ database credentials n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
      <p class="tip-text">üí° Database credentials ƒë∆∞·ª£c l∆∞u t·∫°i path <code>database/[t√™n]</code></p>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Policies ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'policies') {
    <div class="tab-panel">
      <div class="section-header">
        <div>
          <h3>üìã Vault Policies</h3>
          <p class="text-muted">Qu·∫£n l√Ω ch√≠nh s√°ch truy c·∫≠p vault</p>
        </div>
        <button class="btn btn-sm btn-primary" (click)="showPolicyDialog.set(true)">
          ‚ûï T·∫°o Policy
        </button>
      </div>
      <div class="card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>T√™n</th>
                <th>Path Pattern</th>
                <th>Capabilities</th>
                <th>M√¥ t·∫£</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (p of policies(); track p.id) {
                <tr>
                  <td class="cell-bold">{{ p.name }}</td>
                  <td>
                    <code>{{ p.pathPattern }}</code>
                  </td>
                  <td>
                    @for (cap of p.capabilities; track cap) {
                      <span class="badge badge-outline">{{ cap }}</span>
                    }
                  </td>
                  <td>{{ p.description || '‚Äî' }}</td>
                  <td>
                    <div class="action-cell">
                      <button class="btn btn-xs btn-danger" (click)="deletePolicy(p.id)">
                        üóë X√≥a
                      </button>
                    </div>
                  </td>
                </tr>
              }
              @if (policies().length === 0) {
                <tr>
                  <td colspan="5" class="empty-state">üìã Ch∆∞a c√≥ policy n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: User Policies ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'user-policies') {
    <div class="tab-panel">
      <div class="section-header">
        <div>
          <h3>üë§ User Policies</h3>
          <p class="text-muted">G√°n ch√≠nh s√°ch vault cho ng∆∞·ªùi d√πng</p>
        </div>
        <button class="btn btn-sm btn-primary" (click)="showUserPolicyDialog.set(true)">
          ‚ûï G√°n Policy
        </button>
      </div>
      <div class="card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Policy</th>
                <th>G√°n l√∫c</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (up of userPolicies(); track up.id) {
                <tr>
                  <td class="cell-bold">{{ up.userName || up.userId }}</td>
                  <td>
                    <span class="badge badge-info">{{ up.policyName || up.policyId }}</span>
                  </td>
                  <td>{{ up.grantedAt ? formatDate(up.grantedAt) : '‚Äî' }}</td>
                  <td>
                    <div class="action-cell">
                      <button class="btn btn-xs btn-danger" (click)="removeUserPolicy(up.id)">
                        üóë G·ª°
                      </button>
                    </div>
                  </td>
                </tr>
              }
              @if (userPolicies().length === 0) {
                <tr>
                  <td colspan="4" class="empty-state">üë§ Ch∆∞a g√°n policy cho user n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Leases ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'leases') {
    <div class="tab-panel">
      <div class="section-header">
        <div>
          <h3>‚è±Ô∏è Secret Leases</h3>
          <p class="text-muted">Qu·∫£n l√Ω lease (th·ªùi gian s·ª≠ d·ª•ng) c·ªßa secrets</p>
        </div>
        <button class="btn btn-primary" (click)="showLeaseDialog.set(true)">‚ûï T·∫°o Lease</button>
      </div>
      <div class="card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Secret</th>
                <th>TTL</th>
                <th>Renewable</th>
                <th>H·∫øt h·∫°n</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (lease of leases(); track lease.id) {
                <tr>
                  <td class="cell-bold">{{ lease.secretPath }}</td>
                  <td>{{ lease.ttl }}s</td>
                  <td class="cell-center">{{ lease.renewable ? '‚úÖ' : '‚Äî' }}</td>
                  <td>{{ formatDate(lease.expiresAt) }}</td>
                  <td>
                    <span
                      class="badge"
                      [class.badge-success]="!lease.revoked"
                      [class.badge-danger]="lease.revoked"
                    >
                      {{ lease.revoked ? 'Revoked' : 'Active' }}
                    </span>
                  </td>
                  <td>
                    <div class="action-cell">
                      @if (!lease.revoked) {
                        @if (lease.renewable) {
                          <button
                            class="btn btn-xs btn-outline"
                            (click)="renewLease(lease.leaseId)"
                          >
                            üîÑ Gia h·∫°n
                          </button>
                        }
                        <button class="btn btn-xs btn-danger" (click)="revokeLease(lease.leaseId)">
                          üö´ Thu h·ªìi
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
              @if (leases().length === 0) {
                <tr>
                  <td colspan="6" class="empty-state">‚è±Ô∏è Kh√¥ng c√≥ lease n√†o ƒëang active</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ Create Lease Dialog ‚îÄ‚îÄ‚îÄ -->
      @if (showLeaseDialog()) {
        <div class="dialog-overlay" (click)="showLeaseDialog.set(false)">
          <div class="dialog" (click)="$event.stopPropagation()">
            <div class="dialog-header">
              <h3>‚ûï T·∫°o Lease m·ªõi</h3>
              <button class="btn btn-xs btn-outline" (click)="showLeaseDialog.set(false)">‚úï</button>
            </div>
            <div class="dialog-body">
              <div class="form-group">
                <label>Secret Path</label>
                <input
                  type="text"
                  [(ngModel)]="newLeaseForm.secretPath"
                  placeholder="database/postgres"
                />
              </div>
              <div class="form-group">
                <label>TTL (gi√¢y)</label>
                <input type="number" [(ngModel)]="newLeaseForm.ttlSeconds" min="60" />
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="newLeaseForm.renewable" />
                  Cho ph√©p gia h·∫°n (Renewable)
                </label>
              </div>
            </div>
            <div class="dialog-footer">
              <button class="btn btn-outline" (click)="showLeaseDialog.set(false)">H·ªßy</button>
              <button
                class="btn btn-primary"
                (click)="createLease()"
                [disabled]="loading() || !newLeaseForm.secretPath"
              >
                üíæ T·∫°o
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Dynamic ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'dynamic') {
    <div class="tab-panel">
      <div class="section-header">
        <div>
          <h3>‚ö° Dynamic Credentials</h3>
          <p class="text-muted">T·∫°o credentials t·∫°m th·ªùi cho database v√† services</p>
        </div>
        <button class="btn btn-sm btn-primary" (click)="showDynamicDialog.set(true)">
          ‚ûï Th√™m Config
        </button>
      </div>
      <div class="card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Lease ID</th>
                <th>Backend</th>
                <th>Username</th>
                <th>Host</th>
                <th>Database</th>
                <th>H·∫øt h·∫°n</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (cred of dynamicCredentials(); track cred.id) {
                <tr>
                  <td class="cell-bold">
                    <code>{{ cred.leaseId }}</code>
                  </td>
                  <td>
                    <span class="badge badge-info">{{ cred.backend }}</span>
                  </td>
                  <td>{{ cred.username }}</td>
                  <td>{{ cred.dbHost }}:{{ cred.dbPort }}</td>
                  <td>{{ cred.dbName }}</td>
                  <td>{{ formatDate(cred.expiresAt) }}</td>
                  <td>
                    <div class="action-cell">
                      @if (!cred.revoked) {
                        <button
                          class="btn btn-xs btn-danger"
                          (click)="deleteDynamicCredential(cred.id)"
                        >
                          üö´ Revoke
                        </button>
                      } @else {
                        <span class="badge badge-danger">Revoked</span>
                      }
                    </div>
                  </td>
                </tr>
              }
              @if (dynamicCredentials().length === 0) {
                <tr>
                  <td colspan="7" class="empty-state">‚ö° Ch∆∞a c√≥ dynamic credential n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Tokens ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'tokens') {
    <div class="tab-panel">
      <div class="section-header">
        <div>
          <h3>üéüÔ∏è Vault Tokens</h3>
          <p class="text-muted">Qu·∫£n l√Ω token truy c·∫≠p vault</p>
        </div>
        <button class="btn btn-sm btn-primary" (click)="showTokenDialog.set(true)">
          ‚ûï T·∫°o Token
        </button>
      </div>
      <div class="card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Display Name</th>
                <th>Accessor</th>
                <th>Type</th>
                <th>Policies</th>
                <th>Uses</th>
                <th>H·∫øt h·∫°n</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (token of tokens(); track token.id) {
                <tr>
                  <td class="cell-bold">{{ token.displayName || '‚Äî' }}</td>
                  <td>
                    <code>{{ token.accessor }}</code>
                  </td>
                  <td>
                    <span class="badge badge-outline">{{ token.tokenType }}</span>
                  </td>
                  <td>
                    @for (p of token.policies; track p) {
                      <span class="badge badge-outline">{{ p }}</span>
                    }
                  </td>
                  <td>{{ token.usesCount }}{{ token.numUses ? '/' + token.numUses : '' }}</td>
                  <td>{{ formatDate(token.expiresAt ?? null) }}</td>
                  <td>
                    <span
                      class="badge"
                      [class.badge-success]="token.isValid"
                      [class.badge-danger]="!token.isValid"
                    >
                      {{ token.isValid ? 'Valid' : token.revoked ? 'Revoked' : 'Expired' }}
                    </span>
                  </td>
                  <td>
                    <div class="action-cell">
                      @if (!token.revoked) {
                        <button class="btn btn-xs btn-danger" (click)="revokeToken(token.id)">
                          üö´ Thu h·ªìi
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
              @if (tokens().length === 0) {
                <tr>
                  <td colspan="8" class="empty-state">üéüÔ∏è Ch∆∞a c√≥ token n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Created Token Alert -->
      @if (createdToken()) {
        <div class="alert alert-success mt-8">
          <div class="alert-title">üéüÔ∏è Token ƒë√£ t·∫°o ‚Äî sao ch√©p ngay! (ch·ªâ hi·ªán m·ªôt l·∫ßn)</div>
          <div class="result-row">
            <span class="result-label">Token:</span>
            <code class="result-mono">{{ createdToken()!.token }}</code>
            <button class="btn btn-xs btn-outline" (click)="copyToClipboard(createdToken()!.token)">
              üìã Copy
            </button>
          </div>
          <div class="result-row">
            <span class="result-label">Accessor:</span>
            <code>{{ createdToken()!.accessor }}</code>
          </div>
          <button class="btn btn-xs btn-outline mt-8" (click)="createdToken.set(null)">‚úï ·∫®n</button>
        </div>
      }
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Settings ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'settings') {
    <div class="tab-panel">
      <!-- Azure Key Vault Config -->
      <div class="card">
        <div class="card-header">
          <h3>üî∑ Azure Key Vault Auto-Unseal</h3>
          <p class="text-muted">S·ª≠ d·ª•ng Azure Key Vault ƒë·ªÉ t·ª± ƒë·ªông m·ªü kh√≥a vault khi kh·ªüi ƒë·ªông</p>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Vault URL</label>
              <input
                type="text"
                [(ngModel)]="settingsForm.vaultUrl"
                placeholder="https://myvault.vault.azure.net/"
              />
            </div>
            <div class="form-group">
              <label>Key Name</label>
              <input
                type="text"
                [(ngModel)]="settingsForm.keyName"
                placeholder="vault-unseal-key"
              />
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Tenant ID</label>
              <input
                type="text"
                [(ngModel)]="settingsForm.tenantId"
                placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
              />
            </div>
            <div class="form-group">
              <label>Client ID (App Registration)</label>
              <input
                type="text"
                [(ngModel)]="settingsForm.clientId"
                placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Client Secret</label>
            <input
              type="password"
              [(ngModel)]="settingsForm.clientSecret"
              placeholder="Azure App Secret"
            />
          </div>
          <div class="form-actions form-actions-between">
            <button
              class="btn btn-outline"
              (click)="testConnection()"
              [disabled]="testingConnection()"
            >
              {{ testingConnection() ? '‚è≥ ƒêang test...' : 'üîå Test Connection' }}
            </button>
            <button class="btn btn-danger" (click)="saveSettings()" [disabled]="loading()">
              üíæ L∆∞u c·∫•u h√¨nh
            </button>
          </div>
          @if (connectionResult()) {
            <div
              class="alert mt-8"
              [class.alert-success]="connectionResult()!.connected"
              [class.alert-danger]="!connectionResult()!.connected"
            >
              {{ connectionResult()!.connected ? '‚úÖ' : '‚ùå' }} {{ connectionResult()!.message }}
            </div>
          }
        </div>
      </div>

      <!-- Instructions -->
      <div class="card">
        <div class="card-header"><h3>üìñ H∆∞·ªõng d·∫´n c·∫•u h√¨nh Azure Key Vault</h3></div>
        <div class="card-body instructions-list">
          <p><strong>1.</strong> T·∫°o Azure Key Vault trong Azure Portal</p>
          <p><strong>2.</strong> T·∫°o RSA key trong Key Vault (2048-bit ho·∫∑c 4096-bit)</p>
          <p><strong>3.</strong> T·∫°o App Registration trong Azure AD</p>
          <p><strong>4.</strong> C·∫•p quy·ªÅn cho App: Key Vault ‚Üí Access policies ‚Üí Add:</p>
          <p class="indent">‚Ä¢ <code>Wrap Key</code> v√† <code>Unwrap Key</code> permissions</p>
          <p><strong>5.</strong> ƒêi·ªÅn th√¥ng tin ·ªü tr√™n v√† l∆∞u</p>
        </div>
      </div>

      <!-- Enable Auto-Unseal -->
      <div class="card">
        <div class="card-header">
          <h3>üîê K√≠ch Ho·∫°t Auto-Unseal</h3>
          <p class="text-muted">
            Cho ph√©p vault t·ª± ƒë·ªông m·ªü kh√≥a b·∫±ng Azure Key Vault (cho vault ƒë√£ kh·ªüi t·∫°o)
          </p>
        </div>
        <div class="card-body">
          <div class="alert alert-warning">
            ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> B·∫°n c·∫ßn nh·∫≠p Master Password ƒë√£ s·ª≠ d·ª•ng ƒë·ªÉ kh·ªüi t·∫°o vault.
            Password s·∫Ω ƒë∆∞·ª£c m√£ h√≥a b·∫±ng Azure Key Vault v√† l∆∞u v√†o database ƒë·ªÉ auto-unseal.
          </div>
          <div class="form-group mt-8">
            <label>Master Password</label>
            <input
              type="password"
              [(ngModel)]="autoUnsealForm.masterPassword"
              placeholder="Nh·∫≠p Master Password ƒë√£ kh·ªüi t·∫°o vault..."
            />
          </div>
          <button
            class="btn btn-primary full-width"
            (click)="configureAutoUnseal()"
            [disabled]="loading() || autoUnsealForm.masterPassword.length < 8"
          >
            üîë K√≠ch Ho·∫°t Auto-Unseal
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: History ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'history') {
    <div class="tab-panel">
      <div class="card">
        <div class="card-header">
          <h3>üìú L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
          <div class="header-actions">
            <button class="btn btn-sm btn-outline" (click)="loadAuditLogs()">üîÑ L√†m m·ªõi</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Th·ªùi gian</th>
                <th>Action</th>
                <th>Resource</th>
                <th>User</th>
                <th>IP</th>
                <th>Chi ti·∫øt</th>
              </tr>
            </thead>
            <tbody>
              @for (log of auditLogs(); track log.id) {
                <tr>
                  <td>{{ formatDate(log.createdAt) }}</td>
                  <td>
                    <span class="badge badge-info">{{ log.action }}</span>
                  </td>
                  <td>{{ log.resourceType }}{{ log.resourceId ? '/' + log.resourceId : '' }}</td>
                  <td>{{ log.userId || '‚Äî' }}</td>
                  <td>
                    <code>{{ log.ipAddress || '‚Äî' }}</code>
                  </td>
                  <td>{{ log.details || '‚Äî' }}</td>
                </tr>
              }
              @if (auditLogs().length === 0) {
                <tr>
                  <td colspan="6" class="empty-state">üìú Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        @if (auditLogTotalCount() > 20) {
          <div class="form-actions">
            <button
              class="btn btn-sm btn-outline"
              [disabled]="auditLogPage() <= 1"
              (click)="auditLogPage.set(auditLogPage() - 1); loadAuditLogs()"
            >
              ‚óÄ Tr∆∞·ªõc
            </button>
            <span>Trang {{ auditLogPage() }} / {{ Math.ceil(auditLogTotalCount() / 20) }}</span>
            <button
              class="btn btn-sm btn-outline"
              (click)="auditLogPage.set(auditLogPage() + 1); loadAuditLogs()"
            >
              Sau ‚ñ∂
            </button>
          </div>
        }
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Import ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'import') {
    <div class="tab-panel">
      <div class="card">
        <div class="card-header">
          <h3>üì• Import Secrets</h3>
          <p class="text-muted">Import secrets t·ª´ file JSON ho·∫∑c .env</p>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Format</label>
              <select [ngModel]="importFormat()" (ngModelChange)="importFormat.set($event)">
                <option value="json">JSON</option>
                <option value="env">.env</option>
              </select>
            </div>
            <div class="form-group">
              <label>Prefix (t√πy ch·ªçn)</label>
              <input
                type="text"
                [ngModel]="importPrefix()"
                (ngModelChange)="importPrefix.set($event)"
                placeholder="e.g. production"
              />
            </div>
          </div>
          <div class="form-group">
            <label>File</label>
            <input type="file" (change)="handleImportFile($event)" accept=".json,.env,.txt" />
          </div>
          <div class="form-group">
            <label>Ho·∫∑c paste d·ªØ li·ªáu</label>
            <textarea
              [ngModel]="importData()"
              (ngModelChange)="importData.set($event)"
              rows="10"
              class="mono-textarea"
              [placeholder]="
                importFormat() === 'json'
                  ? '{&quot;KEY&quot;: &quot;value&quot;, ...}'
                  : 'KEY=value\nKEY2=value2'
              "
            ></textarea>
          </div>
          <div class="form-actions">
            <button
              class="btn btn-primary"
              (click)="executeImport()"
              [disabled]="loading() || !importData()"
            >
              üì• Import
            </button>
          </div>
          @if (importResult()) {
            <div
              class="alert mt-8"
              [class.alert-success]="importResult()!.failed === 0"
              [class.alert-danger]="importResult()!.failed > 0"
            >
              ‚úÖ {{ importResult()!.success }} th√†nh c√¥ng, ‚ùå {{ importResult()!.failed }} l·ªói
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Field Access (Ph√¢n quy·ªÅn) ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'field-access') {
    <div class="tab-panel">
      <div class="card">
        <div class="card-header">
          <h3>üîê Ph√¢n quy·ªÅn truy c·∫≠p d·ªØ li·ªáu</h3>
          <div class="header-actions">
            <button class="btn btn-sm btn-outline" (click)="loadFieldAccessPolicies()">
              üîÑ L√†m m·ªõi
            </button>
            <button class="btn btn-sm btn-primary" (click)="openAddFAPolicy()">
              ‚ûï Th√™m policy
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Sub-tabs: Policies / Audit Log -->
          <div class="sub-tabs">
            <button
              class="sub-tab"
              [class.sub-tab-active]="faActiveSubTab() === 'policies'"
              (click)="faActiveSubTab.set('policies')"
            >
              üìã Policies ({{ fieldAccessPolicies().length }})
            </button>
            <button
              class="sub-tab"
              [class.sub-tab-active]="faActiveSubTab() === 'audit'"
              (click)="faActiveSubTab.set('audit'); loadFAAuditLogs()"
            >
              üìú Audit Log
            </button>
          </div>

          @if (faActiveSubTab() === 'policies') {
            <!-- Policies grouped by table -->
            @for (table of faGroupKeys(); track table) {
              <div class="fa-group">
                <div class="fa-group-header" (click)="toggleFAGroup(table)">
                  <span class="fa-group-toggle">{{ faExpandedGroups()[table] ? '‚ñº' : '‚ñ∂' }}</span>
                  <span class="fa-group-name">{{ table }}</span>
                  <span class="badge badge-info"
                    >{{ faPoliciesGrouped()[table].length }} policies</span
                  >
                </div>
                @if (faExpandedGroups()[table]) {
                  <div class="fa-group-body">
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>Tr∆∞·ªùng</th>
                          <th>Vai tr√≤</th>
                          <th>M·ª©c truy c·∫≠p</th>
                          <th>Mask Pattern</th>
                          <th>Thao t√°c</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (p of faPoliciesGrouped()[table]; track p.id) {
                          <tr>
                            <td class="cell-bold">{{ p.fieldName }}</td>
                            <td>{{ p.role }}</td>
                            <td>
                              <span
                                class="badge"
                                [ngClass]="getAccessLevelBadgeClass(p.accessLevel)"
                              >
                                {{ getAccessLevelLabel(p.accessLevel) }}
                              </span>
                            </td>
                            <td>
                              <code>{{ p.accessLevel === 'masked' ? p.maskPattern : '‚Äî' }}</code>
                            </td>
                            <td>
                              <div class="action-cell">
                                <button
                                  class="btn btn-xs btn-primary"
                                  (click)="openEditFAPolicy(p)"
                                >
                                  ‚úèÔ∏è
                                </button>
                                <button class="btn btn-xs btn-danger" (click)="deleteFAPolicy(p)">
                                  üóëÔ∏è
                                </button>
                              </div>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                }
              </div>
            }
            @if (faGroupKeys().length === 0) {
              <div class="empty-state" style="padding: 2rem; text-align: center">
                üîê Ch∆∞a c√≥ policy n√†o. Nh·∫•n "Th√™m policy" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
              </div>
            }

            <!-- Important notes -->
            <div class="info-box mt-16">
              <h4>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng</h4>
              <ul class="text-muted" style="margin: 0.5rem 0; padding-left: 1.5rem">
                <li>
                  Vai tr√≤ <strong>admin</strong> lu√¥n c√≥ quy·ªÅn truy c·∫≠p ƒë·∫ßy ƒë·ªß v√†o t·∫•t c·∫£ d·ªØ li·ªáu
                </li>
                <li>Policies ƒë∆∞·ª£c √°p d·ª•ng theo nguy√™n t·∫Øc "√≠t quy·ªÅn nh·∫•t" (Least Privilege)</li>
                <li>Thay ƒë·ªïi policies s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n trong Audit Log</li>
              </ul>
            </div>
          }

          @if (faActiveSubTab() === 'audit') {
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Th·ªùi gian</th>
                    <th>H√†nh ƒë·ªông</th>
                    <th>Resource</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody>
                  @for (log of faAuditLogs(); track log.id) {
                    <tr>
                      <td>{{ formatDate(log.createdAt) }}</td>
                      <td>
                        <span class="badge badge-outline">{{ log.action }}</span>
                      </td>
                      <td>{{ log.resourceId || '‚Äî' }}</td>
                      <td>{{ log.ipAddress || '‚Äî' }}</td>
                    </tr>
                  }
                  @if (faAuditLogs().length === 0) {
                    <tr>
                      <td colspan="4" class="empty-state">üìú Ch∆∞a c√≥ audit log n√†o</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Encryption (Auto-Encryption Config) ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'encryption') {
    <div class="tab-panel">
      <!-- Header -->
      <div class="card">
        <div class="card-header">
          <h3>üîí C·∫•u H√¨nh Auto-Encryption</h3>
          <div class="header-actions">
            <button class="btn btn-sm btn-outline" (click)="loadEncryptionConfigs()">
              üîÑ L√†m m·ªõi
            </button>
            <button class="btn btn-sm btn-primary" (click)="openAddEncConfig()">
              ‚ûï Th√™m b·∫£ng
            </button>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>B·∫£ng</th>
                <th>Tr∆∞·ªùng m√£ h√≥a</th>
                <th>DEK Purpose</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (c of encryptionConfigs(); track c.id) {
                <tr>
                  <td>
                    <div class="cell-bold">{{ c.tableName }}</div>
                    @if (c.isDefault) {
                      <span class="badge badge-info" style="font-size: 0.7rem">M·∫∑c ƒë·ªãnh</span>
                    }
                  </td>
                  <td>
                    <div class="field-badges">
                      @for (f of c.encryptedFields.slice(0, 3); track f) {
                        <span class="badge badge-outline">{{ f }}</span>
                      }
                      @if (c.encryptedFields.length > 3) {
                        <span class="badge badge-outline">+{{ c.encryptedFields.length - 3 }}</span>
                      }
                    </div>
                  </td>
                  <td>
                    <span
                      class="badge"
                      [class.badge-primary]="c.dekPurpose === 'data'"
                      [class.badge-warning]="c.dekPurpose === 'session'"
                      [class.badge-info]="c.dekPurpose === 'api'"
                      [class.badge-secondary]="c.dekPurpose === 'backup'"
                    >
                      {{ getDekPurposeLabel(c.dekPurpose) }}
                    </span>
                  </td>
                  <td>
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        [checked]="c.isEnabled"
                        (change)="toggleEncConfig(c)"
                      />
                      <span class="toggle-slider"></span>
                    </label>
                  </td>
                  <td>
                    <div class="action-cell">
                      <button class="btn btn-xs btn-primary" (click)="openEditEncConfig(c)">
                        ‚úèÔ∏è
                      </button>
                      @if (!c.isDefault) {
                        <button class="btn btn-xs btn-danger" (click)="deleteEncConfig(c)">
                          üóëÔ∏è
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
              @if (encryptionConfigs().length === 0) {
                <tr>
                  <td colspan="5" class="empty-state">üîí Ch∆∞a c√≥ c·∫•u h√¨nh encryption n√†o</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Hybrid Auto-Encryption Info -->
      <div class="card mt-16">
        <div class="card-body">
          <div class="info-box">
            <h4>üîê Hybrid Auto-Encryption</h4>
            <p class="text-muted">
              H·ªá th·ªëng s·ª≠ d·ª•ng m√£ h√≥a k·∫øt h·ª£p (Hybrid Encryption) ƒë·ªÉ b·∫£o v·ªá d·ªØ li·ªáu PHI: M·ªói b·∫£ng d·ªØ
              li·ªáu nh·∫°y c·∫£m s·∫Ω ƒë∆∞·ª£c c·∫•u h√¨nh v·ªõi m·ªôt Data Encryption Key (DEK) ri√™ng, ƒë∆∞·ª£c b·∫£o v·ªá
              b·ªüi Key Encryption Key (KEK) th√¥ng qua Azure Key Vault RSA-OAEP-256. Khi d·ªØ li·ªáu ƒë∆∞·ª£c
              ghi v√†o database, c√°c tr∆∞·ªùng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c m√£ h√≥a b·∫±ng AES-256-GCM
              tr∆∞·ªõc khi l∆∞u tr·ªØ.
            </p>
          </div>
        </div>
      </div>

      <!-- Auto-Unseal Configuration (collapsed) -->
      <div class="card mt-16">
        <div class="card-header"><h3>üîì Auto-Unseal (Azure Key Vault RSA-OAEP-256)</h3></div>
        <div class="card-body">
          @if (autoUnsealStatus(); as aus) {
            <div class="auto-unseal-status">
              <div
                class="status-badge"
                [class.status-configured]="aus.isConfigured"
                [class.status-not-configured]="!aus.isConfigured"
              >
                {{ aus.isConfigured ? '‚úÖ ƒê√£ c·∫•u h√¨nh' : '‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh' }}
              </div>
              @if (aus.isConfigured) {
                <div class="status-details">
                  <div class="result-row">
                    <span class="result-label">Key Vault URL:</span>
                    <code>{{ aus.keyVaultUrl || '‚Äî' }}</code>
                  </div>
                  <div class="result-row">
                    <span class="result-label">Key Name:</span>
                    <code>{{ aus.keyName || '‚Äî' }}</code>
                  </div>
                  <div class="result-row">
                    <span class="result-label">Algorithm:</span>
                    <code>{{ aus.algorithm || '‚Äî' }}</code>
                  </div>
                </div>
                <button
                  class="btn btn-primary mt-8"
                  (click)="triggerAutoUnseal()"
                  [disabled]="loading()"
                >
                  üîì Auto-Unseal Now
                </button>
              }
            </div>
          }
          <div class="auto-unseal-config mt-16">
            <h4>‚öôÔ∏è C·∫•u h√¨nh Auto-Unseal</h4>
            <div class="form-group">
              <label>Master Password</label>
              <input
                type="password"
                [(ngModel)]="autoUnsealForm.masterPassword"
                placeholder="Master password (t·ªëi thi·ªÉu 12 k√Ω t·ª±)"
              />
            </div>
            <div class="form-group">
              <label>Azure Key Name</label>
              <input
                type="text"
                [(ngModel)]="autoUnsealForm.azureKeyName"
                placeholder="ivf-master-key"
              />
            </div>
            <button
              class="btn btn-primary"
              (click)="configureAutoUnseal()"
              [disabled]="loading() || autoUnsealForm.masterPassword.length < 12"
            >
              üíæ C·∫•u h√¨nh Auto-Unseal
            </button>
          </div>
        </div>
      </div>

      <!-- DEK Status Cards -->
      <div class="card">
        <div class="card-header"><h3>üîí Encryption Keys (DEKs)</h3></div>
        <div class="card-body">
          <div class="encryption-grid">
            <div class="enc-card">
              <div class="enc-icon">üîë</div>
              <div class="enc-name">Data DEK</div>
              <div class="enc-desc">M√£ h√≥a d·ªØ li·ªáu b·ªánh nh√¢n</div>
            </div>
            <div class="enc-card">
              <div class="enc-icon">üîê</div>
              <div class="enc-name">Session DEK</div>
              <div class="enc-desc">M√£ h√≥a phi√™n ƒëƒÉng nh·∫≠p</div>
            </div>
            <div class="enc-card">
              <div class="enc-icon">üóùÔ∏è</div>
              <div class="enc-name">API DEK</div>
              <div class="enc-desc">M√£ h√≥a API keys</div>
            </div>
            <div class="enc-card">
              <div class="enc-icon">üíæ</div>
              <div class="enc-name">Backup DEK</div>
              <div class="enc-desc">M√£ h√≥a b·∫£n sao l∆∞u</div>
            </div>
            <div class="enc-card">
              <div class="enc-icon">üßÇ</div>
              <div class="enc-name">Master Salt</div>
              <div class="enc-desc">Salt cho PBKDF2 key derivation</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Key Wrap / Unwrap -->
      <div class="card mt-16">
        <div class="card-header"><h3>üì¶ Key Wrap / Unwrap (Envelope Encryption)</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <!-- Wrap -->
            <div class="crypto-panel">
              <h4>üîí Wrap Key</h4>
              <p class="text-muted">
                M√£ h√≥a (wrap) m·ªôt key b·∫±ng KEK qua AES-256-GCM ho·∫∑c Azure RSA-OAEP-256
              </p>
              <div class="form-group">
                <label>Key Name</label>
                <input type="text" [(ngModel)]="wrapForm.keyName" placeholder="ivf-master-key" />
              </div>
              <div class="form-group">
                <label>Plaintext (d·ªØ li·ªáu c·∫ßn wrap)</label>
                <textarea
                  [(ngModel)]="wrapForm.plaintext"
                  placeholder="Nh·∫≠p plaintext..."
                  rows="3"
                ></textarea>
              </div>
              <button
                class="btn btn-primary"
                (click)="wrapKey()"
                [disabled]="loading() || !wrapForm.plaintext"
              >
                üîí Wrap Key
              </button>
              @if (wrapResult()) {
                <div class="result-box mt-8">
                  <div class="result-row">
                    <span class="result-label">Algorithm:</span>
                    <code>{{ wrapResult()!.algorithm }}</code>
                  </div>
                  <div class="result-row">
                    <span class="result-label">Wrapped Key:</span>
                    <code class="result-mono">{{ wrapResult()!.wrappedKeyBase64 }}</code>
                    <button
                      class="btn btn-xs btn-outline"
                      (click)="copyToClipboard(wrapResult()!.wrappedKeyBase64)"
                    >
                      üìã
                    </button>
                  </div>
                  <div class="result-row">
                    <span class="result-label">IV:</span>
                    <code class="result-mono">{{ wrapResult()!.ivBase64 || '‚Äî' }}</code>
                  </div>
                  <button class="btn btn-sm btn-outline mt-8" (click)="useWrapResultForUnwrap()">
                    ‚û°Ô∏è D√πng cho Unwrap
                  </button>
                </div>
              }
            </div>

            <!-- Unwrap -->
            <div class="crypto-panel">
              <h4>üîì Unwrap Key</h4>
              <p class="text-muted">Gi·∫£i m√£ (unwrap) m·ªôt wrapped key v·ªÅ plaintext</p>
              <div class="form-group">
                <label>Key Name</label>
                <input type="text" [(ngModel)]="unwrapForm.keyName" placeholder="ivf-master-key" />
              </div>
              <div class="form-group">
                <label>Wrapped Key (Base64)</label>
                <textarea
                  [(ngModel)]="unwrapForm.wrappedKeyBase64"
                  placeholder="Wrapped key base64..."
                  rows="3"
                ></textarea>
              </div>
              <div class="form-group">
                <label>IV (Base64)</label>
                <input
                  type="text"
                  [(ngModel)]="unwrapForm.ivBase64"
                  placeholder="IV base64 (n·∫øu AES-GCM)"
                />
              </div>
              <button
                class="btn btn-primary"
                (click)="unwrapKey()"
                [disabled]="loading() || !unwrapForm.wrappedKeyBase64"
              >
                üîì Unwrap Key
              </button>
              @if (unwrapResult() !== null) {
                <div class="result-box mt-8">
                  <div class="result-row">
                    <span class="result-label">Plaintext:</span>
                    <code class="result-mono">{{ unwrapResult() }}</code>
                    <button
                      class="btn btn-xs btn-outline"
                      (click)="copyToClipboard(unwrapResult()!)"
                    >
                      üìã
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Encrypt / Decrypt Data -->
      <div class="card mt-16">
        <div class="card-header"><h3>üîê Encrypt / Decrypt Data (AES-256-GCM)</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <!-- Encrypt -->
            <div class="crypto-panel">
              <h4>üîí Encrypt</h4>
              <p class="text-muted">M√£ h√≥a d·ªØ li·ªáu b·∫±ng DEK theo m·ª•c ƒë√≠ch s·ª≠ d·ª•ng</p>
              <div class="form-group">
                <label>Key Purpose</label>
                <select [(ngModel)]="encryptForm.purpose">
                  @for (p of keyPurposes; track p) {
                    <option [value]="p">{{ p }}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label>Plaintext</label>
                <textarea
                  [(ngModel)]="encryptForm.plaintext"
                  placeholder="Nh·∫≠p d·ªØ li·ªáu c·∫ßn m√£ h√≥a..."
                  rows="3"
                ></textarea>
              </div>
              <button
                class="btn btn-primary"
                (click)="encryptData()"
                [disabled]="loading() || !encryptForm.plaintext"
              >
                üîí Encrypt
              </button>
              @if (encryptResult()) {
                <div class="result-box mt-8">
                  <div class="result-row">
                    <span class="result-label">Algorithm:</span>
                    <code>{{ encryptResult()!.algorithm }}</code>
                  </div>
                  <div class="result-row">
                    <span class="result-label">Purpose:</span>
                    <code>{{ encryptResult()!.purpose }}</code>
                  </div>
                  <div class="result-row">
                    <span class="result-label">Ciphertext:</span>
                    <code class="result-mono">{{ encryptResult()!.ciphertextBase64 }}</code>
                    <button
                      class="btn btn-xs btn-outline"
                      (click)="copyToClipboard(encryptResult()!.ciphertextBase64)"
                    >
                      üìã
                    </button>
                  </div>
                  <div class="result-row">
                    <span class="result-label">IV:</span>
                    <code class="result-mono">{{ encryptResult()!.ivBase64 }}</code>
                  </div>
                  <button
                    class="btn btn-sm btn-outline mt-8"
                    (click)="useEncryptResultForDecrypt()"
                  >
                    ‚û°Ô∏è D√πng cho Decrypt
                  </button>
                </div>
              }
            </div>

            <!-- Decrypt -->
            <div class="crypto-panel">
              <h4>üîì Decrypt</h4>
              <p class="text-muted">Gi·∫£i m√£ d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c m√£ h√≥a b·∫±ng DEK</p>
              <div class="form-group">
                <label>Key Purpose</label>
                <select [(ngModel)]="decryptForm.purpose">
                  @for (p of keyPurposes; track p) {
                    <option [value]="p">{{ p }}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label>Ciphertext (Base64)</label>
                <textarea
                  [(ngModel)]="decryptForm.ciphertextBase64"
                  placeholder="Ciphertext base64..."
                  rows="3"
                ></textarea>
              </div>
              <div class="form-group">
                <label>IV (Base64)</label>
                <input type="text" [(ngModel)]="decryptForm.ivBase64" placeholder="IV base64" />
              </div>
              <button
                class="btn btn-primary"
                (click)="decryptData()"
                [disabled]="loading() || !decryptForm.ciphertextBase64"
              >
                üîì Decrypt
              </button>
              @if (decryptResult() !== null) {
                <div class="result-box mt-8">
                  <div class="result-row">
                    <span class="result-label">Plaintext:</span>
                    <code class="result-mono">{{ decryptResult() }}</code>
                    <button
                      class="btn btn-xs btn-outline"
                      (click)="copyToClipboard(decryptResult()!)"
                    >
                      üìã
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Key Hierarchy Diagram -->
      <div class="card mt-16">
        <div class="card-header"><h3>üèóÔ∏è Key Hierarchy</h3></div>
        <div class="card-body">
          <div class="key-hierarchy">
            <div class="hierarchy-level hierarchy-level-1">
              <div class="hierarchy-node node-azure">
                <span class="node-icon">‚òÅÔ∏è</span>
                <span class="node-label">Azure RSA Key (RSA-OAEP-256)</span>
              </div>
            </div>
            <div class="hierarchy-arrow">‚ñº</div>
            <div class="hierarchy-level hierarchy-level-2">
              <div class="hierarchy-node node-kek">
                <span class="node-icon">üîë</span>
                <span class="node-label">Master Password ‚Üí PBKDF2 ‚Üí KEK (AES-256)</span>
              </div>
            </div>
            <div class="hierarchy-arrow">‚ñº</div>
            <div class="hierarchy-level hierarchy-level-3">
              <div class="hierarchy-node node-dek">
                <span class="node-icon">üîê</span>
                <span class="node-label">DEK Data</span>
              </div>
              <div class="hierarchy-node node-dek">
                <span class="node-icon">üîê</span>
                <span class="node-label">DEK Session</span>
              </div>
              <div class="hierarchy-node node-dek">
                <span class="node-icon">üîê</span>
                <span class="node-label">DEK API</span>
              </div>
              <div class="hierarchy-node node-dek">
                <span class="node-icon">üîê</span>
                <span class="node-label">DEK Backup</span>
              </div>
            </div>
            <div class="hierarchy-arrow">‚ñº</div>
            <div class="hierarchy-level hierarchy-level-4">
              <div class="hierarchy-node node-data">
                <span class="node-icon">üìÑ</span>
                <span class="node-label">Encrypted Data (AES-256-GCM)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: New Secret ‚ïê‚ïê‚ïê -->
  @if (showNewSecretDialog()) {
    <div class="modal-overlay" (click)="showNewSecretDialog.set(false)">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚ûï T·∫°o Secret m·ªõi</h3>
          <button class="btn-close" (click)="showNewSecretDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <!-- Templates -->
          <div class="templates-section">
            <h4>üìã Templates</h4>
            <div class="template-grid">
              @for (t of secretTemplates; track t.label) {
                <button class="template-card" (click)="applyTemplate(t)">
                  <span class="template-icon">{{ t.icon }}</span>
                  <span class="template-label">{{ t.label }}</span>
                </button>
              }
            </div>
          </div>

          <div class="form-group">
            <label>Secret Path</label>
            <input
              type="text"
              [(ngModel)]="newSecretForm.path"
              placeholder="e.g. database/connection-string"
            />
          </div>
          <div class="form-group">
            <label>Secret Data (JSON)</label>
            <textarea [(ngModel)]="newSecretForm.data" rows="8" class="mono-textarea"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showNewSecretDialog.set(false)">H·ªßy</button>
          <button class="btn btn-primary" (click)="createSecret()" [disabled]="loading()">
            üíæ L∆∞u Secret
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: Secret Detail ‚ïê‚ïê‚ïê -->
  @if (showSecretDetailDialog() && selectedSecret()) {
    <div class="modal-overlay" (click)="showSecretDetailDialog.set(false)">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üîë {{ selectedSecret()!.name }}</h3>
          <button class="btn-close" (click)="showSecretDetailDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="secret-meta">
            <span class="text-muted">L·∫•y l√∫c: {{ formatDate(selectedSecret()!.retrievedAt) }}</span>
          </div>
          <div class="secret-fields">
            @for (field of getSecretFields(); track field.key) {
              <div class="secret-field-row">
                <span class="field-key">{{ field.key }}</span>
                <div class="field-value-wrap">
                  @if (showSecretData()[field.key]) {
                    <code class="field-value">{{ field.value }}</code>
                  } @else {
                    <code class="field-value field-masked">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
                  }
                  <button class="btn btn-xs btn-outline" (click)="toggleSecretField(field.key)">
                    {{ showSecretData()[field.key] ? 'üôà' : 'üëÅ' }}
                  </button>
                  <button class="btn btn-xs btn-outline" (click)="copyToClipboard(field.value)">
                    üìã
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showSecretDetailDialog.set(false)">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: Rotate Key ‚ïê‚ïê‚ïê -->
  @if (rotatingKey()) {
    <div class="modal-overlay" (click)="rotatingKey.set(null)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üîÑ Xoay Key: {{ rotatingKey()!.keyName }}</h3>
          <button class="btn-close" (click)="rotatingKey.set(null)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>New Key Hash</label>
            <input
              type="text"
              [(ngModel)]="rotateForm.newKeyHash"
              placeholder="Nh·∫≠p key hash m·ªõi"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="rotatingKey.set(null)">H·ªßy</button>
          <button class="btn btn-primary" (click)="rotateKey()" [disabled]="loading()">
            Xoay Key
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: New Database ‚ïê‚ïê‚ïê -->
  @if (showDbDialog()) {
    <div class="modal-overlay" (click)="showDbDialog.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üóÑÔ∏è Th√™m Database Credentials</h3>
          <button class="btn-close" (click)="showDbDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>T√™n (ID)</label>
            <input type="text" [(ngModel)]="newDbForm.name" placeholder="postgres-main" />
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Host</label>
              <input type="text" [(ngModel)]="newDbForm.host" placeholder="localhost" />
            </div>
            <div class="form-group">
              <label>Port</label>
              <input type="number" [(ngModel)]="newDbForm.port" />
            </div>
          </div>
          <div class="form-group">
            <label>Database</label>
            <input type="text" [(ngModel)]="newDbForm.database" placeholder="ivf_db" />
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Username</label>
              <input type="text" [(ngModel)]="newDbForm.username" placeholder="admin" />
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" [(ngModel)]="newDbForm.password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showDbDialog.set(false)">H·ªßy</button>
          <button
            class="btn btn-primary"
            (click)="createDatabaseSecret()"
            [disabled]="loading() || !newDbForm.name"
          >
            üíæ L∆∞u Credentials
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: New Policy ‚ïê‚ïê‚ïê -->
  @if (showPolicyDialog()) {
    <div class="modal-overlay" (click)="showPolicyDialog.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üìã T·∫°o Vault Policy</h3>
          <button class="btn-close" (click)="showPolicyDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>T√™n Policy</label>
            <input type="text" [(ngModel)]="newPolicyForm.name" placeholder="read-only-secrets" />
          </div>
          <div class="form-group">
            <label>M√¥ t·∫£</label>
            <input
              type="text"
              [(ngModel)]="newPolicyForm.description"
              placeholder="M√¥ t·∫£ policy..."
            />
          </div>
          <div class="form-group">
            <label>Path Pattern</label>
            <input type="text" [(ngModel)]="newPolicyForm.pathPattern" placeholder="secret/*" />
          </div>
          <div class="form-group">
            <label>Capabilities</label>
            <div class="toggle-grid">
              @for (cap of allCapabilities; track cap) {
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    [checked]="newPolicyForm.capabilities.includes(cap)"
                    (change)="toggleCapability(cap)"
                  />
                  <span>{{ cap }}</span>
                </label>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showPolicyDialog.set(false)">H·ªßy</button>
          <button
            class="btn btn-primary"
            (click)="createPolicy()"
            [disabled]="loading() || !newPolicyForm.name"
          >
            üíæ T·∫°o Policy
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: Assign User Policy ‚ïê‚ïê‚ïê -->
  @if (showUserPolicyDialog()) {
    <div class="modal-overlay" (click)="showUserPolicyDialog.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üë§ G√°n Policy cho User</h3>
          <button class="btn-close" (click)="showUserPolicyDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>User ID</label>
            <input type="text" [(ngModel)]="newUserPolicyForm.userId" placeholder="user-id..." />
          </div>
          <div class="form-group">
            <label>Policy</label>
            <select [(ngModel)]="newUserPolicyForm.policyId">
              <option value="">-- Ch·ªçn Policy --</option>
              @for (p of policies(); track p.id) {
                <option [value]="p.id">{{ p.name }}</option>
              }
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showUserPolicyDialog.set(false)">H·ªßy</button>
          <button
            class="btn btn-primary"
            (click)="assignUserPolicy()"
            [disabled]="loading() || !newUserPolicyForm.userId || !newUserPolicyForm.policyId"
          >
            üíæ G√°n Policy
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: New Dynamic Credential ‚ïê‚ïê‚ïê -->
  @if (showDynamicDialog()) {
    <div class="modal-overlay" (click)="showDynamicDialog.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚ö° T·∫°o Dynamic Credential</h3>
          <button class="btn-close" (click)="showDynamicDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Backend</label>
              <select [(ngModel)]="newDynamicForm.backend">
                <option value="postgres">PostgreSQL</option>
                <option value="mysql">MySQL</option>
                <option value="mssql">MS SQL</option>
                <option value="redis">Redis</option>
              </select>
            </div>
            <div class="form-group">
              <label>TTL (gi√¢y)</label>
              <input type="number" [(ngModel)]="newDynamicForm.ttlSeconds" />
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>DB Host</label>
              <input type="text" [(ngModel)]="newDynamicForm.dbHost" placeholder="localhost" />
            </div>
            <div class="form-group">
              <label>DB Port</label>
              <input type="number" [(ngModel)]="newDynamicForm.dbPort" />
            </div>
          </div>
          <div class="form-group">
            <label>Database Name</label>
            <input type="text" [(ngModel)]="newDynamicForm.dbName" placeholder="mydb" />
          </div>
          <div class="form-group">
            <label>Username (s·∫Ω t·∫°o)</label>
            <input
              type="text"
              [(ngModel)]="newDynamicForm.username"
              placeholder="dynamic-user-001"
            />
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Admin Username</label>
              <input
                type="text"
                [(ngModel)]="newDynamicForm.adminUsername"
                placeholder="postgres"
              />
            </div>
            <div class="form-group">
              <label>Admin Password</label>
              <input
                type="password"
                [(ngModel)]="newDynamicForm.adminPassword"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showDynamicDialog.set(false)">H·ªßy</button>
          <button
            class="btn btn-primary"
            (click)="createDynamicCredential()"
            [disabled]="loading() || !newDynamicForm.username"
          >
            üíæ T·∫°o Credential
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: New Token ‚ïê‚ïê‚ïê -->
  @if (showTokenDialog()) {
    <div class="modal-overlay" (click)="showTokenDialog.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üéüÔ∏è T·∫°o Vault Token</h3>
          <button class="btn-close" (click)="showTokenDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" [(ngModel)]="newTokenForm.displayName" placeholder="ci-cd-token" />
          </div>
          <div class="form-group">
            <label>Policies (ph√¢n c√°ch b·ªüi d·∫•u ph·∫©y)</label>
            <input
              type="text"
              [(ngModel)]="newTokenForm.policies"
              placeholder="read-only-secrets, deploy-policy"
            />
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Token Type</label>
              <select [(ngModel)]="newTokenForm.tokenType">
                <option value="service">Service</option>
                <option value="batch">Batch</option>
              </select>
            </div>
            <div class="form-group">
              <label>TTL (gi√¢y)</label>
              <input type="number" [(ngModel)]="newTokenForm.ttl" />
            </div>
          </div>
          <div class="form-group">
            <label>Max Uses (0 = kh√¥ng gi·ªõi h·∫°n)</label>
            <input type="number" [(ngModel)]="newTokenForm.numUses" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showTokenDialog.set(false)">H·ªßy</button>
          <button class="btn btn-primary" (click)="createToken()" [disabled]="loading()">
            üíæ T·∫°o Token
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: Encryption Config ‚ïê‚ïê‚ïê -->
  @if (showEncConfigDialog()) {
    <div class="modal-overlay" (click)="showEncConfigDialog.set(false)">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editingEncConfig() ? '‚úèÔ∏è S·ª≠a c·∫•u h√¨nh' : '‚ûï Th√™m b·∫£ng m√£ h√≥a' }}</h3>
          <button class="btn-close" (click)="showEncConfigDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>T√™n b·∫£ng</label>
            @if (editingEncConfig()) {
              <input type="text" [value]="newEncConfigForm.tableName" disabled />
            } @else {
              <select [(ngModel)]="newEncConfigForm.tableName" (ngModelChange)="onEncTableChange()">
                <option value="">-- Ch·ªçn b·∫£ng --</option>
                @for (t of dbTableNames(); track t) {
                  <option [value]="t">{{ t }}</option>
                }
              </select>
            }
          </div>
          @if (availableFields.length > 0) {
            <div class="form-group">
              <label>Tr∆∞·ªùng c·∫ßn m√£ h√≥a</label>
              <div class="checkbox-grid">
                @for (f of availableFields; track f) {
                  <label class="checkbox-item">
                    <input
                      type="checkbox"
                      [checked]="newEncConfigForm.encryptedFields.includes(f)"
                      (change)="toggleEncField(f)"
                    />
                    <span>{{ f }}</span>
                  </label>
                }
              </div>
            </div>
          }
          <div class="form-group">
            <label>DEK Purpose</label>
            <select [(ngModel)]="newEncConfigForm.dekPurpose">
              @for (p of dekPurposeOptions; track p) {
                <option [value]="p">{{ getDekPurposeLabel(p) }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>M√¥ t·∫£</label>
            <input
              type="text"
              [(ngModel)]="newEncConfigForm.description"
              placeholder="M√¥ t·∫£ (t√πy ch·ªçn)"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showEncConfigDialog.set(false)">H·ªßy</button>
          <button
            class="btn btn-primary"
            (click)="saveEncryptionConfig()"
            [disabled]="
              loading() ||
              !newEncConfigForm.tableName ||
              newEncConfigForm.encryptedFields.length === 0
            "
          >
            üíæ L∆∞u
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: Field Access Policy ‚ïê‚ïê‚ïê -->
  @if (showFAPolicyDialog()) {
    <div class="modal-overlay" (click)="showFAPolicyDialog.set(false)">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editingFAPolicy() ? '‚úèÔ∏è S·ª≠a policy' : '‚ûï Th√™m policy m·ªõi' }}</h3>
          <button class="btn-close" (click)="showFAPolicyDialog.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-group">
              <label>T√™n b·∫£ng</label>
              @if (editingFAPolicy()) {
                <input type="text" [value]="newFAPolicyForm.tableName" disabled />
              } @else {
                <select [(ngModel)]="newFAPolicyForm.tableName" (ngModelChange)="onFATableChange()">
                  <option value="">-- Ch·ªçn b·∫£ng --</option>
                  @for (t of dbTableNames(); track t) {
                    <option [value]="t">{{ t }}</option>
                  }
                </select>
              }
            </div>
            <div class="form-group">
              <label>Tr∆∞·ªùng √°p d·ª•ng</label>
              @if (editingFAPolicy()) {
                <input type="text" [value]="newFAPolicyForm.fieldNames.join(', ')" disabled />
              } @else if (faAvailableFields.length > 0) {
                <div class="checkbox-grid">
                  @for (f of faAvailableFields; track f) {
                    <label class="checkbox-item">
                      <input
                        type="checkbox"
                        [checked]="newFAPolicyForm.fieldNames.includes(f)"
                        (change)="toggleFAField(f)"
                      />
                      <span>{{ f }}</span>
                    </label>
                  }
                </div>
              } @else {
                <p class="text-muted">Ch·ªçn b·∫£ng tr∆∞·ªõc ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch tr∆∞·ªùng</p>
              }
            </div>
            <div class="form-group">
              <label>Vai tr√≤</label>
              @if (editingFAPolicy()) {
                <input type="text" [value]="newFAPolicyForm.role" disabled />
              } @else {
                <select [(ngModel)]="newFAPolicyForm.role">
                  <option value="">-- Ch·ªçn vai tr√≤ --</option>
                  @for (r of faRoles(); track r) {
                    <option [value]="r">{{ r }}</option>
                  }
                </select>
              }
            </div>
            <div class="form-group">
              <label>M·ª©c truy c·∫≠p</label>
              <select [(ngModel)]="newFAPolicyForm.accessLevel">
                @for (l of faAccessLevels; track l) {
                  <option [value]="l">{{ getAccessLevelLabel(l) }}</option>
                }
              </select>
            </div>
          </div>
          @if (newFAPolicyForm.accessLevel === 'masked') {
            <div class="form-group">
              <label>Mask Pattern</label>
              <input type="text" [(ngModel)]="newFAPolicyForm.maskPattern" placeholder="********" />
            </div>
          }
          @if (newFAPolicyForm.accessLevel === 'partial') {
            <div class="form-group">
              <label>Partial Length (k√Ω t·ª± hi·ªÉn th·ªã)</label>
              <input type="number" [(ngModel)]="newFAPolicyForm.partialLength" min="1" max="50" />
            </div>
          }
          <div class="form-group">
            <label>M√¥ t·∫£</label>
            <input
              type="text"
              [(ngModel)]="newFAPolicyForm.description"
              placeholder="M√¥ t·∫£ (t√πy ch·ªçn)"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showFAPolicyDialog.set(false)">H·ªßy</button>
          <button
            class="btn btn-primary"
            (click)="saveFAPolicy()"
            [disabled]="
              loading() ||
              (!editingFAPolicy() &&
                (!newFAPolicyForm.tableName ||
                  newFAPolicyForm.fieldNames.length === 0 ||
                  !newFAPolicyForm.role))
            "
          >
            üíæ L∆∞u
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Secret Rotation ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'secret-rotation') {
    <app-secret-rotation-tab />
  }

  <!-- ‚ïê‚ïê‚ïê TAB: DEK Rotation ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'dek-rotation') {
    <app-dek-rotation-tab />
  }

  <!-- ‚ïê‚ïê‚ïê TAB: DB Credential Rotation ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'db-rotation') {
    <app-db-credential-rotation-tab />
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Compliance ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'compliance') {
    <app-compliance-tab />
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Vault DR & Backup ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'vault-dr') {
    <app-vault-dr-tab />
  }

  <!-- ‚ïê‚ïê‚ïê TAB: SIEM Events ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'siem') {
    <app-siem-tab />
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Multi-Provider Unseal ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'multi-unseal') {
    <app-multi-unseal-tab />
  }

  <!-- ‚ïê‚ïê‚ïê TAB: Vault Metrics ‚ïê‚ïê‚ïê -->
  @if (activeTab() === 'vault-metrics') {
    <app-vault-metrics-tab />
  }

  <!-- ‚ïê‚ïê‚ïê DIALOG: Edit ZT Policy ‚ïê‚ïê‚ïê -->
  @if (editingZTPolicy()) {
    <div class="modal-overlay" (click)="editingZTPolicy.set(false)">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úèÔ∏è Ch·ªânh s·ª≠a Policy: {{ editForm.action }}</h3>
          <button class="btn-close" (click)="editingZTPolicy.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Required Auth Level</label>
              <select [(ngModel)]="editForm.requiredAuthLevel">
                <option value="None">None</option>
                <option value="Session">Session</option>
                <option value="Password">Password</option>
                <option value="MFA">MFA</option>
                <option value="FreshSession">Fresh Session</option>
                <option value="Biometric">Biometric</option>
              </select>
            </div>
            <div class="form-group">
              <label>Max Allowed Risk</label>
              <select [(ngModel)]="editForm.maxAllowedRisk">
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
          </div>
          <div class="toggle-grid">
            <label class="toggle-item">
              <input type="checkbox" [(ngModel)]="editForm.requireTrustedDevice" />
              <span>Require Trusted Device</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" [(ngModel)]="editForm.requireFreshSession" />
              <span>Require Fresh Session</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" [(ngModel)]="editForm.blockAnomaly" />
              <span>Block Anomaly</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" [(ngModel)]="editForm.requireGeoFence" />
              <span>Require Geo Fence</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" [(ngModel)]="editForm.blockVpnTor" />
              <span>Block VPN/Tor</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" [(ngModel)]="editForm.allowBreakGlassOverride" />
              <span>Allow Break Glass Override</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="editingZTPolicy.set(false)">H·ªßy</button>
          <button class="btn btn-primary" (click)="savePolicy()" [disabled]="loading()">
            üíæ L∆∞u
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê Toast ‚ïê‚ïê‚ïê -->
  @if (statusMessage()) {
    <div
      class="toast"
      [class.toast-success]="statusMessage()!.type === 'success'"
      [class.toast-error]="statusMessage()!.type === 'error'"
    >
      {{ statusMessage()!.text }}
    </div>
  }
</div>
