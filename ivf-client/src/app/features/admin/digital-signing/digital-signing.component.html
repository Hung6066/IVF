<div class="dashboard-layout">
  <header class="page-header">
    <div class="header-title">
      <h1>üîè Qu·∫£n l√Ω K√Ω s·ªë</h1>
      <p class="subtitle">EJBCA Certificate Authority & SignServer Document Signing</p>
    </div>
    <div class="header-actions">
      <button
        class="btn-secondary"
        [class.active]="autoRefreshEnabled"
        (click)="toggleAutoRefresh()"
      >
        {{ autoRefreshEnabled ? '‚è∏ D·ª´ng auto-refresh' : 'üîÑ Auto-refresh' }}
      </button>
      <button class="btn-primary" (click)="loadDashboard()" [disabled]="loading()">
        {{ loading() ? '‚è≥ ƒêang t·∫£i...' : 'üîÑ L√†m m·ªõi' }}
      </button>
    </div>
  </header>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'overview'"
      (click)="switchTab('overview')"
    >
      üìä T·ªïng quan
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'signserver'"
      (click)="switchTab('signserver')"
    >
      ‚úçÔ∏è SignServer
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'ejbca'" (click)="switchTab('ejbca')">
      üèõÔ∏è EJBCA
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'config'" (click)="switchTab('config')">
      ‚öôÔ∏è C·∫•u h√¨nh
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'signatures'"
      (click)="switchTab('signatures')"
    >
      ‚úçÔ∏è Ch·ªØ k√Ω
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'test'" (click)="switchTab('test')">
      üß™ Ki·ªÉm tra
    </button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TAB: Overview -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @if (activeTab === 'overview') {
    <div class="tab-content">
      @if (loading()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>ƒêang t·∫£i th√¥ng tin...</p>
        </div>
      } @else if (dashboard()) {
        <!-- Status Cards -->
        <div class="stats-grid">
          <div class="stat-card" [class]="getStatusClass(dashboard()!.signServer.status)">
            <div class="stat-icon">‚úçÔ∏è</div>
            <div class="stat-info">
              <h3>SignServer</h3>
              <span class="stat-badge" [class]="getStatusClass(dashboard()!.signServer.status)">
                {{ getStatusIcon(dashboard()!.signServer.status) }}
                {{ getStatusLabel(dashboard()!.signServer.status) }}
              </span>
              <small class="stat-url">{{ dashboard()!.signServer.url }}</small>
            </div>
            <button
              class="btn-icon"
              title="M·ªü Admin UI"
              (click)="
                openExternalUrl(
                  dashboard()!
                    .signing.signServerUrl.replace('http://', 'https://')
                    .replace(':8080', ':8443') + '/adminweb/'
                )
              "
            >
              üîó
            </button>
          </div>

          <div class="stat-card" [class]="getStatusClass(dashboard()!.ejbca.status)">
            <div class="stat-icon">üèõÔ∏è</div>
            <div class="stat-info">
              <h3>EJBCA</h3>
              <span class="stat-badge" [class]="getStatusClass(dashboard()!.ejbca.status)">
                {{ getStatusIcon(dashboard()!.ejbca.status) }}
                {{ getStatusLabel(dashboard()!.ejbca.status) }}
              </span>
              <small class="stat-url">{{ dashboard()!.ejbca.url }}</small>
            </div>
            <button
              class="btn-icon"
              title="M·ªü Admin UI"
              (click)="openExternalUrl(dashboard()!.signing.ejbcaUrl + '/adminweb/')"
            >
              üîó
            </button>
          </div>

          <div
            class="stat-card"
            [class]="dashboard()!.signing.enabled ? 'status-healthy' : 'status-disabled'"
          >
            <div class="stat-icon">üîè</div>
            <div class="stat-info">
              <h3>K√Ω s·ªë PDF</h3>
              <span
                class="stat-badge"
                [class]="dashboard()!.signing.enabled ? 'status-healthy' : 'status-disabled'"
              >
                {{ dashboard()!.signing.enabled ? '‚úÖ ƒê√£ b·∫≠t' : '‚è∏Ô∏è ƒê√£ t·∫Øt' }}
              </span>
              <small>Worker: {{ dashboard()!.signing.workerName }}</small>
            </div>
          </div>

          <div
            class="stat-card"
            [class]="dashboard()!.health.isHealthy ? 'status-healthy' : 'status-unhealthy'"
          >
            <div class="stat-icon">üíö</div>
            <div class="stat-info">
              <h3>Tr·∫°ng th√°i chung</h3>
              <span
                class="stat-badge"
                [class]="dashboard()!.health.isHealthy ? 'status-healthy' : 'status-unhealthy'"
              >
                {{ dashboard()!.health.isHealthy ? '‚úÖ S·∫µn s√†ng' : '‚ö†Ô∏è Ch∆∞a s·∫µn s√†ng' }}
              </span>
              @if (dashboard()!.health.errorMessage) {
                <small class="error-text">{{ dashboard()!.health.errorMessage }}</small>
              }
            </div>
          </div>
        </div>

        <!-- Infrastructure Diagram -->
        <div class="card">
          <div class="section-header">
            <h2>üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng</h2>
          </div>
          <div class="infra-diagram">
            <div class="infra-node ejbca-node">
              <div class="node-header">
                <span class="node-icon">üèõÔ∏è</span>
                <span>EJBCA</span>
              </div>
              <div class="node-body">
                <small>Certificate Authority</small>
                <span class="node-status" [class]="getStatusClass(dashboard()!.ejbca.status)">
                  {{ getStatusIcon(dashboard()!.ejbca.status) }}
                </span>
              </div>
            </div>

            <div class="infra-arrow">‚Üí ph√°t h√†nh cert ‚Üí</div>

            <div class="infra-node signserver-node">
              <div class="node-header">
                <span class="node-icon">‚úçÔ∏è</span>
                <span>SignServer</span>
              </div>
              <div class="node-body">
                <small>PDFSigner Worker</small>
                <span class="node-status" [class]="getStatusClass(dashboard()!.signServer.status)">
                  {{ getStatusIcon(dashboard()!.signServer.status) }}
                </span>
              </div>
            </div>

            <div class="infra-arrow">‚Üê REST API ‚Üê</div>

            <div class="infra-node api-node">
              <div class="node-header">
                <span class="node-icon">üñ•Ô∏è</span>
                <span>IVF API</span>
              </div>
              <div class="node-body">
                <small>DigitalSigningService</small>
                <span class="node-status status-healthy">‚úÖ</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Info -->
        <div class="card">
          <div class="section-header">
            <h2>üìã Th√¥ng tin c·∫•u h√¨nh</h2>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <label>SignServer URL</label>
              <span>{{ dashboard()!.signing.signServerUrl }}</span>
            </div>
            <div class="info-item">
              <label>EJBCA URL</label>
              <span>{{ dashboard()!.signing.ejbcaUrl }}</span>
            </div>
            <div class="info-item">
              <label>Worker</label>
              <span
                >{{ dashboard()!.signing.workerName }} (ID:
                {{ dashboard()!.signing.workerId || 'auto' }})</span
              >
            </div>
            <div class="info-item">
              <label>L√Ω do k√Ω m·∫∑c ƒë·ªãnh</label>
              <span>{{ dashboard()!.signing.defaultReason }}</span>
            </div>
            <div class="info-item">
              <label>V·ªã tr√≠ m·∫∑c ƒë·ªãnh</label>
              <span>{{ dashboard()!.signing.defaultLocation }}</span>
            </div>
            <div class="info-item">
              <label>Ch·ªØ k√Ω hi·ªÉn th·ªã</label>
              <span>{{ dashboard()!.signing.addVisibleSignature ? 'C√≥' : 'Kh√¥ng' }}</span>
            </div>
            <div class="info-item">
              <label>Timeout</label>
              <span>{{ dashboard()!.signing.timeoutSeconds }}s</span>
            </div>
            @if (dashboard()!.health.certificateSubject) {
              <div class="info-item">
                <label>Ch·ª©ng th∆∞ s·ªë</label>
                <span>{{ dashboard()!.health.certificateSubject }}</span>
              </div>
            }
            @if (dashboard()!.health.certificateExpiry) {
              <div class="info-item">
                <label>H·∫øt h·∫°n</label>
                <span>{{ formatDateTime(dashboard()!.health.certificateExpiry!) }}</span>
              </div>
            }
          </div>
        </div>
      } @else {
        <div class="empty-state-box">
          <p>‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i th√¥ng tin k√Ω s·ªë. Ki·ªÉm tra k·∫øt n·ªëi API.</p>
          <button class="btn-primary" (click)="loadDashboard()">Th·ª≠ l·∫°i</button>
        </div>
      }
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TAB: SignServer -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @if (activeTab === 'signserver') {
    <div class="tab-content">
      <!-- SignServer Health -->
      <div class="card">
        <div class="section-header">
          <h2>‚úçÔ∏è SignServer Health</h2>
          <button
            class="btn-secondary"
            (click)="refreshSignServerHealth()"
            [disabled]="refreshingHealth()"
          >
            {{ refreshingHealth() ? '‚è≥' : 'üîÑ' }} Ki·ªÉm tra
          </button>
        </div>

        @if (signServerHealth()) {
          <div class="health-detail">
            <div class="health-row">
              <span class="health-label">K·∫øt n·ªëi</span>
              <span
                class="health-value"
                [class.healthy]="signServerHealth()!.reachable"
                [class.error]="!signServerHealth()!.reachable"
              >
                {{
                  signServerHealth()!.reachable ? '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng' : '‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c'
                }}
              </span>
            </div>
            <div class="health-row">
              <span class="health-label">HTTP Status</span>
              <span class="health-value">{{ signServerHealth()!.statusCode }}</span>
            </div>
            <div class="health-row">
              <span class="health-label">Tr·∫°ng th√°i</span>
              <span
                class="health-value"
                [class.healthy]="signServerHealth()!.healthy"
                [class.error]="!signServerHealth()!.healthy"
              >
                {{ signServerHealth()!.healthy ? '‚úÖ Healthy' : '‚ö†Ô∏è Unhealthy' }}
              </span>
            </div>
            <div class="health-row">
              <span class="health-label">URL</span>
              <span class="health-value mono">{{ signServerHealth()!.url }}</span>
            </div>
            @if (signServerHealth()!.body) {
              <div class="health-row">
                <span class="health-label">Response</span>
                <pre class="health-body">{{ signServerHealth()!.body }}</pre>
              </div>
            }
          </div>
        } @else {
          <p class="muted">Nh·∫•n "Ki·ªÉm tra" ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i SignServer.</p>
        }
      </div>

      <!-- Workers -->
      <div class="card">
        <div class="section-header">
          <h2>üë∑ Workers</h2>
          <button class="btn-secondary" (click)="loadWorkers()">üîÑ T·∫£i l·∫°i</button>
        </div>

        @if (workers()) {
          @if (workers().workers?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>T√™n</th>
                  <th>Lo·∫°i</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>S·ªë l·∫ßn k√Ω</th>
                </tr>
              </thead>
              <tbody>
                @for (worker of workers().workers; track worker.id || $index) {
                  <tr>
                    <td>{{ worker.id }}</td>
                    <td>
                      <strong>{{ worker.name }}</strong>
                    </td>
                    <td>{{ worker.type || 'PDFSigner' }}</td>
                    <td>
                      <span
                        class="status-badge"
                        [class.active]="worker.status === 'Active'"
                        [class.offline]="worker.status !== 'Active'"
                      >
                        {{ worker.status || 'N/A' }}
                      </span>
                    </td>
                    <td>{{ worker.signings ?? '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="info-message">
              <p>
                üìã Worker m·∫∑c ƒë·ªãnh:
                <strong>{{ dashboard()?.signing?.workerName || 'PDFSigner' }}</strong> (ID:
                {{ dashboard()?.signing?.workerId || 1 }})
              </p>
              @if (workers().error) {
                <p class="muted">‚ÑπÔ∏è REST API workers list kh√¥ng kh·∫£ d·ª•ng: {{ workers().error }}</p>
              }
            </div>
          }
        } @else {
          <p class="muted">Nh·∫•n "T·∫£i l·∫°i" ƒë·ªÉ xem danh s√°ch workers.</p>
        }
      </div>

      <!-- External Links -->
      <div class="card">
        <div class="section-header">
          <h2>üîó Li√™n k·∫øt qu·∫£n tr·ªã</h2>
        </div>
        <div class="links-grid">
          <button
            class="link-card"
            (click)="openExternalUrl('https://localhost:9443/signserver/adminweb/')"
          >
            <span class="link-icon">üåê</span>
            <span class="link-text">
              <strong>SignServer Admin UI</strong>
              <small>https://localhost:9443/signserver/adminweb/</small>
            </span>
          </button>
          <button
            class="link-card"
            (click)="
              openExternalUrl('https://localhost:9443/signserver/healthcheck/signserverhealth')
            "
          >
            <span class="link-icon">üíö</span>
            <span class="link-text">
              <strong>Health Check</strong>
              <small>SignServer healthcheck endpoint</small>
            </span>
          </button>
          <button
            class="link-card"
            (click)="openExternalUrl('http://localhost:9080/signserver/process')"
          >
            <span class="link-icon">‚ö°</span>
            <span class="link-text">
              <strong>REST Process API</strong>
              <small>http://localhost:9080/signserver/process</small>
            </span>
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TAB: EJBCA -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @if (activeTab === 'ejbca') {
    <div class="tab-content">
      <!-- EJBCA Health -->
      <div class="card">
        <div class="section-header">
          <h2>üèõÔ∏è EJBCA Health</h2>
          <button
            class="btn-secondary"
            (click)="refreshEjbcaHealth()"
            [disabled]="refreshingHealth()"
          >
            {{ refreshingHealth() ? '‚è≥' : 'üîÑ' }} Ki·ªÉm tra
          </button>
        </div>

        @if (ejbcaHealth()) {
          <div class="health-detail">
            <div class="health-row">
              <span class="health-label">K·∫øt n·ªëi</span>
              <span
                class="health-value"
                [class.healthy]="ejbcaHealth()!.reachable"
                [class.error]="!ejbcaHealth()!.reachable"
              >
                {{ ejbcaHealth()!.reachable ? '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng' : '‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c' }}
              </span>
            </div>
            <div class="health-row">
              <span class="health-label">HTTP Status</span>
              <span class="health-value">{{ ejbcaHealth()!.statusCode }}</span>
            </div>
            <div class="health-row">
              <span class="health-label">Tr·∫°ng th√°i</span>
              <span
                class="health-value"
                [class.healthy]="ejbcaHealth()!.healthy"
                [class.error]="!ejbcaHealth()!.healthy"
              >
                {{ ejbcaHealth()!.healthy ? '‚úÖ Healthy' : '‚ö†Ô∏è Unhealthy' }}
              </span>
            </div>
            <div class="health-row">
              <span class="health-label">URL</span>
              <span class="health-value mono">{{ ejbcaHealth()!.url }}</span>
            </div>
            @if (ejbcaHealth()!.body) {
              <div class="health-row">
                <span class="health-label">Response</span>
                <pre class="health-body">{{ ejbcaHealth()!.body }}</pre>
              </div>
            }
          </div>
        } @else {
          <p class="muted">Nh·∫•n "Ki·ªÉm tra" ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i EJBCA.</p>
        }
      </div>

      <!-- Certificate Authorities -->
      <div class="card">
        <div class="section-header">
          <h2>üìú Certificate Authorities</h2>
          <button class="btn-secondary" (click)="loadEjbcaCAs()">üîÑ T·∫£i l·∫°i</button>
        </div>

        @if (ejbcaCAs()) {
          @if (ejbcaCAs().certificate_authorities?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>T√™n CA</th>
                  <th>Subject DN</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>H·∫øt h·∫°n</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
                @for (ca of ejbcaCAs().certificate_authorities; track ca.name || $index) {
                  <tr>
                    <td>
                      <strong>{{ ca.name }}</strong>
                    </td>
                    <td class="mono small">{{ ca.subject_dn || ca.subjectDn || '-' }}</td>
                    <td>
                      <span class="status-badge active">{{ ca.status || 'Active' }}</span>
                    </td>
                    <td>{{ ca.expiration_date ? formatDateTime(ca.expiration_date) : '-' }}</td>
                    <td>
                      <button
                        class="btn-sm btn-outline"
                        (click)="downloadCaCert(ca.name)"
                        title="T·∫£i ch·ª©ng th∆∞ CA"
                      >
                        üì•
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="info-message">
              <p>‚ÑπÔ∏è Ch∆∞a c√≥ CA n√†o ho·∫∑c REST API EJBCA y√™u c·∫ßu client certificate.</p>
              @if (ejbcaCAs().message) {
                <p class="muted">{{ ejbcaCAs().message }}</p>
              }
              @if (ejbcaCAs().error) {
                <p class="muted">{{ ejbcaCAs().error }}</p>
              }
            </div>
          }
        } @else {
          <p class="muted">Nh·∫•n "T·∫£i l·∫°i" ƒë·ªÉ xem danh s√°ch CA.</p>
        }
      </div>

      <!-- Certificate Search -->
      <div class="card">
        <div class="section-header">
          <h2>üîç T√¨m ki·∫øm ch·ª©ng th∆∞</h2>
        </div>

        <div class="search-form">
          <div class="search-row">
            <div class="search-field">
              <label>Subject DN</label>
              <input
                type="text"
                [(ngModel)]="ejbcaCertSearch.subject"
                placeholder="CN=..."
                class="form-input"
              />
            </div>
            <div class="search-field">
              <label>Issuer DN</label>
              <input
                type="text"
                [(ngModel)]="ejbcaCertSearch.issuer"
                placeholder="CN=IVF..."
                class="form-input"
              />
            </div>
            <div class="search-field">
              <label>Serial Number</label>
              <input
                type="text"
                [(ngModel)]="ejbcaCertSearch.serialNumber"
                placeholder="ABC123..."
                class="form-input"
              />
            </div>
            <div class="search-field">
              <label>Tr·∫°ng th√°i</label>
              <select [(ngModel)]="ejbcaCertSearch.status" class="form-input">
                <option value="">T·∫•t c·∫£</option>
                @for (s of certStatuses; track s.value) {
                  <option [value]="s.value">{{ s.label }}</option>
                }
              </select>
            </div>
          </div>
          <div class="search-actions">
            <button
              class="btn-primary"
              (click)="searchEjbcaCertificates()"
              [disabled]="ejbcaSearching()"
            >
              {{ ejbcaSearching() ? '‚è≥ ƒêang t√¨m...' : 'üîç T√¨m ki·∫øm' }}
            </button>
          </div>
        </div>

        @if (ejbcaCertificates().length > 0) {
          <p class="muted" style="margin-bottom: 0.5rem">
            T√¨m th·∫•y <strong>{{ ejbcaTotalCount() || ejbcaCertificates().length }}</strong> ch·ª©ng
            th∆∞
          </p>
          <table class="data-table cert-table">
            <thead>
              <tr>
                <th></th>
                <th>Subject</th>
                <th>Lo·∫°i</th>
                <th>Serial Number</th>
                <th>Hi·ªáu l·ª±c</th>
                <th>H·∫øt h·∫°n</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (cert of ejbcaCertificates(); track cert.serial_number) {
                <tr [class.expanded]="expandedCertSerial() === cert.serial_number">
                  <td>
                    <button
                      class="btn-icon expand-btn"
                      (click)="toggleCertDetail(cert.serial_number)"
                      [title]="
                        expandedCertSerial() === cert.serial_number ? 'Thu g·ªçn' : 'Xem chi ti·∫øt'
                      "
                    >
                      {{ expandedCertSerial() === cert.serial_number ? '‚ñº' : '‚ñ∂' }}
                    </button>
                  </td>
                  <td>
                    <strong>{{ formatCertSubject(cert.subject_dn || '') }}</strong>
                    @if (cert.username) {
                      <small class="block-text text-muted">üë§ {{ cert.username }}</small>
                    }
                  </td>
                  <td>
                    <span class="cert-type-badge" [attr.data-type]="cert.cert_type">{{
                      cert.cert_type || '-'
                    }}</span>
                  </td>
                  <td class="mono small">{{ cert.serial_number }}</td>
                  <td>{{ cert.not_before ? formatDateTime(cert.not_before) : '-' }}</td>
                  <td>{{ cert.not_after ? formatDateTime(cert.not_after) : '-' }}</td>
                  <td>
                    @if (cert.status === 'CERT_ACTIVE' || !cert.status) {
                      <span class="status-badge active">Ho·∫°t ƒë·ªông</span>
                    } @else if (cert.status === 'CERT_REVOKED') {
                      <span class="status-badge revoked">ƒê√£ thu h·ªìi</span>
                    } @else if (cert.status === 'CERT_EXPIRED') {
                      <span class="status-badge expired">H·∫øt h·∫°n</span>
                    } @else if (cert.status === 'CERT_ARCHIVED') {
                      <span class="status-badge archived">ƒê√£ l∆∞u tr·ªØ</span>
                    } @else if (cert.status === 'CERT_TEMP_REVOKED') {
                      <span class="status-badge revoked">T·∫°m thu h·ªìi</span>
                    } @else {
                      <span class="status-badge">{{ cert.status }}</span>
                    }
                  </td>
                  <td>
                    <div class="action-btns">
                      @if (cert.status !== 'CERT_REVOKED') {
                        <button
                          class="btn-sm btn-outline btn-danger"
                          (click)="openRevokeConfirm(cert.serial_number, cert.issuer_dn || '')"
                          title="Thu h·ªìi ch·ª©ng th∆∞"
                        >
                          üö´
                        </button>
                      }
                    </div>
                  </td>
                </tr>
                @if (expandedCertSerial() === cert.serial_number) {
                  <tr class="cert-detail-row">
                    <td colspan="8">
                      <div class="cert-detail-grid">
                        <div class="detail-item">
                          <label>Subject DN</label>
                          <span class="mono small">{{ cert.subject_dn || '-' }}</span>
                        </div>
                        <div class="detail-item">
                          <label>Issuer DN</label>
                          <span class="mono small">{{ cert.issuer_dn || '-' }}</span>
                        </div>
                        <div class="detail-item">
                          <label>Fingerprint (SHA-1)</label>
                          <span class="mono small">{{ cert.fingerprint || '-' }}</span>
                        </div>
                        <div class="detail-item">
                          <label>Username</label>
                          <span>{{ cert.username || '-' }}</span>
                        </div>
                        <div class="detail-item">
                          <label>Certificate Profile</label>
                          <span>{{ cert.certificate_profile || '-' }}</span>
                        </div>
                        <div class="detail-item">
                          <label>End Entity Profile</label>
                          <span>{{ cert.end_entity_profile || '-' }}</span>
                        </div>
                        @if (cert.subject_alt_name) {
                          <div class="detail-item">
                            <label>Subject Alt Name</label>
                            <span class="mono small">{{ cert.subject_alt_name }}</span>
                          </div>
                        }
                        @if (cert.subject_key_id) {
                          <div class="detail-item">
                            <label>Subject Key ID</label>
                            <span class="mono small">{{ cert.subject_key_id }}</span>
                          </div>
                        }
                        @if (cert.revocation_reason) {
                          <div class="detail-item">
                            <label>L√Ω do thu h·ªìi</label>
                            <span>{{ cert.revocation_reason }}</span>
                          </div>
                        }
                        @if (cert.revocation_date) {
                          <div class="detail-item">
                            <label>Ng√†y thu h·ªìi</label>
                            <span>{{ formatDateTime(cert.revocation_date) }}</span>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
          @if (ejbcaMoreResults()) {
            <p class="muted" style="margin-top: 0.75rem">
              ‚ö†Ô∏è C√≥ th√™m k·∫øt qu·∫£. Thu h·∫πp ƒëi·ªÅu ki·ªán t√¨m ki·∫øm ƒë·ªÉ xem ƒë·∫ßy ƒë·ªß.
            </p>
          }
        } @else if (ejbcaSearching()) {
          <div class="loading-state small-loading">
            <div class="spinner"></div>
            <p>ƒêang t√¨m ki·∫øm...</p>
          </div>
        }
      </div>

      <!-- Revoke Confirmation Modal -->
      @if (ejbcaRevokeConfirm()) {
        <div class="modal-overlay" (click)="cancelRevoke()">
          <div class="modal-content revoke-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h2>üö´ Thu h·ªìi ch·ª©ng th∆∞</h2>
              <button class="btn-icon" (click)="cancelRevoke()">‚úï</button>
            </div>
            <div class="modal-body">
              <div class="revoke-info">
                <div class="info-row">
                  <label>Serial Number</label>
                  <span class="mono">{{ ejbcaRevokeConfirm()!.serial }}</span>
                </div>
                <div class="info-row">
                  <label>Issuer DN</label>
                  <span class="mono small">{{ ejbcaRevokeConfirm()!.issuerDn }}</span>
                </div>
              </div>

              <div class="form-group">
                <label>L√Ω do thu h·ªìi</label>
                <select [(ngModel)]="ejbcaRevokeReason" class="form-input">
                  @for (r of revokeReasons; track r.value) {
                    <option [value]="r.value">{{ r.label }}</option>
                  }
                </select>
              </div>

              <div class="warning-box">
                ‚ö†Ô∏è <strong>C·∫£nh b√°o:</strong> Thu h·ªìi ch·ª©ng th∆∞ l√† thao t√°c kh√¥ng th·ªÉ ho√†n t√°c.
                Ch·ª©ng th∆∞ s·∫Ω kh√¥ng th·ªÉ d√πng ƒë·ªÉ k√Ω s·ªë sau khi b·ªã thu h·ªìi.
              </div>

              @if (ejbcaRevokeResult()) {
                <div
                  class="result-box"
                  [class.success]="ejbcaRevokeResult()!.success"
                  [class.failure]="!ejbcaRevokeResult()!.success"
                >
                  {{
                    ejbcaRevokeResult()!.success
                      ? '‚úÖ ' + ejbcaRevokeResult()!.message
                      : '‚ùå ' + ejbcaRevokeResult()!.error
                  }}
                </div>
              }
            </div>
            <div class="modal-footer">
              <button class="btn-secondary" (click)="cancelRevoke()">H·ªßy</button>
              <button
                class="btn-danger"
                (click)="confirmRevokeCertificate()"
                [disabled]="ejbcaRevoking()"
              >
                {{ ejbcaRevoking() ? '‚è≥ ƒêang thu h·ªìi...' : 'üö´ X√°c nh·∫≠n thu h·ªìi' }}
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Profiles -->
      <div class="card">
        <div class="section-header">
          <h2>üìã Profiles</h2>
          <button class="btn-secondary" (click)="loadEjbcaProfiles()">üîÑ T·∫£i l·∫°i</button>
        </div>
        <div class="profiles-grid">
          <div class="profile-section">
            <h4>Certificate Profiles</h4>
            @if (ejbcaCertProfiles()?.certificate_profiles?.length > 0) {
              <ul class="profile-list">
                @for (p of ejbcaCertProfiles().certificate_profiles; track p.name || $index) {
                  <li>{{ p.name || p }}</li>
                }
              </ul>
            } @else {
              <p class="muted small">
                {{
                  ejbcaCertProfiles()?.error ||
                    'EJBCA CE kh√¥ng h·ªó tr·ª£ REST API profiles. Xem trong Admin Web UI.'
                }}
              </p>
            }
          </div>
          <div class="profile-section">
            <h4>End Entity Profiles</h4>
            @if (ejbcaEndEntityProfiles()?.end_entity_profiles?.length > 0) {
              <ul class="profile-list">
                @for (p of ejbcaEndEntityProfiles().end_entity_profiles; track p.name || $index) {
                  <li>{{ p.name || p }}</li>
                }
              </ul>
            } @else {
              <p class="muted small">
                {{
                  ejbcaEndEntityProfiles()?.error ||
                    'EJBCA CE kh√¥ng h·ªó tr·ª£ REST API profiles. Xem trong Admin Web UI.'
                }}
              </p>
            }
          </div>
        </div>
      </div>

      <!-- External Links -->
      <div class="card">
        <div class="section-header">
          <h2>üîó Li√™n k·∫øt qu·∫£n tr·ªã</h2>
        </div>
        <div class="links-grid">
          <button
            class="link-card"
            (click)="openExternalUrl('https://localhost:8443/ejbca/adminweb/')"
          >
            <span class="link-icon">üåê</span>
            <span class="link-text">
              <strong>EJBCA Admin UI</strong>
              <small>https://localhost:8443/ejbca/adminweb/</small>
            </span>
          </button>
          <button
            class="link-card"
            (click)="openExternalUrl('https://localhost:8443/ejbca/publicweb/')"
          >
            <span class="link-icon">üåç</span>
            <span class="link-text">
              <strong>EJBCA Public Web</strong>
              <small>Enrollment & certificate info</small>
            </span>
          </button>
          <button
            class="link-card"
            (click)="
              openExternalUrl('https://localhost:8443/ejbca/publicweb/healthcheck/ejbcahealth')
            "
          >
            <span class="link-icon">üíö</span>
            <span class="link-text">
              <strong>Health Check</strong>
              <small>EJBCA healthcheck endpoint</small>
            </span>
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TAB: Config -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @if (activeTab === 'config') {
    <div class="tab-content">
      <div class="card">
        <div class="section-header">
          <h2>‚öôÔ∏è C·∫•u h√¨nh k√Ω s·ªë</h2>
          <button class="btn-secondary" (click)="loadConfig()">üîÑ T·∫£i l·∫°i</button>
        </div>

        @if (config()) {
          <div class="config-grid">
            <div class="config-section">
              <h3>üîè T·ªïng quan</h3>
              <div class="config-item">
                <label>Tr·∫°ng th√°i</label>
                <span
                  class="config-value"
                  [class.enabled]="config()!.enabled"
                  [class.disabled]="!config()!.enabled"
                >
                  {{ config()!.enabled ? '‚úÖ ƒê√£ b·∫≠t' : '‚è∏Ô∏è ƒê√£ t·∫Øt' }}
                </span>
              </div>
              <div class="config-item">
                <label>SignServer URL</label>
                <code>{{ config()!.signServerUrl }}</code>
              </div>
              <div class="config-item">
                <label>EJBCA URL</label>
                <code>{{ config()!.ejbcaUrl }}</code>
              </div>
              <div class="config-item">
                <label>Timeout</label>
                <span>{{ config()!.timeoutSeconds }} gi√¢y</span>
              </div>
              <div class="config-item">
                <label>B·ªè qua TLS Validation</label>
                <span>{{ config()!.skipTlsValidation ? 'C√≥ (Dev mode)' : 'Kh√¥ng' }}</span>
              </div>
              <div class="config-item">
                <label>Client Certificate</label>
                <span>{{ config()!.hasClientCertificate ? 'ƒê√£ c·∫•u h√¨nh' : 'Ch∆∞a c√≥' }}</span>
              </div>
            </div>

            <div class="config-section">
              <h3>‚úçÔ∏è Worker</h3>
              <div class="config-item">
                <label>Worker Name</label>
                <code>{{ config()!.workerName }}</code>
              </div>
              <div class="config-item">
                <label>Worker ID</label>
                <span>{{ config()!.workerId || 'Auto' }}</span>
              </div>
            </div>

            <div class="config-section">
              <h3>üìù Ch·ªØ k√Ω PDF</h3>
              <div class="config-item">
                <label>L√Ω do k√Ω m·∫∑c ƒë·ªãnh</label>
                <span>{{ config()!.defaultReason }}</span>
              </div>
              <div class="config-item">
                <label>V·ªã tr√≠ m·∫∑c ƒë·ªãnh</label>
                <span>{{ config()!.defaultLocation }}</span>
              </div>
              <div class="config-item">
                <label>Th√¥ng tin li√™n h·ªá</label>
                <span>{{ config()!.defaultContactInfo }}</span>
              </div>
              <div class="config-item">
                <label>Ch·ªØ k√Ω hi·ªÉn th·ªã</label>
                <span>{{ config()!.addVisibleSignature ? 'C√≥' : 'Kh√¥ng' }}</span>
              </div>
              <div class="config-item">
                <label>Trang ch·ªØ k√Ω</label>
                <span>{{
                  config()!.visibleSignaturePage === 0
                    ? 'Trang cu·ªëi'
                    : 'Trang ' + config()!.visibleSignaturePage
                }}</span>
              </div>
            </div>
          </div>

          <div class="config-note">
            <p>
              üí° <strong>L∆∞u √Ω:</strong> ƒê·ªÉ thay ƒë·ªïi c·∫•u h√¨nh, ch·ªânh s·ª≠a m·ª•c
              <code>DigitalSigning</code> trong <code>appsettings.json</code> ho·∫∑c thi·∫øt l·∫≠p bi·∫øn
              m√¥i tr∆∞·ªùng Docker t∆∞∆°ng ·ª©ng, sau ƒë√≥ kh·ªüi ƒë·ªông l·∫°i API.
            </p>
          </div>
        } @else {
          <p class="muted">ƒêang t·∫£i c·∫•u h√¨nh...</p>
        }
      </div>

      <!-- API Endpoints Reference -->
      <div class="card">
        <div class="section-header">
          <h2>üîå API Endpoints</h2>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Method</th>
              <th>Endpoint</th>
              <th>M√¥ t·∫£</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="method-badge get">GET</span></td>
              <td class="mono">/api/signing/health</td>
              <td>Ki·ªÉm tra s·ª©c kho·∫ª SignServer</td>
            </tr>
            <tr>
              <td><span class="method-badge post">POST</span></td>
              <td class="mono">/api/signing/sign-pdf</td>
              <td>Upload & k√Ω s·ªë PDF (multipart/form-data)</td>
            </tr>
            <tr>
              <td><span class="method-badge get">GET</span></td>
              <td class="mono">/api/forms/responses/{{ '{' }}id{{ '}' }}/export-pdf?sign=true</td>
              <td>Xu·∫•t form response PDF c√≥ k√Ω s·ªë</td>
            </tr>
            <tr>
              <td><span class="method-badge get">GET</span></td>
              <td class="mono">/api/forms/reports/{{ '{' }}id{{ '}' }}/export-pdf?sign=true</td>
              <td>Xu·∫•t report PDF c√≥ k√Ω s·ªë</td>
            </tr>
            <tr>
              <td><span class="method-badge get">GET</span></td>
              <td class="mono">/api/signing/config</td>
              <td>Xem th√¥ng tin c·∫•u h√¨nh k√Ω s·ªë</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TAB: User Signatures                              -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @if (activeTab === 'signatures') {
    <div class="tab-content">
      <!-- Signatures List -->
      <div class="card">
        <div class="section-header">
          <h2>‚úçÔ∏è Ch·ªØ k√Ω ng∆∞·ªùi d√πng</h2>
          <button class="btn-secondary" (click)="loadUserSignatures()">üîÑ T·∫£i l·∫°i</button>
        </div>

        @if (userSignatures().length > 0) {
          <table class="data-table">
            <thead>
              <tr>
                <th>Ng∆∞·ªùi d√πng</th>
                <th>Vai tr√≤</th>
                <th>Ph√≤ng ban</th>
                <th>Ch·ªØ k√Ω tay</th>
                <th>Tr·∫°ng th√°i ch·ª©ng th∆∞</th>
                <th>Worker</th>
                <th>H·∫øt h·∫°n</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              @for (sig of userSignatures(); track sig.userId) {
                <tr>
                  <td>
                    <strong>{{ sig.userFullName || 'N/A' }}</strong>
                  </td>
                  <td>{{ sig.userRole || '-' }}</td>
                  <td>{{ sig.userDepartment || '-' }}</td>
                  <td>
                    @if (sig.hasSignatureImage && signatureImageUrls.get(sig.userId)) {
                      <div class="sig-preview-cell">
                        <img
                          [src]="signatureImageUrls.get(sig.userId)"
                          alt="Ch·ªØ k√Ω"
                          class="sig-preview-thumb"
                        />
                      </div>
                    } @else if (sig.hasSignatureImage) {
                      <div class="sig-preview-cell">
                        <span class="muted">ƒêang t·∫£i...</span>
                      </div>
                    } @else {
                      <span class="muted">Ch∆∞a c√≥</span>
                    }
                  </td>
                  <td>
                    <span class="cert-badge" [class]="getCertStatusClass(sig.certStatus)">
                      {{ getCertStatusLabel(sig.certStatus) }}
                    </span>
                  </td>
                  <td class="mono small">{{ sig.workerName || '-' }}</td>
                  <td>{{ sig.certificateExpiry ? formatDateTime(sig.certificateExpiry) : '-' }}</td>
                  <td>
                    <div class="action-btns">
                      <button
                        class="btn-sm btn-outline"
                        (click)="openSignaturePad(sig.userId)"
                        [title]="sig.hasSignatureImage ? 'C·∫≠p nh·∫≠t ch·ªØ k√Ω tay' : 'T·∫£i ch·ªØ k√Ω tay'"
                      >
                        {{ sig.hasSignatureImage ? 'üñäÔ∏è' : '‚ûï' }}
                      </button>
                      @if (sig.hasSignatureImage) {
                        <button
                          class="btn-sm btn-outline"
                          (click)="provisionCertificate(sig.userId)"
                          [disabled]="provisioningCert()"
                          title="C·∫•p ch·ª©ng th∆∞ s·ªë"
                        >
                          üîê
                        </button>
                      }
                      @if (sig.certStatus === 'Active') {
                        <button
                          class="btn-sm btn-outline"
                          (click)="testUserSign(sig.userId)"
                          [disabled]="testingUserSign()"
                          title="Ki·ªÉm tra k√Ω s·ªë"
                        >
                          üß™
                        </button>
                      }
                      @if (sig.certStatus === 'Expired' || sig.certStatus === 'Error') {
                        <button
                          class="btn-sm btn-outline btn-renew"
                          (click)="renewCertificate(sig.userId)"
                          [disabled]="renewingCert()"
                          title="Gia h·∫°n ch·ª©ng th∆∞ s·ªë"
                        >
                          üîÑ
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <div class="empty-state-box">
            <p>Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o trong h·ªá th·ªëng.</p>
          </div>
        }
      </div>

      <!-- Provision Result -->
      @if (provisionResult()) {
        <div class="card">
          <div
            class="test-result"
            [class.success]="provisionResult()!.success"
            [class.failure]="!provisionResult()!.success"
          >
            <div class="test-result-header">
              <span class="test-result-icon">{{ provisionResult()!.success ? '‚úÖ' : '‚ùå' }}</span>
              <h3>{{ provisionResult()!.message }}</h3>
            </div>
            @if (provisionResult()!.success) {
              <div class="test-result-body">
                <div class="test-stat">
                  <label>Subject</label>
                  <span>{{ provisionResult()!.certificateSubject }}</span>
                </div>
                <div class="test-stat">
                  <label>Worker</label>
                  <span>{{ provisionResult()!.workerName }}</span>
                </div>
                @if (provisionResult()!.expiry) {
                  <div class="test-stat">
                    <label>H·∫øt h·∫°n</label>
                    <span>{{ formatDateTime(provisionResult()!.expiry!) }}</span>
                  </div>
                }
              </div>
            } @else if (provisionResult()!.error) {
              <div class="test-result-body">
                <div class="test-error">
                  <label>Chi ti·∫øt l·ªói</label>
                  <pre>{{ provisionResult()!.error }}</pre>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- User Test Sign Result -->
      @if (userTestResult()) {
        <div class="card">
          <div
            class="test-result"
            [class.success]="userTestResult()!.success"
            [class.failure]="!userTestResult()!.success"
          >
            <div class="test-result-header">
              <span class="test-result-icon">{{ userTestResult()!.success ? '‚úÖ' : '‚ùå' }}</span>
              <h3>{{ userTestResult()!.success ? 'K√Ω s·ªë th√†nh c√¥ng!' : 'K√Ω s·ªë th·∫•t b·∫°i' }}</h3>
            </div>
            @if (userTestResult()!.success) {
              <div class="test-result-body">
                <div class="test-stat">
                  <label>Worker</label>
                  <span>{{ userTestResult()!.workerName }}</span>
                </div>
                <div class="test-stat">
                  <label>PDF g·ªëc</label>
                  <span>{{ formatBytes(userTestResult()!.originalSize!) }}</span>
                </div>
                <div class="test-stat">
                  <label>PDF ƒë√£ k√Ω</label>
                  <span>{{ formatBytes(userTestResult()!.signedSize!) }}</span>
                </div>
                <div class="test-stat">
                  <label>Th·ªùi gian</label>
                  <span>{{ userTestResult()!.durationMs }} ms</span>
                </div>
                @if (userTestResult()!.signer) {
                  <div class="test-stat">
                    <label>Ng∆∞·ªùi k√Ω</label>
                    <span>{{ userTestResult()!.signer }}</span>
                  </div>
                }
              </div>
            } @else {
              <div class="test-result-body">
                <div class="test-error">
                  <label>L·ªói</label>
                  <pre>{{ userTestResult()!.error }}</pre>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Usage Guide -->
      <div class="card">
        <div class="section-header">
          <h2>üìñ H∆∞·ªõng d·∫´n</h2>
        </div>
        <div class="troubleshoot-list">
          <div class="troubleshoot-item">
            <h4>1. üñäÔ∏è T·∫£i ch·ªØ k√Ω tay</h4>
            <p>
              Nh·∫•n n√∫t üñäÔ∏è ƒë·ªÉ v·∫Ω ho·∫∑c c·∫≠p nh·∫≠t ch·ªØ k√Ω tay cho ng∆∞·ªùi d√πng. Ch·ªØ k√Ω s·∫Ω hi·ªÉn th·ªã tr√™n PDF
              khi k√Ω s·ªë.
            </p>
          </div>
          <div class="troubleshoot-item">
            <h4>2. üîê C·∫•p ch·ª©ng th∆∞ s·ªë</h4>
            <p>
              Nh·∫•n n√∫t üîê ƒë·ªÉ t·∫°o keystore v√† worker SignServer ri√™ng cho user. M·ªói user s·∫Ω k√Ω b·∫±ng
              ch·ª©ng th∆∞ ri√™ng.
            </p>
          </div>
          <div class="troubleshoot-item">
            <h4>3. üîÑ Gia h·∫°n ch·ª©ng th∆∞ s·ªë</h4>
            <p>
              Khi ch·ª©ng th∆∞ <span class="cert-badge cert-expired">H·∫øt h·∫°n</span> ho·∫∑c
              <span class="cert-badge cert-error">L·ªói</span>, nh·∫•n üîÑ ƒë·ªÉ t·∫°o l·∫°i keystore v√† worker
              m·ªõi v·ªõi th·ªùi h·∫°n 3 nƒÉm.
            </p>
          </div>
          <div class="troubleshoot-item">
            <h4>4. üß™ Ki·ªÉm tra k√Ω s·ªë</h4>
            <p>
              Khi ch·ª©ng th∆∞ <span class="cert-badge cert-active">Ho·∫°t ƒë·ªông</span>, nh·∫•n üß™ ƒë·ªÉ ki·ªÉm
              tra k√Ω PDF v·ªõi worker ri√™ng c·ªßa user.
            </p>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Signature Pad Modal -->
  @if (showSignaturePad()) {
    <div class="modal-overlay" (click)="closeSignaturePad()">
      <div class="modal-content sig-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>üñäÔ∏è Ch·ªØ k√Ω tay</h2>
          <button class="btn-icon" (click)="closeSignaturePad()">‚úï</button>
        </div>
        <div class="modal-body">
          <app-signature-pad #signaturePad [width]="500" [height]="200"></app-signature-pad>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeSignaturePad()">Hu·ª∑</button>
          <button class="btn-primary" (click)="saveSignature()" [disabled]="uploadingSignature()">
            @if (uploadingSignature()) {
              <span class="spinner-inline"></span> ƒêang l∆∞u...
            } @else {
              üíæ L∆∞u ch·ªØ k√Ω
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TAB: Test -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @if (activeTab === 'test') {
    <div class="tab-content">
      <div class="card">
        <div class="section-header">
          <h2>üß™ Ki·ªÉm tra k√Ω s·ªë</h2>
        </div>

        <div class="test-section">
          <p>
            G·ª≠i m·ªôt file PDF m·∫´u t·ªõi SignServer ƒë·ªÉ ki·ªÉm tra to√†n b·ªô quy tr√¨nh k√Ω s·ªë ho·∫°t ƒë·ªông ch√≠nh
            x√°c.
          </p>

          <button class="btn-primary btn-lg" (click)="testSigning()" [disabled]="testingSign()">
            @if (testingSign()) {
              <span class="spinner-inline"></span> ƒêang k√Ω th·ª≠...
            } @else {
              üß™ Ch·∫°y ki·ªÉm tra k√Ω s·ªë
            }
          </button>

          @if (testResult()) {
            <div
              class="test-result"
              [class.success]="testResult()!.success"
              [class.failure]="!testResult()!.success"
            >
              <div class="test-result-header">
                <span class="test-result-icon">{{ testResult()!.success ? '‚úÖ' : '‚ùå' }}</span>
                <h3>{{ testResult()!.success ? 'K√Ω s·ªë th√†nh c√¥ng!' : 'K√Ω s·ªë th·∫•t b·∫°i' }}</h3>
              </div>

              @if (testResult()!.success) {
                <div class="test-result-body">
                  <div class="test-stat">
                    <label>PDF g·ªëc</label>
                    <span>{{ formatBytes(testResult()!.originalSize!) }}</span>
                  </div>
                  <div class="test-stat">
                    <label>PDF ƒë√£ k√Ω</label>
                    <span>{{ formatBytes(testResult()!.signedSize!) }}</span>
                  </div>
                  <div class="test-stat">
                    <label>Th·ªùi gian</label>
                    <span>{{ testResult()!.durationMs }} ms</span>
                  </div>
                  <div class="test-stat">
                    <label>C√≥ ch·ªØ k√Ω</label>
                    <span>{{ testResult()!.containsSignature ? '‚úÖ C√≥' : '‚ùå Kh√¥ng' }}</span>
                  </div>
                  <div class="test-stat">
                    <label>Th·ªùi ƒëi·ªÉm</label>
                    <span>{{ formatDateTime(testResult()!.timestamp) }}</span>
                  </div>
                </div>
              } @else {
                <div class="test-result-body">
                  <div class="test-error">
                    <label>L·ªói</label>
                    <pre>{{ testResult()!.error }}</pre>
                  </div>
                  @if (testResult()!.errorType) {
                    <div class="test-stat">
                      <label>Lo·∫°i l·ªói</label>
                      <span>{{ testResult()!.errorType }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Quick Troubleshooting -->
      <div class="card">
        <div class="section-header">
          <h2>üîß X·ª≠ l√Ω s·ª± c·ªë</h2>
        </div>
        <div class="troubleshoot-list">
          <div class="troubleshoot-item">
            <h4>‚ùå SignServer kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c</h4>
            <p>Ki·ªÉm tra container ƒëang ch·∫°y: <code>docker ps | findstr signserver</code></p>
            <p>Ki·ªÉm tra logs: <code>docker logs ivf-signserver --tail=20</code></p>
          </div>
          <div class="troubleshoot-item">
            <h4>‚ö†Ô∏è Crypto Token offline</h4>
            <p>
              K√≠ch ho·∫°t l·∫°i:
              <code>docker exec ivf-signserver bin/signserver activatecryptotoken 1 changeit</code>
            </p>
          </div>
          <div class="troubleshoot-item">
            <h4>‚ö†Ô∏è EJBCA kh√¥ng ph·∫£n h·ªìi</h4>
            <p>
              EJBCA kh·ªüi ƒë·ªông m·∫•t 2-3 ph√∫t. Ki·ªÉm tra: <code>docker logs ivf-ejbca --tail=20</code>
            </p>
          </div>
          <div class="troubleshoot-item">
            <h4>üîÑ Kh·ªüi ƒë·ªông l·∫°i to√†n b·ªô</h4>
            <p><code>docker compose restart signserver signserver-db ejbca ejbca-db</code></p>
          </div>
        </div>
      </div>
    </div>
  }
</div>
