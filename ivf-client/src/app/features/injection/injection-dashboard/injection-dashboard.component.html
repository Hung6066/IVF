<div class="dashboard-layout">
    <header class="page-header">
        <div class="header-title">
            <h1>üíâ Ph√≤ng Ti√™m</h1>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon info">‚è≥</div>
            <div class="stat-content">
                <span class="value">{{ queueCount() }}</span>
                <span class="label">ƒêang ch·ªù</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">‚úÖ</div>
            <div class="stat-content">
                <span class="value">{{ completedCount() }}</span>
                <span class="label">ƒê√£ ti√™m</span>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab-btn" [class.active]="activeTab === 'queue'" (click)="activeTab = 'queue'">H√†ng ƒë·ª£i</button>
        <button class="tab-btn" [class.active]="activeTab === 'history'" (click)="activeTab = 'history'">L·ªãch
            s·ª≠</button>
    </div>

    @if (activeTab === 'queue') {
    <section class="card">
        <div class="section-header">
            <h2>Danh s√°ch ch·ªù ({{ queueCount() }})</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç t√™n</th>
                        <th>Gi·ªù l·∫•y s·ªë</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th class="text-right">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @for (q of queue(); track q.id) {
                    <tr>
                        <td class="stt-cell">{{ q.ticketNumber }}</td>
                        <td>{{ q.patientName }}</td>
                        <td>{{ formatTime(q.issuedAt) }}</td>
                        <td>
                            @if (q.status === 'Waiting') { <span class="status-badge pending">ƒêang ch·ªù</span> }
                            @else if (q.status === 'Called') { <span class="status-badge called">ƒêang g·ªçi</span> }
                            @else if (q.status === 'InService') { <span class="status-badge processing">ƒêang ti√™m</span>
                            }
                            @else { <span class="status-badge">{{ q.status }}</span> }
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-sm btn-primary" (click)="callPatient(q)"
                                [disabled]="q.status !== 'Waiting'">üì¢ G·ªçi</button>
                            <button class="btn btn-sm btn-success" (click)="startInjection(q)"
                                [disabled]="q.status === 'InService'">üíâ Ti√™m</button>
                            <button class="btn btn-sm btn-warning" (click)="skipPatient(q)"
                                [disabled]="q.status === 'InService'">‚è≠Ô∏è B·ªè qua</button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="5" class="empty-state">Kh√¥ng c√≥ b·ªánh nh√¢n ch·ªù</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'history') {
    <section class="card">
        <div class="section-header">
            <h2>L·ªãch s·ª≠ ti√™m h√¥m nay ({{ completedCount() }})</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç t√™n</th>
                        <th>Gi·ªù ti√™m</th>
                        <th>Ghi ch√∫</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody>
                    @for (h of history(); track h.id) {
                    <tr>
                        <td class="stt-cell">{{ h.ticketNumber }}</td>
                        <td>{{ h.patientName }}</td>
                        <td>{{ formatTime(h.completedAt || h.issuedAt) }}</td>
                        <td>{{ h.notes || '-' }}</td>
                        <td><span class="status-badge success">ƒê√£ ti√™m</span></td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="5" class="empty-state">Ch∆∞a c√≥ l·ªãch s·ª≠ ti√™m h√¥m nay</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (showForm) {
    <div class="modal-overlay" (click)="showForm = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>üíâ X√°c nh·∫≠n ti√™m thu·ªëc</h3>
                <button class="close-btn" (click)="showForm = false">√ó</button>
            </div>

            <form (ngSubmit)="submitInjection()">
                <div class="modal-body">
                    <div class="patient-info-summary"
                        style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed #e2e8f0;">
                        <strong>BN: </strong> {{ currentPatientName }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lo·∫°i thu·ªëc / Ghi ch√∫</label>
                        <textarea class="form-control" [(ngModel)]="injectionNotes" name="notes" rows="3"
                            placeholder="Ghi ch√∫ thu·ªëc ƒë√£ ti√™m..."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="showForm = false">Hu·ª∑</button>
                    <button type="submit" class="btn btn-primary">X√°c nh·∫≠n Ti√™m xong</button>
                </div>
            </form>
        </div>
    </div>
    }
</div>