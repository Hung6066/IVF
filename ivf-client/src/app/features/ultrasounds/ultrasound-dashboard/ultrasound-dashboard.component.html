<div class="dashboard-layout">
    <header class="page-header">
        <div class="header-title">
            <h1>üî¨ Ph√≤ng Si√™u √¢m</h1>
            <span class="subtitle">Qu·∫£n l√Ω h√†ng ƒë·ª£i v√† k·∫øt qu·∫£ si√™u √¢m</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" (click)="showNewExam = true">
                <span class="icon">‚ûï</span> K·∫øt qu·∫£ m·ªõi
            </button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon waiting">‚è≥</div>
            <div class="stat-content">
                <span class="value">{{ queueCount() }}</span>
                <span class="label">ƒêang ch·ªù</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon completed">‚úÖ</div>
            <div class="stat-content">
                <span class="value">{{ completedCount() }}</span>
                <span class="label">ƒê√£ kh√°m h√¥m nay</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">‚ö†Ô∏è</div>
            <div class="stat-content">
                <span class="value">{{ abnornalCount() }}</span>
                <span class="label">B·∫•t th∆∞·ªùng</span>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab-btn" [class.active]="activeTab === 'queue'" (click)="activeTab = 'queue'">H√†ng ƒë·ª£i</button>
        <button class="tab-btn" [class.active]="activeTab === 'exams'" (click)="activeTab = 'exams'">K·∫øt qu·∫£
            kh√°m</button>
    </div>

    @if (activeTab === 'queue') {
    <section class="content-section card">
        <div class="section-header">
            <h2>Danh s√°ch ch·ªù <span class="count-badge">{{ queueCount() }}</span></h2>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="80">STT</th>
                        <th>H·ªç t√™n</th>
                        <th>M√£ BN</th>
                        <th>Gi·ªù l·∫•y s·ªë</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th width="200" class="text-right">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @for (q of queue(); track q.id) {
                    <tr [class.active-row]="q.status === 'Called'">
                        <td class="stt-cell">{{ q.number }}</td>
                        <td class="name-cell">{{ q.patientName }}</td>
                        <td class="code-cell">{{ q.patientCode }}</td>
                        <td>{{ formatTime(q.issueTime) }}</td>
                        <td>
                            <span class="status-badge" [ngClass]="{
                    'pending': q.status === 'Waiting',
                    'called': q.status === 'Called',
                    'processing': q.status === 'InService'
                  }">
                                {{ q.status === 'Waiting' ? 'ƒêang ch·ªù' :
                                q.status === 'Called' ? 'ƒêang g·ªçi' :
                                q.status === 'InService' ? 'ƒêang kh√°m' : q.status }}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-sm btn-info" (click)="callPatient(q)"
                                [disabled]="q.status !== 'Waiting'">
                                üì¢ G·ªçi
                            </button>
                            <button class="btn btn-sm btn-success" (click)="startExam(q)"
                                [disabled]="q.status === 'InService'">
                                üë®‚Äç‚öïÔ∏è Kh√°m
                            </button>
                            <button class="btn btn-sm btn-warning" (click)="skipPatient(q)"
                                [disabled]="q.status === 'InService'">
                                ‚è≠Ô∏è B·ªè qua
                            </button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-content">
                                <span class="empty-icon">üì≠</span>
                                <p>Kh√¥ng c√≥ b·ªánh nh√¢n ch·ªù</p>
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (activeTab === 'exams') {
    <section class="content-section card">
        <div class="section-header">
            <h2>K·∫øt qu·∫£ si√™u √¢m g·∫ßn ƒë√¢y</h2>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£ phi·∫øu</th>
                        <th>B·ªánh nh√¢n</th>
                        <th>Lo·∫°i si√™u √¢m</th>
                        <th>K·∫øt lu·∫≠n</th>
                        <th>B√°c sƒ©</th>
                        <th width="80"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (ex of recentExams(); track ex.id) {
                    <tr>
                        <td class="code-cell">{{ ex.code }}</td>
                        <td class="name-cell">{{ ex.patientName }}</td>
                        <td>{{ ex.type }}</td>
                        <td class="text-truncate" style="max-width: 300px;">{{ ex.conclusion }}</td>
                        <td>{{ ex.doctor }}</td>
                        <td class="actions-cell">
                            <button class="btn-icon" (click)="viewExam(ex)" title="Xem chi ti·∫øt">
                                üëÅÔ∏è
                            </button>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td colspan="6" class="empty-state">Ch∆∞a c√≥ k·∫øt qu·∫£</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
    }

    @if (showNewExam) {
    <div class="modal-overlay" (click)="showNewExam = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <header class="modal-header">
                <h3>üìù Nh·∫≠p k·∫øt qu·∫£ si√™u √¢m</h3>
                <button class="close-btn" (click)="showNewExam = false">√ó</button>
            </header>

            <form (ngSubmit)="submitExam()" class="modal-form-wrapper">
                <div class="modal-body">
                    <div class="form-group full-width">
                        <label>B·ªánh nh√¢n <span class="required">*</span></label>
                        <input type="text" [(ngModel)]="newExam.patient" name="patient" required
                            placeholder="T√¨m ki·∫øm b·ªánh nh√¢n..." class="form-control" [readonly]="!!currentTicketId" />
                    </div>

                    <div class="form-group full-width">
                        <label>Lo·∫°i si√™u √¢m</label>
                        <select [(ngModel)]="newExam.type" name="type" class="form-control">
                            <option value="2D TC-PP">2D T·ª≠ cung - Ph·∫ßn ph·ª•</option>
                            <option value="Canh no√£n">Canh no√£n</option>
                            <option value="Doppler">Doppler m√†u</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>T·ª≠ cung</label>
                            <input type="text" [(ngModel)]="newExam.uterus" name="uterus"
                                placeholder="T∆∞ th·∫ø, k√≠ch th∆∞·ªõc..." class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>N·ªôi m·∫°c (mm)</label>
                            <input type="number" [(ngModel)]="newExam.endometrium" name="endo" step="0.1"
                                class="form-control" />
                        </div>
                    </div>

                    <fieldset class="form-group fieldset">
                        <legend>Bu·ªìng tr·ª©ng (S·ªë l∆∞·ª£ng nang)</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ph·∫£i (MP)</label>
                                <input type="text" [(ngModel)]="newExam.rightOvary" name="ro"
                                    placeholder="VD: 3 nang (10,12,14mm)" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Tr√°i (MT)</label>
                                <input type="text" [(ngModel)]="newExam.leftOvary" name="lo"
                                    placeholder="VD: 5 nang nh·ªè" class="form-control" />
                            </div>
                        </div>
                    </fieldset>

                    <div class="form-group full-width">
                        <label>K·∫øt lu·∫≠n</label>
                        <textarea [(ngModel)]="newExam.conclusion" name="concl" rows="3"
                            class="form-control"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="showNewExam = false">Hu·ª∑ b·ªè</button>
                    <button type="submit" class="btn btn-primary">L∆∞u k·∫øt qu·∫£</button>
                </div>
            </form>
        </div>
    </div>
    }
</div>