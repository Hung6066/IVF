#!/bin/bash
# ==============================================================================
# Automated Penetration Testing Script for IVF SignServer Infrastructure
# Phase 4: Security validation & OWASP compliance testing
# ==============================================================================
# Usage:
#   ./pentest.sh --target <api|signserver|ejbca|all> [--output <dir>]
#                [--verbose] [--quick]
#
# Prerequisites:
#   - curl, openssl installed
#   - API running at $API_URL (default: http://localhost:5000)
#   - SignServer running at $SIGNSERVER_URL (default: https://localhost:9443)
#   - EJBCA running at $EJBCA_URL (default: https://localhost:8443)
# ==============================================================================

set -euo pipefail

# ── Configuration ──────────────────────────────────────────
API_URL="${API_URL:-http://localhost:5000}"
SIGNSERVER_URL="${SIGNSERVER_URL:-https://localhost:9443}"
EJBCA_URL="${EJBCA_URL:-https://localhost:8443}"
OUTPUT_DIR="${OUTPUT_DIR:-./pentest-results}"
VERBOSE=false
QUICK=false
TARGET="all"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0
WARNING_TESTS=0
RESULTS=()

# ── Functions ──────────────────────────────────────────────

log() { echo -e "${BLUE}[$(date '+%H:%M:%S')]${NC} $1"; }
log_test() { echo -e "${CYAN}  [TEST]${NC} $1"; }

record_result() {
    local id="$1" name="$2" status="$3" detail="$4" severity="$5"
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    case "$status" in
        PASS)    PASSED_TESTS=$((PASSED_TESTS + 1));  echo -e "    ${GREEN}✓ PASS${NC}  $name" ;;
        FAIL)    FAILED_TESTS=$((FAILED_TESTS + 1));  echo -e "    ${RED}✗ FAIL${NC}  $name — $detail" ;;
        WARN)    WARNING_TESTS=$((WARNING_TESTS + 1)); echo -e "    ${YELLOW}⚠ WARN${NC}  $name — $detail" ;;
    esac
    RESULTS+=("$id|$name|$status|$detail|$severity")
}

# ── OWASP API Security Tests ──────────────────────────────

test_api_security() {
    log "═══════════════════════════════════════════════════"
    log "  OWASP API Security Testing — $API_URL"
    log "═══════════════════════════════════════════════════"
    echo ""

    # ── A01: Broken Access Control ──
    log "─── A01: Broken Access Control ───"

    # Test unauthenticated access to admin endpoints
    log_test "Admin endpoints require authentication"
    local resp
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/admin/signing/dashboard" 2>/dev/null || echo "000")
    if [ "$resp" = "401" ] || [ "$resp" = "403" ]; then
        record_result "A01-001" "Admin endpoints require auth" "PASS" "" "Critical"
    elif [ "$resp" = "000" ]; then
        record_result "A01-001" "Admin endpoints require auth" "WARN" "API not reachable (code=$resp)" "Critical"
    else
        record_result "A01-001" "Admin endpoints require auth" "FAIL" "Got HTTP $resp (expected 401/403)" "Critical"
    fi

    # Test unauthenticated access to signing endpoints
    log_test "Signing endpoints require authentication"
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/admin/signing/test-sign" -X POST 2>/dev/null || echo "000")
    if [ "$resp" = "401" ] || [ "$resp" = "403" ]; then
        record_result "A01-002" "Signing endpoints require auth" "PASS" "" "Critical"
    elif [ "$resp" = "000" ]; then
        record_result "A01-002" "Signing endpoints require auth" "WARN" "API not reachable" "Critical"
    else
        record_result "A01-002" "Signing endpoints require auth" "FAIL" "Got HTTP $resp (expected 401/403)" "Critical"
    fi

    # Test IDOR on patient endpoints
    log_test "Patient endpoints prevent IDOR"
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/patients/99999" 2>/dev/null || echo "000")
    if [ "$resp" = "401" ] || [ "$resp" = "403" ] || [ "$resp" = "404" ]; then
        record_result "A01-003" "Patient IDOR prevention" "PASS" "" "High"
    elif [ "$resp" = "000" ]; then
        record_result "A01-003" "Patient IDOR prevention" "WARN" "API not reachable" "High"
    else
        record_result "A01-003" "Patient IDOR prevention" "FAIL" "Got HTTP $resp (expected 401/403/404)" "High"
    fi

    # ── A02: Cryptographic Failures ──
    log "─── A02: Cryptographic Failures ───"

    # Test HTTPS enforcement
    log_test "API enforces HTTPS headers"
    local headers
    headers=$(curl -s -D - -o /dev/null "$API_URL/" 2>/dev/null || echo "")
    if echo "$headers" | grep -qi "strict-transport-security"; then
        record_result "A02-001" "HSTS header present" "PASS" "" "High"
    else
        record_result "A02-001" "HSTS header present" "WARN" "No HSTS header found" "High"
    fi

    # Test TLS version on SignServer
    log_test "SignServer TLS 1.2+ only"
    if command -v openssl &>/dev/null; then
        local tls_test
        tls_test=$(echo | openssl s_client -connect "$(echo "$SIGNSERVER_URL" | sed 's|https://||;s|/.*||')" \
            -tls1_1 2>&1 || true)
        if echo "$tls_test" | grep -qi "alert\|error\|no protocols available\|wrong version number"; then
            record_result "A02-002" "TLS 1.1 rejected by SignServer" "PASS" "" "High"
        else
            record_result "A02-002" "TLS 1.1 rejected by SignServer" "WARN" "Could not confirm TLS 1.1 rejection" "High"
        fi
    else
        record_result "A02-002" "TLS 1.1 rejected by SignServer" "WARN" "openssl not available for testing" "High"
    fi

    # ── A03: Injection ──
    log "─── A03: Injection ───"

    # SQL injection in query parameters
    log_test "SQL injection prevention"
    resp=$(curl -s -o /dev/null -w "%{http_code}" \
        "$API_URL/api/patients?search=1'%20OR%201=1--" 2>/dev/null || echo "000")
    if [ "$resp" = "400" ] || [ "$resp" = "401" ] || [ "$resp" = "403" ] || [ "$resp" = "404" ] || [ "$resp" = "000" ]; then
        record_result "A03-001" "SQL injection prevention" "PASS" "" "Critical"
    elif [ "$resp" = "200" ]; then
        # Could be a false positive — need to check if data was actually returned
        record_result "A03-001" "SQL injection prevention" "WARN" "Got 200 — verify with manual testing" "Critical"
    else
        record_result "A03-001" "SQL injection prevention" "PASS" "Got HTTP $resp" "Critical"
    fi

    # XSS in input fields
    log_test "XSS prevention (Content-Type headers)"
    resp=$(curl -s -D - -o /dev/null "$API_URL/api/patients" \
        -H "Content-Type: application/json" \
        -d '{"name":"<script>alert(1)</script>"}' 2>/dev/null || echo "")
    if echo "$resp" | grep -qi "x-content-type-options: nosniff"; then
        record_result "A03-002" "X-Content-Type-Options: nosniff" "PASS" "" "Medium"
    else
        record_result "A03-002" "X-Content-Type-Options: nosniff" "WARN" "Header not found" "Medium"
    fi

    # Command injection via filename
    log_test "Command injection in file upload"
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/admin/signing/test-sign" \
        -X POST -H "Content-Type: application/json" \
        -d '{"filename":"; cat /etc/passwd"}' 2>/dev/null || echo "000")
    if [ "$resp" = "401" ] || [ "$resp" = "403" ] || [ "$resp" = "400" ]; then
        record_result "A03-003" "Command injection prevention" "PASS" "" "Critical"
    else
        record_result "A03-003" "Command injection prevention" "WARN" "HTTP $resp — requires manual verification" "Critical"
    fi

    # ── A04: Insecure Design ──
    log "─── A04: Insecure Design ───"

    # Rate limiting
    log_test "Rate limiting active on signing endpoints"
    local rate_fail=0
    for i in $(seq 1 5); do
        resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/admin/signing/config" 2>/dev/null || echo "000")
        if [ "$resp" = "429" ]; then
            rate_fail=1
            break
        fi
    done
    if [ "$rate_fail" = "1" ]; then
        record_result "A04-001" "Rate limiting active" "PASS" "Rate limit triggered" "Medium"
    else
        record_result "A04-001" "Rate limiting active" "WARN" "Rate limit not triggered in 5 requests (may need auth)" "Medium"
    fi

    # ── A05: Security Misconfiguration ──
    log "─── A05: Security Misconfiguration ───"

    # Server header removal
    log_test "Server identification headers removed"
    headers=$(curl -s -D - -o /dev/null "$API_URL/" 2>/dev/null || echo "")
    if echo "$headers" | grep -qi "^server:"; then
        local server_val
        server_val=$(echo "$headers" | grep -i "^server:" | head -1)
        record_result "A05-001" "Server header removed" "WARN" "Server header present: $server_val" "Low"
    else
        record_result "A05-001" "Server header removed" "PASS" "" "Low"
    fi

    # X-Powered-By header
    log_test "X-Powered-By header removed"
    if echo "$headers" | grep -qi "x-powered-by"; then
        record_result "A05-002" "X-Powered-By removed" "FAIL" "X-Powered-By header exposes technology" "Low"
    else
        record_result "A05-002" "X-Powered-By removed" "PASS" "" "Low"
    fi

    # CORS configuration
    log_test "CORS properly configured"
    resp=$(curl -s -D - -o /dev/null "$API_URL/api/patients" \
        -H "Origin: https://evil.com" 2>/dev/null || echo "")
    if echo "$resp" | grep -qi "access-control-allow-origin.*evil.com"; then
        record_result "A05-003" "CORS restricts origins" "FAIL" "Wildcard or evil origin allowed" "High"
    else
        record_result "A05-003" "CORS restricts origins" "PASS" "" "High"
    fi

    # Debug/swagger endpoints in production
    log_test "Debug endpoints not exposed"
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/swagger" 2>/dev/null || echo "000")
    if [ "$resp" = "200" ]; then
        record_result "A05-004" "Swagger not exposed" "WARN" "Swagger UI accessible — disable in production" "Low"
    else
        record_result "A05-004" "Swagger not exposed" "PASS" "" "Low"
    fi

    # ── A06: Vulnerable Components ──
    log "─── A06: Vulnerable & Outdated Components ───"

    log_test "Container image vulnerability scan"
    if command -v docker &>/dev/null; then
        record_result "A06-001" "Container scanning available" "PASS" "Use: docker compose --profile security-scan up trivy-scan" "Medium"
    else
        record_result "A06-001" "Container scanning available" "WARN" "Docker not available for scanning" "Medium"
    fi

    # ── A07: Auth Failures ──
    log "─── A07: Identification & Authentication Failures ───"

    # JWT with invalid token
    log_test "Invalid JWT rejected"
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/admin/signing/dashboard" \
        -H "Authorization: Bearer invalid.jwt.token" 2>/dev/null || echo "000")
    if [ "$resp" = "401" ]; then
        record_result "A07-001" "Invalid JWT rejected" "PASS" "" "Critical"
    elif [ "$resp" = "000" ]; then
        record_result "A07-001" "Invalid JWT rejected" "WARN" "API not reachable" "Critical"
    else
        record_result "A07-001" "Invalid JWT rejected" "FAIL" "Got HTTP $resp with invalid JWT" "Critical"
    fi

    # JWT with none algorithm
    log_test "JWT 'none' algorithm rejected"
    # eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzdWIiOiJhZG1pbiJ9.
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/admin/signing/dashboard" \
        -H "Authorization: Bearer eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzdWIiOiJhZG1pbiIsInJvbGUiOiJBZG1pbiJ9." 2>/dev/null || echo "000")
    if [ "$resp" = "401" ]; then
        record_result "A07-002" "JWT 'none' algorithm rejected" "PASS" "" "Critical"
    elif [ "$resp" = "000" ]; then
        record_result "A07-002" "JWT 'none' algorithm rejected" "WARN" "API not reachable" "Critical"
    else
        record_result "A07-002" "JWT 'none' algorithm rejected" "FAIL" "JWT 'none' alg accepted! HTTP $resp" "Critical"
    fi

    # ── A08: Software & Data Integrity ──
    log "─── A08: Software & Data Integrity ───"

    log_test "Content-Security-Policy present"
    headers=$(curl -s -D - -o /dev/null "$API_URL/" 2>/dev/null || echo "")
    if echo "$headers" | grep -qi "content-security-policy"; then
        record_result "A08-001" "CSP header present" "PASS" "" "Medium"
    else
        record_result "A08-001" "CSP header present" "WARN" "No CSP header found" "Medium"
    fi

    # ── A09: Logging & Monitoring ──
    log "─── A09: Security Logging & Monitoring ───"

    log_test "Compliance audit endpoint available"
    resp=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/admin/signing/compliance-audit" 2>/dev/null || echo "000")
    if [ "$resp" = "200" ] || [ "$resp" = "401" ]; then
        record_result "A09-001" "Compliance audit endpoint" "PASS" "Endpoint exists (HTTP $resp)" "Medium"
    else
        record_result "A09-001" "Compliance audit endpoint" "WARN" "HTTP $resp" "Medium"
    fi

    # ── A10: SSRF ──
    log "─── A10: Server-Side Request Forgery (SSRF) ───"

    log_test "SSRF via user input prevented"
    # Try to access internal metadata service via API
    resp=$(curl -s -o /dev/null -w "%{http_code}" \
        "$API_URL/api/admin/signing/signserver/workers" \
        -H "X-Forwarded-For: 169.254.169.254" 2>/dev/null || echo "000")
    if [ "$resp" = "401" ] || [ "$resp" = "403" ]; then
        record_result "A10-001" "SSRF prevention" "PASS" "Endpoint requires auth" "High"
    else
        record_result "A10-001" "SSRF prevention" "WARN" "HTTP $resp — verify SSRF protection manually" "High"
    fi
}

# ── SignServer Specific Tests ──────────────────────────────

test_signserver_security() {
    log ""
    log "═══════════════════════════════════════════════════"
    log "  SignServer Security Testing — $SIGNSERVER_URL"
    log "═══════════════════════════════════════════════════"
    echo ""

    # HTTP port (9080) not accessible
    log "─── SignServer Network Security ───"

    log_test "HTTP port 9080 not exposed"
    local ss_host
    ss_host=$(echo "$SIGNSERVER_URL" | sed 's|https://||;s|:.*||')
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 3 "http://${ss_host}:9080/" 2>/dev/null || echo "000")
    if [ "$resp" = "000" ]; then
        record_result "SS-001" "HTTP port 9080 not exposed" "PASS" "" "Critical"
    else
        record_result "SS-001" "HTTP port 9080 not exposed" "FAIL" "Port 9080 accessible (HTTP $resp)" "Critical"
    fi

    # HTTPS requires client cert
    log_test "HTTPS requires client certificate"
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 -k \
        "${SIGNSERVER_URL}/signserver/process" -X POST 2>/dev/null || echo "000")
    if [ "$resp" = "400" ] || [ "$resp" = "403" ] || [ "$resp" = "401" ]; then
        record_result "SS-002" "mTLS enforcement" "PASS" "HTTP $resp without client cert" "Critical"
    elif [ "$resp" = "000" ]; then
        record_result "SS-002" "mTLS enforcement" "WARN" "SignServer not reachable" "Critical"
    else
        record_result "SS-002" "mTLS enforcement" "WARN" "HTTP $resp — verify client cert required" "Critical"
    fi

    # Admin web requires cert
    log_test "Admin web requires authentication"
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 -k \
        "${SIGNSERVER_URL}/signserver/adminweb/" 2>/dev/null || echo "000")
    if [ "$resp" = "403" ] || [ "$resp" = "401" ] || [ "$resp" = "400" ]; then
        record_result "SS-003" "Admin web auth required" "PASS" "HTTP $resp" "Critical"
    elif [ "$resp" = "000" ]; then
        record_result "SS-003" "Admin web auth required" "WARN" "SignServer not reachable" "Critical"
    elif [ "$resp" = "200" ]; then
        record_result "SS-003" "Admin web auth required" "FAIL" "Admin web accessible without cert!" "Critical"
    else
        record_result "SS-003" "Admin web auth required" "WARN" "HTTP $resp" "Critical"
    fi

    # Health endpoint accessible (designed to be public)
    log_test "Health endpoint available (OK to be public)"
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 -k \
        "${SIGNSERVER_URL}/signserver/healthcheck/signserverhealth" 2>/dev/null || echo "000")
    if [ "$resp" = "200" ]; then
        record_result "SS-004" "Health endpoint available" "PASS" "" "Info"
    else
        record_result "SS-004" "Health endpoint available" "WARN" "HTTP $resp" "Info"
    fi

    # TLS certificate validation
    log "─── SignServer TLS ───"
    log_test "TLS certificate inspection"
    if command -v openssl &>/dev/null; then
        local ss_hostport
        ss_hostport=$(echo "$SIGNSERVER_URL" | sed 's|https://||;s|/.*||')
        local cert_info
        cert_info=$(echo | openssl s_client -connect "$ss_hostport" -servername "$(echo "$ss_hostport" | cut -d: -f1)" 2>/dev/null | openssl x509 -noout -dates -subject 2>/dev/null || echo "UNAVAILABLE")
        if echo "$cert_info" | grep -q "notAfter"; then
            record_result "SS-005" "TLS certificate valid" "PASS" "$(echo "$cert_info" | tr '\n' ' ')" "High"
        else
            record_result "SS-005" "TLS certificate valid" "WARN" "Cannot inspect TLS cert" "High"
        fi
    else
        record_result "SS-005" "TLS certificate valid" "WARN" "openssl not available" "High"
    fi
}

# ── EJBCA Specific Tests ──────────────────────────────────

test_ejbca_security() {
    log ""
    log "═══════════════════════════════════════════════════"
    log "  EJBCA Security Testing — $EJBCA_URL"
    log "═══════════════════════════════════════════════════"
    echo ""

    # Admin web requires cert
    log "─── EJBCA Access Control ───"
    log_test "EJBCA admin requires client certificate"
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 -k \
        "${EJBCA_URL}/ejbca/adminweb/" 2>/dev/null || echo "000")
    if [ "$resp" = "403" ] || [ "$resp" = "401" ] || [ "$resp" = "400" ]; then
        record_result "EJBCA-001" "Admin auth required" "PASS" "HTTP $resp" "Critical"
    elif [ "$resp" = "000" ]; then
        record_result "EJBCA-001" "Admin auth required" "WARN" "EJBCA not reachable" "Critical"
    elif [ "$resp" = "200" ]; then
        record_result "EJBCA-001" "Admin auth required" "FAIL" "Admin web open without cert!" "Critical"
    else
        record_result "EJBCA-001" "Admin auth required" "WARN" "HTTP $resp" "Critical"
    fi

    # REST API requires auth
    log_test "EJBCA REST API requires authentication"
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 -k \
        "${EJBCA_URL}/ejbca-rest-api/v1/ca" 2>/dev/null || echo "000")
    if [ "$resp" = "403" ] || [ "$resp" = "401" ]; then
        record_result "EJBCA-002" "REST API auth required" "PASS" "" "High"
    elif [ "$resp" = "000" ]; then
        record_result "EJBCA-002" "REST API auth required" "WARN" "EJBCA not reachable" "High"
    else
        record_result "EJBCA-002" "REST API auth required" "WARN" "HTTP $resp" "High"
    fi

    # Public enrollment page
    log_test "Public enrollment restricted"
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 -k \
        "${EJBCA_URL}/ejbca/enrol/keystore.jsp" 2>/dev/null || echo "000")
    if [ "$resp" = "403" ] || [ "$resp" = "404" ] || [ "$resp" = "000" ]; then
        record_result "EJBCA-003" "Public enrollment restricted" "PASS" "" "High"
    elif [ "$resp" = "200" ]; then
        record_result "EJBCA-003" "Public enrollment restricted" "WARN" "Public enrollment page accessible" "High"
    else
        record_result "EJBCA-003" "Public enrollment restricted" "PASS" "HTTP $resp" "High"
    fi

    # Health check
    log_test "EJBCA health endpoint"
    resp=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 -k \
        "${EJBCA_URL}/ejbca/publicweb/healthcheck/ejbcahealth" 2>/dev/null || echo "000")
    if [ "$resp" = "200" ]; then
        record_result "EJBCA-004" "Health endpoint available" "PASS" "" "Info"
    else
        record_result "EJBCA-004" "Health endpoint available" "WARN" "HTTP $resp" "Info"
    fi
}

# ── Security Headers Deep Scan ─────────────────────────────

test_security_headers() {
    log ""
    log "═══════════════════════════════════════════════════"
    log "  Security Headers Deep Scan — $API_URL"
    log "═══════════════════════════════════════════════════"
    echo ""

    local headers
    headers=$(curl -s -D - -o /dev/null "$API_URL/" 2>/dev/null || echo "")

    log "─── Response Headers ───"

    local check_headers=(
        "X-Content-Type-Options|nosniff|Medium"
        "X-Frame-Options|DENY|Medium"
        "Referrer-Policy|strict-origin|Medium"
        "Content-Security-Policy|default-src|High"
        "Strict-Transport-Security|max-age|High"
        "Permissions-Policy|camera|Medium"
        "Cross-Origin-Embedder-Policy|require-corp|Medium"
        "Cross-Origin-Opener-Policy|same-origin|Medium"
        "Cross-Origin-Resource-Policy|same-origin|Medium"
    )

    for check in "${check_headers[@]}"; do
        local header_name header_val severity
        header_name=$(echo "$check" | cut -d'|' -f1)
        header_val=$(echo "$check" | cut -d'|' -f2)
        severity=$(echo "$check" | cut -d'|' -f3)

        log_test "$header_name"
        if echo "$headers" | grep -qi "$header_name.*$header_val"; then
            record_result "HDR-$(echo "$header_name" | md5sum | cut -c1-4 | tr 'a-z' 'A-Z')" \
                "$header_name" "PASS" "" "$severity"
        elif echo "$headers" | grep -qi "$header_name"; then
            local actual
            actual=$(echo "$headers" | grep -i "$header_name" | head -1 | tr -d '\r')
            record_result "HDR-$(echo "$header_name" | md5sum | cut -c1-4 | tr 'a-z' 'A-Z')" \
                "$header_name" "WARN" "Present but unexpected value: $actual" "$severity"
        else
            record_result "HDR-$(echo "$header_name" | md5sum | cut -c1-4 | tr 'a-z' 'A-Z')" \
                "$header_name" "FAIL" "Header not found" "$severity"
        fi
    done

    # X-Powered-By should NOT be present
    log_test "X-Powered-By absent"
    if echo "$headers" | grep -qi "x-powered-by"; then
        record_result "HDR-XPOW" "X-Powered-By absent" "FAIL" "Exposes technology stack" "Low"
    else
        record_result "HDR-XPOW" "X-Powered-By absent" "PASS" "" "Low"
    fi

    # Server header should NOT be present
    log_test "Server header absent"
    if echo "$headers" | grep -qi "^server:"; then
        local svr
        svr=$(echo "$headers" | grep -i "^server:" | head -1 | tr -d '\r')
        record_result "HDR-SRVR" "Server header absent" "WARN" "$svr" "Low"
    else
        record_result "HDR-SRVR" "Server header absent" "PASS" "" "Low"
    fi
}

# ── Generate Report ────────────────────────────────────────

generate_report() {
    mkdir -p "$OUTPUT_DIR"
    local timestamp
    timestamp=$(date '+%Y%m%d_%H%M%S')
    local report_file="${OUTPUT_DIR}/pentest_report_${timestamp}.md"
    local json_file="${OUTPUT_DIR}/pentest_results_${timestamp}.json"

    # Markdown report
    cat > "$report_file" <<EOF
# IVF System — Penetration Test Report

**Date:** $(date '+%Y-%m-%d %H:%M:%S %Z')
**Target:** $TARGET
**API URL:** $API_URL
**SignServer URL:** $SIGNSERVER_URL
**EJBCA URL:** $EJBCA_URL

---

## Summary

| Metric | Value |
|--------|-------|
| **Total Tests** | $TOTAL_TESTS |
| **Passed** | $PASSED_TESTS |
| **Warnings** | $WARNING_TESTS |
| **Failed** | $FAILED_TESTS |
| **Pass Rate** | $(( TOTAL_TESTS > 0 ? PASSED_TESTS * 100 / TOTAL_TESTS : 0 ))% |

---

## Detailed Results

| ID | Test | Status | Severity | Detail |
|----|------|--------|----------|--------|
EOF

    for result in "${RESULTS[@]}"; do
        local id name status detail severity
        id=$(echo "$result" | cut -d'|' -f1)
        name=$(echo "$result" | cut -d'|' -f2)
        status=$(echo "$result" | cut -d'|' -f3)
        detail=$(echo "$result" | cut -d'|' -f4)
        severity=$(echo "$result" | cut -d'|' -f5)
        local status_icon="✓"
        [ "$status" = "FAIL" ] && status_icon="✗"
        [ "$status" = "WARN" ] && status_icon="⚠"
        echo "| $id | $name | $status_icon $status | $severity | $detail |" >> "$report_file"
    done

    cat >> "$report_file" <<EOF

---

## Recommendations

### Critical Findings
EOF

    local has_critical=false
    for result in "${RESULTS[@]}"; do
        local status severity name detail
        status=$(echo "$result" | cut -d'|' -f3)
        severity=$(echo "$result" | cut -d'|' -f5)
        name=$(echo "$result" | cut -d'|' -f2)
        detail=$(echo "$result" | cut -d'|' -f4)
        if [ "$status" = "FAIL" ] && [ "$severity" = "Critical" ]; then
            echo "- **$name**: $detail" >> "$report_file"
            has_critical=true
        fi
    done
    if [ "$has_critical" = false ]; then
        echo "No critical failures found." >> "$report_file"
    fi

    cat >> "$report_file" <<EOF

### Warnings
EOF

    local has_warnings=false
    for result in "${RESULTS[@]}"; do
        local status name detail
        status=$(echo "$result" | cut -d'|' -f3)
        name=$(echo "$result" | cut -d'|' -f2)
        detail=$(echo "$result" | cut -d'|' -f4)
        if [ "$status" = "WARN" ]; then
            echo "- $name: $detail" >> "$report_file"
            has_warnings=true
        fi
    done
    if [ "$has_warnings" = false ]; then
        echo "No warnings." >> "$report_file"
    fi

    cat >> "$report_file" <<EOF

---

## Methodology

Tests follow the **OWASP Top 10 (2021)** and **OWASP API Security Top 10**.

| Category | Tests |
|----------|-------|
| A01: Broken Access Control | Auth bypass, IDOR, privilege escalation |
| A02: Cryptographic Failures | HSTS, TLS version, cert validation |
| A03: Injection | SQL injection, XSS, command injection |
| A04: Insecure Design | Rate limiting, business logic |
| A05: Security Misconfiguration | Headers, CORS, debug endpoints |
| A06: Vulnerable Components | Container scanning (Trivy) |
| A07: Auth Failures | JWT validation, algorithm confusion |
| A08: Data Integrity | CSP, SRI check |
| A09: Logging | Audit endpoints, monitoring |
| A10: SSRF | Server-side request forgery |
| SS-*: SignServer | mTLS, port exposure, admin access |
| EJBCA-*: EJBCA | Admin access, REST API, enrollment |
| HDR-*: Headers | OWASP recommended security headers |

---

*Generated by IVF Pentest Script v1.0 — Phase 4 Compliance*
EOF

    # JSON results
    echo "[" > "$json_file"
    local first=true
    for result in "${RESULTS[@]}"; do
        local id name status detail severity
        id=$(echo "$result" | cut -d'|' -f1)
        name=$(echo "$result" | cut -d'|' -f2)
        status=$(echo "$result" | cut -d'|' -f3)
        detail=$(echo "$result" | cut -d'|' -f4)
        severity=$(echo "$result" | cut -d'|' -f5)
        [ "$first" = true ] && first=false || echo "," >> "$json_file"
        cat >> "$json_file" <<JSONEOF
  {"id":"$id","name":"$name","status":"$status","detail":"$detail","severity":"$severity"}
JSONEOF
    done
    echo "]" >> "$json_file"

    log ""
    log "═══════════════════════════════════════════════════"
    log "  Report generated: $report_file"
    log "  JSON results:     $json_file"
    log "═══════════════════════════════════════════════════"
}

# ── Usage / Help ───────────────────────────────────────────

usage() {
    cat <<EOF
IVF Penetration Testing Script — Phase 4 Compliance

Usage: $0 --target <api|signserver|ejbca|all> [OPTIONS]

Options:
  --target <TARGET>    What to test (api, signserver, ejbca, all)
  --output <DIR>       Output directory for reports (default: ./pentest-results)
  --verbose            Show detailed output
  --quick              Skip slow network tests
  -h, --help           Show this help

Environment Variables:
  API_URL              API base URL (default: http://localhost:5000)
  SIGNSERVER_URL       SignServer base URL (default: https://localhost:9443)
  EJBCA_URL            EJBCA base URL (default: https://localhost:8443)

Examples:
  $0 --target all
  $0 --target api --verbose
  API_URL=http://10.0.0.5:5000 $0 --target api --output /tmp/pentest
EOF
    exit 0
}

# ── Parse Arguments ────────────────────────────────────────

while [[ $# -gt 0 ]]; do
    case "$1" in
        --target)  TARGET="$2";     shift 2 ;;
        --output)  OUTPUT_DIR="$2"; shift 2 ;;
        --verbose) VERBOSE=true;    shift ;;
        --quick)   QUICK=true;      shift ;;
        -h|--help) usage ;;
        *)         echo "Unknown option: $1"; usage ;;
    esac
done

# ── Main ───────────────────────────────────────────────────

echo ""
echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║  IVF System — Automated Penetration Testing (Phase 4)   ║${NC}"
echo -e "${CYAN}║  OWASP Top 10 + SignServer + EJBCA Security Validation  ║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

case "$TARGET" in
    api)
        test_api_security
        test_security_headers
        ;;
    signserver)
        test_signserver_security
        ;;
    ejbca)
        test_ejbca_security
        ;;
    all)
        test_api_security
        test_signserver_security
        test_ejbca_security
        test_security_headers
        ;;
    *)
        echo "Unknown target: $TARGET"
        usage
        ;;
esac

# Final Summary
echo ""
log "═══════════════════════════════════════════════════"
log "  PENETRATION TEST SUMMARY"
log "═══════════════════════════════════════════════════"
echo ""
echo -e "  Total Tests:  $TOTAL_TESTS"
echo -e "  ${GREEN}Passed:       $PASSED_TESTS${NC}"
echo -e "  ${YELLOW}Warnings:     $WARNING_TESTS${NC}"
echo -e "  ${RED}Failed:       $FAILED_TESTS${NC}"
local pass_rate=$(( TOTAL_TESTS > 0 ? PASSED_TESTS * 100 / TOTAL_TESTS : 0 ))
echo -e "  Pass Rate:    ${pass_rate}%"
echo ""

if [ "$FAILED_TESTS" -gt 0 ]; then
    echo -e "${RED}  ✗ SECURITY ISSUES FOUND — Review failed tests above${NC}"
elif [ "$WARNING_TESTS" -gt 0 ]; then
    echo -e "${YELLOW}  ⚠ WARNINGS FOUND — Review for potential improvements${NC}"
else
    echo -e "${GREEN}  ✓ ALL TESTS PASSED${NC}"
fi
echo ""

generate_report

log "Done."
